<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>開発メモ その136 Windows 10 Ver1803で起動しなくなったCentOS on Hyper-Vを復旧する · A certain engineer "COMPLEX"</title><meta name="description" content="IntroductionWindows 10 April 2018 Update (Ver.1803) のマシンにおいて、Hyper-V上のLinux仮想マシンが起動しない現象が発生した。 こんな感じになります。 具体的に起動しないマシンは、

1803で新規に作成したマシン (世代1で作成)
18"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li><li><a href="/guestbook">メッセージ</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>開発メモ その136 Windows 10 Ver1803で起動しなくなったCentOS on Hyper-Vを復旧する</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p><strong>Windows 10 April 2018 Update (Ver.1803)</strong> のマシンにおいて、Hyper-V上のLinux仮想マシンが起動しない現象が発生した。 こんな感じになります。<br><a href="../../../../public/2018/10/01.png"><img src="../../../../public/2018/10/01-1024x859.png"></a><br> 具体的に起動しないマシンは、</p>
<ol>
<li>1803で新規に作成したマシン (世代1で作成)</li>
<li>1803より前の環境で作成し、1803にVHDをコピーして再作成したマシン (世代1で作成)</li>
</ol>
<p>という条件である。 要するに世代1で作成するのが不味かったのだが、既存の資産が動いているレガシーなLinuxだとそうも言っていられない。 これが会社のマシンで起こり、自宅の環境でも再現してしまったので、解決策を模索した。</p>
<h1 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a>Resolution</h1><p>Google先生に聞いても、この現象に遭遇している人がいなかった。 なので、自分で探すこと1週間。解決のきっかけに気づいたのは、イベントビューアを見ていたときである。<br><a href="../../../../public/2018/10/00.png"><img src="../../../../public/2018/10/00-1024x763.png"></a> <strong>Microsoft-Windows-Hyper-V-Worker-Admin</strong> に奇妙なログが記載されていた。 <code>仮想マシン %1 でデバイス %3 を読み込むことができません。相互にサポートされているプロトコル バージョンがありません。サーバー バージョンは %4 で、クライアント バージョンは %5 です (仮想マシン ID %2) 。</code> どうも、問題のマシンを立ち上げた時に記録されている模様。 これを見て思ったのは、グラフィック系統のデバイスが正しく読み込まれていないから、起動時におかしな画面に陥るのでは?と推測。 だから、起動時にグラフィック表示をなくせば起動できるのでは?と予想。 試したところ、ビンゴでした。 下記のOSは <strong>CentOS 6.10</strong> ですが、手順はどのOSでも似たようなものかと。</p>
<h3 id="1-起動"><a href="#1-起動" class="headerlink" title="1. 起動"></a>1. 起動</h3><p>下記の画面でキーを押下して、メニューに入ります。<br><a href="../../../../public/2018/10/02.png"><img src="../../../../public/2018/10/02.png"></a></p>
<h3 id="2-GRUB"><a href="#2-GRUB" class="headerlink" title="2. GRUB"></a>2. GRUB</h3><p>下記のメニューが表示されたら <strong>a</strong> を押下して、カーネルの引数を編集する画面に入ります。<br><a href="../../../../public/2018/10/04.png"><img src="../../../../public/2018/10/04.png"></a></p>
<h3 id="3-カーネル引数の編集"><a href="#3-カーネル引数の編集" class="headerlink" title="3. カーネル引数の編集"></a>3. カーネル引数の編集</h3><p>OSの状態によって評される文字列が異なります。 例えば、下記はOSをインストールした直後になります。<br><a href="../../../../public/2018/10/05.png"><img src="../../../../public/2018/10/05.png"></a> 下記はOSをインストールして、初期ユーザの設定が終わった以降になります。 <a href="../../../../public/2018/10/05-2.png"><img src="../../../../public/2018/10/05-2.png"></a> どちらでも共通に存在する <strong>rhgb quiet</strong> を削除し、Enterキーを押下し、ブートを再開します。 <a href="../../../../public/2018/10/06.png"><img src="../../../../public/2018/10/06.png"></a></p>
<h3 id="4-無事に起動"><a href="#4-無事に起動" class="headerlink" title="4. 無事に起動"></a>4. 無事に起動</h3><p>一瞬、画面が乱れた問題になった画面が表示されますが、少し待つとブートが継続されます。<br><a href="../../../../public/2018/10/99.png"><img src="../../../../public/2018/10/99-1024x844.png"></a></p>
<h3 id="5-永続化"><a href="#5-永続化" class="headerlink" title="5. 永続化"></a>5. 永続化</h3><p>ここまでの方法はその場限りで再起動すれば戻ってしまいます。 なので、GRUBの設定ファイルを編集することで設定を永続化します。 無事にログインしたら、シェルから設定ファイルを編集します。 [code lang=”shell”] $ sudo vi /etc/grub.conf [/code] 編集ファイルを開くと下記のような状態です。 [code] # grub.conf generated by anaconda # # Note that you do not have to rerun grub after making changes to this file # NOTICE: You have a /boot partition. This means that # all kernel and initrd paths are relative to /boot/, eg. # root (hd0,0) # kernel /vmlinuz-version ro root=/dev/mapper/VolGroup-lv_root # initrd /initrd-[generic-]version.img #boot=/dev/sda default=0 timeout=5 splashimage=(hd0,0)/grub/splash.xpm.gz hiddenmenu title CentOS 6 (2.6.32-754.el6.x86_64) root (hd0,0) kernel /vmlinuz-2.6.32-754.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS LANG=en_US.UTF-8 rd_NO_MD rd_LVM_LV=VolGroup/lv_swap SYSFONT=latarcyrheb-sun16 rd_LVM_LV=VolGroup/lv_root KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet initrd /initramfs-2.6.32-754.el6.x86_64.img [/code] これを下記のように編集します。 わかりにくいですが、先述のように、<strong>rhgb quiet</strong>を削除するだけです。 [code] # grub.conf generated by anaconda # # Note that you do not have to rerun grub after making changes to this file # NOTICE: You have a /boot partition. This means that # all kernel and initrd paths are relative to /boot/, eg. # root (hd0,0) # kernel /vmlinuz-version ro root=/dev/mapper/VolGroup-lv_root # initrd /initrd-[generic-]version.img #boot=/dev/sda default=0 timeout=5 splashimage=(hd0,0)/grub/splash.xpm.gz hiddenmenu title CentOS 6 (2.6.32-754.el6.x86_64) root (hd0,0) kernel /vmlinuz-2.6.32-754.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS LANG=en_US.UTF-8 rd_NO_MD rd_LVM_LV=VolGroup/lv_swap SYSFONT=latarcyrheb-sun16 rd_LVM_LV=VolGroup/lv_root KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM initrd /initramfs-2.6.32-754.el6.x86_64.img [/code] これで設定が永続化されます。 ただし、これらを行っても、たまに起動に失敗することがあります。 その時はリセットボタンで再度ブートをやり直します。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-10-13</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Linux/" title="Linux">Linux </a><a class="tag" href="/categories/Microsoft/Hyper-V/" title="Hyper-V">Hyper-V </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2018/10/13/3201/,A certain engineer &quot;COMPLEX&quot;,開発メモ その136 Windows 10 Ver1803で起動しなくなったCentOS on Hyper-Vを復旧する,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2018/10/20/3218/" title="開発メモ その137 Chainer with CUDA on Anaconda3 for Windowsを使う">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/09/09/3172/" title="開発メモ その135 OpenCVに組み込んだlibjpeg-turbo 1.5.3と2.0.0を比較">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script></body></html>