<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><link rel="icon" href="/images/favicon.ico" type="image/x-icon"><title>開発メモ その360 古いマシンにインストールされた Windows 11 21H2 を 23H2 にアップグレードする · A certain engineer "COMPLEX"</title><meta name="description" content="Introduction忘備録。
開発メモ その261 Windows 11 を古いマシンにインストールする にてインストールした Windows 11 マシンに対して、いつまでたっても 23H2 のアップデートが降ってこない。CPU とかのハードウェア要件をバイパスした影響だということに気づき、ア"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/apps">Apps</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>開発メモ その360 古いマシンにインストールされた Windows 11 21H2 を 23H2 にアップグレードする</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>忘備録。</p>
<p><a target="_blank" rel="noopener" href="https://taktak.jp/2022/05/03/4420/">開発メモ その261 Windows 11 を古いマシンにインストールする</a> にてインストールした Windows 11 マシンに対して、いつまでたっても 23H2 のアップデートが降ってこない。<br>CPU とかのハードウェア要件をバイパスした影響だということに気づき、アップデートする方法を探したのが事の発端。</p>
<p>とはいえ、いきなり物理マシンで使うのは怖いので、Hyper-V 環境を用意してそちらで検証。</p>
<p><a href="../../../../public/2024/01/28/4468/001.png"><img src="../../../../public/2024/01/28/4468/001.png" alt="win11upgrade"></a></p>
<h1 id="How-to-do"><a href="#How-to-do" class="headerlink" title="How to do?"></a>How to do?</h1><p>実は、Windows 10 から 11 へのアップグレードに関して、<a target="_blank" rel="noopener" href="https://support.microsoft.com/ja-jp/windows/windows-11-%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95-e0edbbfb-cfc5-4011-868b-2ce77ac7c70e">Windows 11 をインストールする方法</a> というページで CPU 等の条件チェックを回避する方法を Microsoft が公式として説明している。</p>
<p>ページ自体は Windows 10 から 11 へのアップグレードだが、21H2 から 23H2 のようなアップデートにも対応できる。</p>
<p>ただし、</p>
<blockquote>
<p>TPM 2.0 (少なくとも TPM 1.2 が必要) のチェック、CPU ファミリ、CPU モデルをバイパスできます。</p>
</blockquote>
<p>とあるように、TPM 自体は 1.2 が最低でも必要で、このチェックだけは回避できない。</p>
<p>TPM 自体のチェックを回避する方法は後述。</p>
<h3 id="1-普通にアップデートを実行"><a href="#1-普通にアップデートを実行" class="headerlink" title="1. 普通にアップデートを実行"></a>1. 普通にアップデートを実行</h3><p>まずは何も対処しないでアップデートを実施。</p>
<p><a href="../../../../public/2024/01/28/4468/002.png"><img src="../../../../public/2024/01/28/4468/002.png" alt="win11upgrade"></a><br>Windows 11 の iso を挿入し、 <code>setup.exe</code> を実行。</p>
<p><a href="../../../../public/2024/01/28/4468/003.png"><img src="../../../../public/2024/01/28/4468/003.png" alt="win11upgrade"></a></p>
<p><a href="../../../../public/2024/01/28/4468/004.png"><img src="../../../../public/2024/01/28/4468/004.png" alt="win11upgrade"></a></p>
<p><a href="../../../../public/2024/01/28/4468/005.png"><img src="../../../../public/2024/01/28/4468/005.png" alt="win11upgrade"></a></p>
<p><a href="../../../../public/2024/01/28/4468/006.png"><img src="../../../../public/2024/01/28/4468/006.png" alt="win11upgrade"></a><br>ここで、条件チェックに引っかかる。</p>
<h3 id="2-ハードウェア要件回避を実行"><a href="#2-ハードウェア要件回避を実行" class="headerlink" title="2. ハードウェア要件回避を実行"></a>2. ハードウェア要件回避を実行</h3><p>先の Micorsoft の公式手順に従い、レジストリを変更する。</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ reg add HKEY_LOCAL_MACHINE\SYSTEM\Setup\MoSetup /v AllowUpgradesWithUnsupportedTPMOrCPU /t REG_DWORD /d <span class="number">1</span> /f</span><br><span class="line">The operation completed successfully.</span><br></pre></td></tr></table></figure>

<p>再度、<code>setup.exe</code> から再開する。</p>
<p><a href="../../../../public/2024/01/28/4468/007.png"><img src="../../../../public/2024/01/28/4468/007.png" alt="win11upgrade"></a><br>が、TPM だけは回避できない。</p>
<p>これも公式手順通りで、当該のマシンには TPM 自体が組み込まれていないため、TPM 1.2 以上という条件を満たすことができず、チェックを回避できない。</p>
<h3 id="3-TPM-のチェックを回避"><a href="#3-TPM-のチェックを回避" class="headerlink" title="3. TPM のチェックを回避"></a>3. TPM のチェックを回避</h3>

<p>によれば、TPM のチェックどころか、ハードウェア要件のチェック全体を回避できるバッチスクリプトが存在するとのこと。<br>それが </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://github.com/AveYo/MediaCreationTool.bat/blob/main/bypass11/Skip_TPM_Check_on_Dynamic_Update.cmd" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=github.com"></img><div class="hbc-site-name">GitHub</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img src="https://repository-images.githubusercontent.com/415421172/44213d64-6546-4d9d-a39c-8c8617a20603"></img></div><div class="hbc-text"><div class="hbc-title">MediaCreationTool.bat/bypass11/Skip_TPM_Check_on_Dynamic_Update.cmd at main · AveYo/MediaCreationTool.bat</div><div class="hbc-url">https://github.com/AveYo/MediaCreationTool.bat/blob/main/bypass11/Skip_TPM_Check_on_Dynamic_Update.cmd</div><div class="hbc-description">Universal MCT wrapper script for all Windows 10/11 versions from 1507 to 21H2! - AveYo/MediaCreationTool.bat</div></div></div></div></a></div></div>

<p>である。</p>
<p>このバッチを管理者で実行し、再度 <code>setup.exe</code> を実行すればいい。</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ Skip_TPM_Check_on_Dynamic_Update.<span class="built_in">cmd</span></span><br><span class="line"></span><br><span class="line"> Skip TPM Check on Dynamic Update V13  INSTALLED  run again to remove</span><br><span class="line"></span><br><span class="line">Waiting <span class="keyword">for</span> <span class="number">0</span> seconds, press a key to continue ...</span><br></pre></td></tr></table></figure>

<p>一応、このバッチ Skip_TPM_Check_on_Dynamic_Update.cmd の中身を張っておく。</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">@(<span class="built_in">set</span> &#x27;(=)||&#x27; &lt;# lean and mean <span class="built_in">cmd</span> / powershell hybrid #&gt; @&#x27;</span><br><span class="line"></span><br><span class="line">::# Get <span class="number">11</span> on &#x27;unsupported&#x27; PC via Windows Update or mounted ISO (no patching needed)</span><br><span class="line">::# <span class="keyword">if</span> WU is stuck use windows_update_refresh.bat; Beta/Dev/Canary needs OfflineInsiderEnroll</span><br><span class="line">::# V13: skip <span class="number">2</span>nd tpm check on Canary iso; no Server <span class="built_in">label</span>; future proofing; tested with <span class="number">26010</span> iso, wu and wu repair version</span><br><span class="line"></span><br><span class="line">@<span class="built_in">echo</span> off &amp; <span class="built_in">title</span> get <span class="number">11</span> on &#x27;unsupported&#x27; PC || AveYo <span class="number">2023</span>.<span class="number">12</span>.<span class="number">07</span></span><br><span class="line"><span class="keyword">if</span> /i &quot;%~f0&quot; <span class="keyword">neq</span> &quot;<span class="variable">%SystemDrive%</span>\Scripts\get11.<span class="built_in">cmd</span>&quot; <span class="keyword">goto</span> setup</span><br><span class="line">powershell -win <span class="number">1</span> -nop -c &quot;;&quot;</span><br><span class="line"><span class="built_in">set</span> CLI=%*&amp; <span class="built_in">set</span> SOURCES=<span class="variable">%SystemDrive%</span>\$WINDOWS.~BT\Sources&amp; <span class="built_in">set</span> MEDIA=.&amp; <span class="built_in">set</span> MOD=CLI&amp; <span class="built_in">set</span> PRE=WUA&amp; <span class="built_in">set</span> /a <span class="built_in">VER</span>=<span class="number">11</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">defined</span> CLI (<span class="keyword">exit</span> /b) <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exist</span> <span class="variable">%SOURCES%</span>\SetupHost.exe (<span class="keyword">exit</span> /b)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exist</span> <span class="variable">%SOURCES%</span>\WindowsUpdateBox.exe mklink /h <span class="variable">%SOURCES%</span>\WindowsUpdateBox.exe <span class="variable">%SOURCES%</span>\SetupHost.exe</span><br><span class="line">reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate /f /v DisableWUfBSafeguards /d <span class="number">1</span> /t reg_dword</span><br><span class="line">reg add HKLM\SYSTEM\Setup\MoSetup /f /v AllowUpgradesWithUnsupportedTPMorCPU /d <span class="number">1</span> /t reg_dword</span><br><span class="line"><span class="built_in">set</span> OPT=/Compat IgnoreWarning /MigrateDrivers All /Telemetry Disable</span><br><span class="line"><span class="built_in">set</span> /a restart_application=<span class="number">0</span>x800705BB &amp; (<span class="keyword">call</span> <span class="built_in">set</span> CLI=<span class="variable">%%C</span>LI:%<span class="number">1</span> =<span class="variable">%%)</span></span><br><span class="line"><span class="built_in">set</span> /a incorrect_parameter=<span class="number">0</span>x80070057 &amp; (<span class="built_in">set</span> SRV=%CLI:/Product Client =%)</span><br><span class="line"><span class="built_in">set</span> /a launch_option_error=<span class="number">0</span>xc190010a &amp; (<span class="built_in">set</span> SRV=%SRV:/Product Server =%)</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%W</span> <span class="keyword">in</span> (<span class="variable">%CLI%</span>) <span class="keyword">do</span> <span class="keyword">if</span> /i <span class="variable">%%W</span> == /PreDownload (<span class="built_in">set</span> MOD=SRV)</span><br><span class="line"><span class="keyword">for</span> <span class="variable">%%W</span> <span class="keyword">in</span> (<span class="variable">%CLI%</span>) <span class="keyword">do</span> <span class="keyword">if</span> /i <span class="variable">%%W</span> == /InstallFile (<span class="built_in">set</span> PRE=ISO&amp; <span class="built_in">set</span> &quot;MEDIA=&quot;) <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">defined</span> MEDIA <span class="built_in">set</span> &quot;MEDIA=<span class="variable">%%~</span>dpW&quot;</span><br><span class="line"><span class="keyword">if</span> <span class="variable">%VER%</span> == <span class="number">11</span> <span class="keyword">for</span> <span class="variable">%%W</span> <span class="keyword">in</span> (&quot;<span class="variable">%MEDIA%</span>appraiserres.dll&quot;) <span class="keyword">do</span> <span class="keyword">if</span> <span class="keyword">exist</span> <span class="variable">%%W</span> <span class="keyword">if</span> <span class="variable">%%~</span>zW == <span class="number">0</span> <span class="built_in">set</span> AlreadyPatched=<span class="number">1</span> &amp; <span class="built_in">set</span> /a <span class="built_in">VER</span>=<span class="number">10</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">%VER%</span> == <span class="number">11</span> <span class="built_in">findstr</span> /r &quot;P.r.o.d.u.c.t.V.e.r.s.i.o.n...<span class="number">1</span>.<span class="number">0</span>.\..<span class="number">0</span>.\..<span class="number">2</span>.[<span class="number">2</span>-<span class="number">9</span>]&quot; <span class="variable">%SOURCES%</span>\SetupHost.exe &gt;<span class="built_in">nul</span> <span class="number">2</span>&gt;<span class="built_in">nul</span> || <span class="built_in">set</span> /a <span class="built_in">VER</span>=<span class="number">10</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">%VER%</span> == <span class="number">11</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exist</span> &quot;<span class="variable">%MEDIA%</span>EI.cfg&quot; (<span class="built_in">echo</span>;[Channel]&gt;<span class="variable">%SOURCES%</span>\EI.cfg &amp; <span class="built_in">echo</span>;_Default&gt;&gt;<span class="variable">%SOURCES%</span>\EI.cfg)</span><br><span class="line"><span class="keyword">if</span> <span class="variable">%VER%</span>_<span class="variable">%PRE%</span> == <span class="number">11</span>_ISO (<span class="variable">%SOURCES%</span>\WindowsUpdateBox.exe /Product Server /PreDownload /Quiet <span class="variable">%OPT%</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="variable">%VER%</span>_<span class="variable">%PRE%</span> == <span class="number">11</span>_ISO (<span class="built_in">del</span> /f /q <span class="variable">%SOURCES%</span>\appraiserres.dll <span class="number">2</span>&gt;<span class="built_in">nul</span> &amp; <span class="built_in">cd</span>.&gt;<span class="variable">%SOURCES%</span>\appraiserres.dll &amp; <span class="keyword">call</span> :canary)</span><br><span class="line"><span class="keyword">if</span> <span class="variable">%VER%</span>_<span class="variable">%MOD%</span> == <span class="number">11</span>_SRV (<span class="built_in">set</span> ARG=<span class="variable">%OPT%</span> <span class="variable">%SRV%</span> /Product Server)</span><br><span class="line"><span class="keyword">if</span> <span class="variable">%VER%</span>_<span class="variable">%MOD%</span> == <span class="number">11</span>_CLI (<span class="built_in">set</span> ARG=<span class="variable">%OPT%</span> <span class="variable">%CLI%</span>)</span><br><span class="line"><span class="variable">%SOURCES%</span>\WindowsUpdateBox.exe <span class="variable">%ARG%</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">%errorlevel%</span> == <span class="variable">%restart_application%</span> (<span class="keyword">call</span> :canary &amp; <span class="variable">%SOURCES%</span>\WindowsUpdateBox.exe <span class="variable">%ARG%</span>)</span><br><span class="line"><span class="keyword">exit</span> /b</span><br><span class="line"></span><br><span class="line">:canary iso skip <span class="number">2</span>nd tpm check by AveYo  </span><br><span class="line"><span class="built_in">set</span> C=  $X=&#x27;<span class="variable">%SOURCES%</span>\hwreqchk.dll&#x27;; $Y=&#x27;SQ_TpmVersion GTE <span class="number">1</span>&#x27;; $Z=&#x27;SQ_TpmVersion GTE <span class="number">0</span>&#x27;; <span class="keyword">if</span> (test-<span class="built_in">path</span> $X) &#123; </span><br><span class="line"><span class="built_in">set</span> C=<span class="variable">%C%</span>  try &#123; takeown.exe /f $X /a; icacls.exe $X /grant *S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">32</span>-<span class="number">544</span>:f; <span class="built_in">attrib</span> -R -S $X; [io.file]::OpenWrite($X).close() &#125;</span><br><span class="line"><span class="built_in">set</span> C=<span class="variable">%C%</span>  catch &#123; return &#125;; $R=[Text.Encoding]::UTF8.GetBytes($Z); $l=$R.Length; $i=<span class="number">2</span>; $w=!<span class="number">1</span>;</span><br><span class="line"><span class="built_in">set</span> C=<span class="variable">%C%</span>  $B=[io.file]::ReadAllBytes($X); $H=[BitConverter]::ToString($B) -<span class="built_in">replace</span> &#x27;-&#x27;;</span><br><span class="line"><span class="built_in">set</span> C=<span class="variable">%C%</span>  $S=[BitConverter]::ToString([Text.Encoding]::UTF8.GetBytes($Y)) -<span class="built_in">replace</span> &#x27;-&#x27;;</span><br><span class="line"><span class="built_in">set</span> C=<span class="variable">%C%</span>  <span class="keyword">do</span> &#123; $i=$H.IndexOf($S, $i + <span class="number">2</span>); <span class="keyword">if</span> ($i -gt <span class="number">0</span>) &#123; $w=!<span class="number">0</span>; <span class="keyword">for</span> ($k=<span class="number">0</span>; $k -lt $l; $k++) &#123; $B[$k + $i / <span class="number">2</span>]=$R[$k] &#125; &#125; &#125;</span><br><span class="line"><span class="built_in">set</span> C=<span class="variable">%C%</span>  until ($i -lt <span class="number">1</span>); <span class="keyword">if</span> ($w) &#123; [io.file]::WriteAllBytes($X, $B); [GC]::Collect() &#125; &#125;</span><br><span class="line"><span class="keyword">if</span> <span class="variable">%VER%</span>_<span class="variable">%PRE%</span> == <span class="number">11</span>_ISO powershell -nop -c iex($env:C) &gt;<span class="built_in">nul</span> <span class="number">2</span>&gt;<span class="built_in">nul</span></span><br><span class="line"><span class="keyword">exit</span> /b</span><br><span class="line"></span><br><span class="line">:setup</span><br><span class="line">::# elevate with native shell by AveYo</span><br><span class="line">&gt;<span class="built_in">nul</span> reg add hkcu\software\classes\.Admin\shell\runas\command /f /ve /d &quot;<span class="built_in">cmd</span> /x /d /r <span class="built_in">set</span> \&quot;f0=<span class="variable">%%2</span>\&quot;&amp; <span class="keyword">call</span> \&quot;<span class="variable">%%2</span>\&quot; <span class="variable">%%3</span>&quot;&amp; <span class="built_in">set</span> _= %*</span><br><span class="line">&gt;<span class="built_in">nul</span> fltmc|| <span class="keyword">if</span> &quot;<span class="variable">%f0%</span>&quot; <span class="keyword">neq</span> &quot;%~f0&quot; (<span class="built_in">cd</span>.&gt;&quot;<span class="variable">%temp%</span>\runas.Admin&quot; &amp; <span class="built_in">start</span> &quot;%~n0&quot; /high &quot;<span class="variable">%temp%</span>\runas.Admin&quot; &quot;%~f0&quot; &quot;<span class="variable">%_:&quot;=&quot;&quot;%</span>&quot; &amp; <span class="keyword">exit</span> /b)</span><br><span class="line"></span><br><span class="line">::# lean xp+ <span class="built_in">color</span> macros by AveYo:  <span class="variable">%&lt;%</span>:af &quot; hello &quot;<span class="variable">%&gt;&gt;%</span>  &amp;  <span class="variable">%&lt;%</span>:cf &quot; w\&quot;or\&quot;ld &quot;<span class="variable">%&gt;%</span>   <span class="keyword">for</span> single \ / &quot; use .<span class="variable">%|%</span>\  .<span class="variable">%|%</span>/  \&quot;<span class="variable">%|%</span>\&quot;</span><br><span class="line"><span class="keyword">for</span> /f &quot;delims=:&quot; <span class="variable">%%s</span> <span class="keyword">in</span> (&#x27;<span class="built_in">echo</span>;prompt $h$s$h:^|<span class="built_in">cmd</span> /d&#x27;) <span class="keyword">do</span> <span class="built_in">set</span> &quot;|=<span class="variable">%%s</span>&quot;&amp;<span class="built_in">set</span> &quot;&gt;&gt;=\..\c <span class="built_in">nul</span>&amp;<span class="built_in">set</span> /p s=<span class="variable">%%s</span><span class="variable">%%s</span><span class="variable">%%s</span><span class="variable">%%s</span><span class="variable">%%s</span><span class="variable">%%s</span><span class="variable">%%s</span>&lt;<span class="built_in">nul</span>&amp;<span class="built_in">popd</span>&quot;</span><br><span class="line"><span class="built_in">set</span> &quot;&lt;=<span class="built_in">pushd</span> &quot;<span class="variable">%appdata%</span>&quot;&amp;<span class="number">2</span>&gt;<span class="built_in">nul</span> <span class="built_in">findstr</span> /c:\ /a&quot; &amp;<span class="built_in">set</span> &quot;&gt;=<span class="variable">%&gt;&gt;%</span>&amp;<span class="built_in">echo</span>;&quot; &amp;<span class="built_in">set</span> &quot;|=<span class="variable">%|:~0,1%</span>&quot; &amp;<span class="built_in">set</span> /p s=\&lt;<span class="built_in">nul</span>&gt;&quot;<span class="variable">%appdata%</span>\c&quot;</span><br><span class="line"></span><br><span class="line">::# toggle when launched without arguments, <span class="keyword">else</span> jump to arguments: &quot;install&quot; or &quot;remove&quot;</span><br><span class="line"><span class="built_in">set</span> CLI=%*&amp; (<span class="built_in">set</span> IFEO=HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options)</span><br><span class="line">wmic /namespace:&quot;\\root\subscription&quot; <span class="built_in">path</span> __EventFilter where Name=&quot;Skip TPM Check on Dynamic Update&quot; delete &gt;<span class="built_in">nul</span> <span class="number">2</span>&gt;<span class="built_in">nul</span> &amp; <span class="built_in">rem</span> v1</span><br><span class="line">reg delete &quot;<span class="variable">%IFEO%</span>\vdsldr.exe&quot; /f <span class="number">2</span>&gt;<span class="built_in">nul</span> &amp; <span class="built_in">rem</span> v2 - v5</span><br><span class="line"><span class="keyword">if</span> /i &quot;<span class="variable">%CLI%</span>&quot;==&quot;&quot; reg query &quot;<span class="variable">%IFEO%</span>\SetupHost.exe\<span class="number">0</span>&quot; /v Debugger &gt;<span class="built_in">nul</span> <span class="number">2</span>&gt;<span class="built_in">nul</span> &amp;&amp; <span class="keyword">goto</span> remove || <span class="keyword">goto</span> install</span><br><span class="line"><span class="keyword">if</span> /i &quot;%~<span class="number">1</span>&quot;==&quot;install&quot; (<span class="keyword">goto</span> install) <span class="keyword">else</span> <span class="keyword">if</span> /i &quot;%~<span class="number">1</span>&quot;==&quot;remove&quot; <span class="keyword">goto</span> remove</span><br><span class="line"></span><br><span class="line">:install</span><br><span class="line"><span class="built_in">mkdir</span> <span class="variable">%SystemDrive%</span>\Scripts &gt;<span class="built_in">nul</span> <span class="number">2</span>&gt;<span class="built_in">nul</span> &amp; <span class="built_in">copy</span> /y &quot;%~f0&quot; &quot;<span class="variable">%SystemDrive%</span>\Scripts\get11.<span class="built_in">cmd</span>&quot; &gt;<span class="built_in">nul</span> <span class="number">2</span>&gt;<span class="built_in">nul</span></span><br><span class="line">reg add &quot;<span class="variable">%IFEO%</span>\SetupHost.exe&quot; /f /v UseFilter /d <span class="number">1</span> /t reg_dword &gt;<span class="built_in">nul</span></span><br><span class="line">reg add &quot;<span class="variable">%IFEO%</span>\SetupHost.exe\<span class="number">0</span>&quot; /f /v FilterFullPath /d &quot;<span class="variable">%SystemDrive%</span>\$WINDOWS.~BT\Sources\SetupHost.exe&quot; &gt;<span class="built_in">nul</span></span><br><span class="line">reg add &quot;<span class="variable">%IFEO%</span>\SetupHost.exe\<span class="number">0</span>&quot; /f /v Debugger /d &quot;<span class="variable">%SystemDrive%</span>\Scripts\get11.<span class="built_in">cmd</span>&quot; &gt;<span class="built_in">nul</span></span><br><span class="line"><span class="built_in">echo</span>;</span><br><span class="line"><span class="variable">%&lt;%</span>:f0 &quot; Skip TPM Check on Dynamic Update V13 &quot;<span class="variable">%&gt;&gt;%</span> &amp; <span class="variable">%&lt;%</span>:<span class="number">2</span>f &quot; INSTALLED &quot;<span class="variable">%&gt;&gt;%</span> &amp; <span class="variable">%&lt;%</span>:f0 &quot; run again to remove &quot;<span class="variable">%&gt;%</span></span><br><span class="line"><span class="keyword">if</span> /i &quot;<span class="variable">%CLI%</span>&quot;==&quot;&quot; timeout /t <span class="number">7</span></span><br><span class="line"><span class="keyword">exit</span> /b</span><br><span class="line"></span><br><span class="line">:remove</span><br><span class="line"><span class="built_in">del</span> /f /q &quot;<span class="variable">%SystemDrive%</span>\Scripts\get11.<span class="built_in">cmd</span>&quot; &quot;<span class="variable">%Public%</span>\get11.<span class="built_in">cmd</span>&quot; &quot;<span class="variable">%ProgramData%</span>\get11.<span class="built_in">cmd</span>&quot; &gt;<span class="built_in">nul</span> <span class="number">2</span>&gt;<span class="built_in">nul</span></span><br><span class="line">reg delete &quot;<span class="variable">%IFEO%</span>\SetupHost.exe&quot; /f &gt;<span class="built_in">nul</span> <span class="number">2</span>&gt;<span class="built_in">nul</span></span><br><span class="line"><span class="built_in">echo</span>;</span><br><span class="line"><span class="variable">%&lt;%</span>:f0 &quot; Skip TPM Check on Dynamic Update V13 &quot;<span class="variable">%&gt;&gt;%</span> &amp; <span class="variable">%&lt;%</span>:df &quot; REMOVED &quot;<span class="variable">%&gt;&gt;%</span> &amp; <span class="variable">%&lt;%</span>:f0 &quot; run again to install &quot;<span class="variable">%&gt;%</span></span><br><span class="line"><span class="keyword">if</span> /i &quot;<span class="variable">%CLI%</span>&quot;==&quot;&quot; timeout /t <span class="number">7</span></span><br><span class="line"><span class="keyword">exit</span> /b</span><br><span class="line"></span><br><span class="line">&#x27;@); $<span class="number">0</span> = &quot;$env:temp\Skip_TPM_Check_on_Dynamic_Update.<span class="built_in">cmd</span>&quot;; $&#123;(=)||&#125; -split &quot;\r?\n&quot; | out-file $<span class="number">0</span> -encoding default -force; &amp; $<span class="number">0</span></span><br><span class="line"># press enter</span><br></pre></td></tr></table></figure>

<p>インストール再開後、ハードウェア要件のチェックを回避し、次の画面に進むことができるはず。</p>
<p><a href="../../../../public/2024/01/28/4468/008.png"><img src="../../../../public/2024/01/28/4468/008.png" alt="win11upgrade"></a></p>
<p><a href="../../../../public/2024/01/28/4468/009.png"><img src="../../../../public/2024/01/28/4468/009.png" alt="win11upgrade"></a></p>
<p><a href="../../../../public/2024/01/28/4468/010.png"><img src="../../../../public/2024/01/28/4468/010.png" alt="win11upgrade"></a></p>
<p><a href="../../../../public/2024/01/28/4468/011.png"><img src="../../../../public/2024/01/28/4468/011.png" alt="win11upgrade"></a></p>
<p><a href="../../../../public/2024/01/28/4468/012.png"><img src="../../../../public/2024/01/28/4468/012.png" alt="win11upgrade"></a></p>
<p><a href="../../../../public/2024/01/28/4468/013.png"><img src="../../../../public/2024/01/28/4468/013.png" alt="win11upgrade"></a></p>
<p>長い更新を終えて無事に 23H2 に</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-01-28</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Microsoft/Windows/" title="Windows">Windows </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2024/01/28/4468/,A certain engineer &quot;COMPLEX&quot;,開発メモ その360 古いマシンにインストールされた Windows 11 21H2 を 23H2 にアップグレードする,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2024/02/03/4469/" title="開発メモ その361 無線LANの問題を調べる">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2024/01/27/4466/" title="開発メモ その358 MultipartFormDataContent が Unable to write content to request stream; content would exceed Content-Length.">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>