<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><link rel="icon" href="/images/favicon.ico" type="image/x-icon"><title>開発メモ その391 PXE ブートを試してみる · A certain engineer "COMPLEX"</title><meta name="description" content="Introduction以前から試してみたかった PXE ブートを試してみる。これができれば、いちいち iso ファイルや CD/DVD メディアを仮想マシンにアタッチしたりする必要がなくなって便利になる。
How to do?ググると出てくるのは、 dnsmasq を使っての PXE サーバ構築で"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/apps">Apps</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>開発メモ その391 PXE ブートを試してみる</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>以前から試してみたかった PXE ブートを試してみる。<br>これができれば、いちいち iso ファイルや CD/DVD メディアを仮想マシンにアタッチしたりする必要がなくなって便利になる。</p>
<h1 id="How-to-do"><a href="#How-to-do" class="headerlink" title="How to do?"></a>How to do?</h1><p>ググると出てくるのは、 <strong>dnsmasq</strong> を使っての PXE サーバ構築で、よくある事例は dnsmasq で DHCP と TFTP サーバを全て担当してもらう例が多い。<br>だが、自分のネットワーク環境では既に DHCP サーバ (Buffalo のルータ) が存在しており、dnsmasq に DHCP を担当させるのは影響が大きすぎる。<br>また、 dnsmasq を使うとしても、 iso ファイルなどは別に用意してあるファイルサーバを使うことで、dnsmasq をインストールしたサーバは極力軽量にしておきたい。</p>
<p>ということで、こんな我儘な要望を実現するために参考にしたのは下記の記事</p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://manski.net/articles/ubuntu/ubuntu-pxe-server" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=manski.net"></img><div class="hbc-site-name">Manski&#39;s Dev Log</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">PXE Server on Existing Network (DHCP Proxy) with Ubuntu</div><div class="hbc-url">https://manski.net/articles/ubuntu/ubuntu-pxe-server</div><div class="hbc-description">There are a lot of articles out there that explain how to run a PXE server. However, I couldn’t find a single one that contained all the inf…</div></div></div></div></a></div></div>

<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://zappy.hatenablog.jp/entry/2018/05/31/190434" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=zappy.hatenablog.jp"></img><div class="hbc-site-name">Dig that groovy!</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/j/jackson58/20180531/20180531185459.png"></img></div><div class="hbc-text"><div class="hbc-title">既存のDHCPサーバが存在する場合でもPXE Bootをする（dnsmasqを使ったProxy DHCPの設定） - Dig that groovy!</div><div class="hbc-url">https://zappy.hatenablog.jp/entry/2018/05/31/190434</div><div class="hbc-description">はじめに PXE BootをするためにはDHCPサーバにブート情報を設定する必要があるが，Buffalo等の家庭用ルータが設置してあるとこれができない．だからといって別途サブネットを分けたりするのも面倒． そこで，Proxy DHCPという仕組みを使うと，既存のDHCPサーバの設…</div></div></div></div></a></div></div>

<p>これを参考にした上で肝となるのは下記の点。</p>
<ul>
<li>dnsmasq の Proxy DHCP 機能を使い、既存の DHCP に IP のリリースを委譲</li>
<li>TFTP も外部のサーバを使うよう設定</li>
</ul>
<h4 id="01-環境の確認"><a href="#01-環境の確認" class="headerlink" title="01. 環境の確認"></a>01. 環境の確認</h4><p>ネットワーク環境は下記。</p>
<ul>
<li>サブネット: 192.168.11.0/24</li>
<li>PXE サーバ (Alpine Linux 3.20.2): 192.168.11.109</li>
<li>TFTP サーバ (既存のファイルサーバ): 192.168.11.17</li>
<li>DHCP サーバ (既存の Buffalo ルータ): 192.168.11.1</li>
</ul>
<h4 id="02-dnsmasq-のインストール"><a href="#02-dnsmasq-のインストール" class="headerlink" title="02. dnsmasq のインストール"></a>02. dnsmasq のインストール</h4><p>PXE サーバにインストール。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> apk add dnsmasq</span></span><br></pre></td></tr></table></figure>

<p>設定ファイルを作成。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/dnsmasq.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> Disable DNS Server</span></span><br><span class="line">port=0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> logging</span></span><br><span class="line">log-facility=/var/log/dnsmasq/dnsmasq.log</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Enable dhcp <span class="built_in">log</span></span></span><br><span class="line">log-dhcp</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Respond to PXE requests <span class="keyword">for</span> the specified network;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> run as DHCP proxy</span></span><br><span class="line">dhcp-range=192.168.11.1,proxy</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Specify TFPT Server</span></span><br><span class="line">dhcp-boot=pxelinux/pxelinux.0,192.168.11.17</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Provide network boot options</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The known types are x86PC, PC98, IA64_EFI, Alpha, Arc_x86,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Intel_Lean_Client, IA32_EFI, ARM_EFI, BC_EFI, Xscale_EFI and X86-64_EFI</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This option is first and will be the default <span class="keyword">if</span> there is no input from the user.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ex. pxe-service=&lt;<span class="built_in">type</span>&gt;,<span class="string">&quot;&lt;name&gt;&quot;</span>,&lt;path to bootfile&gt;,&lt;tftp server address&gt;</span></span><br><span class="line">pxe-service=x86PC,&quot;Network Boot&quot;,pxelinux/pxelinux,192.168.11.17</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>dnsmasq を自動起動するように設定し、再起動。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir /var/<span class="built_in">log</span>/dnsmasq</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rc-update add dnsmasq boot</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rc-service dnsmasq start</span></span><br></pre></td></tr></table></figure>

<h4 id="03-ブート設定ファイルの作成"><a href="#03-ブート設定ファイルの作成" class="headerlink" title="03. ブート設定ファイルの作成"></a>03. ブート設定ファイルの作成</h4><p>今回は先のブログの記事を参考にして、OS ではなく <strong>memtest86+</strong> を起動するようにする。<br>参考記事では古いバージョン (そもそも記事自体が 8 年前!!) なので、最新の memtest86+ を使うようにした。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">default memtest86</span><br><span class="line">prompt 1</span><br><span class="line">timeout 15</span><br><span class="line"></span><br><span class="line">label memtest86</span><br><span class="line">  menu label Memtest86+ v7.00</span><br><span class="line">  kernel /memtest/v7.00/memtest64</span><br></pre></td></tr></table></figure>

<p>このようなテキストファイルを TFTP サーバの公開ディレクトリから見て <code>pxelinux/pxelinux.cfg/default</code> として保存する。</p>
<h4 id="04-memtest86-の展開"><a href="#04-memtest86-の展開" class="headerlink" title="04. memtest86+ の展開"></a>04. memtest86+ の展開</h4><p><a target="_blank" rel="noopener" href="https://www.memtest.org/download/v7.00/mt86plus_7.00.binaries.zip">memtest86+ v7.00</a> をダウンロード。<br>展開後、<code>memtest64.bin</code> を TFTP サーバの公開ディレクトリから見て <code>pxelinux/memtest/v7.00/memtest64</code> として保存する。<br>注意するのは、必ず拡張子の <strong>.bin</strong> は削除して保存すること。<br>そうしないと正しくブートしない。</p>
<h4 id="05-TFTP-の疎通試験"><a href="#05-TFTP-の疎通試験" class="headerlink" title="05. TFTP の疎通試験"></a>05. TFTP の疎通試験</h4><p>TFTP は WinSCP ではサポートされていないため、手軽に確認したいなら Windows の追加機能で実現できる。</p>
<p><a href="../../../../public/2024/08/24/4500/tftp.png"><img src="../../../../public/2024/08/24/4500/tftp.png" alt="tftp"></a></p>
<p>インストール後、下記のように指定する。</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tftp -i <span class="number">192</span>.<span class="number">168</span>.<span class="number">11</span>.<span class="number">17</span> GET pxelinux/pxelinux.cfg/default</span><br><span class="line">転送を正常に完了しました: <span class="number">1</span> 秒間に <span class="number">124</span> バイト、<span class="number">124</span> バイト/秒</span><br></pre></td></tr></table></figure>

<h4 id="06-linux-のブートイメージを準備"><a href="#06-linux-のブートイメージを準備" class="headerlink" title="06. linux のブートイメージを準備"></a>06. linux のブートイメージを準備</h4><p>linux ならどのディストリビューションでもいい (と思う) ので、 <strong>syslinux</strong> パッケージをインストールし、ブートイメージを取り出す。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> apk add syslinux</span></span><br></pre></td></tr></table></figure>

<p>インストール後、 <code>/usr/share/syslinux</code> 配下の</p>
<ul>
<li>ldlinux.c32</li>
<li>pxelinux.0</li>
</ul>
<p>を TFTP サーバの公開ディレクトリから見て <code>pxelinux</code> の配下に保存する。</p>
<p>現時点で、公開ディレクトリは下記のようになっている筈。</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(公開ディレクトリ)</span><br><span class="line">└─pxelinux</span><br><span class="line">    │  ldlinux.c32</span><br><span class="line">    │  pxelinux.<span class="number">0</span></span><br><span class="line">    │</span><br><span class="line">    ├─memtest</span><br><span class="line">    │  └─v7.<span class="number">00</span></span><br><span class="line">    │          memtest64</span><br><span class="line">    │</span><br><span class="line">    └─pxelinux.cfg</span><br><span class="line">            default</span><br></pre></td></tr></table></figure>

<p>これで準備完了。</p>
<h4 id="07-PXE-ブートしてみる"><a href="#07-PXE-ブートしてみる" class="headerlink" title="07. PXE ブートしてみる"></a>07. PXE ブートしてみる</h4><p>今回は VMware ESXi 上の仮想マシンで確認してみた。<br>設定で UEFI ではなく BIOS で起動するように設定しておくこと。<br>PXE ブートが始まると、PXE サーバ側に要求が飛んできて、ブートに必要な情報が流れてくるのがわかる。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># tail -f &#x2F;var&#x2F;log&#x2F;dnsmasq&#x2F;dnsmasq.log</span><br><span class="line">Aug 24 07:36:21 dnsmasq[3692]: started, version 2.90 DNS disabled</span><br><span class="line">Aug 24 07:36:21 dnsmasq[3692]: compile time options: IPv6 GNU-getopt no-DBus no-UBus no-i18n no-IDN DHCP DHCPv6 no-Lua TFTP no-conntrack ipset no-nftset auth no-cryptohash no-DNSSEC loop-detect inotify dumpfile</span><br><span class="line">Aug 24 07:36:21 dnsmasq-dhcp[3692]: DHCP, proxy on subnet 192.168.11.1</span><br></pre></td></tr></table></figure>

<p>ここで PXE の要求が飛んでくると…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Aug 24 07:36:42 dnsmasq-dhcp[3692]: 717457579 available DHCP subnet: 192.168.11.1&#x2F;255.255.255.0</span><br><span class="line">Aug 24 07:36:42 dnsmasq-dhcp[3692]: 717457579 vendor class: PXEClient:Arch:00000:UNDI:002001</span><br><span class="line">Aug 24 07:36:42 dnsmasq-dhcp[3692]: 717457579 PXE(eth0) 00:0c:29:c3:88:ab proxy</span><br><span class="line">Aug 24 07:36:42 dnsmasq-dhcp[3692]: 717457579 tags: eth0</span><br><span class="line">Aug 24 07:36:42 dnsmasq-dhcp[3692]: 717457579 bootfile name: pxelinux&#x2F;pxelinux.0</span><br><span class="line">Aug 24 07:36:42 dnsmasq-dhcp[3692]: 717457579 broadcast response</span><br><span class="line">Aug 24 07:36:42 dnsmasq-dhcp[3692]: 717457579 sent size:  1 option: 53 message-type  2</span><br><span class="line">Aug 24 07:36:42 dnsmasq-dhcp[3692]: 717457579 sent size:  4 option: 54 server-identifier  192.168.11.109</span><br><span class="line">Aug 24 07:36:42 dnsmasq-dhcp[3692]: 717457579 sent size:  9 option: 60 vendor-class  50:58:45:43:6c:69:65:6e:74</span><br><span class="line">Aug 24 07:36:42 dnsmasq-dhcp[3692]: 717457579 sent size: 17 option: 97 client-machine-id  00:56:4d:38:7e:28:50:3a:f2:7f:cc:38:dc:5a...</span><br><span class="line">Aug 24 07:36:42 dnsmasq-dhcp[3692]: 717457579 sent size: 36 option: 43 vendor-encap  06:01:03:0a:04:00:50:58:45:08:07:80:00:01...</span><br><span class="line">Aug 24 07:36:44 dnsmasq-dhcp[3692]: 717457579 available DHCP subnet: 192.168.11.1&#x2F;255.255.255.0</span><br><span class="line">Aug 24 07:36:44 dnsmasq-dhcp[3692]: 717457579 vendor class: PXEClient:Arch:00000:UNDI:002001</span><br><span class="line">Aug 24 07:36:45 dnsmasq-dhcp[3692]: 717457579 available DHCP subnet: 192.168.11.1&#x2F;255.255.255.0</span><br><span class="line">Aug 24 07:36:45 dnsmasq-dhcp[3692]: 717457579 vendor class: PXEClient:Arch:00000:UNDI:002001</span><br><span class="line">Aug 24 07:36:45 dnsmasq-dhcp[3692]: 717457579 PXE(eth0) 192.168.11.54 00:0c:29:c3:88:ab pxelinux&#x2F;pxelinux.0</span><br><span class="line">Aug 24 07:36:45 dnsmasq-dhcp[3692]: 717457579 tags: eth0</span><br><span class="line">Aug 24 07:36:45 dnsmasq-dhcp[3692]: 717457579 bootfile name: pxelinux&#x2F;pxelinux.0</span><br><span class="line">Aug 24 07:36:45 dnsmasq-dhcp[3692]: 717457579 next server: 192.168.11.17</span><br><span class="line">Aug 24 07:36:45 dnsmasq-dhcp[3692]: 717457579 sent size:  1 option: 53 message-type  5</span><br><span class="line">Aug 24 07:36:45 dnsmasq-dhcp[3692]: 717457579 sent size:  4 option: 54 server-identifier  192.168.11.109</span><br><span class="line">Aug 24 07:36:45 dnsmasq-dhcp[3692]: 717457579 sent size:  9 option: 60 vendor-class  50:58:45:43:6c:69:65:6e:74</span><br><span class="line">Aug 24 07:36:45 dnsmasq-dhcp[3692]: 717457579 sent size: 17 option: 97 client-machine-id  00:56:4d:38:7e:28:50:3a:f2:7f:cc:38:dc:5a...</span><br><span class="line">Aug 24 07:36:45 dnsmasq-dhcp[3692]: 717457579 sent size:  7 option: 43 vendor-encap  47:04:80:00:00:00:ff</span><br></pre></td></tr></table></figure>

<p>確かに、既存の DHCP サーバとやり取りして IP をリースしたり、ブートファイルの情報を送っているのがわかる。</p>
<p>実際、正しく memtest86+ が起動した。</p>
<p><a href="../../../../public/2024/08/24/4500/memtest.gif"><img src="../../../../public/2024/08/24/4500/memtest.gif" alt="tftp"></a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-08-24</span><i class="fa fa-tag"></i><a class="tag" href="/categories/PXE/" title="PXE">PXE </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2024/08/24/4500/,A certain engineer &quot;COMPLEX&quot;,開発メモ その391 PXE ブートを試してみる,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2024/08/24/4499/" title="開発メモ その390 Alpine Linux に GUI をつける">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>