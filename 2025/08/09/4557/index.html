<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><link rel="icon" href="/images/favicon.ico" type="image/x-icon"><title>開発メモ その452 Debian に cloudflared をインストールして LAN 内のサーバーに外部からアクセスできるようにする · A certain engineer "COMPLEX"</title><meta name="description" content="Introduction固定 IP を取得しようと思ったら ISP が固定 IP サービスを数年前に廃止していたので困っていたところ、 cloudflared を使えば自宅サーバを公開できるらしい、とのことで試してみた。ドメインの取得は必要だが、格安ドメインで対処。GitLab、Snipe-IT が"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/apps">Apps</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>開発メモ その452 Debian に cloudflared をインストールして LAN 内のサーバーに外部からアクセスできるようにする</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>固定 IP を取得しようと思ったら ISP が固定 IP サービスを数年前に廃止していたので困っていたところ、 <strong>cloudflared</strong> を使えば自宅サーバを公開できるらしい、とのことで試してみた。<br>ドメインの取得は必要だが、格安ドメインで対処。<br>GitLab、Snipe-IT があるので nginx をリバースプロキシにして公開。</p>
<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>環境は</p>
<ul>
<li>OS: Debian: 12</li>
<li>nginx: 1,22</li>
<li>ドメイン: xxxxxx.com</li>
</ul>
<h3 id="1-Nginx-のインストール"><a href="#1-Nginx-のインストール" class="headerlink" title="1. Nginx のインストール"></a>1. Nginx のインストール</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install -y nginx</span><br></pre></td></tr></table></figure>

<h3 id="2-etc-hosts-の編集"><a href="#2-etc-hosts-の編集" class="headerlink" title="2. /etc/hosts の編集"></a>2. /etc/hosts の編集</h3><p>DNS が諸事情で動いていないので名前解決は手動</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.11.107 snipeit.xxxxxx.local</span><br><span class="line">192.168.11.108 gitlab.xxxxxx.local</span><br></pre></td></tr></table></figure>

<h3 id="3-nginx-の設定"><a href="#3-nginx-の設定" class="headerlink" title="3. nginx の設定"></a>3. nginx の設定</h3><p>リバースプロキシとして使用するための設定を実施。<br><code>/etc/nginx/sites-available/lan-proxy.conf</code> を作成していく。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">map $http_upgrade $connection_upgrade &#123; default upgrade; &#x27;&#x27; close; &#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">127.0.0.1:8081</span>;</span><br><span class="line">    <span class="attribute">server_name</span> snipeit.xxxxxx.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> https://192.168.11.107:443;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> ~^https://snipeit\.xxxxxx\.local(/.*)?$ https://snipeit.xxxxxx.com<span class="variable">$1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host snipeit.xxxxxx.local;</span><br><span class="line">        <span class="attribute">proxy_ssl_name</span> snipeit.xxxxxx.local;</span><br><span class="line">        <span class="attribute">proxy_ssl_server_name</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">proxy_ssl_verify</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_ssl_protocols</span> TLSv1.<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For  <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto https;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP        <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_read_timeout</span> <span class="number">300s</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">keepalive_timeout</span> <span class="number">65s</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Accept-Encoding <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">sub_filter_once</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">sub_filter_types</span> text/html</span><br><span class="line">                         text/css</span><br><span class="line">                         application/javascript</span><br><span class="line">                         application/json</span><br><span class="line">                         text/plain</span><br><span class="line">                         application/xml;</span><br><span class="line">        <span class="attribute">sub_filter</span> https://snipeit.xxxxxx.local https://snipeit.xxxxxx.com;</span><br><span class="line">        <span class="attribute">sub_filter</span> //snipeit.xxxxxx.local //snipeit.xxxxxx.com;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">127.0.0.1:8082</span>;</span><br><span class="line">    <span class="attribute">server_name</span> gitlab.xxxxxx.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> https://192.168.11.108:443;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> ~^https://gitlab\.xxxxxx\.local(/.*)?$ https://gitlab.xxxxxx.com<span class="variable">$1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host gitlab.xxxxxx.local;</span><br><span class="line">        <span class="attribute">proxy_ssl_name</span> gitlab.xxxxxx.local;</span><br><span class="line">        <span class="attribute">proxy_ssl_server_name</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">proxy_ssl_verify</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_ssl_protocols</span> TLSv1.<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For  <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto https;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP        <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_read_timeout</span> <span class="number">300s</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">keepalive_timeout</span> <span class="number">65s</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Accept-Encoding <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">sub_filter_once</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">sub_filter_types</span> text/html</span><br><span class="line">                         text/css</span><br><span class="line">                         application/javascript</span><br><span class="line">                         application/json</span><br><span class="line">                         text/plain</span><br><span class="line">                         application/xml;</span><br><span class="line">        <span class="attribute">sub_filter</span> https://gitlab.xxxxxx.local https://gitlab.xxxxxx.com;</span><br><span class="line">        <span class="attribute">sub_filter</span> //gitlab.xxxxxx.local //gitlab.xxxxxx.com;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>設定</th>
<th>概要</th>
</tr>
</thead>
<tbody><tr>
<td>proxy_pass</td>
<td>転送する先の url</td>
</tr>
<tr>
<td>proxy_redirect</td>
<td>プロキシ先のサーバが nginx に返すレスポンスのLocation, Refreshヘッダの書き換えルール</td>
</tr>
<tr>
<td>subsub_filter_types_filter</td>
<td>リクエストを書き換える対象。デフォルトは <code>text/html</code></td>
</tr>
<tr>
<td>sub_filter</td>
<td>リクエストに含まれる文字を書き換える正規表現ルール</td>
</tr>
<tr>
<td>proxy_ssl_verify</td>
<td>転送先のサーバの証明書を検証するか。自己署名証明書が配置されているが面倒なので off</td>
</tr>
</tbody></table>
<p>リンク先の url が古い url のままだったりしたので、 <code>sub_filter</code> を使って書き換えることで対処。</p>
<p>設定後は下記で nginx に反映して起動。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># デフォルト設定のシンボリックリンクを削除</span></span><br><span class="line">$ rm /etc/nginx/sites-enabled/default</span><br><span class="line">$ ln -s /etc/nginx/sites-available/lan-proxy.conf /etc/nginx/sites-enabled/</span><br><span class="line"><span class="comment"># 構文チェック</span></span><br><span class="line">$ /usr/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line">$ systemctl reload nginx</span><br></pre></td></tr></table></figure>

<h3 id="4-cloudflared-をインストール"><a href="#4-cloudflared-をインストール" class="headerlink" title="4. cloudflared をインストール"></a>4. cloudflared をインストール</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl -LO https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb</span><br><span class="line">$ apt install ./cloudflared-linux-amd64.deb &amp;&amp; rm ./cloudflared-linux-amd64.deb</span><br><span class="line">$ cloudflared --version</span><br><span class="line">cloudflared version 2025.8.0 (built 2025-08-08-1545 UTC)</span><br></pre></td></tr></table></figure>

<p>Cloudflare のアカウントにログインし、認証情報を配置。<br>url をコピーして任意の端末上のブラウザから認証すれば OK。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cloudflared tunnel login</span><br><span class="line">Please open the following URL and <span class="built_in">log</span> <span class="keyword">in</span> with your Cloudflare account:</span><br><span class="line"></span><br><span class="line">https://dash.cloudflare.com/argotunnel?aud=&amp;callback=https%3A%2F%2Flogin.cloudflareaccess.org%2FyvsCJ9NAdeij4RRREdnz3pNNx5QPdxX6zyeYfauDc8Nf%3D</span><br><span class="line"></span><br><span class="line">Leave cloudflared running to download the cert automatically.</span><br><span class="line">2025-08-09T08:42:18Z INF Waiting <span class="keyword">for</span> login...</span><br><span class="line">2025-08-09T08:43:02Z INF You have successfully logged <span class="keyword">in</span>.</span><br><span class="line">If you wish to copy your credentials to a server, they have been saved to:</span><br><span class="line">/root/.cloudflared/cert.pem</span><br></pre></td></tr></table></figure>

<p>続いてトンネルを作成。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cloudflared tunnel create mytunnel</span><br><span class="line">Tunnel credentials written to /root/.cloudflared/713ba16e-21ed-4b21-a2d0-c7afad85f728.json. cloudflared chose this file based on <span class="built_in">where</span> your origin certificate was found. Keep this file secret. To revoke these credentials, delete the tunnel.</span><br><span class="line"></span><br><span class="line">Created tunnel mytunnel with id 713ba16e-21ed-4b21-a2d0-c7afad85f728</span><br></pre></td></tr></table></figure>

<p>次にトンネルの設定ファイルを作成。</p>
<p><code>/etc/cloudflared/config.yml</code> を編集。<br>最後の <code>- service: http_status:404</code> は必須なので注意。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tunnel:</span> <span class="string">mytunnel</span></span><br><span class="line"><span class="attr">credentials-file:</span> <span class="string">/root/.cloudflared/713ba16e-21ed-4b21-a2d0-c7afad85f728.json</span></span><br><span class="line"><span class="comment"># 高負荷時は並列数を追加</span></span><br><span class="line"><span class="comment"># connections: 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># それぞれの FQDN を nginx のローカル待受にバインド</span></span><br><span class="line"><span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostname:</span> <span class="string">snipeit.xxxxxx.com</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">http://127.0.0.1:8081</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostname:</span> <span class="string">gitlab.xxxxxx.com</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">http://127.0.0.1:8082</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">http_status:404</span></span><br></pre></td></tr></table></figure>

<p>作成した設定ファイルを検証。<br><code>- service: http_status:404</code> がないとエラーになります (戒め)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cloudflared tunnel ingress validate /etc/cloudflared/config.yml</span><br><span class="line">Validating rules from /etc/cloudflared/config.yml</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>サブドメインとトンネルのルーティングを実施。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cloudflared tunnel route dns mytunnel snipeit.xxxxxx.com</span><br><span class="line">2025-08-09T09:07:17Z INF Added CNAME snipeit.xxxxxx.com <span class="built_in">which</span> will route to this tunnel tunnelID=713ba16e-21ed-4b21-a2d0-c7afad85f728</span><br><span class="line">$ cloudflared tunnel route dns mytunnel gitlab.xxxxxx.com</span><br><span class="line">2025-08-09T09:07:29Z INF Added CNAME gitlab.xxxxxx.com <span class="built_in">which</span> will route to this tunnel tunnelID=713ba16e-21ed-4b21-a2d0-c7afad85f728</span><br></pre></td></tr></table></figure>

<p>次に <code>cloudflared</code> を自動起動するように設定。<br>何故か <code>systemctl enable --now cloudflared</code> がエラーになったので、手動で unit ファイルを作成。<br><code>/etc/systemd/system/cloudflared.service</code> を編集。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;cloudflared tunnel</span><br><span class="line">After&#x3D;network-online.target</span><br><span class="line">Wants&#x3D;network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User&#x3D;nobody</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;cloudflared --no-autoupdate --config &#x2F;etc&#x2F;cloudflared&#x2F;config.yml tunnel run</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">RestartSec&#x3D;5s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>

<p>後は念のため <code>cloudflared</code> を再起動。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart cloudflared</span><br></pre></td></tr></table></figure>

<h3 id="5-ファイアウォール設定"><a href="#5-ファイアウォール設定" class="headerlink" title="5. ファイアウォール設定"></a>5. ファイアウォール設定</h3><p>別にサーバを直接公開しているわけでもないが、 <code>cloudflared</code> が動いているサーバのファイアーウォールを強化しておく。<br>管理は必要なので SSH 以外は拒否。<br><code>cloudflared</code> はアウトバウンドを使ってトンネルをしているので、SSH 以外のインバウンドは拒否しても問題なし。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ apt install ufw -y</span><br><span class="line">$ ufw default deny incoming</span><br><span class="line">$ ufw default allow outgoing</span><br><span class="line">$ ufw allow 22/tcp</span><br><span class="line">$ ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2025-08-09</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Cloudflare/" title="Cloudflare">Cloudflare </a><a class="tag" href="/categories/Cloudflare/cloudflared/" title="cloudflared">cloudflared </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2025/08/09/4557/,A certain engineer &quot;COMPLEX&quot;,開発メモ その452 Debian に cloudflared をインストールして LAN 内のサーバーに外部からアクセスできるようにする,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2025/08/09/4558/" title="開発メモ その453 Alpine に dnsmasq をインストールしてローカル用の DNS サーバを作る">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2025/08/03/4556/" title="開発メモ その451 Snipe-IT を SSL 化する">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>