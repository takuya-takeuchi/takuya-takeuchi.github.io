<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>開発メモ その171 ChainerのモデルデータをONNXに変換してみる · A certain engineer "COMPLEX"</title><meta name="description" content="IntroductionChainerはPythonで動きます。 学習はPythonで良くてもシステムに組み込む際にPythonは聊か都合が悪いです。 なので、学習結果であるモデルファイルをPython以外の言語で扱えるように、共通データフォーマットである**ONNX (Open Neural Ne"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li><li><a href="/guestbook">メッセージ</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>開発メモ その171 ChainerのモデルデータをONNXに変換してみる</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p><strong>Chainer</strong>はPythonで動きます。 学習はPythonで良くてもシステムに組み込む際にPythonは聊か都合が悪いです。 なので、学習結果であるモデルファイルをPython以外の言語で扱えるように、共通データフォーマットである**ONNX (Open Neural Network Exchange)**に変換してみます。</p>
<h1 id="How-to"><a href="#How-to" class="headerlink" title="How to"></a>How to</h1><p>シンプルなMNISTのサンプルで生成されるモデルファイルを変換してみます。 まずはChainerの環境を構築。Windows上の仮想環境を想定。</p>
<h2 id="環境構築"><a href="#環境構築" class="headerlink" title="環境構築"></a>環境構築</h2>

<p>を参考にし、下記のコマンドを実行します。 [code lang=”dos”] &gt; python -m pip install –upgrade pip &gt; python -m pip install cupy==5.3.0 &gt; python -m pip install cupy-cuda92==5.3.0 &gt; python -m pip install chainer==5.3.0 &gt; python -m pip install onnx-chainer [/code] インストール後はCUDAを認識しているかを確認します。 [code lang=”dos”] &gt; python -c “import chainer; chainer.print_runtime_info()” Platform: Windows-10-10.0.17763-SP0 Chainer: 5.3.0 NumPy: 1.16.2 CuPy: CuPy Version : 5.3.0 CUDA Root : C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v9.2 CUDA Build Version : 9020 CUDA Driver Version : 10000 CUDA Runtime Version : 9020 cuDNN Build Version : 7402 cuDNN Version : 7402 NCCL Build Version : None NCCL Runtime Version : None iDeep: Not Available [/code]</p>
<h2 id="学習と変換"><a href="#学習と変換" class="headerlink" title="学習と変換"></a>学習と変換</h2><p>ソースをクローンし、<strong>train_mnist.py</strong>を修正します。 [code lang=”dos”] &gt; git clone <a target="_blank" rel="noopener" href="https://github.com/chainer/chainer">https://github.com/chainer/chainer</a> &gt; cd chainer &gt; git checkout v5.3.0 &gt; cd examples\mnist [/code] 修正前はモデルファイルを出力しないためです。 修正は下記2箇所。</p>
<h4 id="箇所1"><a href="#箇所1" class="headerlink" title="箇所1"></a>箇所1</h4><p>[code lang=”diff”] #!/usr/bin/env python import argparse<br>import chainer import chainer.functions as F import chainer.links as L from chainer import training from chainer.training import extensions<br>+ import os + from chainer import serializers + import onnx_chainer + import cupy as xp [/code]</p>
<h4 id="箇所2"><a href="#箇所2" class="headerlink" title="箇所2"></a>箇所2</h4><p>[code lang=”diff”] if args.resume: # Resume from a snapshot chainer.serializers.load_npz(args.resume, trainer)<br># Run the training trainer.run()<br>+ model_file = os.path.join(args.out, ‘mnist.model’) + onnx_file = os.path.join(args.out, ‘mnist.onnx’) + serializers.save_npz(model_file, model) + chainer.config.train = False + # ダミーデータ + x = xp.zeros((1, 1, 28, 28), dtype=xp.float32) + onnx_chainer.export(model.predictor, x, filename=onnx_file)<br>if __name__ == ‘__main__‘: main() [/code] 下記を実行します。 [code lang=”dos”] &gt; python train_mnist.py –gpu 0 GPU: 0 # unit: 1000 # Minibatch-size: 100 # epoch: 20<br>Downloading from <a target="_blank" rel="noopener" href="http://yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz">http://yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz</a>… Downloading from <a target="_blank" rel="noopener" href="http://yann.lecun.com/exdb/mnist/train-labels-idx1-ubyte.gz">http://yann.lecun.com/exdb/mnist/train-labels-idx1-ubyte.gz</a>… Downloading from <a target="_blank" rel="noopener" href="http://yann.lecun.com/exdb/mnist/t10k-images-idx3-ubyte.gz">http://yann.lecun.com/exdb/mnist/t10k-images-idx3-ubyte.gz</a>… Downloading from <a target="_blank" rel="noopener" href="http://yann.lecun.com/exdb/mnist/t10k-labels-idx1-ubyte.gz">http://yann.lecun.com/exdb/mnist/t10k-labels-idx1-ubyte.gz</a>… D:\Works\Python\envs\Chainer_5.3.0\lib\site-packages\chainer\training\extensions\plot_report.py:25: UserWarning: matplotlib is not installed on your environment, so nothing will be plotted at this time. Please install matplotlib to plot figures.<br>$ pip install matplotlib<br>warnings.warn(‘matplotlib is not installed on your environment, ‘ epoch main/loss validation/main/loss main/accuracy validation/main/accuracy elapsed_time 1 0.189437 0.0972368 0.94235 0.9701 8.70826 2 0.0736203 0.0654 0.977182 0.9789 11.5016 3 0.0483072 0.0657967 0.984433 0.9786 13.9685 4 0.0344889 0.0775722 0.988614 0.9779 16.4064 5 0.0307565 0.073484 0.990132 0.9808 18.8182 6 0.0247791 0.0676734 0.991932 0.981 21.2477 7 0.0187978 0.0756141 0.993648 0.9822 23.7888 8 0.0151227 0.0729054 0.994965 0.9836 26.2349 9 0.0162507 0.09349 0.994649 0.9805 28.6772 10 0.0186082 0.07771 0.994565 0.983 31.1291 11 0.0121478 0.0878187 0.996282 0.9829 33.575 12 0.0139532 0.103692 0.995515 0.9803 36.1334 13 0.0128902 0.0869704 0.996015 0.9812 38.5139 14 0.00887171 0.0960986 0.997182 0.9807 40.966 15 0.00950978 0.0941747 0.997016 0.9835 43.492 16 0.0117687 0.112775 0.996632 0.9805 45.8972 17 0.012322 0.109815 0.996782 0.9803 48.2932 18 0.00880352 0.10031 0.997383 0.9818 50.731 19 0.00929279 0.118552 0.997365 0.979 53.3326 20 0.00607901 0.0849677 0.99825 0.9852 55.8271 [/code] 学習の結果、<strong>result\mnist.model</strong>と<strong>result\mnist.onnx</strong>が出力されています。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-04-02</span><i class="fa fa-tag"></i><a class="tag" href="/categories/e3-83-87-e3-82-a3-e3-83-bc-e3-83-97-e3-83-a9-e3-83-bc-e3-83-8b-e3-83-b3-e3-82-b0/" title="%e3%83%87%e3%82%a3%e3%83%bc%e3%83%97%e3%83%a9%e3%83%bc%e3%83%8b%e3%83%b3%e3%82%b0">%e3%83%87%e3%82%a3%e3%83%bc%e3%83%97%e3%83%a9%e3%83%bc%e3%83%8b%e3%83%b3%e3%82%b0 </a><a class="tag" href="/categories/e3-83-87-e3-82-a3-e3-83-bc-e3-83-97-e3-83-a9-e3-83-bc-e3-83-8b-e3-83-b3-e3-82-b0/Chainer/" title="Chainer">Chainer </a><a class="tag" href="/categories/ディープラーニング/" title="ディープラーニング">ディープラーニング </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2019/04/02/4024/,A certain engineer &quot;COMPLEX&quot;,開発メモ その171 ChainerのモデルデータをONNXに変換してみる,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/05/20/4042/" title="開発メモ その172 Synology GitLabでLFSを使ってみる">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/04/02/4014/" title="開発メモ その170 M2DetをUbuntu18.04で使ってみる(学習編)">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script></body></html>