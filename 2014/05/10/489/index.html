<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>BitNami Redmine Stack のアップデート 2.3.0-0 to 2.5.1-1 · A certain engineer "COMPLEX"</title><meta name="description" content="久しぶりにBitNami Redmine Stackを更新しました。が、今回はいつも以上に更新に手間取りました。

基本のアップデート手順は前回 (2.0.3-1 to 2.1.0-0)と同じですが、**(8)** の手順は実行しないでください。つまり (7) まで実行した段階で、次からの手順を実行"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>BitNami Redmine Stack のアップデート 2.3.0-0 to 2.5.1-1</a></h3></div><div class="post-content"><p>久しぶりに<strong>BitNami Redmine Stack</strong>を更新しました。<br>が、今回はいつも以上に更新に手間取りました。</p>
<a id="more"></a>
<p>基本のアップデート手順は<a target="_blank" rel="noopener" href="https://taktak.jp/2012/09/21/280">前回 (2.0.3-1 to 2.1.0-0)</a>と同じですが、**(8)** の手順は実行しないでください。<br>つまり (7) まで実行した段階で、次からの手順を実行します。</p>
<h3 id="1-プラグインの退避"><a href="#1-プラグインの退避" class="headerlink" title="(1) プラグインの退避"></a>(1) プラグインの退避</h3><p><strong>&lt;InstallDir&gt;\apps\redmine\htdocs\plugins</strong> (InstallDirはBitNami Redmine Stackのインストール先) から、プラグインを一度全部別のフォルダに移動します。<br>私の場合は、</p>
<ul>
<li>redmine_logs</li>
<li>redmine_comment_only</li>
<li>redmine_knowledgebase</li>
</ul>
<p>でした。</p>
<h3 id="2-データベースのマイグレーション"><a href="#2-データベースのマイグレーション" class="headerlink" title="(2) データベースのマイグレーション"></a>(2) データベースのマイグレーション</h3><p>データベースの更新を実行。<strong>スタートメニュー</strong>-&gt;<strong>BitNami Redmine Stack</strong>-&gt;<strong>Use BitNami Redmine Stack</strong> でコマンドプロンプトを起動。<br>以下のコマンドを順次実行 (カレントディレクトリは私の環境です)。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">BitNami</span>\<span class="title">Redmine</span>&gt;<span class="title">cd</span> <span class="title">apps</span>\<span class="title">redmine</span>\<span class="title">htdocs</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">BitNami</span>\<span class="title">Redmine</span>\<span class="title">apps</span>\<span class="title">redmine</span>\<span class="title">htdocs</span>&gt;<span class="title">rake</span> <span class="title">db:migrate</span> <span class="title">RAILS_ENV</span>=&quot;<span class="title">production</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>すると、</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">BitNami</span>\<span class="title">Redmine</span>\<span class="title">apps</span>\<span class="title">redmine</span>\<span class="title">htdocs</span>&gt;<span class="title">bundle</span> <span class="title">exec</span> <span class="title">rake</span> <span class="title">db:migrate</span> <span class="title">RAILS_ENV</span>=&quot;<span class="title">pr</span></span></span><br><span class="line"><span class="function"><span class="title">oduction</span>&quot;</span></span><br><span class="line"><span class="function"><span class="title">rake</span> <span class="title">aborted</span>!</span></span><br><span class="line"><span class="function"><span class="title">An</span> <span class="title">error</span> <span class="title">has</span> <span class="title">occurred</span>, <span class="title">all</span> <span class="title">later</span> <span class="title">migrations</span> <span class="title">canceled</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Mysql2</span>::<span class="title">Error</span>: <span class="title">Table</span> &#x27;<span class="title">queries_roles</span>&#x27; <span class="title">already</span> <span class="title">exists</span>: <span class="title">CREATE</span> <span class="title">TABLE</span> `<span class="title">queries_roles</span></span></span><br><span class="line"><span class="function">` (`<span class="title">query_id</span>` <span class="title">int</span>(11) <span class="title">NOT</span> <span class="title">NULL</span>, `<span class="title">role_id</span>` <span class="title">int</span>(11) <span class="title">NOT</span> <span class="title">NULL</span>) <span class="title">ENGINE</span>=<span class="title">InnoDBC</span>:/<span class="title">BitN</span></span></span><br><span class="line"><span class="function"><span class="title">ami</span>/<span class="title">Redmine</span>/<span class="title">apps</span>/<span class="title">redmine</span>/<span class="title">htdocs</span>/<span class="title">vendor</span>/<span class="title">bundle</span>/<span class="title">ruby</span>/1.9.1/<span class="title">gems</span>/<span class="title">activerecord</span>-3.2.1</span></span><br><span class="line"><span class="function">7/<span class="title">lib</span>/<span class="title">active_record</span>/<span class="title">connection_adapters</span>/<span class="title">abstract_mysql_adapter.rb</span>:245:<span class="title">in</span> `<span class="title">query</span>&#x27;</span></span><br></pre></td></tr></table></figure>

<p>のようなエラーが出ました。<br>どうも<strong>queries_roles</strong>が既に存在しているとのことなので、このテーブルを削除します。<br><strong>※削除前にこのテーブルを削除していいかは確認してください</strong></p>
<p>まず<strong>mysql</strong>に接続します。<br>データベースのパスワードは <strong>&lt;InstallDir&gt;\apps\redmine\htdocs\config\database.yml</strong> に書かれています。<br>引き続きコマンドプロンプトに下記のように入力します。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -u bitnami -p bitnami_redmine</span><br><span class="line">Enter password: (ここはdatabase.ymlに記述されているパスワードを入力)</span><br><span class="line">drop table queries_roles;</span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure>

<p>これで<strong>queries_roles</strong>が削除されます。<br>もう一度マイグレーションを試みますが、今度は、</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">BitNami</span>\<span class="title">Redmine</span>\<span class="title">apps</span>\<span class="title">redmine</span>\<span class="title">htdocs</span>&gt;<span class="title">bundle</span> <span class="title">exec</span> <span class="title">rake</span> <span class="title">db:migrate</span> <span class="title">RAILS_ENV</span>=&quot;<span class="title">pr</span></span></span><br><span class="line"><span class="function"><span class="title">oduction</span>&quot;</span></span><br><span class="line"><span class="function">==  <span class="title">CreateCustomFieldsRoles</span>: <span class="title">migrating</span> ========================================</span></span><br><span class="line"><span class="function">-- <span class="title">create_table</span>(:<span class="title">custom_fields_roles</span>, &#123;:<span class="title">id</span>=&gt;<span class="title">false</span>&#125;)</span></span><br><span class="line"><span class="function"><span class="title">rake</span> <span class="title">aborted</span>!</span></span><br><span class="line"><span class="function"><span class="title">An</span> <span class="title">error</span> <span class="title">has</span> <span class="title">occurred</span>, <span class="title">all</span> <span class="title">later</span> <span class="title">migrations</span> <span class="title">canceled</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Mysql2</span>::<span class="title">Error</span>: <span class="title">Table</span> &#x27;<span class="title">custom_fields_roles</span>&#x27; <span class="title">already</span> <span class="title">exists</span>: <span class="title">CREATE</span> <span class="title">TABLE</span> `<span class="title">custom_</span></span></span><br><span class="line"><span class="function"><span class="title">fields_roles</span>` (`<span class="title">custom_field_id</span>` <span class="title">int</span>(11) <span class="title">NOT</span> <span class="title">NULL</span>, `<span class="title">role_id</span>` <span class="title">int</span>(11) <span class="title">NOT</span> <span class="title">NULL</span>) <span class="title">E</span></span></span><br><span class="line"><span class="function"><span class="title">NGINE</span>=<span class="title">InnoDBC</span>:/<span class="title">BitNami</span>/<span class="title">Redmine</span>/<span class="title">apps</span>/<span class="title">redmine</span>/<span class="title">htdocs</span>/<span class="title">vendor</span>/<span class="title">bundle</span>/<span class="title">ruby</span>/1.9.1/<span class="title">gems</span></span></span><br><span class="line"><span class="function">/<span class="title">activerecord</span>-3.2.17/<span class="title">lib</span>/<span class="title">active_record</span>/<span class="title">connection_adapters</span>/<span class="title">abstract_mysql_adapte</span></span></span><br><span class="line"><span class="function"><span class="title">r.rb</span>:245:<span class="title">in</span> `<span class="title">query</span>&#x27;</span></span><br></pre></td></tr></table></figure>

<p>と表示され、同じように<strong>custom_fields_roles</strong>が既に存在しているとのことなので、下記のコマンドでこのテーブルを削除します。<br><strong>※削除前にこのテーブルを削除していいかは確認してください</strong></p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -u bitnami -p bitnami_redmine</span><br><span class="line">Enter password: (ここはdatabase.ymlに記述されているパスワードを入力)</span><br><span class="line">drop table custom_fields_roles;</span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure>

<p>その後、マイグレーションを実行すると成功します。</p>
<h3 id="3-プラグインのマイグレーション-その1"><a href="#3-プラグインのマイグレーション-その1" class="headerlink" title="(3) プラグインのマイグレーション その1"></a>(3) プラグインのマイグレーション その1</h3><p>退避したプラグインを <strong>&lt;InstallDir&gt;\apps\redmine\htdocs\plugins</strong> に戻します。<br>ただし、<strong>redmine_knowledgebase</strong>は削除します。<br><strong>※redmine_knowledgebaseを使っていない人は何もしません</strong></p>
<p>戻した後下記のコマンドでプラグインのマイグレーションを実施します。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bundle install</span><br><span class="line">bundle exec rake redmine:plugins:migrate RAILS_ENV=production</span><br><span class="line">bundle exec rake tmp:cache:clear</span><br><span class="line">bundle exec rake tmp:sessions:clear</span><br></pre></td></tr></table></figure>

<p>成功したら、<strong>redmine manager tool</strong> から全てのサービス再起動。<br>その後、redmineにログインしてエラーが無いことを確認したら、2.5.1-1への更新が完了します。</p>
<h3 id="4-プラグインのマイグレーション-その2"><a href="#4-プラグインのマイグレーション-その2" class="headerlink" title="(4) プラグインのマイグレーション その2"></a>(4) プラグインのマイグレーション その2</h3><p><strong>redmine_knowledgebase</strong>を使っている方はこの作業が必須になります。<br>まず、最新のredmine_knowledgebaseを入手します (2014/05/10時点で3.0.4が最新)。<br>下記のコマンドを入力します。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">BitNami</span>\<span class="title">Redmine</span>&gt;<span class="title">cd</span> <span class="title">apps</span>\<span class="title">redmine</span>\<span class="title">htdocs</span>\<span class="title">plugins</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">BitNami</span>\<span class="title">Redmine</span>&gt;<span class="title">cd</span> <span class="title">apps</span>\<span class="title">redmine</span>\<span class="title">htdocs</span>\<span class="title">plugins</span>&gt;<span class="title">git</span> <span class="title">clone</span> <span class="title">git</span>://<span class="title">github.com</span>/<span class="title">alexbevi</span>/<span class="title">redmine_knowledgebase.git</span> <span class="title">redmine_knowledgebase</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">BitNami</span>\<span class="title">Redmine</span>&gt;<span class="title">cd</span> <span class="title">apps</span>\<span class="title">redmine</span>\<span class="title">htdocs</span>\<span class="title">plugins</span>&gt;<span class="title">bundle</span> <span class="title">install</span> --<span class="title">no</span>-<span class="title">deployment</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">BitNami</span>\<span class="title">Redmine</span>&gt;<span class="title">cd</span> <span class="title">apps</span>\<span class="title">redmine</span>\<span class="title">htdocs</span>\<span class="title">plugins</span>&gt;<span class="title">bundle</span> <span class="title">exec</span> <span class="title">rake</span> <span class="title">redmine:plugins</span>:<span class="title">migrate</span> <span class="title">RAILS_ENV</span>=<span class="title">production</span></span></span><br></pre></td></tr></table></figure>

<p>これでエラー無く更新が完了します。<br>前項と同じくサービスを再起動してログインします。</p>
<p>そこでおかしな事に気づきます。</p>
<p><a href="../../../../public/2014/05/redmine.png"><img src="../../../../public/2014/05/redmine-300x199.png"></a></p>
<p>上部のメニューに<strong>知識DB</strong>の項目がありません。<br>代わりにプロジェクトのメニューに<strong>ナレッジベース</strong>の文字が追加されています。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alexbevi/redmine_knowledgebase">公式サイト</a>によると、redmine_knowledgebaseの仕様が変わったようです。</p>
<blockquote>
<p>Upon restarting Redmine, the Knowledgebase entry will no longer appear as a :top_menu entry. The knowledgebase is now project-specific, and therefore must be included in at least one project to work properly. If you wish to use it like v2.x, you can make a public project that will only be used to store knowledgebase articles. You will need to go into your database now and change the kb_articles and kb_categories project_id to the project id of the knowledgebase project you just created.</p>
</blockquote>
<p>と記載があります。<br>これは</p>
<blockquote>
<p>Redmineを再起動するにあたり、Knowledgebaseの項目がトップメニューの項目に表示されないでしょう。<br>Knowledgebaseの現在のプロジェクトの仕様により、最低1つの正常に動作しているプロジェクトに含めなくてはなりません。もし、2.X系 (恐らくredmine_knowledgebaseのバージョン)のように使用した場合、記事を保存するためだけのパブリックなプロジェクトを作成します。<br>kb_articlesとkb_categories内のproject_id列を、作成したプロジェクト (記事を格納するために作成したもの)のproject_idに変更する必要があります。</p>
</blockquote>
<p>と訳せます。</p>
<p>纏めれば、従来の記事はRedmine全体のシステムに関連づけられるのではなく、特定のプロジェクトの配下に関連づけられるようになったため、記事を移動する必要があるということです。<br>そのため、記事を移行させるためのSQLを実行します。</p>
<h3 id="5-記事の移動"><a href="#5-記事の移動" class="headerlink" title="(5) 記事の移動"></a>(5) 記事の移動</h3><p>まず移動先のプロジェクトを作成します (既存のプロジェクトでも構いません)。<br>移動先のプロジェクトの<strong>識別子</strong>を確認します。<br>識別子は<strong>設定</strong>-&gt;<strong>情報</strong>-&gt;<strong>識別子</strong>から確認できます。</p>
<p>次に、下記のように、<strong>mysql</strong>に繋いで、<strong>project_id</strong>を確認します。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -u bitnami -p bitnami_redmine</span><br><span class="line">Enter password: (ここはdatabase.ymlに記述されているパスワードを入力)</span><br><span class="line">SELECT id FROM bitnami_redmine.projects WHERE identifier=&#x27;識別子&#x27;;</span><br></pre></td></tr></table></figure>

<p>すると、</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+----+</span><br><span class="line">| id |</span><br><span class="line">+----+</span><br><span class="line">| <span class="number">27</span> |</span><br><span class="line">+----+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0</span>.<span class="number">00</span> sec)</span><br></pre></td></tr></table></figure>

<p>のような感じで、project_idを取得できます。ここでは27とします。<br>次にこの値で<strong>kb_articles</strong>と<strong>kb_categories</strong>内の<strong>project_id</strong>を更新します。<br>続けて下記のSQLを実行します。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> bitnami_redmine.kb_articles <span class="keyword">SET</span> project_id=<span class="string">&#x27;27&#x27;</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> bitnami_redmine.kb_categories <span class="keyword">SET</span> project_id=<span class="string">&#x27;27&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>これで記事の移動は完了しました。<br>Redmineで移動先のプロジェクトの<strong>ナレッジベース</strong>を確認します。</p>
<p><a href="../../../../public/2014/05/redmine1.png"><img src="../../../../public/2014/05/redmine1-300x167.png"></a></p>
<p>このような感じになると思います。</p>
<p>以上で<strong>redmine_knowledgebase</strong>の更新は完了です。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2014-05-10</span><i class="fa fa-tag"></i><a class="tag" href="/categories/プロジェクト管理/" title="プロジェクト管理">プロジェクト管理 </a><a class="tag" href="/categories/プロジェクト管理/Redmine/" title="Redmine">Redmine </a><a class="tag" href="/categories/ソフトウェア工学/" title="ソフトウェア工学">ソフトウェア工学 </a><a class="tag" href="/categories/ソフトウェア紹介/" title="ソフトウェア紹介">ソフトウェア紹介 </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2014/05/10/489/,A certain engineer &quot;COMPLEX&quot;,BitNami Redmine Stack のアップデート 2.3.0-0 to 2.5.1-1,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2015/12/06/507/" title="ご無沙汰しておりました">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2014/05/09/486/" title="Windows Server 2012 R2 #1 -ユーザー インターフェイスが戻せない-">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>