<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>.NETでPythonを試してみる 第2回 · A certain engineer "COMPLEX"</title><meta name="description" content="前回は簡単な関数を呼び出してみました。

Introduction今回の目的は、引数を渡し、その戻りを表示します。 ただ、単純に文字列や数値を渡すのは面白くありません。 今回は配列を渡して、配列を返します。 なんと言っても、Pythonは配列、リスト、タップルの操作を得意としており、またそれらを操作"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/hexo-tag-blog-card.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>.NETでPythonを試してみる 第2回</a></h3></div><div class="post-content"><p><a target="_blank" rel="noopener" href="http://wp.me/p7138e-sF">前回</a>は簡単な関数を呼び出してみました。</p>
<a id="more"></a>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>今回の目的は、引数を渡し、その戻りを表示します。 ただ、単純に文字列や数値を渡すのは面白くありません。 今回は配列を渡して、配列を返します。 なんと言っても、Pythonは配列、リスト、タップルの操作を得意としており、またそれらを操作するライブラリが豊富です。 すなわち、配列をPythonで処理させ、その結果をC#で受け取ることができれば、より実践的なアプリが作成できます。 今回は、2つの数値を指定し、その数値を数列の先頭、末尾として扱い、差が1の階差数列を生成します。 その階差数列をPythonに渡し、各要素を2倍にした配列をC#に返し、最終的に配列内の要素の総和を返すアプリです。 例えば、1、10を指定すれば、1,2,…9,10が生成され、最終的な値は55*2の110と表示されます。 今回のソースは下記になります </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://github.com/takuya-takeuchi/Demo/tree/master/WPF.Python2" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=github.com"></img><div class="hbc-site-name">GitHub</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img src="https://avatars0.githubusercontent.com/u/6241854?s=400&v=4"></img></div><div class="hbc-text"><div class="hbc-title">takuya-takeuchi/Demo</div><div class="hbc-url">https://github.com/takuya-takeuchi/Demo/tree/master/WPF.Python2</div><div class="hbc-description">Sample source code for Demonstration, Experiment and Test - takuya-takeuchi/Demo</div></div></div></div></a></div></div>

<h1 id="Python側"><a href="#Python側" class="headerlink" title="Python側"></a>Python側</h1><p>Python側のプロジェクトを作成します。 Pythonのソースは下記になります。 [code lang=”python”] class PythonTest(): def twice(selt, array): list = [0 for i in range(len(array))] i = 0 for x in array: list[i] = x * 2 i += 1 return list; [/code] Pythonの文法をかなり忘れているので、ググりながら作成しました。情けない。 まず、list変数は、引数に渡ってきた配列arrayの長さの個数を持ち、かつ各要素は0で初期化されます。 次に、渡ってきた配列arrayをループで各要素、つまりxにアクセス、そのxを2倍にし、先頭から順にlistに格納します。 そして、listを返します。</p>
<h1 id="C-側"><a href="#C-側" class="headerlink" title="C#側"></a>C#側</h1><p>今回もWPFです。Xaml側は省略します。 数列の開始数値と終了数値を入力できるTextBox、結果を表示するメッセージボックスを表示するボタンだけです。 IronPythonの参照方法、<strong>Microsoft.Scripting.Hosting.ScriptRuntime 型</strong>、<strong>IronPython.Hosting.Python.CreateRuntime メソッド</strong>、<strong>UseFile メソッド</strong>の説明は前回の記事を参照してください。 今回は、Pythonと配列をやりとりする箇所のみ説明します。 [code lang=”csharp”] public RelayCommand MessageCommand { get { return this._MessageCommand ?? new RelayCommand(() =&gt; { var array = Enumerable.Range(this._Start, this._End - this._Start + 1).ToArray(); var sum = array.Sum(); var list = this._PythonWrapper.Twice(array);<br>var message = $”Initial total:{sum}, final total:{list.Sum()}”; this._MessageDialog.ShowMessage(message); }); } } [/code] _PythonWrapper.Twiceが今回、Pythonスクリプトの関数を呼び出します。 arrayはint[]です。 そしてlistもint[]です。 では、PythonWrapperの中身です。 [code lang=”csharp”] using System; using System.Collections; using System.Collections.Generic; using System.IO; using System.Linq; using Microsoft.Scripting.Hosting; using WPFPython2.ViewModels.Interfaces;<br>namespace WPFPython2.ViewModels {<br>public sealed class PythonWrapper : IPythonWrapper {<br>#region フィールド<br>private readonly ScriptRuntime _ScriptRuntime;<br>private dynamic _PythonObject;<br>private dynamic _PythonTest;<br>private readonly string _Path;<br>#endregion<br>#region コンストラクタ<br>public PythonWrapper(ScriptRuntime scriptRuntime, string path) { if (scriptRuntime == null) throw new ArgumentNullException(nameof(scriptRuntime)); if (path == null) throw new ArgumentNullException(nameof(path));<br>if (!File.Exists(path)) throw new FileNotFoundException(path);<br>this._ScriptRuntime = scriptRuntime; this._Path = path; this._PythonObject = this._ScriptRuntime.UseFile(this._Path); this._PythonTest = this._PythonObject.PythonTest(); }<br>#endregion<br>#region メソッド<br>public int[] Twice(int[] array) { var list = this._PythonTest.twice(array); return ((IList<object>)list).Cast<int>().ToArray(); }<br>#endregion<br>}<br>} [/code] コンストラクタは前回と同じです。Twiceメソッドだけが肝です。 まず、普通にint[]をPython側に渡しています。 しかし、戻ってきたlist変数はそのまま返すことはできません。 この変数の正確な型は、<strong>IronPython.Runtime.List</strong> という型です。 この変数を <strong>GetType().GetMembers()</strong> するとわかるのですが、 [code] Void set_Item(IronPython.Runtime.Slice, System.Object) Void set_Item(Int32, System.Object) Void set_Item(System.Numerics.BigInteger, System.Object) Void set_Item(System.Object, System.Object) Void __init__() Void __init__(System.Collections.IEnumerable) Void __init__(System.Collections.ICollection) Void __init__(IronPython.Runtime.SetCollection) Void __init__(IronPython.Runtime.FrozenSetCollection) Void __init__(IronPython.Runtime.List) Void __init__(System.String) Void __init__(IronPython.Runtime.CodeContext, System.Object) System.Object __new__(IronPython.Runtime.CodeContext, IronPython.Runtime.Types.PythonType) System.Object __new__(IronPython.Runtime.CodeContext, IronPython.Runtime.Types.PythonType, System.Object) System.Object __new__(IronPython.Runtime.CodeContext, IronPython.Runtime.Types.PythonType, System.Object[]) System.Object __new__(IronPython.Runtime.CodeContext, IronPython.Runtime.Types.PythonType, System.Collections.Generic.IDictionary`2[System.Object,System.Object], System.Object[]) IronPython.Runtime.List op_Addition(IronPython.Runtime.List, IronPython.Runtime.List) IronPython.Runtime.List op_Multiply(IronPython.Runtime.List, Int32) IronPython.Runtime.List op_Multiply(Int32, IronPython.Runtime.List) System.Object op_Multiply(IronPython.Runtime.List, IronPython.Runtime.Index) System.Object op_Multiply(IronPython.Runtime.Index, IronPython.Runtime.List) System.Object op_Multiply(IronPython.Runtime.List, System.Object) System.Object op_Multiply(System.Object, IronPython.Runtime.List) Int32 __len__() System.Collections.IEnumerator __iter__() System.Collections.IEnumerator __reversed__() Boolean __contains__(System.Object) System.Object InPlaceAdd(System.Object) IronPython.Runtime.List InPlaceMultiply(Int32) System.Object InPlaceMultiply(IronPython.Runtime.Index) System.Object InPlaceMultiply(System.Object) System.Object __getslice__(Int32, Int32) Void __setslice__(Int32, Int32, System.Object) Void __delslice__(Int32, Int32) System.Object get_Item(IronPython.Runtime.Slice) Void __delitem__(Int32) Void __delitem__(System.Object) Void __delitem__(IronPython.Runtime.Slice) Void append(System.Object) Int32 count(System.Object) Void extend(IronPython.Runtime.List) Void extend(IronPython.Runtime.PythonTuple) Void extend(System.Object) Int32 index(System.Object) Int32 index(System.Object, Int32) Int32 index(System.Object, Int32, Int32) Int32 index(System.Object, System.Object) Int32 index(System.Object, System.Object, System.Object) Void insert(Int32, System.Object) Void Insert(Int32, System.Object) System.Object pop() System.Object pop(Int32) Void remove(System.Object) Void reverse() Void sort(IronPython.Runtime.CodeContext) Void sort(IronPython.Runtime.CodeContext, System.Object) Void sort(IronPython.Runtime.CodeContext, System.Object, System.Object) Void sort(IronPython.Runtime.CodeContext, System.Object, System.Object, Boolean) System.Object get_Item(Int32) System.Object get_Item(System.Numerics.BigInteger) System.Object get_Item(System.Object) Void RemoveAt(Int32) Boolean Contains(System.Object) Void Clear() Int32 IndexOf(System.Object) Int32 Add(System.Object) Int32 get_Count() Void CopyTo(System.Array, Int32) System.Collections.IEnumerator GetEnumerator() System.String __repr__(IronPython.Runtime.CodeContext) Void CopyTo(System.Object[], Int32) Boolean Remove(System.Object) System.Object op_GreaterThan(IronPython.Runtime.List, System.Object) System.Object op_LessThan(IronPython.Runtime.List, System.Object) System.Object op_GreaterThanOrEqual(IronPython.Runtime.List, System.Object) System.Object op_LessThanOrEqual(IronPython.Runtime.List, System.Object) System.String ToString() Boolean Equals(System.Object) Int32 GetHashCode() System.Type GetType() Void .ctor() System.Object Item [IronPython.Runtime.Slice] System.Object Item [Int32] System.Object Item [System.Numerics.BigInteger] System.Object Item [System.Object] Int32 Count System.Object __hash__ [/code] ところどころ、Pythonで提供している関数名が見つかります。また、Int32 Countやインデクサがあることから、System.Collections.IListを実装していそうなことはわかります。 実際にキャストもできます。 ですが、Pythonでは型はあってないようなものですし、要素の型がわからないため、明示的にキャストして呼び出し元に返しています。 キャストこそ面倒ですが、配列を渡す、呼び出すことに全く問題はありません。</p>
<h1 id="テスト"><a href="#テスト" class="headerlink" title="テスト"></a>テスト</h1><p>実際に実行してみます。 サンプルソースをビルドすると実行ディレクトリに、pythonsフォルダが生成され、<strong>Python2.py</strong>ファイルがコピーされます。 このファイルはPythonプロジェクトのファイルそのものです。 実行するとButtonが1つとTextBoxが2つ。。<br><a href="../../../../public/2017/02/2f18568491823fb77999e5278edfd49f.png"><img src="../../../../public/2017/02/2f18568491823fb77999e5278edfd49f.png"></a></p>
<p>ボタンを押すと、Python2.pyのtwiceの戻りの内容の総和が表示されます。<br><a href="../../../../public/2017/02/b797a53aff385fe3fc1e790f3515fd10.png"><img src="../../../../public/2017/02/b797a53aff385fe3fc1e790f3515fd10.png"></a></p>
<p>アプリを終了し、Python2.pyのtwice関数内の、2倍の部分を3に変更したりすれば、今回も内容が変わることがわかります。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>今回も簡単に実行できました。 異なる言語間のやりとりで面倒なことの筆頭は配列の扱いだと思います。例えば、C#とC/C++におけるポインタとか。 しかし、そんな面倒なところを感じさせないところは、Pythonがグルー言語と言われるところでしょう。</p>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/WPF.Python2">https://github.com/takuya-takeuchi/Demo/tree/master/WPF.Python2</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-02-13</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Microsoft/NET-Framework/" title=".NET Framework">.NET Framework </a><a class="tag" href="/categories/e3-83-97-e3-83-ad-e3-82-b0-e3-83-a9-e3-83-9f-e3-83-b3-e3-82-b0-e8-a8-80-e8-aa-9e/" title="%e3%83%97%e3%83%ad%e3%82%b0%e3%83%a9%e3%83%9f%e3%83%b3%e3%82%b0%e8%a8%80%e8%aa%9e">%e3%83%97%e3%83%ad%e3%82%b0%e3%83%a9%e3%83%9f%e3%83%b3%e3%82%b0%e8%a8%80%e8%aa%9e </a><a class="tag" href="/categories/net-framework/" title="net-framework">net-framework </a><a class="tag" href="/categories/Microsoft/NET-Framework/C/" title="C#">C# </a><a class="tag" href="/categories/e3-83-97-e3-83-ad-e3-82-b0-e3-83-a9-e3-83-9f-e3-83-b3-e3-82-b0-e8-a8-80-e8-aa-9e/Python/" title="Python">Python </a><a class="tag" href="/categories/net-framework/NETで○○○を試してみる/" title=".NETで○○○を試してみる">.NETで○○○を試してみる </a><a class="tag" href="/categories/Microsoft/NET-Framework/C/Windows-Presentation-Foundation/" title="Windows Presentation Foundation">Windows Presentation Foundation </a><a class="tag" href="/categories/netで○○○を試してみる/" title="netで○○○を試してみる">netで○○○を試してみる </a><a class="tag" href="/categories/python-2/" title="python-2">python-2 </a><a class="tag" href="/categories/netで○○○を試してみる/NETでPythonを試してみる/" title=".NETでPythonを試してみる">.NETでPythonを試してみる </a><a class="tag" href="/categories/python-2/IronPython/" title="IronPython">IronPython </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2017/02/13/1786/,A certain engineer &quot;COMPLEX&quot;,.NETでPythonを試してみる 第2回,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/02/26/1795/" title="開発メモ その31 NLogで動的にファイル名を設定する">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/02/13/1777/" title=".NETでPythonを試してみる 第1回">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>