<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>開発メモ その72 dlibをCUDAを有効にしてビルドする · A certain engineer "COMPLEX"</title><meta name="description" content="ProblemOpenCVには顔検出用の関数があるが、どうにも精度が良くないときがある。 そこで最近名前を聞くようになったdlibを使って見ることにする。 ただ、C#のラッパーなどは出回っておらず、C++から呼び出す泥臭いことが必要な模様。 ただ、ソースのサンプルが豊富なので、試してみるのは簡単そう"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/hexo-tag-blog-card.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>開発メモ その72 dlibをCUDAを有効にしてビルドする</a></h3></div><div class="post-content"><h1 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h1><p><strong>OpenCV</strong>には顔検出用の関数があるが、どうにも精度が良くないときがある。 そこで最近名前を聞くようになった<strong>dlib</strong>を使って見ることにする。 ただ、C#のラッパーなどは出回っておらず、C++から呼び出す泥臭いことが必要な模様。 ただ、ソースのサンプルが豊富なので、試してみるのは簡単そう…. と思っていましたがそうでは無かったです。</p>
<h1 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h1><h2 id="ソース"><a href="#ソース" class="headerlink" title="ソース"></a>ソース</h2><p>まずはソースをダウンロード。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="http://dlib.net/" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=dlib.net"></img><div class="hbc-site-name">dlib.net</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img src="http://dlib.net/dlib-logo-small.png"></img></div><div class="hbc-text"><div class="hbc-title">dlib C++ Library</div><div class="hbc-url">http://dlib.net/</div></div></div></div></a></div></div>

<p>ページ左下の青いボタンがダウンロードになります。2017/07/05時点の最新版は19.4です。<br><a href="../../../../public/2017/07/screencapture-dlib-net-1499263587443.png"><img src="../../../../public/2017/07/screencapture-dlib-net-1499263587443-1024x274.png"></a><br> ダウンロード後、任意の場所に展開します。 ここでは、<strong>D:\Works\Lib\DLib\19.4</strong>とします。 配下には下記のファイル、フォルダが展開されます。 dlib docs examples python_examples tools CMakeLists.txt documentation.html MANIFEST.in README.md setup.py</p>
<h2 id="CUDA"><a href="#CUDA" class="headerlink" title="CUDA"></a>CUDA</h2><p>dlibはCUDAを利用することで性能を大幅に向上させることが出来ます。 ただし、利用できるCUDAは7.5以降になります。今回は8.0を選択。 ダウンロードは下記になります。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://developer.nvidia.com/cuda-downloads" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=developer.nvidia.com"></img><div class="hbc-site-name">NVIDIA Developer</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">CUDA Toolkit 11.1 Update 1 Downloads</div><div class="hbc-url">https://developer.nvidia.com/cuda-downloads</div><div class="hbc-description">Please Note: Due to an incompatibility issue, we advise users to defer updating to Linux Kernel 5.9+ until mid-November when an NVIDIA Linux…</div></div></div></div></a></div></div>

<p>今回はWindows 10用のインストーラを入手します。<br><a href="../../../../public/2017/07/screencapture-developer-nvidia-cuda-downloads-1499263676219.png"><img src="../../../../public/2017/07/screencapture-developer-nvidia-cuda-downloads-1499263676219-1024x888.png"></a><br> パッチもダウンロードできるようなので、そちらもダウンロードします。 バージョンは異なりますが、インストールは下記を参考にできます。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://taktak.jp/2016/02/11/net%E3%81%A7gpupu%E3%82%92%E8%A9%A6%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B-cuda%E7%B7%A8-%E7%AC%AC0%E5%9B%9E/" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=taktak.jp"></img><div class="hbc-site-name">taktak.jp</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">.NETでGPUPUを試してみる CUDA編 第0回 – A certain engineer &quot;COMPLEX&quot;</div><div class="hbc-url">https://taktak.jp/2016/02/11/net%E3%81%A7gpupu%E3%82%92%E8%A9%A6%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B-cuda%E7%B7%A8-%E7%AC%AC0%E5%9B%9E/</div></div></div></div></a></div></div>

<h2 id="cuDNN"><a href="#cuDNN" class="headerlink" title="cuDNN"></a>cuDNN</h2><p>CUDAを利用するにはcuDNNが必要です。 インストールしたCUDAに合わせたバージョンを使います。6.0はdlibで利用できないので、5.1を利用します。 ダウンロードは下記になります。 NVIDIAの開発者登録が必要ですので、登録を済ませておいてください。 </p>


<p>入手や展開は下記を参考にできます。 </p>


<p>今回は、<strong>D:\Works\Lib\NVIDIA\cuDNN</strong>に展開します。</p>
<h2 id="OpenCV"><a href="#OpenCV" class="headerlink" title="OpenCV"></a>OpenCV</h2><p>下記からインストーラをダウンロードしてインストールしておきます。2017/07/05の時点で最新は3.2.0になります。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="http://opencv.org/releases.html" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=opencv.org"></img><div class="hbc-site-name">opencv.org</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">Releases</div><div class="hbc-url">http://opencv.org/releases.html</div></div></div></div></a></div></div>

<p>今回は、<strong>D:\Works\Lib\OpenCV\opencv-3.2.0</strong>に展開します。</p>
<h2 id="CMake"><a href="#CMake" class="headerlink" title="CMake"></a>CMake</h2><p>Visual Studioのソリューションファイルを生成するために必要です。 下記でダウンロードしインストールします。2017/07/05時点の最新の安定版は3.8.2です。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://cmake.org/" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=cmake.org"></img><div class="hbc-site-name">cmake.org</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">CMake</div><div class="hbc-url">https://cmake.org/</div></div></div></div></a></div></div>

<p>インストール時、CMakeを環境変数PATHに追加するか選択できますが、そこは好みで。</p>
<h2 id="Visual-Studio"><a href="#Visual-Studio" class="headerlink" title="Visual Studio"></a>Visual Studio</h2><p>ビルドに使います。当たり前かもしれませんが、これがくせ者。 まず、dlibが対応しているCUDAは7.5以降になります。今回は8.0にします。 しかし、8.0に対応しているのはVisual Studio 2015以前です。 2017は<strong>対応していません</strong> </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="http://docs.nvidia.com/cuda/cuda-installation-guide-microsoft-windows/index.html#axzz4lyCjEB3M" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=docs.nvidia.com"></img><div class="hbc-site-name">docs.nvidia.com</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">Installation Guide Windows :: CUDA Toolkit Documentation</div><div class="hbc-url">http://docs.nvidia.com/cuda/cuda-installation-guide-microsoft-windows/index.html#axzz4lyCjEB3M</div><div class="hbc-description">The installation instructions for the CUDA Toolkit on MS-Windows systems.</div></div></div></div></a></div></div>

<h1 id="Build-with-CUDA"><a href="#Build-with-CUDA" class="headerlink" title="Build with CUDA"></a>Build with CUDA</h1><p>まずコマンドプロンプトで、dlibの展開フォルダを開きます。 なお、<strong>build</strong>フォルダの名前は自由です。 [code lang=”batch”] D:\Works\Lib\DLib\19.4&gt;cd examples D:\Works\Lib\DLib\19.4\examples&gt;mkdir build D:\Works\Lib\DLib\19.4\examples&gt;cd build D:\Works\Lib\DLib\19.4\examples\build&gt;”C:\Program Files\CMake\bin\cmake.exe” -G “Visual Studio 14 2015 Win64” -DCOMPILER_CAN_DO_CPP_11=ON -DOpenCV_DIR=D:\Works\Lib\OpenCV\opencv-3.2.0\build .. – The C compiler identification is MSVC 19.0.24215.1 – The CXX compiler identification is MSVC 19.0.24215.1 – Check for working C compiler: C:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/bin/x86_amd64/cl.exe – Check for working C compiler: C:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/bin/x86_amd64/cl.exe – works – Detecting C compiler ABI info – Detecting C compiler ABI info - done – Check for working CXX compiler: C:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/bin/x86_amd64/cl.exe – Check for working CXX compiler: C:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/bin/x86_amd64/cl.exe – works – Detecting CXX compiler ABI info – Detecting CXX compiler ABI info - done – Detecting CXX compile features – Detecting CXX compile features - done – Looking for sys/types.h – Looking for sys/types.h - found – Looking for stdint.h – Looking for stdint.h - found – Looking for stddef.h – Looking for stddef.h - found – Check size of void* – Check size of void* - done – Enabling SSE2 instructions – Looking for png_create_read_struct – Looking for png_create_read_struct - found – Looking for jpeg_read_header – Looking for jpeg_read_header - not found – Searching for BLAS and LAPACK – Found CUDA: C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v8.0 (found suitable version “8.0”, minimum required is “7.5”) – Looking for cuDNN install… – *** cuDNN V5.0 OR GREATER NOT FOUND. DLIB WILL NOT USE CUDA. *** – *** If you have cuDNN then set CMAKE_PREFIX_PATH to include cuDNN’s folder. – Configuring done – Generating done – Build files have been written to: D:/Works/Lib/DLib/19.4/examples/build [/code] しかし、Cmakeが失敗します。 ネットを見ると、<strong>-DCMAKE_PREFIX_PATH</strong>に<strong>cuDNN</strong>のルートフォルダを指定する、みたいなことが書いてありますが、これでは私の環境ではダメでした。 解決策は、cuDNN内の <strong>cuda\include\cudnn.h</strong> <strong>cuda\lib\x64\cudnn.lib</strong> を、それぞれ <strong>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0\include</strong> <strong>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0\lib\x64</strong> にコピーします。 その後、buildフォルダ内を削除し、先のコマンドを実行します。 [code lang=”batch”] D:\Works\Lib\DLib\19.4\examples\build&gt;”C:\Program Files\CMake\bin\cmake.exe” -G “Visual Studio 14 2015 Win64” -DCOMPILER_CAN_DO_CPP_11=ON -DOpenCV_DIR=D:\Works\Lib\OpenCV\opencv-3.2.0\build ..<br>-- Found CUDA: C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v8.0 (found suitable version “8.0”, minimum required is “7.5”) – Looking for cuDNN install… – Building a CUDA test project to see if your compiler is compatible with CUDA… – Checking if you have the right version of cuDNN installed. – Found cuDNN: C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v8.0/lib/x64/cudnn.lib – Configuring done – Generating done – Build files have been written to: D:/Works/Lib/DLib/19.4/examples/build [/code] CMakeでVisual Studioのソリューションファイルの生成に成功しましたので、下記のようにビルドします。 [code lang=”batch”] D:\Works\Lib\DLib\19.4&gt;”C:\Program Files\CMake\bin\cmake.exe” –build . –config Release<br>..大量のログ..<br>188 個の警告 0 エラー<br>経過時間 00:21:08.86 [/code]</p>
<h1 id="Build-without-CUDA"><a href="#Build-without-CUDA" class="headerlink" title="Build without CUDA"></a>Build without CUDA</h1><p>もし、CUDAを無効にしたいなら [code lang=”batch”] D:\Works\Lib\DLib\19.4&gt;cd examples D:\Works\Lib\DLib\19.4\examples&gt;mkdir build_cuda_off D:\Works\Lib\DLib\19.4\examples&gt;cd build_cuda_off D:\Works\Lib\DLib\19.4\examples\build_cuda_off&gt;”C:\Program Files\CMake\bin\cmake.exe” -G “Visual Studio 14 2015 Win64” -DOpenCV_DIR=D:\Works\Lib\OpenCV\opencv-3.2.0\build -DDLIB_USE_CUDA=OFF .. – The C compiler identification is MSVC 19.0.24215.1 – The CXX compiler identification is MSVC 19.0.24215.1 – Check for working C compiler: C:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/bin/x86_amd64/cl.exe – Check for working C compiler: C:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/bin/x86_amd64/cl.exe – works – Detecting C compiler ABI info – Detecting C compiler ABI info - done – Check for working CXX compiler: C:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/bin/x86_amd64/cl.exe – Check for working CXX compiler: C:/Program Files (x86)/Microsoft Visual Studio 14.0/VC/bin/x86_amd64/cl.exe – works – Detecting CXX compiler ABI info – Detecting CXX compiler ABI info - done – Detecting CXX compile features – Detecting CXX compile features - done – C++11 activated. – Looking for sys/types.h – Looking for sys/types.h - found – Looking for stdint.h – Looking for stdint.h - found – Looking for stddef.h – Looking for stddef.h - found – Check size of void* – Check size of void* - done – Enabling SSE2 instructions – Looking for png_create_read_struct – Looking for png_create_read_struct - found – Looking for jpeg_read_header – Looking for jpeg_read_header - not found – Searching for BLAS and LAPACK – Configuring done – Generating done – Build files have been written to: D:/Works/Lib/DLib/19.4/examples/build_cuda_off [/code] とします。 この際、cmakeを実行するフォルダを<strong>build</strong>フォルダと別名にしておかないと、CUDAを有効にしたバイナリが上書きされますので注意です。 ビルドは同様に、 [code lang=”batch”] D:\Works\Lib\DLib\19.4\examples\build_cuda_off&gt;”C:\Program Files\CMake\bin\cmake.exe” –build . –config Release<br>..大量のログ..<br>188 個の警告 0 エラー<br>経過時間 00:21:28.63 [/code] とします。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-07-07</span><i class="fa fa-tag"></i><a class="tag" href="/categories/マルチメディア/" title="マルチメディア">マルチメディア </a><a class="tag" href="/categories/gpupu/" title="gpupu">gpupu </a><a class="tag" href="/categories/gpupu/CUDA/" title="CUDA">CUDA </a><a class="tag" href="/categories/GPUPU/" title="GPUPU">GPUPU </a><a class="tag" href="/categories/機械学習/" title="機械学習">機械学習 </a><a class="tag" href="/categories/機械学習/dlib/" title="dlib">dlib </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2017/07/07/2485/,A certain engineer &quot;COMPLEX&quot;,開発メモ その72 dlibをCUDAを有効にしてビルドする,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/07/29/2514/" title="開発メモ その73 Red Hat Enterprise Linux 7.3でbluetoothを使ってみる">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/06/20/2475/" title="開発メモ その71 NLogでLoggerの読み込みに失敗する">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>