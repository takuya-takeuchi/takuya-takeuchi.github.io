<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><link rel="icon" href="/images/favicon.ico" type="image/x-icon"><title>開発メモ その69 OpenCV 3.2 with ContribモジュールでInpaintを使用する · A certain engineer "COMPLEX"</title><meta name="description" content="IntroductionOpenCVSharpにPull Requestを投げました。内容は、OpenCVの拡張モジュールに含まれる、xphoto内に用意されているInpaintingと呼ばれる画像修復関数のOpenCVSharp対応です。


そんな画像修復をC++で試してみたメモになります。
W"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/apps">Apps</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>開発メモ その69 OpenCV 3.2 with ContribモジュールでInpaintを使用する</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p><strong>OpenCVSharp</strong>にPull Requestを投げました。<br>内容は、<strong>OpenCV</strong>の拡張モジュールに含まれる、xphoto内に用意されている<strong>Inpainting</strong>と呼ばれる画像修復関数のOpenCVSharp対応です。</p>


<p>そんな画像修復をC++で試してみたメモになります。</p>
<h2 id="What-is-Inpainting"><a href="#What-is-Inpainting" class="headerlink" title="What is Inpainting?"></a>What is Inpainting?</h2><p>Inpaintingとは聞き慣れない単語ですが、<strong>画像修復</strong>です。</p>
<p>Wikipediaの<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Inpainting">Inpaintingの記事 (英語。日本語記事は無し)</a>によれば</p>
<blockquote>
<p>Inpainting is the process of reconstructing lost or deteriorated parts of images and videos. In the museum world, in the case of a valuable painting, this task would be carried out by a skilled art conservator or art restorer. In the digital world, inpainting (also known as image interpolation or video interpolation) refers to the application of sophisticated algorithms to replace lost or corrupted parts of the image data (mainly small regions or to remove small defects).</p>
</blockquote>
<blockquote>
<p>Inpaintingは画像や映像における消失または悪化した部分を再構成する手順である。美術の世界において、価値ある絵画の場合、この仕事は技術的に優れた修復士または美術修復家によって為される。デジタルの世界において、inpainting (画像補間またはビデオ補間とも知られている) は、画像データ (主に小さな領域または小さな結果を取り除くため) の消失または壊れた部分を置換するために洗練されたアルゴリズムのアプリケーションを示している。</p>
</blockquote>
<p>とあります。</p>
<p>有名なPhotoshopもこの機能があります。<br>流石に、Photoshop程の性能はありませんが、適切な場面で用いればOpenCVのInpaintingは威力を発揮します。</p>
<h2 id="How-to-use"><a href="#How-to-use" class="headerlink" title="How to use?"></a>How to use?</h2><p>Inpaintingは拡張モジュールにもありますが、通常の<strong>cv名前空間</strong>にも<strong>inpaint関数</strong>があります。<br>どちらも、修復対象の画像、マスク画像 (8ビットグレイスケール)、出力先画像、パラメータを指定しますが、両者の違いはマスク画像の指定方法とパラメータの有無にあります。</p>
<ul>
<li><strong>cv::xphoto::inpaint</strong><ul>
<li>マスク画像の非0 (通常は輝度値255)を有効な画像領域、0 (つまり黒)を修復対象の領域として扱う</li>
</ul>
</li>
<li><strong>cv::inpaint</strong><ul>
<li>マスク画像の0 (つまり黒)を有効な画像領域、非0 (通常は輝度値255)を修復対象の領域として扱う</li>
<li>パラメータとして、</li>
<li>修復される各点を中心とする近傍円形領域の半径</li>
<li>修復手法 (INPAINT_NSまたはINPAINT_TELEA) を指定</li>
</ul>
</li>
</ul>
<p>という違いがあります。<br>正確には、cv::xphoto::inpaintにも指定できるパラメータはありますが、OpenCV 3.2の時点では利用できるパラメータは1つだけなので、事実上パラメータはありません。<br>なので、拡張モジュールのcv::xphoto::inpaintは非常に簡単に利用できます。<br>また、cv::xphoto::inpaintの実装は、<strong>Microsoft Research Asia</strong>の<a target="_blank" rel="noopener" href="http://kaiminghe.com/eccv12/index.html">Statistics of Patch Offsets for Image Completion</a>という論文の実装の模様。</p>
<h2 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h2><p>Inpaintingのアルゴリズムは、近隣の領域の複製になります。<br>近隣の近似している領域を継ぎ目が自然となるように、補正対象領域のピクセルを置換していきます。<br>当然、壊れた領域はまわりのピクセルから推測されて複製されるため、そこに存在しないものは修復できません。</p>
<p>例えば、野球選手の背番号が完全に隠れていて、それを補正した場合、正しい背番号は修復できない、ということです。<br>このケースの場合、ユニフォームの布地の大部分で背番号の部分が補完されるでしょう。</p>
<h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><p>下記がサンプルです。<br>cv::xphoto::inpaintとcv::inpaintを実行し、元画像、マスク画像、修復後の画像を上下に表示して比較します。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/xphoto.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// https://ja.wikipedia.org/wiki/%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB:Tokyo_Tower_and_around_Skyscrapers.jpg</span></span><br><span class="line">    <span class="keyword">auto</span> path = <span class="string">&quot;B:\\300px-Tokyo_Tower_and_around_Skyscrapers.jpg&quot;</span>;</span><br><span class="line">    <span class="keyword">auto</span> maskpath = <span class="string">&quot;B:\\300px-Tokyo_Tower_and_around_Skyscrapers_mask.bmp&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> src = cv::imread(path);</span><br><span class="line">    <span class="keyword">auto</span> mask = cv::imread(maskpath, cv::IMREAD_GRAYSCALE);</span><br><span class="line">    <span class="keyword">if</span> (mask.channels() != <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// xphotoのinpaint</span></span><br><span class="line">    <span class="function">cv::Mat <span class="title">dst</span><span class="params">(src.rows, src.cols, src.type())</span></span>;</span><br><span class="line">    cv::xphoto::inpaint(src, mask, dst, cv::xphoto::INPAINT_SHIFTMAP);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 従来のinpaint</span></span><br><span class="line">    <span class="function">cv::Mat <span class="title">dst2</span><span class="params">(src.rows, src.cols, src.type())</span></span>;</span><br><span class="line">    <span class="function">cv::Mat <span class="title">mask2</span><span class="params">(mask.rows, mask.cols, mask.type())</span></span>;</span><br><span class="line">    <span class="comment">// 従来のinpaintのマスクは白領域が修復対象</span></span><br><span class="line">    cv::bitwise_not(mask, mask2);</span><br><span class="line">    cv::inpaint(src, mask2, dst2, <span class="number">3</span>, cv::INPAINT_TELEA);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 元画像、マスク画像、修復後の画像の合成画像</span></span><br><span class="line">    <span class="function">cv::Mat <span class="title">combiend</span><span class="params">(src.rows * <span class="number">2</span>, src.cols * <span class="number">3</span>, src.type())</span></span>;</span><br><span class="line"></span><br><span class="line">    cv::Rect roi_rect;</span><br><span class="line">    roi_rect.x = <span class="number">0</span>;</span><br><span class="line">    roi_rect.y = <span class="number">0</span>;</span><br><span class="line">    roi_rect.width = src.cols;</span><br><span class="line">    roi_rect.height = src.rows;</span><br><span class="line"></span><br><span class="line">    <span class="function">cv::Mat <span class="title">roi_src</span><span class="params">(combiend, roi_rect)</span></span>;</span><br><span class="line">    src.copyTo(roi_src);</span><br><span class="line"></span><br><span class="line">    roi_rect.x = src.cols;</span><br><span class="line">    <span class="function">cv::Mat <span class="title">roi_mask</span><span class="params">(combiend, roi_rect)</span></span>;</span><br><span class="line">    <span class="function">cv::Mat <span class="title">colorMask</span><span class="params">(mask.rows, mask.cols, src.type())</span></span>;</span><br><span class="line">    cv::cvtColor(mask, colorMask, cv::COLOR_GRAY2BGR);</span><br><span class="line">    colorMask.copyTo(roi_mask);</span><br><span class="line"></span><br><span class="line">    roi_rect.x = src.cols * <span class="number">2</span>;</span><br><span class="line">    <span class="function">cv::Mat <span class="title">roi_dst</span><span class="params">(combiend, roi_rect)</span></span>;</span><br><span class="line">    dst.copyTo(roi_dst);</span><br><span class="line"></span><br><span class="line">    roi_rect.x = <span class="number">0</span>;</span><br><span class="line">    roi_rect.y = src.rows;</span><br><span class="line">    <span class="function">cv::Mat <span class="title">roi_src2</span><span class="params">(combiend, roi_rect)</span></span>;</span><br><span class="line">    src.copyTo(roi_src2);</span><br><span class="line"></span><br><span class="line">    roi_rect.x = src.cols;</span><br><span class="line">    <span class="function">cv::Mat <span class="title">roi_mask2</span><span class="params">(combiend, roi_rect)</span></span>;</span><br><span class="line">    <span class="function">cv::Mat <span class="title">colorMask2</span><span class="params">(mask.rows, mask.cols, src.type())</span></span>;</span><br><span class="line">    cv::cvtColor(mask2, colorMask2, cv::COLOR_GRAY2BGR);</span><br><span class="line">    colorMask2.copyTo(roi_mask2);</span><br><span class="line"></span><br><span class="line">    roi_rect.x = src.cols * <span class="number">2</span>;</span><br><span class="line">    <span class="function">cv::Mat <span class="title">roi_dst2</span><span class="params">(combiend, roi_rect)</span></span>;</span><br><span class="line">    dst2.copyTo(roi_dst2);</span><br><span class="line"></span><br><span class="line">    cv::namedWindow(<span class="string">&quot;preview&quot;</span>);</span><br><span class="line">    cv::imshow(<span class="string">&quot;preview&quot;</span>, combiend);</span><br><span class="line"></span><br><span class="line">    cv::waitKey();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>サンプルでは、Wikipediaの<a target="_blank" rel="noopener" href="https://ja.wikipedia.org/wiki/%E6%9D%B1%E4%BA%AC%E3%82%BF%E3%83%AF%E3%83%BC">東京タワーの記事</a>の、ある画像中から東京タワーを除去しています。</p>
<p><a href="../../../../public/2017/05/1694ff4ab6d4577d3b03337798861275.png"><img src="../../../../public/2017/05/1694ff4ab6d4577d3b03337798861275.png"></a></p>
<p>上段がcv::xphoto::inpaint、下段がcv::inpaintを実行した結果になります。<br>ぱっと見た感じ、cv::xphoto::inpaintは良い感じです。<br>細かく見ると、付近の建物が複製されているのが目立ちます。</p>
<p><a href="../../../../public/2017/05/check.png"><img src="../../../../public/2017/05/check.png"></a></p>
<p>一方、cv::inpaintはぼけた感じになってしまいました。<br>パラメータを調整すれば変わる可能性はあると思いますが、いくつか試してみても、どれも似た感じで大差ありませんでした。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Photoshopが凄すぎるのであって、OSSでここまで実行できるというのは相当凄いことだと実感できます。<br>流石に、人間の手による修復にはかないませんが、近年のAIやDNNなどで、こうした画像修復の分野も、やがて人間に匹敵する性能を見せることになっていくのでしょう。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-05-16</span><i class="fa fa-tag"></i><a class="tag" href="/categories/マルチメディア/" title="マルチメディア">マルチメディア </a><a class="tag" href="/categories/マルチメディア/OpenCV/" title="OpenCV">OpenCV </a><a class="tag" href="/categories/マルチメディア/OpenCV/画像処理/" title="画像処理">画像処理 </a><a class="tag" href="/categories/マルチメディア/OpenCV/画像処理/画像修復/" title="画像修復">画像修復 </a><a class="tag" href="/categories/マルチメディア/OpenCV/画像処理/画像修復/画像処理/" title="画像処理">画像処理 </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2017/05/16/2291/,A certain engineer &quot;COMPLEX&quot;,開発メモ その69 OpenCV 3.2 with ContribモジュールでInpaintを使用する,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/05/16/2372/" title=".NETでLinuxと遊んでみる .NET Core インストール編">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/05/15/2344/" title="開発メモ その68 Red Hat Enterprise Linux 7.2でGitKrakenを使う">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>