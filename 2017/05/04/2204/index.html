<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>開発メモ その59 OpenCV 3.2 with ContribモジュールでArUcoを使用する · A certain engineer "COMPLEX"</title><meta name="description" content="IntroductionOpenCVSharpに新しいPull Requestを投げました。 内容は、OpenCVの拡張モジュールに含まれる、ArUcoと呼ばれる拡張現実アプリケーション用の計量ライブラリのOpenCVSharpへの移植です。 移植作業において、P/Invokeを書くことも大変だった"><meta name="keywords" content="极限博客,极限Blog,博客,极限"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>心之所愿，无事不成。<br> Nothing is impossible to a willing heart.</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/mrcore"><i class="fa fa-github"></i></a></li><li><a href="mailto:x@jixian.io"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY="><i class="fa fa-qq"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/people/"><i class="fa fa-mortar-board"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2017 - 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li><li><a href="/guestbook">メッセージ</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>開発メモ その59 OpenCV 3.2 with ContribモジュールでArUcoを使用する</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p><strong>OpenCVSharp</strong>に新しいPull Requestを投げました。 内容は、<strong>OpenCV</strong>の拡張モジュールに含まれる、<strong>ArUco</strong>と呼ばれる拡張現実アプリケーション用の計量ライブラリのOpenCVSharpへの移植です。 移植作業において、P/Invokeを書くことも大変だったのですが、ライブラリそのものの使い方も大変でしたのでメモします。</p>
<h2 id="What-is-ArUco"><a href="#What-is-ArUco" class="headerlink" title="What is ArUco?"></a>What is ArUco?</h2><p>まず、ArUcoの公式ページは下記のようです。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="http://www.uco.es/investiga/grupos/ava/node/26" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=www.uco.es"></img><div class="hbc-site-name">www.uco.es</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title"> ArUco: a minimal library for Augmented Reality applications based on OpenCV | Aplicaciones de la Visión Artificial</div><div class="hbc-url">http://www.uco.es/investiga/grupos/ava/node/26</div></div></div></div></a></div></div>

<p>ArUcoという名称は、おそらく、<strong>Augmented Reality Universidad de Córdoba</strong>の略なのだと思います。 ucoというは、Universidad de Córdoba、つまりスペインのコルドバ大学のドメインです。</p>
<h2 id="特徴"><a href="#特徴" class="headerlink" title="特徴"></a>特徴</h2><p>下記は、ArUcoについてのOpenCVの下記のドキュメントページです。 </p>


<p>そこで、</p>
<blockquote>
<p>ArUco markers are binary square fiducial markers that can be used for camera pose estimation. Their main benefit is that their detection is robust, fast and simple. The aruco module includes the detection of these types of markers and the tools to employ them for pose estimation and camera calibration. Also, the ChArUco functionalities combine ArUco markers with traditional chessboards to allow an easy and versatile corner detection. The module also includes the functions to detect ChArUco corners and use them for pose estimation and camera calibration.</p>
</blockquote>
<p>AuUcoマーカーはカメラの姿勢推定に用いことが可能な二値化された位置合わせマーカーです。主な利点はそれらの検出がロバスト、高速かつシンプルであることです。 ArUcoモジュールには、これらの種別の検出、姿勢推定とカメラキャリブレーションのためのツールを含みます。 また、ChArUcoの機能は、ArUcoマーカーに従来のチェスボードを組み合わせることで、簡単で多目的に使えるコーナー検出を可能にします。モジュールは、ChArUcoのコーナー検出、それらを使用した姿勢推定とカメラキャリブレーション機能も含みます。 と記述してあります。 とりあえず、位置合わせマーカーが全ての起点となります。 画像中からマーカーを見つけ出し、マーカーの位置関係から、壁や床の向き、角度を計算できる模様。</p>
<h1 id="How-to-use"><a href="#How-to-use" class="headerlink" title="How to use"></a>How to use</h1><p>最初に使い方が大変だったと書きましたが、コード自体は大したことがないです。後述のソース見ればわかりますが、マーカーの検出自体は数行です。 何にはまったかというと、</p>
<ul>
<li>OpenCVに含まれるサンプル画像は使えない</li>
<li>辞書が一致しないと検出できない</li>
</ul>
<p>とい2点です。</p>
<h2 id="サンプル画像が使えない"><a href="#サンプル画像が使えない" class="headerlink" title="サンプル画像が使えない"></a>サンプル画像が使えない</h2><p>例えば、<a target="_blank" rel="noopener" href="https://github.com/opencv/opencv_contrib/blob/master/modules/aruco/tutorials/aruco_detection/images/singlemarkersoriginal.png">https://github.com/opencv/opencv_contrib/blob/master/modules/aruco/tutorials/aruco_detection/images/singlemarkersoriginal.png</a>というサンプルがあります。OpenCVの公式リポジトリにあるサンプルです。 普通に、この画像を読み込んで、<strong>cv::aruco::detectMarkers</strong>に渡しても何も返ってきません。 どうも、サンプル画像のマーカーは、現行の辞書で生成される画像とは異なる模様。 下記のコミュニティのAnswerでの回答です。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="http://answers.opencv.org/question/92137/valid-marker-ends-up-in-rejected-candidates-with-aruco-marker-detection/" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=answers.opencv.org"></img><div class="hbc-site-name">answers.opencv.org</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">Valid marker ends up in rejected candidates with aruco marker detection - OpenCV Q&amp;A Forum</div><div class="hbc-url">http://answers.opencv.org/question/92137/valid-marker-ends-up-in-rejected-candidates-with-aruco-marker-detection/</div><div class="hbc-description">Hello, I am trying to test the basic functionalities with aruco. I have two problems. I am getting an numpad_chunk() : invalid pointer error…</div></div></div></div></a></div></div>

<p>なので、自分でマーカーを作って、検出しているのが、後述のソースになります。</p>
<h2 id="辞書が一致しないと検出できない"><a href="#辞書が一致しないと検出できない" class="headerlink" title="辞書が一致しないと検出できない"></a>辞書が一致しないと検出できない</h2><p>これは、考えてみれば当たり前なのですが、マーカーを検出する際、どの辞書を使うかを引数に渡しています。 つまり、検出対象の画像に含まれるマーカーの基になった辞書と、検出に利用する辞書が一致しないと何も検出できません。 これに気づかなかったため、OpenCVSharpに移植する際、P/Invokeの記述ミスやメモリ破壊を疑ってしまい、無駄に時間を消費してしまいました。</p>
<h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><p>下記がサンプルです。 [code lang=”cpp”] #include “stdafx.h” #include <iostream> #include <vector> #include &lt;opencv2/core.hpp&gt; #include &lt;opencv2/highgui.hpp&gt; #include &lt;opencv2/aruco.hpp&gt; #include &lt;opencv2/opencv.hpp&gt;<br>int main(int argc, const char * argv[]) { // 共通パラメータ const auto name = cv::aruco::DICT_6X6_250; const auto dictionary = cv::aruco::getPredefinedDictionary(name);<br>// マーカー画像を生成 const auto markerSidePixels = 128; const auto columns = 4; const auto rows = 5; const auto margin = 20;<br>auto width = columns * markerSidePixels + margin * (columns + 1); auto height = rows * markerSidePixels + margin * (rows + 1);<br>auto id = 0; cv::Rect roi(0, 0, markerSidePixels, markerSidePixels); cv::Mat marker(cv::Size(width, height), CV_8UC1, cv::Scalar::all(255));<br>for (auto y = 0; y &lt; rows; y++) { roi.y = y * markerSidePixels + margin * (y + 1);<br>for (auto x = 0; x &lt; columns; x++) { roi.x = x * markerSidePixels + margin * (x + 1);<br>cv::Mat roiMat(marker, roi); cv::Mat markerImage; cv::aruco::drawMarker(dictionary, id++, markerSidePixels, markerImage, 1); markerImage.copyTo(roiMat); } }<br>std::vector<int> markerIds; std::vector&lt;std::vector<a href="cv::Point2f">cv::Point2f</a>&gt; markerCorners, rejectedCandidates; cv::Ptr<a href="cv::aruco::DetectorParameters">cv::aruco::DetectorParameters</a> parameters(new cv::aruco::DetectorParameters());<br>// マーカーの検出 cv::aruco::detectMarkers(marker, dictionary, markerCorners, markerIds, parameters, rejectedCandidates); cv::Mat detected_marker; cv::cvtColor(marker, detected_marker, cv::COLOR_GRAY2RGB); cv::aruco::drawDetectedMarkers(detected_marker, markerCorners, markerIds, CvScalar(255, 0, 0)); // rejectedCandidatesにはidがないのでnoArray cv::aruco::drawDetectedMarkers(detected_marker, rejectedCandidates, cv::noArray(), CvScalar(0, 0, 255));<br>/* 表示 */ cv::namedWindow(“marker”); cv::namedWindow(“detected”); cv::imshow(“marker”, marker); cv::imshow(“detected”, detected_marker); cv::waitKey(0);<br>return 0; } [/code] これを動かすと、次のようになります。 [caption id=”attachment_2209” align=”alignleft” width=”233”]<br><a href="../../../../public/2017/05/0bde279f01158ab3d1847cfeeb476963.png"><img src="../../../../public/2017/05/0bde279f01158ab3d1847cfeeb476963-233x300.png"></a> マーカー画像[/caption] [caption id=”attachment_2210” align=”alignright” width=”233”]<a href="../../../../public/2017/05/e8fc75a46239cd683a875c32097c5b51.png"><img src="../../../../public/2017/05/e8fc75a46239cd683a875c32097c5b51-233x300.png"></a><br> 検出後[/caption]<br>検出後の画像には、マーカーを青で囲んでいます。 赤い領域は、候補として検出されたがマーカーとしては識別されなかった棄却された領域です。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>今回は歪みもない画像なので検出精度は100%ですが、現実の空間でもきちんとマーカーの位置を検出できます。 マーカーを紙面に印刷し、壁やボードに貼ることで、カメラの位置もわかりますし、付近の物体の位置関係も推定できそうです。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-05-04</span><i class="fa fa-tag"></i><a class="tag" href="/categories/マルチメディア/" title="マルチメディア">マルチメディア </a><a class="tag" href="/categories/マルチメディア/OpenCV/" title="OpenCV">OpenCV </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2017/05/04/2204/,A certain engineer &quot;COMPLEX&quot;,開発メモ その59 OpenCV 3.2 with ContribモジュールでArUcoを使用する,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/05/06/2216/" title="OSS IssueReport">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/05/04/2202/" title="開発メモ その58 OpenCV 3.2 with Contribモジュールをスタティックライブラリとしてビルドする">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script></body></html>