<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><link rel="icon" href="/images/favicon.ico" type="image/x-icon"><title>開発メモ その59 OpenCV 3.2 with ContribモジュールでArUcoを使用する · A certain engineer "COMPLEX"</title><meta name="description" content="IntroductionOpenCVSharp に新しいPull Requestを投げました。内容は、OpenCV の拡張モジュールに含まれる、ArUco と呼ばれる拡張現実アプリケーション用軽量ライブラリのOpenCVSharpへの移植です。
移植作業において、P/Invokeを書くことも大変だっ"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>開発メモ その59 OpenCV 3.2 with ContribモジュールでArUcoを使用する</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p><strong>OpenCVSharp</strong> に新しいPull Requestを投げました。<br>内容は、<strong>OpenCV</strong> の拡張モジュールに含まれる、<strong>ArUco</strong> と呼ばれる拡張現実アプリケーション用軽量ライブラリのOpenCVSharpへの移植です。</p>
<p>移植作業において、P/Invokeを書くことも大変だったのですが、ライブラリそのものの使い方も大変でしたのでメモします。</p>
<h2 id="What-is-ArUco"><a href="#What-is-ArUco" class="headerlink" title="What is ArUco?"></a>What is ArUco?</h2><p>まず、ArUcoの公式ページは下記のようです。</p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="http://www.uco.es/investiga/grupos/ava/node/26" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=www.uco.es"></img><div class="hbc-site-name">www.uco.es</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title"> ArUco: a minimal library for Augmented Reality applications based on OpenCV | Aplicaciones de la Visión Artificial</div><div class="hbc-url">http://www.uco.es/investiga/grupos/ava/node/26</div></div></div></div></a></div></div>

<p>ArUcoという名称は、おそらく、<strong>Augmented Reality Universidad de Córdoba</strong>の略なのだと思います。<br>ucoというは、Universidad de Córdoba、つまりスペインのコルドバ大学のドメインです。</p>
<h2 id="特徴"><a href="#特徴" class="headerlink" title="特徴"></a>特徴</h2><p>下記は、ArUcoについてのOpenCVの下記のドキュメントページです。</p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="http://docs.opencv.org/3.2.0/d9/d6d/tutorial_table_of_content_aruco.html" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=docs.opencv.org"></img><div class="hbc-site-name">docs.opencv.org</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">OpenCV: ArUco marker detection (aruco module)</div><div class="hbc-url">http://docs.opencv.org/3.2.0/d9/d6d/tutorial_table_of_content_aruco.html</div></div></div></div></a></div></div>

<p>そこで、</p>
<blockquote>
<p>ArUco markers are binary square fiducial markers that can be used for camera pose estimation. Their main benefit is that their detection is robust, fast and simple. The aruco module includes the detection of these types of markers and the tools to employ them for pose estimation and camera calibration. Also, the ChArUco functionalities combine ArUco markers with traditional chessboards to allow an easy and versatile corner detection. The module also includes the functions to detect ChArUco corners and use them for pose estimation and camera calibration.</p>
</blockquote>
<p>AuUcoマーカーはカメラの姿勢推定に用いことが可能な二値化された位置合わせマーカーです。主な利点はそれらの検出がロバスト、高速かつシンプルであることです。<br>ArUcoモジュールには、これらの種別の検出、姿勢推定とカメラキャリブレーションのためのツールを含みます。<br>また、ChArUcoの機能は、ArUcoマーカーに従来のチェスボードを組み合わせることで、簡単で多目的に使えるコーナー検出を可能にします。モジュールは、ChArUcoのコーナー検出、それらを使用した姿勢推定とカメラキャリブレーション機能も含みます。</p>
<p>と記述してあります。</p>
<p>とりあえず、位置合わせマーカーが全ての起点となります。<br>画像中からマーカーを見つけ出し、マーカーの位置関係から、壁や床の向き、角度を計算できる模様。</p>
<h1 id="How-to-use"><a href="#How-to-use" class="headerlink" title="How to use"></a>How to use</h1><p>最初に使い方が大変だったと書きましたが、コード自体は大したことがないです。後述のソース見ればわかりますが、マーカーの検出自体は数行です。<br>何にはまったかというと、</p>
<ul>
<li>OpenCVに含まれるサンプル画像は使えない</li>
<li>辞書が一致しないと検出できない</li>
</ul>
<p>とい2点です。</p>
<h2 id="サンプル画像が使えない"><a href="#サンプル画像が使えない" class="headerlink" title="サンプル画像が使えない"></a>サンプル画像が使えない</h2><p>例えば、<a target="_blank" rel="noopener" href="https://github.com/opencv/opencv_contrib/blob/master/modules/aruco/tutorials/aruco_detection/images/singlemarkersoriginal.png">https://github.com/opencv/opencv_contrib/blob/master/modules/aruco/tutorials/aruco_detection/images/singlemarkersoriginal.png</a>というサンプルがあります。OpenCVの公式リポジトリにあるサンプルです。</p>
<p>普通に、この画像を読み込んで、<strong>cv::aruco::detectMarkers</strong>に渡しても何も返ってきません。<br>どうも、サンプル画像のマーカーは、現行の辞書で生成される画像とは異なる模様。<br>下記のコミュニティのAnswerでの回答です。</p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="http://answers.opencv.org/question/92137/valid-marker-ends-up-in-rejected-candidates-with-aruco-marker-detection/" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=answers.opencv.org"></img><div class="hbc-site-name">answers.opencv.org</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">Valid marker ends up in rejected candidates with aruco marker detection - OpenCV Q&amp;A Forum</div><div class="hbc-url">http://answers.opencv.org/question/92137/valid-marker-ends-up-in-rejected-candidates-with-aruco-marker-detection/</div><div class="hbc-description">Hello, I am trying to test the basic functionalities with aruco. I have two problems. I am getting an numpad_chunk() : invalid pointer error…</div></div></div></div></a></div></div>

<p>なので、自分でマーカーを作って、検出しているのが、後述のソースになります。</p>
<h2 id="辞書が一致しないと検出できない"><a href="#辞書が一致しないと検出できない" class="headerlink" title="辞書が一致しないと検出できない"></a>辞書が一致しないと検出できない</h2><p>これは、考えてみれば当たり前なのですが、マーカーを検出する際、どの辞書を使うかを引数に渡しています。<br>つまり、検出対象の画像に含まれるマーカーの基になった辞書と、検出に利用する辞書が一致しないと何も検出できません。<br>これに気づかなかったため、OpenCVSharpに移植する際、P/Invokeの記述ミスやメモリ破壊を疑ってしまい、無駄に時間を消費してしまいました。</p>
<h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><p>下記がサンプルです。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/aruco.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 共通パラメータ</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> name = cv::aruco::DICT_6X6_250;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> dictionary = cv::aruco::getPredefinedDictionary(name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// マーカー画像を生成</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> markerSidePixels = <span class="number">128</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> columns = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> rows = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> margin = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> width = columns * markerSidePixels + margin * (columns + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">auto</span> height = rows * markerSidePixels + margin * (rows + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> id = <span class="number">0</span>;</span><br><span class="line">    <span class="function">cv::Rect <span class="title">roi</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, markerSidePixels, markerSidePixels)</span></span>;</span><br><span class="line">    <span class="function">cv::Mat <span class="title">marker</span><span class="params">(cv::Size(width, height), CV_8UC1, cv::Scalar::all(<span class="number">255</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> y = <span class="number">0</span>; y &lt; rows; y++)</span><br><span class="line">    &#123;</span><br><span class="line">        roi.y = y * markerSidePixels + margin * (y + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> x = <span class="number">0</span>; x &lt; columns; x++)</span><br><span class="line">        &#123;</span><br><span class="line">            roi.x = x * markerSidePixels + margin * (x + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="function">cv::Mat <span class="title">roiMat</span><span class="params">(marker, roi)</span></span>;</span><br><span class="line">            cv::Mat markerImage;</span><br><span class="line">            cv::aruco::drawMarker(dictionary, id++, markerSidePixels, markerImage, <span class="number">1</span>);</span><br><span class="line">            markerImage.copyTo(roiMat);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; markerIds;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;cv::Point2f&gt;&gt; markerCorners, rejectedCandidates;</span><br><span class="line">    <span class="function">cv::Ptr&lt;cv::aruco::DetectorParameters&gt; <span class="title">parameters</span><span class="params">(<span class="keyword">new</span> cv::aruco::DetectorParameters())</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// マーカーの検出</span></span><br><span class="line">    cv::aruco::detectMarkers(marker, dictionary, markerCorners, markerIds, parameters, rejectedCandidates);</span><br><span class="line">    cv::Mat detected_marker;</span><br><span class="line">    cv::cvtColor(marker, detected_marker, cv::COLOR_GRAY2RGB);</span><br><span class="line">    cv::aruco::drawDetectedMarkers(detected_marker, markerCorners, markerIds, CvScalar(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">    <span class="comment">// rejectedCandidatesにはidがないのでnoArray</span></span><br><span class="line">    cv::aruco::drawDetectedMarkers(detected_marker, rejectedCandidates, cv::noArray(), CvScalar(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 表示 */</span></span><br><span class="line">    cv::namedWindow(<span class="string">&quot;marker&quot;</span>);</span><br><span class="line">    cv::namedWindow(<span class="string">&quot;detected&quot;</span>);</span><br><span class="line">    cv::imshow(<span class="string">&quot;marker&quot;</span>, marker);</span><br><span class="line">    cv::imshow(<span class="string">&quot;detected&quot;</span>, detected_marker);</span><br><span class="line">    cv::waitKey(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>これを動かすと、次のようになります。</p>
<p><a href="../../../../public/2017/05/0bde279f01158ab3d1847cfeeb476963.png"><img src="../../../../public/2017/05/0bde279f01158ab3d1847cfeeb476963-233x300.png" alt="マーカー画像"></a><br>マーカー画像</p>
<p><a href="../../../../public/2017/05/e8fc75a46239cd683a875c32097c5b51.png"><img src="../../../../public/2017/05/e8fc75a46239cd683a875c32097c5b51-233x300.png" alt="検出後"></a><br>検出後</p>
<p>検出後の画像には、マーカーを青で囲んでいます。<br>赤い領域は、候補として検出されたがマーカーとしては識別されなかった棄却された領域です。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>今回は歪みもない画像なので検出精度は100%ですが、現実の空間でもきちんとマーカーの位置を検出できます。<br>マーカーを紙面に印刷し、壁やボードに貼ることで、カメラの位置もわかりますし、付近の物体の位置関係も推定できそうです。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-05-04</span><i class="fa fa-tag"></i><a class="tag" href="/categories/マルチメディア/" title="マルチメディア">マルチメディア </a><a class="tag" href="/categories/マルチメディア/OpenCV/" title="OpenCV">OpenCV </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2017/05/04/2204/,A certain engineer &quot;COMPLEX&quot;,開発メモ その59 OpenCV 3.2 with ContribモジュールでArUcoを使用する,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/05/06/2222/" title="開発メモ その60 Visual Studioで.NET Coreの単体テスト実行後dotnet.exeが大量に残る">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/05/04/2202/" title="開発メモ その58 OpenCV 3.2 with Contribモジュールをスタティックライブラリとしてビルドする">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>