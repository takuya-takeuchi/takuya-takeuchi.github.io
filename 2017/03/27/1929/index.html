<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><link rel="icon" href="/images/favicon.ico" type="image/x-icon"><title>.NETでRPCを試してみる gRPC編 第1回 · A certain engineer "COMPLEX"</title><meta name="description" content="Introduction前回は導入手順の紹介しました。C#をサポートしているので、試してみないわけにはいきません。Pythonもサポートしており、簡単にテストできそうです。内容としては、C#(クライアント)-Python(サーバー)とし、クライアントから送信した画像をサーバー側で反転して返すというプ"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/apps">Apps</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>.NETでRPCを試してみる gRPC編 第1回</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p><a target="_blank" rel="noopener" href="https://taktak.jp/2017/03/26/1924">前回</a>は導入手順の紹介しました。<br>C#をサポートしているので、試してみないわけにはいきません。<br>Pythonもサポートしており、簡単にテストできそうです。<br>内容としては、C#(クライアント)-Python(サーバー)とし、クライアントから送信した画像をサーバー側で反転して返すというプログラムになります。<br>今回のソースは下記になります。</p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://github.com/takuya-takeuchi/Demo/tree/master/RemoteProcedureCall/gRPC/01_gRPC1" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=github.com"></img><div class="hbc-site-name">GitHub</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img src="https://opengraph.githubassets.com/851176906ee48df067dec3a2c2e134b843c3b8ef356ed967981d7eafde47074a/takuya-takeuchi/Demo"></img></div><div class="hbc-text"><div class="hbc-title">Demo/RemoteProcedureCall/gRPC/01_gRPC1 at master · takuya-takeuchi/Demo</div><div class="hbc-url">https://github.com/takuya-takeuchi/Demo/tree/master/RemoteProcedureCall/gRPC/01_gRPC1</div><div class="hbc-description">Sample source code for Demonstration, Experiment and Test - takuya-takeuchi/Demo</div></div></div></div></a></div></div>

<h1 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h1><p>C#側は前回インストールしましたので省略します。</p>
<h2 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h2><p>Pythonにもインストールしておきます。<br>Pythonインタープリターは、いつも通り<strong>Miniconda</strong>になります。<br>pipでインストールする場合は、pipのバージョンが8以降であることが条件です。<br>バージョンは下記の手順で確認。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Miniconda2</span>&gt;<span class="title">python</span> -<span class="title">m</span> <span class="title">pip</span> --<span class="title">version</span></span></span><br><span class="line"><span class="function"><span class="title">pip</span> 9.0.1 <span class="title">from</span> <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Miniconda2</span>\<span class="title">lib</span>\<span class="title">site</span>-<span class="title">packages</span> (<span class="title">python</span> 2.7)</span></span><br></pre></td></tr></table></figure>

<p><strong>gRPC</strong>をインストールします。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Miniconda2</span>&gt;<span class="title">python</span> -<span class="title">m</span> <span class="title">pip</span> <span class="title">install</span> <span class="title">grpcio</span></span></span><br><span class="line"><span class="function"><span class="title">Collecting</span> <span class="title">grpcio</span></span></span><br><span class="line"><span class="function">  <span class="title">Downloading</span> <span class="title">grpcio</span>-1.2.0-<span class="title">cp27</span>-<span class="title">cp27m</span>-<span class="title">win_amd64.whl</span> (1.1<span class="title">MB</span>)</span></span><br><span class="line"><span class="function">    100% |################################| 1.1<span class="title">MB</span> 846<span class="title">kB</span>/<span class="title">s</span></span></span><br><span class="line"><span class="function"><span class="title">Requirement</span> <span class="title">already</span> <span class="title">satisfied</span>: <span class="title">six</span>&gt;=1.5.2 <span class="title">in</span> <span class="title">c</span>:\<span class="title">program</span> <span class="title">files</span>\<span class="title">miniconda2</span>\<span class="title">lib</span>\<span class="title">site</span>-<span class="title">packages</span> (<span class="title">from</span> <span class="title">grpcio</span>)</span></span><br><span class="line"><span class="function"><span class="title">Collecting</span> <span class="title">protobuf</span>&gt;=3.2.0 (<span class="title">from</span> <span class="title">grpcio</span>)</span></span><br><span class="line"><span class="function">  <span class="title">Downloading</span> <span class="title">protobuf</span>-3.2.0-<span class="title">py2.py3</span>-<span class="title">none</span>-<span class="title">any.whl</span> (360<span class="title">kB</span>)</span></span><br><span class="line"><span class="function">    100% |################################| 368<span class="title">kB</span> 1.8<span class="title">MB</span>/<span class="title">s</span></span></span><br><span class="line"><span class="function"><span class="title">Requirement</span> <span class="title">already</span> <span class="title">satisfied</span>: <span class="title">enum34</span>&gt;=1.0.4 <span class="title">in</span> <span class="title">c</span>:\<span class="title">program</span> <span class="title">files</span>\<span class="title">miniconda2</span>\<span class="title">lib</span>\<span class="title">site</span>-<span class="title">packages</span> (<span class="title">from</span> <span class="title">grpcio</span>)</span></span><br><span class="line"><span class="function"><span class="title">Collecting</span> <span class="title">futures</span>&gt;=2.2.0 (<span class="title">from</span> <span class="title">grpcio</span>)</span></span><br><span class="line"><span class="function">  <span class="title">Downloading</span> <span class="title">futures</span>-3.0.5-<span class="title">py2</span>-<span class="title">none</span>-<span class="title">any.whl</span></span></span><br><span class="line"><span class="function"><span class="title">Requirement</span> <span class="title">already</span> <span class="title">satisfied</span>: <span class="title">setuptools</span> <span class="title">in</span> <span class="title">c</span>:\<span class="title">program</span> <span class="title">files</span>\<span class="title">miniconda2</span>\<span class="title">lib</span>\<span class="title">site</span>-<span class="title">packages</span>\<span class="title">setuptools</span>-20.3-<span class="title">py2</span>.7.<span class="title">egg</span> (<span class="title">from</span> <span class="title">protobuf</span>&gt;=3.2.0-&gt;<span class="title">grpcio</span>)</span></span><br><span class="line"><span class="function"><span class="title">Installing</span> <span class="title">collected</span> <span class="title">packages</span>: <span class="title">protobuf</span>, <span class="title">futures</span>, <span class="title">grpcio</span></span></span><br><span class="line"><span class="function">  <span class="title">Found</span> <span class="title">existing</span> <span class="title">installation</span>: <span class="title">protobuf</span> 2.6.1</span></span><br><span class="line"><span class="function">    <span class="title">Uninstalling</span> <span class="title">protobuf</span>-2.6.1:</span></span><br><span class="line"><span class="function">      <span class="title">Successfully</span> <span class="title">uninstalled</span> <span class="title">protobuf</span>-2.6.1</span></span><br><span class="line"><span class="function"><span class="title">Successfully</span> <span class="title">installed</span> <span class="title">futures</span>-3.0.5 <span class="title">grpcio</span>-1.2.0 <span class="title">protobuf</span>-3.2.0</span></span><br></pre></td></tr></table></figure>

<p>続いて、<strong>gRPC tools</strong>をインストールします。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Miniconda2</span>&gt;<span class="title">python</span> -<span class="title">m</span> <span class="title">pip</span> <span class="title">install</span> <span class="title">grpcio</span>-<span class="title">tools</span></span></span><br><span class="line"><span class="function"><span class="title">Collecting</span> <span class="title">grpcio</span>-<span class="title">tools</span></span></span><br><span class="line"><span class="function">  <span class="title">Downloading</span> <span class="title">grpcio_tools</span>-1.2.0-<span class="title">cp27</span>-<span class="title">cp27m</span>-<span class="title">win_amd64.whl</span> (1.5<span class="title">MB</span>)</span></span><br><span class="line"><span class="function">    100% |################################| 1.5<span class="title">MB</span> 687<span class="title">kB</span>/<span class="title">s</span></span></span><br><span class="line"><span class="function"><span class="title">Requirement</span> <span class="title">already</span> <span class="title">satisfied</span>: <span class="title">grpcio</span>&gt;=1.2.0 <span class="title">in</span> <span class="title">c</span>:\<span class="title">program</span> <span class="title">files</span>\<span class="title">miniconda2</span>\<span class="title">lib</span>\<span class="title">site</span>-<span class="title">packages</span> (<span class="title">from</span> <span class="title">grpcio</span>-<span class="title">tools</span>)</span></span><br><span class="line"><span class="function"><span class="title">Requirement</span> <span class="title">already</span> <span class="title">satisfied</span>: <span class="title">protobuf</span>&gt;=3.2.0 <span class="title">in</span> <span class="title">c</span>:\<span class="title">program</span> <span class="title">files</span>\<span class="title">miniconda2</span>\<span class="title">lib</span>\<span class="title">site</span>-<span class="title">packages</span> (<span class="title">from</span> <span class="title">grpcio</span>-<span class="title">tools</span>)</span></span><br><span class="line"><span class="function"><span class="title">Requirement</span> <span class="title">already</span> <span class="title">satisfied</span>: <span class="title">six</span>&gt;=1.5.2 <span class="title">in</span> <span class="title">c</span>:\<span class="title">program</span> <span class="title">files</span>\<span class="title">miniconda2</span>\<span class="title">lib</span>\<span class="title">site</span>-<span class="title">packages</span> (<span class="title">from</span> <span class="title">grpcio</span>&gt;=1.2.0-&gt;<span class="title">grpcio</span>-<span class="title">tools</span>)</span></span><br><span class="line"><span class="function"><span class="title">Requirement</span> <span class="title">already</span> <span class="title">satisfied</span>: <span class="title">enum34</span>&gt;=1.0.4 <span class="title">in</span> <span class="title">c</span>:\<span class="title">program</span> <span class="title">files</span>\<span class="title">miniconda2</span>\<span class="title">lib</span>\<span class="title">site</span>-<span class="title">packages</span> (<span class="title">from</span> <span class="title">grpcio</span>&gt;=1.2.0-&gt;<span class="title">grpcio</span>-<span class="title">tools</span>)</span></span><br><span class="line"><span class="function"><span class="title">Requirement</span> <span class="title">already</span> <span class="title">satisfied</span>: <span class="title">futures</span>&gt;=2.2.0 <span class="title">in</span> <span class="title">c</span>:\<span class="title">program</span> <span class="title">files</span>\<span class="title">miniconda2</span>\<span class="title">lib</span>\<span class="title">site</span>-<span class="title">packages</span> (<span class="title">from</span> <span class="title">grpcio</span>&gt;=1.2.0-&gt;<span class="title">grpcio</span>-<span class="title">tools</span>)</span></span><br><span class="line"><span class="function"><span class="title">Requirement</span> <span class="title">already</span> <span class="title">satisfied</span>: <span class="title">setuptools</span> <span class="title">in</span> <span class="title">c</span>:\<span class="title">program</span> <span class="title">files</span>\<span class="title">miniconda2</span>\<span class="title">lib</span>\<span class="title">site</span>-<span class="title">packages</span>\<span class="title">setuptools</span>-20.3-<span class="title">py2</span>.7.<span class="title">egg</span> (<span class="title">from</span> <span class="title">protobuf</span>&gt;=3.2.0-&gt;<span class="title">grpcio</span>-<span class="title">tools</span>)</span></span><br><span class="line"><span class="function"><span class="title">Installing</span> <span class="title">collected</span> <span class="title">packages</span>: <span class="title">grpcio</span>-<span class="title">tools</span></span></span><br><span class="line"><span class="function"><span class="title">Successfully</span> <span class="title">installed</span> <span class="title">grpcio</span>-<span class="title">tools</span>-1.2.0</span></span><br></pre></td></tr></table></figure>

<p>gRPC toolsは <strong>proto</strong> というファイルから、サーバー、クライアント側のコードを生成するためのジェネレーターになります。</p>
<h1 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h1><h2 id="gRPC-tools"><a href="#gRPC-tools" class="headerlink" title="gRPC tools"></a>gRPC tools</h2><p>protoファイルを用意して、サーバー、クライアントのコードを生成します。</p>
<h3 id="imageProc-proto"><a href="#imageProc-proto" class="headerlink" title="imageProc.proto"></a>imageProc.proto</h3><p>サンプルが <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/blob/master/examples/protos/helloworld.proto">github</a> にありますが、面白くないので、手を加えます。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> imageProc;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">ImageProc</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> Enhancement (EnhancementRequest) <span class="keyword">returns</span> (EnhancementReply) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">EnhancementRequest</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int32</span>  width = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span>  height = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">int32</span>  channel = <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">bytes</span>  image = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">EnhancementReply</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int32</span>  result = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span>  width = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">int32</span>  height = <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">int32</span>  channel = <span class="number">4</span>;</span><br><span class="line">  <span class="built_in">bytes</span>  image = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>続いて、imageProc.protoからコードを生成します。<br>gRPC toolsから生成しますが、PythonとC#側でそれぞれ生成する必要があります。<br>また、言語用にそれぞれgRPC toolsがあるので、それぞれ入手します。</p>
<h3 id="for-Python"><a href="#for-Python" class="headerlink" title="for Python"></a>for Python</h3><p>PythonでのgRPC toolsは下記のように使います。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m grpc_tools.protoc -I&lt;protoファイルの存在ディレクトリ&gt; --python_out=&lt;出力先のパス&gt; --grpc_python_out=&lt;出力先のパス&gt; &lt;protoファイルのパス&gt; </span><br></pre></td></tr></table></figure>

<p>今回のソース構成では、gRPC1フォルダにimageProc.protoがありますので、そこをカレントディレクトリにして下記を実行します。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m grpc_tools.protoc -I. --python_out=python --grpc_python_out=python imageProc.proto </span><br></pre></td></tr></table></figure>

<p>これにより、<strong>Python\imageProc_pb2.py</strong>と<strong>Python\imageProc_pb2_grpc.py</strong> が生成されます。</p>
<h3 id="for-C"><a href="#for-C" class="headerlink" title="for C#"></a>for C#</h3><p>C#側は少し面倒です。<br>まず、nugetを入手します。<br>これはVisual Studioから実行できるものではなく、スタンドアロンのコマンドラインツールです。<br><a target="_blank" rel="noopener" href="https://dist.nuget.org/index.html">Available NuGet Distribution Versions</a>から、**nuget.exe - recommended latest (v3.5.0)**を選択します。<br>ダウンロードしたnuget.exeを適切な場所に展開し、ソースフォルダのpackagesフォルダをカレントディレクトにして、次のコマンドを入力します。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\<span class="title">Works</span>\<span class="title">Demo</span>\<span class="title">gRPC1</span>\<span class="title">packages</span>&gt;&quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">NuGet</span>\<span class="title">nuget.exe</span>&quot; <span class="title">install</span> <span class="title">Grpc.Tools</span></span></span><br><span class="line"><span class="function"><span class="title">Feeds</span> <span class="title">used</span>:</span></span><br><span class="line"><span class="function">  <span class="title">https</span>://<span class="title">api.nuget.org</span>/<span class="title">v3</span>/<span class="title">index.json</span></span></span><br><span class="line"><span class="function">  <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Microsoft</span> <span class="title">SDKs</span>\<span class="title">NuGetPackages</span>\</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">GET</span> <span class="title">https</span>://<span class="title">api.nuget.org</span>/<span class="title">v3</span>/<span class="title">registration1</span>-<span class="title">gz</span>/<span class="title">grpc.tools</span>/<span class="title">index.json</span></span></span><br><span class="line"><span class="function">  <span class="title">OK</span> <span class="title">https</span>://<span class="title">api.nuget.org</span>/<span class="title">v3</span>/<span class="title">registration1</span>-<span class="title">gz</span>/<span class="title">grpc.tools</span>/<span class="title">index.json</span> 672<span class="title">ms</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Attempting</span> <span class="title">to</span> <span class="title">gather</span> <span class="title">dependency</span> <span class="title">information</span> <span class="title">for</span> <span class="title">package</span> &#x27;<span class="title">Grpc.Tools</span>.1.2.0&#x27; <span class="title">with</span></span></span><br><span class="line"><span class="function"><span class="title">respect</span> <span class="title">to</span> <span class="title">project</span> &#x27;<span class="title">D</span>:\<span class="title">Works</span>\<span class="title">Demo</span>\<span class="title">gRPC1</span>\<span class="title">packages</span>&#x27;, <span class="title">targeting</span> &#x27;<span class="title">Any</span>,<span class="title">Version</span>=<span class="title">v0</span>.0&#x27;</span></span><br><span class="line"><span class="function"><span class="title">Gathering</span> <span class="title">dependency</span> <span class="title">information</span> <span class="title">took</span> 15.35 <span class="title">ms</span></span></span><br><span class="line"><span class="function"><span class="title">Attempting</span> <span class="title">to</span> <span class="title">resolve</span> <span class="title">dependencies</span> <span class="title">for</span> <span class="title">package</span> &#x27;<span class="title">Grpc.Tools</span>.1.2.0&#x27; <span class="title">with</span> <span class="title">DependencyBehavior</span> &#x27;<span class="title">Lowest</span>&#x27;</span></span><br><span class="line"><span class="function"><span class="title">Resolving</span> <span class="title">dependency</span> <span class="title">information</span> <span class="title">took</span> 0 <span class="title">ms</span></span></span><br><span class="line"><span class="function"><span class="title">Resolving</span> <span class="title">actions</span> <span class="title">to</span> <span class="title">install</span> <span class="title">package</span> &#x27;<span class="title">Grpc.Tools</span>.1.2.0&#x27;</span></span><br><span class="line"><span class="function"><span class="title">Resolved</span> <span class="title">actions</span> <span class="title">to</span> <span class="title">install</span> <span class="title">package</span> &#x27;<span class="title">Grpc.Tools</span>.1.2.0&#x27;</span></span><br><span class="line"><span class="function"><span class="title">Retrieving</span> <span class="title">package</span> &#x27;<span class="title">Grpc.Tools</span> 1.2.0&#x27; <span class="title">from</span> &#x27;<span class="title">nuget.org</span>&#x27;.</span></span><br><span class="line"><span class="function"><span class="title">Adding</span> <span class="title">package</span> &#x27;<span class="title">Grpc.Tools</span>.1.2.0&#x27; <span class="title">to</span> <span class="title">folder</span> &#x27;<span class="title">D</span>:\<span class="title">Works</span>\<span class="title">Demo</span>\<span class="title">gRPC1</span>\<span class="title">packages</span>&#x27;</span></span><br><span class="line"><span class="function"><span class="title">Added</span> <span class="title">package</span> &#x27;<span class="title">Grpc.Tools</span>.1.2.0&#x27; <span class="title">to</span> <span class="title">folder</span> &#x27;<span class="title">D</span>:\<span class="title">Works</span>\<span class="title">Demo</span>\<span class="title">gRPC1</span>\<span class="title">packages</span>&#x27;</span></span><br><span class="line"><span class="function"><span class="title">Successfully</span> <span class="title">installed</span> &#x27;<span class="title">Grpc.Tools</span> 1.2.0&#x27; <span class="title">to</span> <span class="title">D</span>:\<span class="title">Works</span>\<span class="title">Demo</span>\<span class="title">gRPC1</span>\<span class="title">packages</span></span></span><br><span class="line"><span class="function"><span class="title">Executing</span> <span class="title">nuget</span> <span class="title">actions</span> <span class="title">took</span> 176.33 <span class="title">ms</span> </span></span><br></pre></td></tr></table></figure>

<p>カレントディレクトリに<strong>Grpc.Tools.1.2.0</strong>が作成されます。<br>続いて、コードを生成します。<br>構文はPythonと似ています。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc.exe -I&lt;protpファイルの存在ディレクトリ&gt; --csharp_out &lt;出力先のパス&gt; --grpc_out &lt;出力先のパス&gt; &lt;protoファイルのパス&gt; --plugin=protoc-gen-grpc=&lt;grpc_csharp_plugin.exeのパス&gt; </span><br></pre></td></tr></table></figure>

<p>grpc_csharp_plugin.exeは先ほどのnuget.exeでGrpc.Toolsをインストールした際に、同時にインストールされます。<br>ですので、下記のようにしてimageProc.protoからコードを生成します。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\<span class="title">Works</span>\<span class="title">Demo</span>\<span class="title">gRPC1</span>&gt;<span class="title">mkdir</span> <span class="title">gRPC</span>\<span class="title">Contracts</span> <span class="title">D</span>:\<span class="title">Works</span>\<span class="title">Demo</span>\<span class="title">gRPC1</span>&gt;<span class="title">packages</span>\<span class="title">Grpc.Tools</span>.1.2.0\<span class="title">tools</span>\<span class="title">windows_x86</span>\<span class="title">protoc.exe</span> -<span class="title">I</span>. --<span class="title">csharp_out</span> <span class="title">gRPC</span>\<span class="title">Contracts</span> --<span class="title">grpc_out</span> <span class="title">gRPC</span>\<span class="title">Contracts</span> <span class="title">imageProc.proto</span> --<span class="title">plugin</span>=<span class="title">protoc</span>-<span class="title">gen</span>-<span class="title">grpc</span>=<span class="title">packages</span>\<span class="title">Grpc.Tools</span>.1.2.0\<span class="title">tools</span>\<span class="title">windows_x86</span>\<span class="title">grpc_csharp_plugin.exe</span> </span></span><br></pre></td></tr></table></figure>

<p>これにより、<strong>gRPC\Contracts\ImageProc.cs</strong>と<strong>gRPC\Contracts\ImageProcGrpc.cs</strong> が生成されます。</p>
<h2 id="Python-1"><a href="#Python-1" class="headerlink" title="Python"></a>Python</h2><p>コードの生成が完了したので、Python側でgRPCを利用するコードを記述していきます。</p>
<h3 id="imageProc-server-py"><a href="#imageProc-server-py" class="headerlink" title="imageProc_server.py"></a>imageProc_server.py</h3><p><strong>xxx_pb2_grpc.py</strong> というファイルにて、クライアント、サービスの基底クラスが定義されていますので、これらから派生したクラスを実装していきます。<br>Python側がサーバーになるので、<strong>ImageProcServicer</strong>から派生します。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> PIL.ImageOps</span><br><span class="line"><span class="keyword">import</span> imageProc_pb2</span><br><span class="line"><span class="keyword">import</span> imageProc_pb2_grpc</span><br><span class="line"></span><br><span class="line">_ONE_DAY_IN_SECONDS = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageProc</span>(<span class="params">imageProc_pb2_grpc.ImageProcServicer</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Enhancement</span>(<span class="params">self, request, context</span>):</span></span><br><span class="line">        reply = imageProc_pb2.EnhancementReply()</span><br><span class="line">        reply.width = request.width</span><br><span class="line">        reply.height = request.height</span><br><span class="line">        reply.channel = request.channel</span><br><span class="line"></span><br><span class="line">        imageSize = request.width, request.height</span><br><span class="line">        <span class="comment"># 1 (1-bit pixels, black and white, stored with one pixel per byte)</span></span><br><span class="line">        <span class="comment"># L (8-bit pixels, black and white)</span></span><br><span class="line">        <span class="comment"># P (8-bit pixels, mapped to any other mode using a colour palette)</span></span><br><span class="line">        <span class="comment"># RGB (3x8-bit pixels, true colour)</span></span><br><span class="line">        <span class="comment"># RGBA (4x8-bit pixels, true colour with transparency mask)</span></span><br><span class="line">        <span class="comment"># CMYK (4x8-bit pixels, colour separation)</span></span><br><span class="line">        <span class="comment"># YCbCr (3x8-bit pixels, colour video format)</span></span><br><span class="line">        <span class="comment"># I (32-bit signed integer pixels)</span></span><br><span class="line">        <span class="comment"># F (32-bit floating point pixels)</span></span><br><span class="line">        channel = request.channel</span><br><span class="line">        <span class="keyword">if</span> channel == <span class="number">4</span>:</span><br><span class="line">            print(<span class="string">&#x27;channel is 4&#x27;</span>)</span><br><span class="line">            <span class="comment"># PIL.ImageOps.invert does NOT support RGBA</span></span><br><span class="line">            tmp = Image.frombytes(<span class="string">&#x27;RGBA&#x27;</span>,  imageSize, request.image)</span><br><span class="line">            r, g, b, a = tmp.split()</span><br><span class="line">            rgb = Image.merge(<span class="string">&quot;RGB&quot;</span>, (b, g, r))</span><br><span class="line">            inverted = PIL.ImageOps.invert(rgb)</span><br><span class="line">            r, g, b = inverted.split()</span><br><span class="line">            reply.image = Image.merge(<span class="string">&quot;RGBA&quot;</span>, (r, g, b, a)).tobytes()</span><br><span class="line">        <span class="keyword">elif</span> channel == <span class="number">3</span>:</span><br><span class="line">            print(<span class="string">&#x27;channel is 3&#x27;</span>)</span><br><span class="line">            reply.image = PIL.ImageOps.invert(Image.frombytes(<span class="string">&#x27;RGB&#x27;</span>, imageSize, request.image)).tobytes()</span><br><span class="line">        <span class="keyword">elif</span> channel == <span class="number">1</span>:</span><br><span class="line">            print(<span class="string">&#x27;channel is 1&#x27;</span>)</span><br><span class="line">            reply.image = PIL.ImageOps.invert(Image.frombytes(<span class="string">&#x27;1&#x27;</span>, imageSize, request.image)).tobytes()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&#x27;channel is unknown&#x27;</span>)</span><br><span class="line">            reply.image = PIL.ImageOps.invert(Image.frombytes(<span class="string">&#x27;L&#x27;</span>, imageSize, request.image)).tobytes()</span><br><span class="line"></span><br><span class="line">        reply.result = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> reply</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serve</span>():</span></span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    imageProc_pb2_grpc.add_ImageProcServicer_to_server(ImageProc(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">&#x27;[::]:50051&#x27;</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            time.sleep(_ONE_DAY_IN_SECONDS)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.stop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  serve()</span><br></pre></td></tr></table></figure>

<p><strong>ImageProc</strong>は自動生成された<strong>ImageProcServicer</strong>から派生して適宜実装します。<br>今回は、入力されたバイナリデータを反転する処理を書いています。<br>main関数はserve関数を呼び出しています。<br>serve関数は、<a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/blob/master/examples/python/helloworld/greeter_server.py">https://github.com/grpc/grpc/blob/master/examples/python/helloworld/greeter_server.py</a>を参考に記述しますので簡単です。</p>
<h2 id="C"><a href="#C" class="headerlink" title="C#"></a>C#</h2><p>MVVMで実装します。<br>画像ファイルを読み込むボタン、読み込んだ画像を表示するパネル、サーバーと通信するための送信ボタン、サーバーからの結果を表示するためのパネルを備えています。<br>また、実装を開始する前に、nugetで<strong>Google.Protobuf</strong>をインストールします。</p>
<h3 id="MainViewModel-cs"><a href="#MainViewModel-cs" class="headerlink" title="MainViewModel.cs"></a>MainViewModel.cs</h3><p>まずは、interfaceです。<br>Xaml上のButtonに対応するCommandと、Imgaeに対応するImageSourceを備えているだけです。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Windows.Media;</span><br><span class="line"><span class="keyword">using</span> GalaSoft.MvvmLight.Command;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Grpc1.ViewModels.Interfaces</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IMainViewModel</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> Properties</span></span><br><span class="line"></span><br><span class="line">        RelayCommand OpenFileCommand</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ImageSource ResultImage</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        RelayCommand ServerRequestCommand</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ImageSource SourceImage</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="IMainViewModel-cs"><a href="#IMainViewModel-cs" class="headerlink" title="IMainViewModel.cs"></a>IMainViewModel.cs</h3><p><strong>IMainViewModel</strong>を継承しています。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Windows;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Media;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Media.Imaging;</span><br><span class="line"><span class="keyword">using</span> GalaSoft.MvvmLight;</span><br><span class="line"><span class="keyword">using</span> GalaSoft.MvvmLight.Command;</span><br><span class="line"><span class="keyword">using</span> Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> Grpc1.ViewModels.Interfaces;</span><br><span class="line"><span class="keyword">using</span> ImageProc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.WindowsAPICodePack.Dialogs;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Grpc1.ViewModels</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">MainViewModel</span> : <span class="title">ViewModelBase</span>, <span class="title">IMainViewModel</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">region</span> Properties</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> RelayCommand _OpenFileCommand;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> RelayCommand OpenFileCommand</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>._OpenFileCommand ?? (<span class="keyword">this</span>._OpenFileCommand = <span class="keyword">new</span> RelayCommand(() =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">using</span> (<span class="keyword">var</span> dlg = <span class="keyword">new</span> CommonOpenFileDialog())</span><br><span class="line">                    &#123;</span><br><span class="line">                        dlg.IsFolderPicker = <span class="literal">false</span>;</span><br><span class="line">                        dlg.AddToMostRecentlyUsedList = <span class="literal">false</span>;</span><br><span class="line">                        dlg.AllowNonFileSystemItems = <span class="literal">false</span>;</span><br><span class="line">                        dlg.EnsureFileExists = <span class="literal">true</span>;</span><br><span class="line">                        dlg.EnsurePathExists = <span class="literal">true</span>;</span><br><span class="line">                        dlg.EnsureReadOnly = <span class="literal">false</span>;</span><br><span class="line">                        dlg.EnsureValidNames = <span class="literal">true</span>;</span><br><span class="line">                        dlg.Multiselect = <span class="literal">false</span>;</span><br><span class="line">                        dlg.ShowPlacesList = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> dialogResult = dlg.ShowDialog();</span><br><span class="line">                        <span class="keyword">if</span> (dialogResult != CommonFileDialogResult.Ok)</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> bitmap = <span class="keyword">new</span> BitmapImage();</span><br><span class="line">                        <span class="keyword">try</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            bitmap.BeginInit();</span><br><span class="line">                            bitmap.UriSource = <span class="keyword">new</span> Uri(dlg.FileName);</span><br><span class="line">                            bitmap.EndInit();</span><br><span class="line">                            <span class="keyword">this</span>.SourceImage = bitmap;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                        &#123;</span><br><span class="line">                            MessageBox.Show(ex.Message);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">this</span>._ServerRequestCommand?.RaiseCanExecuteChanged();</span><br><span class="line">                &#125;, () =&gt; <span class="literal">true</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> ImageSource _ResultImage;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ImageSource ResultImage</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>._ResultImage;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._ResultImage = <span class="keyword">value</span>;</span><br><span class="line">                <span class="keyword">this</span>.RaisePropertyChanged();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> RelayCommand _ServerRequestCommand;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> RelayCommand ServerRequestCommand</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>._ServerRequestCommand ?? (<span class="keyword">this</span>._ServerRequestCommand = <span class="keyword">new</span> RelayCommand(<span class="keyword">async</span> () =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> bitmap = <span class="keyword">this</span>._SourceImage <span class="keyword">as</span> BitmapImage;</span><br><span class="line">                    <span class="keyword">if</span> (bitmap == <span class="literal">null</span>)</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> width = bitmap.PixelWidth;</span><br><span class="line">                    <span class="keyword">var</span> height = bitmap.PixelHeight;</span><br><span class="line">                    <span class="keyword">var</span> stride = (width * bitmap.Format.BitsPerPixel + <span class="number">7</span>) / <span class="number">8</span>;</span><br><span class="line">                    <span class="keyword">var</span> bitsPerPixel = bitmap.Format.BitsPerPixel;</span><br><span class="line">                    <span class="keyword">var</span> bytesPerPixel = bitsPerPixel / <span class="number">8</span>;</span><br><span class="line">                    <span class="keyword">var</span> originalPixels = <span class="keyword">new</span> <span class="keyword">byte</span>[width * height * bytesPerPixel];</span><br><span class="line">                    bitmap.CopyPixels(originalPixels, stride, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">var</span> channel = <span class="keyword">new</span> Grpc.Core.Channel(<span class="string">&quot;127.0.0.1:50051&quot;</span>, Grpc.Core.ChannelCredentials.Insecure);</span><br><span class="line">                        <span class="keyword">var</span> client = <span class="keyword">new</span> ImageProc.ImageProc.ImageProcClient(channel);</span><br><span class="line">                        <span class="keyword">var</span> reply = <span class="keyword">await</span> client.EnhancementAsync(<span class="keyword">new</span> EnhancementRequest</span><br><span class="line">                        &#123;</span><br><span class="line">                            Height = height,</span><br><span class="line">                            Width = width,</span><br><span class="line">                            Channel = bytesPerPixel,</span><br><span class="line">                            Image = ByteString.CopyFrom(originalPixels)</span><br><span class="line">                        &#125;);</span><br><span class="line">                        channel.ShutdownAsync().Wait();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> resultPixels = reply.Image.ToByteArray();</span><br><span class="line">                        <span class="keyword">if</span> (resultPixels != <span class="literal">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">var</span> bmpSource = BitmapSource.Create(</span><br><span class="line">                                width,</span><br><span class="line">                                height,</span><br><span class="line">                                bitmap.DpiX,</span><br><span class="line">                                bitmap.DpiY,</span><br><span class="line">                                bitmap.Format,</span><br><span class="line">                                <span class="literal">null</span>,</span><br><span class="line">                                resultPixels,</span><br><span class="line">                                stride);</span><br><span class="line">                            <span class="keyword">if</span> (bmpSource.CanFreeze)</span><br><span class="line">                                bmpSource.Freeze();</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">this</span>.ResultImage = bmpSource;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span></span><br><span class="line">                    &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, () =&gt; <span class="keyword">this</span>._SourceImage != <span class="literal">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> ImageSource _SourceImage;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ImageSource SourceImage</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>._SourceImage;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._SourceImage = <span class="keyword">value</span>;</span><br><span class="line">                <span class="keyword">this</span>.RaisePropertyChanged();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>OpenFileCommand</strong>は、画像ファイルを<strong>System.Windows.Media.Imaging.BitmapImage</strong>に変換して、<strong>SourceImage</strong>に設定するだけです。<br>注目は、<strong>ServerRequestCommand</strong>の下記の部分です。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> channel = <span class="keyword">new</span> Grpc.Core.Channel(<span class="string">&quot;127.0.0.1:50051&quot;</span>, Grpc.Core.ChannelCredentials.Insecure);</span><br><span class="line"><span class="keyword">var</span> client = <span class="keyword">new</span> ImageProc.ImageProc.ImageProcClient(channel);</span><br><span class="line"><span class="keyword">var</span> reply = <span class="keyword">await</span> client.EnhancementAsync(<span class="keyword">new</span> EnhancementRequest</span><br><span class="line">&#123;</span><br><span class="line">    Height = height,</span><br><span class="line">    Width = width,</span><br><span class="line">    Channel = bytesPerPixel,</span><br><span class="line">    Image = ByteString.CopyFrom(originalPixels)</span><br><span class="line">&#125;);</span><br><span class="line">channel.ShutdownAsync().Wait();</span><br></pre></td></tr></table></figure>

<p>ローカル(127.0.0.1)のポート50051に対して、gRPCで通信を確立し、APIを呼び出しています。<br><strong>ImageProc.ImageProc.ImageProcClient</strong>は、gRPC toolsで自動生成しているものです。<br>通信に関係するコードはすべて自動で生成されるので、クライアント側は、ちょっとした呼び出しのコードを記述するだけで、簡単にサーバー側のAPIを呼び出せるわけです。</p>
<h1 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h1><p>サーバー側とクライアント側をテストしてみます。<br>サーバー側(<strong>imageProc_server.py</strong>)を起動し、任意の画像ファイルを読み込み、サーバー側APIを呼び出すと、反転した画像が返ってきます。</p>
<p><a href="../../../../public/2017/03/test-2.gif"><img src="../../../../public/2017/03/test-2-1024x417.gif"></a></p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>通信周りはすべて自動生成に任せ、ビジネスロジックの実装に注力できるのは、本当に楽です。<br>今時、ソケットだのコールバックだの考えるのは本当に面倒です。</p>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/RemoteProcedureCall/gRPC/01_gRPC1">https://github.com/takuya-takeuchi/Demo/tree/master/RemoteProcedureCall/gRPC/01_gRPC1</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-03-27</span><i class="fa fa-tag"></i><a class="tag" href="/categories/NET-Framework/" title=".NET Framework">.NET Framework </a><a class="tag" href="/categories/NET-Framework/NETで○○○を試してみる/" title=".NETで○○○を試してみる">.NETで○○○を試してみる </a><a class="tag" href="/categories/NET-Framework/NETで○○○を試してみる/NETでRPCを試してみる/" title=".NETでRPCを試してみる">.NETでRPCを試してみる </a><a class="tag" href="/categories/NET-Framework/NETで○○○を試してみる/NETでRPCを試してみる/Remote-Procedure-Call/" title="Remote Procedure Call">Remote Procedure Call </a><a class="tag" href="/categories/NET-Framework/NETで○○○を試してみる/NETでRPCを試してみる/Remote-Procedure-Call/gRPC/" title="gRPC">gRPC </a><a class="tag" href="/categories/NET-Framework/NETで○○○を試してみる/NETでRPCを試してみる/Remote-Procedure-Call/gRPC/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/NET-Framework/NETで○○○を試してみる/NETでRPCを試してみる/Remote-Procedure-Call/gRPC/Microsoft/Remote-Procedure-Call/" title="Remote Procedure Call">Remote Procedure Call </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2017/03/27/1929/,A certain engineer &quot;COMPLEX&quot;,.NETでRPCを試してみる gRPC編 第1回,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/03/27/1947/" title="開発メモ その35 protoファイルからドキュメントを生成する">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/03/26/1924/" title=".NETでRPCを試してみる gRPC編 第0回">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>