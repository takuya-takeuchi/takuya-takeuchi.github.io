<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>開発メモ その39 外部プロセスからUWPAppにメッセージを送信できるか? · A certain engineer "COMPLEX"</title><meta name="description" content="Question開発メモ その38 プロセスIDからUWPAppのHWNDは取得できるか?からの追加調査というか本題。 ウィンドウハンドルが取得できれば、たいていのことはできるのがWindows。 WinFormsでもWPFでも、結局かゆいところはWin32API様を三顧の礼で迎え入れる必要がある。"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>開発メモ その39 外部プロセスからUWPAppにメッセージを送信できるか?</a></h3></div><div class="post-content"><h1 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h1><p><a target="_blank" rel="noopener" href="https://taktak.jp/2017/04/02/1960">開発メモ その38 プロセスIDからUWPAppのHWNDは取得できるか?</a>からの追加調査というか本題。 ウィンドウハンドルが取得できれば、たいていのことはできるのがWindows。 <strong>WinForms</strong>でも<strong>WPF</strong>でも、結局かゆいところは<strong>Win32API</strong>様を三顧の礼で迎え入れる必要がある。 で、サンドボックス環境で動作するUWPアプリに対して、ウィンドウハンドルを経由して操作ができるか。 これができるかどうかは結構大きい。 <a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/34935077/getting-hwnd-off-of-corewindow-object-in-uwp">Getting HWND off of CoreWindow object in UWP</a>にで、<strong>Microsoft</strong>の人間がこのようにコメントしている。</p>
<blockquote>
<p>Please note there are no supported APIs for UWP that accept an HWND. Any API you call will fail Windows Store certification, and even if you avoid the Windows Store (eg, side-load or go through an Enterprise deployment) there is no guarantee the app will work in the future.</p>
</blockquote>
<p>パッと見、Win32APIの呼び出しがダメ、みたいに見えるけど、よく読むと、**(APIを呼び出すと)ストア認証に失敗する**って言っているだけで、APIそのものの成否ついては言及していない。 なので、試してみた。</p>
<h1 id="Answer"><a href="#Answer" class="headerlink" title="Answer"></a>Answer</h1><h2 id="一部成功。"><a href="#一部成功。" class="headerlink" title="一部成功。"></a>一部成功。</h2><p>[code lang=”csharp”] using System; using System.Linq; using System.Runtime.InteropServices; using System.Text; using DWORD = System.UInt32;<br>namespace ConsoleApplication1 { class Program { delegate bool Win32Callback(IntPtr hWnd, ref IntPtr lParam);<br>[DllImport(“user32.dll”)] [return: MarshalAs(UnmanagedType.Bool)] static extern bool EnumWindows(Win32Callback lpEnumFunc, ref IntPtr lParam);<br>[DllImport(“user32.dll”, SetLastError = true)] static extern IntPtr FindWindowEx(IntPtr hwndParent, IntPtr hwndChildAfter, string lpszClass, string lpszWindow);<br>[DllImport(“user32.dll”, CharSet = CharSet.Auto)] static extern int GetClassName(IntPtr hWnd, StringBuilder lpClassName, int nMaxCount);<br>[DllImport(“user32.dll”, SetLastError = true)] static extern uint GetWindowThreadProcessId(IntPtr hWnd, out uint lpdwProcessId);<br>[DllImport(“user32.dll”, EntryPoint = “MapVirtualKeyA”)] static extern int MapVirtualKey(int wCode, int wMapType);<br>[DllImport(“user32.dll”, SetLastError = true)] static extern uint SendInput(uint cInputs, KEYBOARDINPUT[] inputs, int cbSize);<br>[DllImport(“user32.dll”)] static extern int SetForegroundWindow(IntPtr hWnd);<br>const uint INPUT_KEYBOARD = 1;<br>const uint KEYEVENTF_KEYDOWN = 0;<br>const uint KEYEVENTF_KEYUP = 2;<br>const ushort VK_DELETE = 0x2E;<br>const int KBD_UNICODE = 0x0004;<br>[StructLayout(LayoutKind.Sequential)] private struct KEYBOARDINPUT { public uint type; public ushort wVk; public ushort wScan; public uint dwFlags; public uint time; public uint dwExtraInfo; public uint unused1; public uint unused2; }<br>static readonly uint GW_HWNDNEXT = 2;<br>static readonly int GWL_HWNDPARENT = -8;<br>static readonly IntPtr NULL = System.IntPtr.Zero;<br>static void Main(string[] args) { var hTarget = IntPtr.Zero; var ps = System.Diagnostics.Process.GetProcesses().Where(process =&gt; process.ProcessName == “Calculator”); if (!ps.Any()) return;<br>var calc = ps.First(); var pid = calc.Id;<br>Console.WriteLine(“プロセス名: {0}”, calc.ProcessName); Console.WriteLine(“ID: {0}”, calc.Id);<br>// EnumWindowsProc で探索対象のプロセスIDを設定 TargetProcessId = (uint)pid;<br>var proc = new Win32Callback(EnumWindowsProc);<br>EnumWindows(proc, ref hTarget);<br>Console.WriteLine(“HWND: {0}”, hTarget.ToString(“X”));<br>if (hTarget == NULL) { Console.WriteLine(“EnumWindows fails”); return; }<br>SendDelKey(hTarget); }<br>private static void SendDelKey(IntPtr hwnd) { // フォアグラウンドに移動 if (SetForegroundWindow(hwnd) == 0) { Console.WriteLine(“SetForegroundWindow fails”); return; }<br>// Delキーを送って、電卓の数字を0にする KEYBOARDINPUT[] inputs; uint retVal; inputs = new KEYBOARDINPUT[2]; inputs[0].type = INPUT_KEYBOARD; inputs[0].wVk = VK_DELETE; inputs[0].wScan = (ushort)MapVirtualKey(VK_DELETE, 0); inputs[0].dwFlags = (KEYEVENTF_KEYDOWN | KBD_UNICODE);<br>inputs[1].type = INPUT_KEYBOARD; inputs[1].wVk = VK_DELETE; inputs[1].wScan = (ushort)MapVirtualKey(VK_DELETE, 0); inputs[1].dwFlags = (KEYEVENTF_KEYUP | KBD_UNICODE);<br>var cbSize = Marshal.SizeOf<KEYBOARDINPUT>(); if (SendInput(2, inputs, cbSize) == 0) { Console.WriteLine(“SendInput fails”); return; } }<br>private static uint TargetProcessId;<br>static bool EnumWindowsProc(IntPtr hWnd, ref IntPtr lParam) { var hChild = IntPtr.Zero; var buf = new StringBuilder(1024); GetClassName(hWnd, buf, buf.Capacity); switch (buf.ToString()) { case “ApplicationFrameWindow”: hChild = FindWindowEx(hWnd, IntPtr.Zero, “Windows.UI.Core.CoreWindow”, null); DWORD processId; GetWindowThreadProcessId(hChild, out processId); if (TargetProcessId == processId) { lParam = hChild; return false; } break; default: break; } return true; }<br>} } [/code] 電卓に対してDELキーを送信し、数字を消すだけ。 でも、電卓は<strong>SetForegroundWindow</strong>で前面には来たけど、<strong>SendInput</strong>が失敗する。 Win7の電卓アプリで、似たようなコードが成功するかは確認済み。</p>
<h1 id="Supplement"><a href="#Supplement" class="headerlink" title="Supplement"></a>Supplement</h1><p>結局、<a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/33026109/windows-10-universal-app-key-press-simulation-what-os-context/33027256#33027256">Windows 10 Universal App Key Press Simulation, what OS Context?</a>という記事で、Microsoftの人間が</p>
<blockquote>
<p>There is no way to synthesize input in a Universal app. The SendInput API (and equivalents) that InputSimulator uses to inject input is available only to classic Win32 desktop apps, not to Windows Runtime apps.</p>
</blockquote>
<p>と発言しているから無理なんでしょう。 全てのWin32APIが無効、というわけではないが、入出力系は全滅かもしれない。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-04-03</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Microsoft/NET-Framework/" title=".NET Framework">.NET Framework </a><a class="tag" href="/categories/Microsoft/NET-Framework/C/" title="C#">C# </a><a class="tag" href="/categories/Microsoft/NET-Framework/C/Universal-Windows-Platform/" title="Universal Windows Platform">Universal Windows Platform </a><a class="tag" href="/categories/Microsoft/NET-Framework/C/Universal-Windows-Platform/WinRT/" title="WinRT">WinRT </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2017/04/03/1970/,A certain engineer &quot;COMPLEX&quot;,開発メモ その39 外部プロセスからUWPAppにメッセージを送信できるか?,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/04/04/1976/" title="開発メモ その40 DEP0700 : アプリケーションの登録に失敗しました">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/04/02/1960/" title="開発メモ その38 プロセスIDからUWPAppのHWNDは取得できるか?">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>