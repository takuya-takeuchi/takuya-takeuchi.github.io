<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>開発メモ その39 外部プロセスからUWPAppにメッセージを送信できるか? · A certain engineer "COMPLEX"</title><meta name="description" content="Question開発メモ その38 プロセスIDからUWPAppのHWNDは取得できるか?からの追加調査というか本題。ウィンドウハンドルが取得できれば、たいていのことはできるのがWindows。WinFormsでもWPFでも、結局かゆいところはWin32API様を三顧の礼で迎え入れる必要がある。で、"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>開発メモ その39 外部プロセスからUWPAppにメッセージを送信できるか?</a></h3></div><div class="post-content"><h1 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h1><p><a target="_blank" rel="noopener" href="https://taktak.jp/2017/04/02/1960">開発メモ その38 プロセスIDからUWPAppのHWNDは取得できるか?</a>からの追加調査というか本題。<br>ウィンドウハンドルが取得できれば、たいていのことはできるのがWindows。<br><strong>WinForms</strong>でも<strong>WPF</strong>でも、結局かゆいところは<strong>Win32API</strong>様を三顧の礼で迎え入れる必要がある。<br>で、サンドボックス環境で動作するUWPアプリに対して、ウィンドウハンドルを経由して操作ができるか。<br>これができるかどうかは結構大きい。<br><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/34935077/getting-hwnd-off-of-corewindow-object-in-uwp">Getting HWND off of CoreWindow object in UWP</a>にで、<strong>Microsoft</strong>の人間がこのようにコメントしている。</p>
<blockquote>
<p>Please note there are no supported APIs for UWP that accept an HWND. Any API you call will fail Windows Store certification, and even if you avoid the Windows Store (eg, side-load or go through an Enterprise deployment) there is no guarantee the app will work in the future.</p>
</blockquote>
<p>パッと見、Win32APIの呼び出しがダメ、みたいに見えるけど、よく読むと、**(APIを呼び出すと)ストア認証に失敗する**って言っているだけで、APIそのものの成否ついては言及していない。<br>なので、試してみた。</p>
<h1 id="Answer"><a href="#Answer" class="headerlink" title="Answer"></a>Answer</h1><h2 id="一部成功。"><a href="#一部成功。" class="headerlink" title="一部成功。"></a>一部成功。</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">using</span> System; <span class="keyword">using</span> System.Linq; <span class="keyword">using</span> System.Runtime.InteropServices; <span class="keyword">using</span> System.Text; <span class="keyword">using</span> DWORD = System.UInt32;  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApplication1</span> &#123; <span class="keyword">class</span> <span class="title">Program</span> &#123; <span class="function"><span class="keyword">delegate</span> <span class="keyword">bool</span> <span class="title">Win32Callback</span>(<span class="params">IntPtr hWnd, <span class="keyword">ref</span> IntPtr lParam</span>)</span>;  </span><br><span class="line">\[DllImport(<span class="string">&quot;user32.dll&quot;</span>)\] \[<span class="keyword">return</span>: MarshalAs(UnmanagedType.Bool)\] <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">bool</span> <span class="title">EnumWindows</span>(<span class="params">Win32Callback lpEnumFunc, <span class="keyword">ref</span> IntPtr lParam</span>)</span>;  </span><br><span class="line">\[DllImport(<span class="string">&quot;user32.dll&quot;</span>, SetLastError = <span class="literal">true</span>)\] <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">FindWindowEx</span>(<span class="params">IntPtr hwndParent, IntPtr hwndChildAfter, <span class="keyword">string</span> lpszClass, <span class="keyword">string</span> lpszWindow</span>)</span>;  </span><br><span class="line">\[DllImport(<span class="string">&quot;user32.dll&quot;</span>, CharSet = CharSet.Auto)\] <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">GetClassName</span>(<span class="params">IntPtr hWnd, StringBuilder lpClassName, <span class="keyword">int</span> nMaxCount</span>)</span>;  </span><br><span class="line">\[DllImport(<span class="string">&quot;user32.dll&quot;</span>, SetLastError = <span class="literal">true</span>)\] <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">uint</span> <span class="title">GetWindowThreadProcessId</span>(<span class="params">IntPtr hWnd, <span class="keyword">out</span> <span class="keyword">uint</span> lpdwProcessId</span>)</span>;  </span><br><span class="line">\[DllImport(<span class="string">&quot;user32.dll&quot;</span>, EntryPoint = <span class="string">&quot;MapVirtualKeyA&quot;</span>)\] <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">MapVirtualKey</span>(<span class="params"><span class="keyword">int</span> wCode, <span class="keyword">int</span> wMapType</span>)</span>;  </span><br><span class="line">\[DllImport(<span class="string">&quot;user32.dll&quot;</span>, SetLastError = <span class="literal">true</span>)\] <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">uint</span> <span class="title">SendInput</span>(<span class="params"><span class="keyword">uint</span> cInputs, KEYBOARDINPUT\[\] inputs, <span class="keyword">int</span> cbSize</span>)</span>;  </span><br><span class="line">\[DllImport(<span class="string">&quot;user32.dll&quot;</span>)\] <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">SetForegroundWindow</span>(<span class="params">IntPtr hWnd</span>)</span>;  </span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint</span> INPUT\_KEYBOARD = <span class="number">1</span>;  </span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint</span> KEYEVENTF\_KEYDOWN = <span class="number">0</span>;  </span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint</span> KEYEVENTF\_KEYUP = <span class="number">2</span>;  </span><br><span class="line"><span class="keyword">const</span> <span class="keyword">ushort</span> VK\_DELETE = <span class="number">0x2E</span>;  </span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> KBD\_UNICODE = <span class="number">0x0004</span>;  </span><br><span class="line">\[StructLayout(LayoutKind.Sequential)\] <span class="keyword">private</span> <span class="keyword">struct</span> KEYBOARDINPUT &#123; <span class="keyword">public</span> <span class="keyword">uint</span> type; <span class="keyword">public</span> <span class="keyword">ushort</span> wVk; <span class="keyword">public</span> <span class="keyword">ushort</span> wScan; <span class="keyword">public</span> <span class="keyword">uint</span> dwFlags; <span class="keyword">public</span> <span class="keyword">uint</span> time; <span class="keyword">public</span> <span class="keyword">uint</span> dwExtraInfo; <span class="keyword">public</span> <span class="keyword">uint</span> unused1; <span class="keyword">public</span> <span class="keyword">uint</span> unused2; &#125;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">uint</span> GW\_HWNDNEXT = <span class="number">2</span>;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">int</span> GWL\_HWNDPARENT = <span class="number">-8</span>;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">readonly</span> IntPtr NULL = System.IntPtr.Zero;  </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>\[\] args</span>)</span> &#123; <span class="keyword">var</span> hTarget = IntPtr.Zero; <span class="keyword">var</span> ps = System.Diagnostics.Process.GetProcesses().Where(process =&gt; process.ProcessName == <span class="string">&quot;Calculator&quot;</span>); <span class="keyword">if</span> (!ps.Any()) <span class="keyword">return</span>;  </span><br><span class="line"><span class="keyword">var</span> calc = ps.First(); <span class="keyword">var</span> pid = calc.Id;  </span><br><span class="line">Console.WriteLine(<span class="string">&quot;プロセス名: &#123;0&#125;&quot;</span>, calc.ProcessName); Console.WriteLine(<span class="string">&quot;ID: &#123;0&#125;&quot;</span>, calc.Id);  </span><br><span class="line"><span class="comment">// EnumWindowsProc で探索対象のプロセスIDを設定 TargetProcessId = (uint)pid;  </span></span><br><span class="line"><span class="keyword">var</span> proc = <span class="keyword">new</span> Win32Callback(EnumWindowsProc);  </span><br><span class="line">EnumWindows(proc, <span class="keyword">ref</span> hTarget);  </span><br><span class="line">Console.WriteLine(<span class="string">&quot;HWND: &#123;0&#125;&quot;</span>, hTarget.ToString(<span class="string">&quot;X&quot;</span>));  </span><br><span class="line"><span class="keyword">if</span> (hTarget == NULL) &#123; Console.WriteLine(<span class="string">&quot;EnumWindows fails&quot;</span>); <span class="keyword">return</span>; &#125;  </span><br><span class="line">SendDelKey(hTarget); &#125;  </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SendDelKey</span>(<span class="params">IntPtr hwnd</span>)</span> &#123; <span class="comment">// フォアグラウンドに移動 if (SetForegroundWindow(hwnd) == 0) &#123; Console.WriteLine(&quot;SetForegroundWindow fails&quot;); return; &#125;  </span></span><br><span class="line"><span class="comment">// Delキーを送って、電卓の数字を0にする KEYBOARDINPUT\[\] inputs; uint retVal; inputs = new KEYBOARDINPUT\[2\]; inputs\[0\].type = INPUT\_KEYBOARD; inputs\[0\].wVk = VK\_DELETE; inputs\[0\].wScan = (ushort)MapVirtualKey(VK\_DELETE, 0); inputs\[0\].dwFlags = (KEYEVENTF\_KEYDOWN | KBD\_UNICODE);  </span></span><br><span class="line">inputs\[<span class="number">1</span>\].type = INPUT\_KEYBOARD; inputs\[<span class="number">1</span>\].wVk = VK\_DELETE; inputs\[<span class="number">1</span>\].wScan = (<span class="keyword">ushort</span>)MapVirtualKey(VK\_DELETE, <span class="number">0</span>); inputs\[<span class="number">1</span>\].dwFlags = (KEYEVENTF\_KEYUP | KBD\_UNICODE);  </span><br><span class="line"><span class="keyword">var</span> cbSize = Marshal.SizeOf&lt;KEYBOARDINPUT&gt;(); <span class="keyword">if</span> (SendInput(<span class="number">2</span>, inputs, cbSize) == <span class="number">0</span>) &#123; Console.WriteLine(<span class="string">&quot;SendInput fails&quot;</span>); <span class="keyword">return</span>; &#125; &#125;  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">uint</span> TargetProcessId;  </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">EnumWindowsProc</span>(<span class="params">IntPtr hWnd, <span class="keyword">ref</span> IntPtr lParam</span>)</span> &#123; <span class="keyword">var</span> hChild = IntPtr.Zero; <span class="keyword">var</span> buf = <span class="keyword">new</span> StringBuilder(<span class="number">1024</span>); GetClassName(hWnd, buf, buf.Capacity); <span class="keyword">switch</span> (buf.ToString()) &#123; <span class="keyword">case</span> <span class="string">&quot;ApplicationFrameWindow&quot;</span>: hChild = FindWindowEx(hWnd, IntPtr.Zero, <span class="string">&quot;Windows.UI.Core.CoreWindow&quot;</span>, <span class="literal">null</span>); DWORD processId; GetWindowThreadProcessId(hChild, <span class="keyword">out</span> processId); <span class="keyword">if</span> (TargetProcessId == processId) &#123; lParam = hChild; <span class="keyword">return</span> <span class="literal">false</span>; &#125; <span class="keyword">break</span>; <span class="keyword">default</span>: <span class="keyword">break</span>; &#125; <span class="keyword">return</span> <span class="literal">true</span>; &#125;  </span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>

<p>電卓に対してDELキーを送信し、数字を消すだけ。<br>でも、電卓は<strong>SetForegroundWindow</strong>で前面には来たけど、<strong>SendInput</strong>が失敗する。<br>Win7の電卓アプリで、似たようなコードが成功するかは確認済み。</p>
<h1 id="Supplement"><a href="#Supplement" class="headerlink" title="Supplement"></a>Supplement</h1><p>結局、<a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/33026109/windows-10-universal-app-key-press-simulation-what-os-context/33027256#33027256">Windows 10 Universal App Key Press Simulation, what OS Context?</a>という記事で、Microsoftの人間が</p>
<blockquote>
<p>There is no way to synthesize input in a Universal app. The SendInput API (and equivalents) that InputSimulator uses to inject input is available only to classic Win32 desktop apps, not to Windows Runtime apps.</p>
</blockquote>
<p>と発言しているから無理なんでしょう。<br>全てのWin32APIが無効、というわけではないが、入出力系は全滅かもしれない。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-04-03</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Microsoft/NET-Framework/" title=".NET Framework">.NET Framework </a><a class="tag" href="/categories/Microsoft/NET-Framework/C/" title="C#">C# </a><a class="tag" href="/categories/Microsoft/NET-Framework/C/Universal-Windows-Platform/" title="Universal Windows Platform">Universal Windows Platform </a><a class="tag" href="/categories/Microsoft/NET-Framework/C/Universal-Windows-Platform/WinRT/" title="WinRT">WinRT </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2017/04/03/1970/,A certain engineer &quot;COMPLEX&quot;,開発メモ その39 外部プロセスからUWPAppにメッセージを送信できるか?,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/04/04/1976/" title="開発メモ その40 DEP0700 : アプリケーションの登録に失敗しました">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/04/02/1960/" title="開発メモ その38 プロセスIDからUWPAppのHWNDは取得できるか?">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>