<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>ディープラーニング Caffe その3 環境構築 with GPU · A certain engineer "COMPLEX"</title><meta name="description" content="Introduction1年以上前、ディープラーニング Caffe その1 環境構築という記事でにて、14.04でCPUを使ったCaffe環境を構築しました。 最近、会社でUbuntu 14.04にGeForce GTX 1080 Tiを2枚差すという、金に物を言わせたマシンが届き、そのテストをして"><meta name="keywords" content="极限博客,极限Blog,博客,极限"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>心之所愿，无事不成。<br> Nothing is impossible to a willing heart.</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/mrcore"><i class="fa fa-github"></i></a></li><li><a href="mailto:x@jixian.io"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY="><i class="fa fa-qq"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/people/"><i class="fa fa-mortar-board"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2017 - 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li><li><a href="/guestbook">メッセージ</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>ディープラーニング Caffe その3 環境構築 with GPU</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>1年以上前、<a target="_blank" rel="noopener" href="http://wp.me/p7138e-d2">ディープラーニング Caffe その1 環境構築</a>という記事でにて、14.04でCPUを使ったCaffe環境を構築しました。 最近、会社でUbuntu 14.04に<strong>GeForce GTX 1080 Ti</strong>を2枚差すという、金に物を言わせたマシンが届き、そのテストをしています。 が、これが動かない。 具体的には、ドライバを入れるとGPUは認識し、Caffe、GPUのテストなどはクリアするが、ログイン画面が真っ黒になってしまう、という現象に陥る。 恐らく、オンボードのグラフィックボードを無効化したのが原因だと思われる。オンボードのグラッフィクドライバは<strong>nouveau</strong>を使っている? ネットのBlogだと、オングラフィックのIntelのグラフィックボードを無効にしろ、みたいなこと書いてあります。 でも、会社のマシンだと、1080 Tiには、出力端子がなかったんだよね… だから、画面を表示するには、オンボードのグラフィックを有効にしておかないといけない気がするんだけど、仕事のときは気づかなかった。 で、とりあえず、自宅の環境で、<strong>GeForece GTX 750 Ti</strong>を有効化した状態で、各所で発生する問題が起きるかを検証し、手順をメモします。 目標は</p>
<ul>
<li>ドライバのインストール</li>
<li>Caffeのテストを全部Pass</li>
<li>Nvidiaのデバイステストをパス</li>
</ul>
<p>を達成することです。 検証環境は</p>
<ul>
<li>Dell Vostro 3800</li>
<li>Ubuntu 14.04 LTSを新規インストールした直後</li>
<li>Intel Core i3-4130 3.40Ghz</li>
<li>メモリ16GB</li>
<li>GeForece GTX 750 Ti</li>
</ul>
<p>になります。 なお、モニタは、グラフィックボードのHDMI端子に接続しています。 また、記事中のコマンドでは、sudoは省略するために、<strong>sudo -s</strong>でrootになっています。</p>
<h1 id="ソフトウェアの更新"><a href="#ソフトウェアの更新" class="headerlink" title="ソフトウェアの更新"></a>ソフトウェアの更新</h1><p>OSインストール直後だと、ソフトウェアの更新通知が来ますので全て更新します。来ていないなら、「ソフトウェアの更新」を明示的に実行します。 ただし、Ubuntuそのものは最新版に更新しないでください。 なお、グラフィックドライバを導入していない状態で、ボードの端子で出力していると、画面の表示文字列が一部だけ欠如していたり、突然ロック画面に戻ったりと不安定になっています。<br><a href="../../../../public/2017/04/d5f8768433ecc3a9c2ba8c3a4bf52561.jpeg"><img src="../../../../public/2017/04/d5f8768433ecc3a9c2ba8c3a4bf52561-1024x768.jpeg"></a></p>
<h1 id="SSHサーバー導入"><a href="#SSHサーバー導入" class="headerlink" title="SSHサーバー導入"></a>SSHサーバー導入</h1><p>マシンの前にいるのはつらいので。 [code lang=”sh”] $ apt-get install openssh-server $ vi /etc/ssh/sshd_config [/code] 下記のように更新 [code lang=”diff”] + #PermitRootLogin without-password - PermitRootLogin without-password + PermitRootLogin no [/code]</p>
<h1 id="nouveau無効化"><a href="#nouveau無効化" class="headerlink" title="nouveau無効化"></a>nouveau無効化</h1><p>ひょっとすると、オンボードしかない場合は、ここをオフにすると、何も表示されない可能性があるので、このセクションは無視しても可 [code lang=”sh”] $ vi /etc/modprobe.d/blacklist-nouveau.conf [/code] 下記のように更新 [code lang=”diff”] + blacklist nouveau + blacklist lbm-nouveau + options nouveau modeset=0 + alias nouveau off + alias lbm-nouveau off [/code] [code lang=”sh”] $ vi /etc/modprobe.d/nouveau-kms.conf [/code] 下記のように更新 [code lang=”diff”] + options nouveau modeset=0 [/code] 更新後、設定を反映し、再起動。 [code lang=”sh”] $ update-initramfs -u $ reboot [/code]</p>
<h2 id="接続しているボードの確認"><a href="#接続しているボードの確認" class="headerlink" title="接続しているボードの確認"></a>接続しているボードの確認</h2><p>[code lang=”sh”] # 1080Ti等は、内部のデータベースに存在しないので、まずは更新 $ update-pciids Downloaded daily snapshot dated 2017-04-23 03:15:02 $ lspci | grep VGA 01:00.0 VGA compatible controller: NVIDIA Corporation GM107 [GeForce GTX 750 Ti] (rev a2) [/code]</p>
<h2 id="ドライバのインストール"><a href="#ドライバのインストール" class="headerlink" title="ドライバのインストール"></a>ドライバのインストール</h2><p>[code lang=”sh”] $ apt-add-repository ppa:xorg-edgers/ppa $ apt-get update $ apt-get upgrade # 検索して見つかる最新をインストールする $ apt-cache search ‘nvidia-[0-9]+$’ $ apt-get install nvidia-375 $ reboot [/code] 再起動後、ログインループなら、Ctrl+Alt+F1でCUIでログインし、下記のコマンドを実行。 [code lang=”sh”] # ユーザフォルダに存在する以下を削除することで、ループを回避できる可能性がある # 自分の環境はこれでログイン成功 $ rm .Xauthority .ICEauthority $ reboot [/code]</p>
<h2 id="ドライバのバージョン確認"><a href="#ドライバのバージョン確認" class="headerlink" title="ドライバのバージョン確認"></a>ドライバのバージョン確認</h2><p>[code lang=”sh”] $ cat /proc/driver/nvidia/version NVRM version: NVIDIA UNIX x86_64 Kernel Module 375.39 Tue Jan 31 20:47:00 PST 2017 GCC version: gcc version 4.8.4 (Ubuntu 4.8.4-2ubuntu1~14.04.3) [/code]</p>
<h2 id="CUDA-Toolkitのインストール"><a href="#CUDA-Toolkitのインストール" class="headerlink" title="CUDA Toolkitのインストール"></a>CUDA Toolkitのインストール</h2><p>[code lang=”sh”] # Ubuntu 14.04 x86_64 network debを入手 $ wget <a target="_blank" rel="noopener" href="http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1404/x86/_64/cuda-repo-ubuntu1404/_8.0.61-1/_amd64.deb">http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1404/x86\_64/cuda-repo-ubuntu1404\_8.0.61-1\_amd64.deb</a> $ apt-get install aptitude -y $ dpkg -i cuda-repo-ubuntu1404_8.0.61-1_amd64.deb $ aptitude update $ aptitude install -y cuda $ reboot [/code]</p>
<h1 id="検証"><a href="#検証" class="headerlink" title="検証"></a>検証</h1><h2 id="Caffeの検証"><a href="#Caffeの検証" class="headerlink" title="Caffeの検証"></a>Caffeの検証</h2><p>Caffeのソースをダウンロードしてきて、ビルド及びtestを実行します。 [code lang=”sh”] $ wget <a target="_blank" rel="noopener" href="https://github.com/BVLC/caffe/archive/1.0.zip">https://github.com/BVLC/caffe/archive/1.0.zip</a> $ unzip 1.0.zip $ cd caffe-1.0 $ cp Makefile.config.example Makefile.config $ vi Makefile.config<br>- CUDA_DIR := /usr/local/cuda + CUDA_DIR := /usr/local/cuda-8.0<br>$ apt-get install libatlas-base-dev libboost-all-dev libgflags-dev libgoogle-glog-dev libhdf5-serial-dev libleveldb-dev liblmdb-dev libopencv-dev libprotobuf-dev protobuf-compiler libsnappy-dev -y $ make $ make test $ make runtest …<br>[———-] Global test environment tear-down [==========] 2041 tests from 267 test cases ran. (421631 ms total) [ PASSED ] 2041 tests. [/code]</p>
<h2 id="GPUの検証1"><a href="#GPUの検証1" class="headerlink" title="GPUの検証1"></a>GPUの検証1</h2><p>[code lang=”sh”] $ cd /usr/local/cuda-8.0/samples # cudnn.hが存在しないというエラーになって途中で止まりますがOK $ make # 停止したら実行 $ ./bin/x86_64/linux/release/deviceQuery ./bin/x86_64/linux/release/deviceQuery Starting…<br>CUDA Device Query (Runtime API) version (CUDART static linking)<br>Detected 1 CUDA Capable device(s)<br>Device 0: “GeForce GTX 750 Ti” CUDA Driver Version / Runtime Version 8.0 / 8.0 CUDA Capability Major/Minor version number: 5.0 Total amount of global memory: 2000 MBytes (2097414144 bytes) ( 5) Multiprocessors, (128) CUDA Cores/MP: 640 CUDA Cores GPU Max Clock rate: 1084 MHz (1.08 GHz) Memory Clock rate: 2700 Mhz Memory Bus Width: 128-bit L2 Cache Size: 2097152 bytes Maximum Texture Dimension Size (x,y,z) 1D=(65536), 2D=(65536, 65536), 3D=(4096, 4096, 4096) Maximum Layered 1D Texture Size, (num) layers 1D=(16384), 2048 layers Maximum Layered 2D Texture Size, (num) layers 2D=(16384, 16384), 2048 layers Total amount of constant memory: 65536 bytes Total amount of shared memory per block: 49152 bytes Total number of registers available per block: 65536 Warp size: 32 Maximum number of threads per multiprocessor: 2048 Maximum number of threads per block: 1024 Max dimension size of a thread block (x,y,z): (1024, 1024, 64) Max dimension size of a grid size (x,y,z): (2147483647, 65535, 65535) Maximum memory pitch: 2147483647 bytes Texture alignment: 512 bytes Concurrent copy and kernel execution: Yes with 1 copy engine(s) Run time limit on kernels: Yes Integrated GPU sharing Host Memory: No Support host page-locked memory mapping: Yes Alignment requirement for Surfaces: Yes Device has ECC support: Disabled Device supports Unified Addressing (UVA): Yes Device PCI Domain ID / Bus ID / location ID: 0 / 1 / 0 Compute Mode: &lt; Default (multiple host threads can use ::cudaSetDevice() with device simultaneously) &gt;<br>deviceQuery, CUDA Driver = CUDART, CUDA Driver Version = 8.0, CUDA Runtime Version = 8.0, NumDevs = 1, Device0 = GeForce GTX 750 Ti Result = PASS [/code]</p>
<h2 id="GPUの検証2"><a href="#GPUの検証2" class="headerlink" title="GPUの検証2"></a>GPUの検証2</h2><p>[code lang=”sh”] $ nvidia-smi Sun Apr 23 22:14:27 2017 +—————————————————————————–+ | NVIDIA-SMI 375.51 Driver Version: 375.51 | |——————————-+———————-+———————-+ | GPU Name Persistence-M| Bus-Id Disp.A | Volatile Uncorr. ECC | | Fan Temp Perf Pwr:Usage/Cap| Memory-Usage | GPU-Util Compute M. | |===============================+======================+======================| | 0 GeForce GTX 750 Ti On | 0000:01:00.0 On | N/A | | 40% 31C P8 1W / 38W | 140MiB / 2000MiB | 0% Default | +——————————-+———————-+———————-+<br>+—————————————————————————–+ | Processes: GPU Memory | | GPU PID Type Process name Usage | |=============================================================================| | 0 1361 G /usr/bin/X 99MiB | | 0 2075 G compiz 39MiB | +—————————————————————————–+ [/code]</p>
<h2 id="NVIDIA-Cuda-compiler"><a href="#NVIDIA-Cuda-compiler" class="headerlink" title="NVIDIA Cuda compiler"></a>NVIDIA Cuda compiler</h2><p>[code lang=”sh”] $ /usr/local/cuda-8.0/bin/nvcc -V nvcc: NVIDIA (R) Cuda compiler driver Copyright (c) 2005-2016 NVIDIA Corporation Built on Tue_Jan_10_13:22:03_CST_2017 Cuda compilation tools, release 8.0, V8.0.61 [/code] 無事に動きました。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-04-23</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Linux/" title="Linux">Linux </a><a class="tag" href="/categories/linux/" title="linux">linux </a><a class="tag" href="/categories/e3-83-87-e3-82-a3-e3-83-bc-e3-83-97-e3-83-a9-e3-83-bc-e3-83-8b-e3-83-b3-e3-82-b0/" title="%e3%83%87%e3%82%a3%e3%83%bc%e3%83%97%e3%83%a9%e3%83%bc%e3%83%8b%e3%83%b3%e3%82%b0">%e3%83%87%e3%82%a3%e3%83%bc%e3%83%97%e3%83%a9%e3%83%bc%e3%83%8b%e3%83%b3%e3%82%b0 </a><a class="tag" href="/categories/e3-83-87-e3-82-a3-e3-83-bc-e3-83-97-e3-83-a9-e3-83-bc-e3-83-8b-e3-83-b3-e3-82-b0/Caffe/" title="Caffe">Caffe </a><a class="tag" href="/categories/linux/Ubuntu/" title="Ubuntu">Ubuntu </a><a class="tag" href="/categories/ディープラーニング/" title="ディープラーニング">ディープラーニング </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2017/04/23/2148/,A certain engineer &quot;COMPLEX&quot;,ディープラーニング Caffe その3 環境構築 with GPU,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/04/27/2178/" title="開発メモ その54 BitNami Redmine Statckでthinが動かない原因を探る">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/04/23/2110/" title=".NET Core 2.0 PreviewとVisual Studio Codeでコンソールアプリをつくる 準備&amp;作成編">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script></body></html>