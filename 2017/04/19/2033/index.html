<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>Raspberry Pi 3をUSBからブートする (失敗) · A certain engineer "COMPLEX"</title><meta name="description" content="Introduction前回、SDカードを使ってマウス、キーボード、ディスプレイなしでRaspberry Pi 3のセットアップを完了。 でも、SDカードって信用できないのね。 USBメモリのがまだましって感じ。 USBメモリのが扱いやすいしね。 あんな小さい筐体に32GBや64GBとか狂気の沙汰や"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/hexo-tag-blog-card.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Raspberry Pi 3をUSBからブートする (失敗)</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>前回、SDカードを使ってマウス、キーボード、ディスプレイなしで<strong>Raspberry Pi 3</strong>のセットアップを完了。 でも、SDカードって信用できないのね。 USBメモリのがまだましって感じ。 USBメモリのが扱いやすいしね。 あんな小さい筐体に32GBや64GBとか狂気の沙汰やで。 今回は下記を参考にしてセットアップしました。 有益な情報ありがとうございます。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://jyn.jp/raspberrypi-usb-only-boot/" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=jyn.jp"></img><div class="hbc-site-name">純規の暇人趣味ブログ</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img src="https://jyn.jp/wp-core/wp-content/uploads/2016/05/raspberrypi-usb-boot-001.jpg"></img></div><div class="hbc-text"><div class="hbc-title">Raspberry PiをUSB(HDD)だけで動かす(SD不要) | 純規の暇人趣味ブログ</div><div class="hbc-url">https://jyn.jp/raspberrypi-usb-only-boot/</div><div class="hbc-description">「Raspberry PiをUSB(HDD)で起動させる」というやり方は既にあります。しかし、これは単にデータ(OS)の部分をHDDに移しただけであり、依然としてブートローダとなるSDカードは必要でした。比較的新しめのRaspberry Piでは、ブートローダーとなるSDカードす…</div></div></div></div></a></div></div>

<h1 id="用意するもの"><a href="#用意するもの" class="headerlink" title="用意するもの"></a>用意するもの</h1><ul>
<li>USBメモリ</li>
</ul>
<p>以上。</p>
<h1 id="ファームウェア更新"><a href="#ファームウェア更新" class="headerlink" title="ファームウェア更新"></a>ファームウェア更新</h1><p>新しいファームでないとUSBブートはできない模様。 下記のブログによれば、安易に後述のコマンドで更新するのは非推奨の模様。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://raspberrypi.akaneiro.jp/archives/1431" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=raspberrypi.akaneiro.jp"></img><div class="hbc-site-name">Raspberry Pi</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img src="https://s0.wp.com/i/blank.jpg"></img></div><div class="hbc-text"><div class="hbc-title">Raspberry Pi のファームウェアのアップデート</div><div class="hbc-url">https://raspberrypi.akaneiro.jp/archives/1431</div><div class="hbc-description">Raspberry Pi の最新ファームウェアは、Raspbian から rpi-update コマンドでアッ…</div></div></div></div></a></div></div>

<p>[code lang=”sh”] # まずはパッケージリストを更新 sudo apt-get update # ファームウェアの最新版を取得 sudo apt-get install -y rpi-update # 更新を実行 sudo rpi-update<br># USBブートを有効 echo “program_usb_boot_mode=1” | sudo tee -a /boot/config.txt<br># 再起動 sudo shutdown -r now [/code] 再起動後、下記の結果になることを確認。 [code lang=”sh”] $ vcgencmd otp_dump | grep 17: 17:3020000a [/code]</p>
<h1 id="USBにパーティションを作成"><a href="#USBにパーティションを作成" class="headerlink" title="USBにパーティションを作成"></a>USBにパーティションを作成</h1><p>USBを差し込みます。 当然、この後フォーマットするからデータが消えます。 差し込んだ後、下記のコマンドで、Deviceに差し込んだUSBが表示されていることを確認。 [code lang=”sh”] # sudo fdisk -l<br>Device Boot Start End Sectors Size Id Type /dev/mmcblk0p1 8192 92159 83968 41M c W95 FAT32 (LBA) /dev/mmcblk0p2 92160 62333951 62241792 29.7G 83 Linux<br>Disk /dev/sda: 28.9 GiB, 30995906560 bytes, 60538880 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0x545445f1<br>Device Boot Start End Sectors Size Id Type /dev/sda1 * 8064 60538879 60530816 28.9G c W95 FAT32 (LBA) [/code] <strong>/dev/sda</strong>にデバイスがあることが確認できたので、下記のコマンドでパーティションを作成します。 しかし、<strong>sudo fdisk -l</strong>でデバイスが使用中になってしまった模様。 なので、再起動します。 [code lang=”sh”] $ sudo parted /dev/sda GNU Parted 3.2 Using /dev/sda Welcome to GNU Parted! Type ‘help’ to view a list of commands. (parted) mktable msdos Warning: Partition(s) on /dev/sda are being used. Ignore/Cancel? Ignore Warning: The existing disk label on /dev/sda will be destroyed and all data on this disk will be lost. Do you want to continue? Yes/No? Yes Error: Partition(s) 1 on /dev/sda have been written, but we have been unable to inform the kernel of the change, probably because it/they are in use. As a result, the old partition(s) will remain in use. You should reboot now before making further changes. Ignore/Cancel? Ignore [/code] 再起動後、再度コマンドを実施。 [code lang=”sh”] $ sudo parted /dev/sda GNU Parted 3.2 Using /dev/sda Welcome to GNU Parted! Type ‘help’ to view a list of commands. (parted) mktable msdos Warning: The existing disk label on /dev/sda will be destroyed and all data on this disk will be lost. Do you want to continue? Yes/No? Yes (parted) mkpart primary fat32 0% 100M (parted) mkpart primary ext4 100M 100% (parted) print Model: TDK LoR TF10 (scsi) Disk /dev/sda: 31.0GB Sector size (logical/physical): 512B/512B Partition Table: msdos Disk Flags:<br>Number Start End Size Type File system Flags 1 1049kB 99.6MB 98.6MB primary fat32 lba 2 99.6MB 31.0GB 30.9GB primary ext4 lba<br>(parted) quit Information: You may need to update /etc/fstab. [/code] 上記によって、**/dev/sda1<strong>と</strong>/dev/sda2**が作成されます。 続いて、フォーマット [code lang=”sh”] $ sudo mkfs.vfat -n BOOT -F 32 /dev/sda1 sudo mkfs.ext4 /dev/sda2mkfs.fat 3.0.27 (2014-11-12) $ sudo mkfs.ext4 /dev/sda2 mke2fs 1.42.12 (29-Aug-2014) Creating filesystem with 7543040 4k blocks and 1888656 inodes Filesystem UUID: 4b3bdbe7-f63e-46a4-ad88-7e2a00bd40a1 Superblock backups stored on blocks: 32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 4096000<br>Allocating group tables: done Writing inode tables: done Creating journal (32768 blocks): done Writing superblocks and filesystem accounting information: done [/code]</p>
<h1 id="SDカードの複製"><a href="#SDカードの複製" class="headerlink" title="SDカードの複製"></a>SDカードの複製</h1><p>SDカードに全データが入っている状態なので、USBにコピーします。 <strong>rsync</strong>で複製ができる模様。 [code lang=”sh”] $ sudo apt-get install -y rsync [/code] 次に、フォーマットした領域をマウントします。 Linuxは直接デバイスにアクセスするのに<strong>mount</strong>が必要なので面倒。 いや、Windowsも背後でExplorerに表示するために、ドライブという形でマウントはしているんですけど… 下記は、**/mnt/target<strong>、</strong>/mnt/target/boot<strong>を作成し、そこにそれぞれ</strong>/dev/sda2<strong>と</strong>/dev/sda2**をマウントします。 その後、rsyncでコピーを開始します。 [code lang=”sh”] sudo mkdir -p /mnt/target sudo mount /dev/sda2 /mnt/target/ sudo mkdir /mnt/target/boot sudo mount /dev/sda1 /mnt/target/boot/ sudo rsync -ax –progress / /boot /mnt/target [/code]</p>
<h1 id="ブート情報の編集"><a href="#ブート情報の編集" class="headerlink" title="ブート情報の編集"></a>ブート情報の編集</h1><p>参考ページの手順だと上手くいきませんでしたので、頑張って調べました。 まず、デバイスを一意に識別する<strong>PARTUUID</strong>を調べます。 これにより、デバイスファイル名が変わっても安心。 [code lang=”sh”] sudo blkid /dev/mmcblk0p1: LABEL=”boot” UUID=”95E0-9AC4” TYPE=”vfat” PARTUUID=”85d563bf-01” /dev/mmcblk0p2: UUID=”b105f9a8-f450-4976-8ac8-69053f57bab4” TYPE=”ext4” PARTUUID=”85d563bf-02” /dev/sda1: LABEL=”BOOT” UUID=”87CD-DAAB” TYPE=”vfat” PARTUUID=”a40eeb1f-01” /dev/mmcblk0: PTUUID=”85d563bf” PTTYPE=”dos” /dev/sda2: UUID=”4b3bdbe7-f63e-46a4-ad88-7e2a00bd40a1” TYPE=”ext4” PARTUUID=”a40eeb1f-02” [/code] 次に**/mnt/target/boot/cmdline.txt<strong>を確認します。 **cmdline.txt</strong>は、起動時にLinux Kernelに渡されるコマンド引数を記述したテキストとのこと。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="http://elinux.org/RPi_cmdline.txt" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=elinux.org"></img><div class="hbc-site-name">elinux.org</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">RPi cmdline.txt - eLinux.org</div><div class="hbc-url">http://elinux.org/RPi_cmdline.txt</div></div></div></div></a></div></div>

<p>[code lang=”sh”] cat /mnt/target/boot/cmdline.txt dwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=PARTUUID=85d563bf-02 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait quiet splash plymouth.ignore-serial-consoles [/code] <strong>root=PARTUUID=85d563bf-02</strong>になっているのを修正する必要があります。 そこで先ほどの<strong>blkid</strong>で調べたPARTUUIDを調べます。 USBメモリのext4になっているPARTUUIDは<strong>a40eeb1f-02</strong>になります。 続いて、**/mnt/target/etc/fstab<strong>を確認します。 **fstab</strong>は<strong>file system table</strong>の略らしい。 起動時に<strong>mount</strong>に読み込まれるコマンドになります。 [code lang=”sh”] $ cat /mnt/target/etc/fstab proc /proc proc defaults 0 0 PARTUUID=85d563bf-01 /boot vfat defaults 0 2 PARTUUID=85d563bf-02 / ext4 defaults,noatime 0 1 # a swapfile is not a swap partition, no line here # use dphys-swapfile swap[on|off] for that [/code] <strong>PARTUUID=85d563bf</strong>はSDカードを指しています。 これを<strong>a40eeb1f</strong>に置換すれば、全部変換できそうです。 以上より、下記のコマンドでファイルを書き換えます。 当然、上述のPARTUUIDは環境依存ですので適宜書き換えてください。 [code lang=”sh”] sudo sed -i.bak “s,85d563bf,a40eeb1f,” /mnt/target/boot/cmdline.txt sudo sed -i.bak “s,85d563bf,a40eeb1f,” /mnt/target/etc/fstab [/code] ちなみに、<strong>sed</strong>はテキストとかの文字列を編集したりするコマンド。 String Editorの略だと思っていたら、<strong>Stream Editor</strong>の略らしい。 <strong>-i.bak</strong>で拡張子bakで編集前のファイルのバックアップを取ってから**i(in place)**を実行します。</p>
<h1 id="再起動"><a href="#再起動" class="headerlink" title="再起動"></a>再起動</h1><p>アンマウントして再起動します。 再起動と言っても、一度SDカードを抜く必要があるので、電源を落とします。 [code lang=”sh”] cd ~ sudo umount /mnt/target/boot sudo umount /mnt/target sudo shutdown -h now [/code] 電源が落ちたら、SDカードを抜いて、電源プラグを差し直します。 するとまた勝手に起動します。</p>
<h2 id="起動しない-ﾟдﾟ"><a href="#起動しない-ﾟдﾟ" class="headerlink" title="起動しない(ﾟдﾟ)"></a>起動しない(ﾟдﾟ)</h2><p>なんでやねん。 最新版はダメなのか、USBメモリがダメなのか、原因は不明。 とりあえず今回はここまで。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-04-19</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Linux/" title="Linux">Linux </a><a class="tag" href="/categories/linux/" title="linux">linux </a><a class="tag" href="/categories/IoT/" title="IoT">IoT </a><a class="tag" href="/categories/iot/" title="iot">iot </a><a class="tag" href="/categories/linux/Raspbian/" title="Raspbian">Raspbian </a><a class="tag" href="/categories/iot/Raspberry-Pi/" title="Raspberry Pi">Raspberry Pi </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2017/04/19/2033/,A certain engineer &quot;COMPLEX&quot;,Raspberry Pi 3をUSBからブートする (失敗),;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/04/20/2068/" title="開発メモ その45 Repodata is over 2 weeks old. Install yum-cron? Or run: yum makecache fast">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/04/19/2061/" title="MAXPATH">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>