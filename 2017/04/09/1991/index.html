<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>.NETでRPCを試してみる Apache Thrift編 第0回 · A certain engineer "COMPLEX"</title><meta name="description" content="Introduction.NETでRPCを試してみる gRPC編 第0回のように、最新のRPCとしてgRPCを試しました。 さまざまな言語をサポートしているので、C++でしか動かない (C#のP/InvokeやC++/CLIからも動作しない) ライブラリをRPCで動かそうと思いました。 ところが、C"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>.NETでRPCを試してみる Apache Thrift編 第0回</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p><a target="_blank" rel="noopener" href="https://taktak.jp/2017/03/26/1924">.NETでRPCを試してみる gRPC編 第0回</a>のように、最新のRPCとして<strong>gRPC</strong>を試しました。 さまざまな言語をサポートしているので、C++でしか動かない (C#のP/InvokeやC++/CLIからも動作しない) ライブラリをRPCで動かそうと思いました。 ところが、C++でgRPCを動かすのは面倒な模様。</p>
<ul>
<li>CMake</li>
<li>Active State Perl</li>
<li>Ninja</li>
<li>Go</li>
<li>yasm</li>
</ul>
<p>といったモジュールのインストールが必要のため断念。 かわりに見つけたのが<strong>Apache Thrift</strong>。 こちらも、クライアント/サーバーのコードを生成して利用するため、ロジックの実装に注力できるRPCフレームワーク。 公式は下記。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://thrift.apache.org/" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=thrift.apache.org"></img><div class="hbc-site-name">thrift.apache.org</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">Apache Thrift - Home</div><div class="hbc-url">https://thrift.apache.org/</div></div></div></div></a></div></div>

<p>今回は、クライアントをC#、サーバーをC++として試してみます。</p>
<h1 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h1><p>Thriftのライブラリは自分でビルドする必要があります。 そのために、下記の手順で、関連ライブラリなどを入手していきます。</p>
<h2 id="boost"><a href="#boost" class="headerlink" title="boost"></a>boost</h2><p><a target="_blank" rel="noopener" href="https://sourceforge.net/projects/boost/">Boost C++ Libraries</a>からインストーラを落としてきて展開します。 2017/04/09時点で、1.63が安定版の最新です。</p>
<h2 id="OpenSSL"><a href="#OpenSSL" class="headerlink" title="OpenSSL"></a>OpenSSL</h2><p><strong>Heartbleed</strong>でも有名になったSSLのライブラリですね。公式ページは下記。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://www.openssl.org/" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=www.openssl.org"></img><div class="hbc-site-name">www.openssl.org</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">
  /index.html
  </div><div class="hbc-url">https://www.openssl.org/</div></div></div></div></a></div></div>

<p>OpenSSLは、2017/04/09時点で、1.1.0eが安定版の最新ですが、1.1.0系はネット上で転がっている情報が少ないし、ビルド方法が違っていて、ビルドできなかったので、1.0.2系を使います。 2017/04/09時点で、1.0.2jが1.0.2系の最新です。 一応説明すると、バイナリの入手は2通りあります。</p>
<ul>
<li>有志が配布しているバイナリの入手<ul>
<li>現在有志が配布していて、最新版はインストーラのみで環境が汚れてしまう、かつ寄付を求められます。</li>
</ul>
</li>
<li>自分でビルド<ul>
<li>Perlのインストールが必要で、環境が汚れてしまう。</li>
<li>Perlの有名どころの<strong>ActivePerl</strong>は無償と有償がある。企業利用でも、<strong>pre-production development and prototyping</strong>なら無償版が使える。<ul>
<li>ビルドのためだけなので無償版でOK?</li>
</ul>
</li>
<li>最近は、<a target="_blank" rel="noopener" href="http://strawberryperl.com/">Strawberry Perl</a>というのがあり、かつzipのようなポータブル版もある。</li>
</ul>
</li>
</ul>
<p>というわけで、インストーラは嫌なので、今回は自分でビルドするために、Strawberry PerlのPortable版を入手しました。 2017/04/09時点で、Strawberry Perlは、5.24.1.1が安定版の最新です。 Portable版でも123MBあります。展開後は、400MBを超えますのでディスク容量には注意。 Strawberry Perlを展開後、<code>スタート &gt; 全てのプログラム &gt; Visual Studio 2015 &gt; Windows Desktop Command Prompts &gt; VS2015 x64 Native Tools コマンド プロンプト</code>を起動、そしてStrawberry Perlの展開先まで移動し、下記のように実行します。 [code lang=”batch”] D:\Works\Lib\Strawberry Perl\5.24.1.1&gt;portableshell.bat ———————————————- Welcome to Strawberry Perl Portable Edition! * URL - <a target="_blank" rel="noopener" href="http://www.strawberryperl.com/">http://www.strawberryperl.com/</a> * see README.TXT for more info ———————————————- Perl executable: D:\Works\Lib\Strawberry Perl\5.24.1.1\perl\bin\perl.exe Perl version : 5.24.1 / MSWin32-x64-multi-thread [/code] 続いて、OpenSSLの展開先まで移動します。そして、下記のように実行します。 [code lang=”batch”] c:\openssl-1.0.2j&gt;mkdir “openssl-1.0.2j_x64_VC-WIN” c:\openssl-1.0.2j&gt;set TARGET=%CD%\openssl-1.0.2j_x64_VC-WIN c:\openssl-1.0.2j&gt;perl Configure VC-WIN64A –prefix=”%TARGET%” no-asm Configuring for VC-WIN64A no-asm [option] OPENSSL_NO_ASM no-ec_nistp_64_gcc_128 [default] OPENSSL_NO_EC_NISTP_64_GCC_128 (skip dir) no-gmp [default] OPENSSL_NO_GMP (skip dir) no-jpake [experimental] OPENSSL_NO_JPAKE (skip dir) no-krb5 [krb5-flavor not specified] OPENSSL_NO_KRB5 no-libunbound [experimental] OPENSSL_NO_LIBUNBOUND (skip dir) no-md2 [default] OPENSSL_NO_MD2 (skip dir) no-rc5 [default] OPENSSL_NO_RC5 (skip dir) no-rfc3779 [default] OPENSSL_NO_RFC3779 (skip dir) no-sctp [default] OPENSSL_NO_SCTP (skip dir) no-shared [default] no-ssl-trace [default] OPENSSL_NO_SSL_TRACE (skip dir) no-ssl2 [default] OPENSSL_NO_SSL2 (skip dir) no-store [experimental] OPENSSL_NO_STORE (skip dir) no-unit-test [default] OPENSSL_NO_UNIT_TEST (skip dir) no-weak-ssl-ciphers [default] OPENSSL_NO_WEAK_SSL_CIPHERS (skip dir) no-zlib [default] no-zlib-dynamic [default] IsMK1MF=1 CC =cl CFLAG =-DOPENSSL_THREADS -DDSO_WIN32 -W3 -Gs0 -Gy -nologo -DOPENSSL_SYS NAME_WIN32 -DWIN32_LEAN_AND_MEAN -DL_ENDIAN -DUNICODE -D_UNICODE -D_CRT_SECURE_NO_DEPRECATE EX_LIBS = CPUID_OBJ =mem_clr.o BN_ASM =bn_asm.o EC_ASM = DES_ENC =des_enc.o fcrypt_b.o AES_ENC =aes_core.o aes_cbc.o BF_ENC =bf_enc.o CAST_ENC =c_enc.o RC4_ENC =rc4_enc.o rc4_skey.o RC5_ENC =rc5_enc.o MD5_OBJ_ASM = SHA1_OBJ_ASM = RMD160_OBJ_ASM= CMLL_ENC =camellia.o cmll_misc.o cmll_cbc.o MODES_OBJ = ENGINES_OBJ = PROCESSOR = RANLIB =true ARFLAGS = PERL =perl SIXTY_FOUR_BIT mode DES_INT used RC4_CHUNK is unsigned long long<br>Configured for VC-WIN64A. [/code] 次に、<strong>do_win64a.bat</strong>というバッチを実行します。 [code lang=”batch”] C:\openssl-1.0.2j&gt;ms\do_win64a.bat<br>C:\openssl-1.0.2j&gt;perl util\mkfiles.pl 1&gt;MINFO<br>C:\openssl-1.0.2j&gt;cmd /c “nasm -f win64 -v” 1&gt;NUL 2&gt;&amp;1<br>C:\openssl-1.0.2j&gt;if 0 NEQ 0 goto ml64<br>C:\openssl-1.0.2j&gt;perl ms\uplink-x86_64.pl nasm 1&gt;ms\uptable.asm<br>C:\openssl-1.0.2j&gt;nasm -f win64 -o ms\uptable.obj ms\uptable.asm ms\uptable.asm:17: warning: absolute address can not be RIP-relative ms\uptable.asm:24: warning: absolute address can not be RIP-relative ms\uptable.asm:37: warning: absolute address can not be RIP-relative ms\uptable.asm:44: warning: absolute address can not be RIP-relative ms\uptable.asm:57: warning: absolute address can not be RIP-relative ms\uptable.asm:64: warning: absolute address can not be RIP-relative ms\uptable.asm:77: warning: absolute address can not be RIP-relative ms\uptable.asm:84: warning: absolute address can not be RIP-relative ms\uptable.asm:97: warning: absolute address can not be RIP-relative ms\uptable.asm:104: warning: absolute address can not be RIP-relative ms\uptable.asm:117: warning: absolute address can not be RIP-relative ms\uptable.asm:124: warning: absolute address can not be RIP-relative ms\uptable.asm:137: warning: absolute address can not be RIP-relative ms\uptable.asm:144: warning: absolute address can not be RIP-relative ms\uptable.asm:157: warning: absolute address can not be RIP-relative ms\uptable.asm:164: warning: absolute address can not be RIP-relative ms\uptable.asm:177: warning: absolute address can not be RIP-relative ms\uptable.asm:184: warning: absolute address can not be RIP-relative ms\uptable.asm:197: warning: absolute address can not be RIP-relative ms\uptable.asm:204: warning: absolute address can not be RIP-relative ms\uptable.asm:217: warning: absolute address can not be RIP-relative ms\uptable.asm:224: warning: absolute address can not be RIP-relative ms\uptable.asm:237: warning: absolute address can not be RIP-relative ms\uptable.asm:244: warning: absolute address can not be RIP-relative ms\uptable.asm:257: warning: absolute address can not be RIP-relative ms\uptable.asm:264: warning: absolute address can not be RIP-relative ms\uptable.asm:277: warning: absolute address can not be RIP-relative ms\uptable.asm:284: warning: absolute address can not be RIP-relative ms\uptable.asm:297: warning: absolute address can not be RIP-relative ms\uptable.asm:304: warning: absolute address can not be RIP-relative ms\uptable.asm:317: warning: absolute address can not be RIP-relative ms\uptable.asm:324: warning: absolute address can not be RIP-relative ms\uptable.asm:337: warning: absolute address can not be RIP-relative ms\uptable.asm:344: warning: absolute address can not be RIP-relative ms\uptable.asm:357: warning: absolute address can not be RIP-relative ms\uptable.asm:364: warning: absolute address can not be RIP-relative ms\uptable.asm:377: warning: absolute address can not be RIP-relative ms\uptable.asm:384: warning: absolute address can not be RIP-relative ms\uptable.asm:397: warning: absolute address can not be RIP-relative ms\uptable.asm:404: warning: absolute address can not be RIP-relative ms\uptable.asm:417: warning: absolute address can not be RIP-relative ms\uptable.asm:424: warning: absolute address can not be RIP-relative ms\uptable.asm:437: warning: absolute address can not be RIP-relative ms\uptable.asm:444: warning: absolute address can not be RIP-relative<br>C:\openssl-1.0.2j&gt;goto proceed<br>C:\openssl-1.0.2j&gt;perl util\mk1mf.pl VC-WIN64A 1&gt;ms\nt.mak<br>C:\openssl-1.0.2j&gt;perl util\mk1mf.pl dll VC-WIN64A 1&gt;ms\ntdll.mak<br>C:\openssl-1.0.2j&gt;perl util\mkdef.pl 32 libeay 1&gt;ms\libeay32.def<br>C:\openssl-1.0.2j&gt;perl util\mkdef.pl 32 ssleay 1&gt;ms\ssleay32.def [/code] 以上で、ビルドの準備ができました。 そして、下記のコマンドを実行することで、<strong>openssl-1.0.2j_x64_VC-WIN</strong>に成果物が出来上がります。 [code lang=”batch”] C:\openssl-1.0.2j&gt;nmake -f ms\nt.mak C:\openssl-1.0.2j&gt;nmake -f ms\nt.mak install [/code] 成功すると、</p>
<ul>
<li>openssl-1.0.2j_x64_VC-WIN\bin</li>
<li>openssl-1.0.2j_x64_VC-WIN\include</li>
<li>openssl-1.0.2j_x64_VC-WIN\lib</li>
<li>openssl-1.0.2j_x64_VC-WIN\ssl</li>
</ul>
<p>というフォルダができています。</p>
<h2 id="libevent"><a href="#libevent" class="headerlink" title="libevent"></a>libevent</h2><p>聞きなれないライブラリですが、公式ページ </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="http://libevent.org/" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=libevent.org"></img><div class="hbc-site-name">libevent.org</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">libevent</div><div class="hbc-url">http://libevent.org/</div></div></div></div></a></div></div>

<p>によれば、</p>
<blockquote>
<p>The libevent API provides a mechanism to execute a callback function when a specific event occurs on a file descriptor or after a timeout has been reached. Furthermore, libevent also support callbacks due to signals or regular timeouts. libevent is meant to replace the event loop found in event driven network servers</p>
</blockquote>
<p>とのこと。つまり、特定のイベントが発生したりしたら、コールバック関数を実行するメカニズムを提供するAPIがlibeventであり、イベントドリブンなネットワークサービス内のイベントループを置き換えるもの、とのこと。 確かに、C++ってイベントみたいな機構って、コールバックしかないし、それらをモジュールで積極的に使うってシーンがないから、こういうライブラリはありがたいのかも。 詳しい説明は例のごとくWikipedia。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://en.wikipedia.org/wiki/Libevent" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=en.wikipedia.org"></img><div class="hbc-site-name">en.wikipedia.org</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img></img></div><div class="hbc-text"><div class="hbc-title">libevent - Wikipedia</div><div class="hbc-url">https://en.wikipedia.org/wiki/Libevent</div></div></div></div></a></div></div>

<p>入手先は、公式ページの<strong>Download–Stable releases</strong>から。 2017/04/09時点で、2.1.8が安定版の最新です。 ソースからビルドするタイプです。 ビルドは簡単で、</p>
<ol>
<li><code>スタート &gt; 全てのプログラム &gt; Visual Studio 2015 &gt; 開発者コマンド プロンプト for VS2015</code> を開く</li>
<li>libeventの展開先フォルダに移動</li>
<li><strong>nmake -f Makefile.nmake</strong> を実行</li>
</ol>
<p>以上です。 終了時に、 [code lang=”batch”] NMAKE : fatal error U1073: ‘print-winsock-errors.obj’ のビルド方法が指定されていません。 Stop. NMAKE : fatal error U1077: ‘“C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\BIN\nmake.exe”‘ : リターン コード ‘0x2’ Stop. [/code] と表示されますが、 libevent.lib libevent_core.lib libevent_extras.lib が、フォルダに出来上がっています。</p>
<h2 id="Apache-Thrift-amp-Compiler"><a href="#Apache-Thrift-amp-Compiler" class="headerlink" title="Apache Thrift &amp; Compiler"></a>Apache Thrift &amp; Compiler</h2><p>ソースとコンパイラーを入手します。 <a target="_blank" rel="noopener" href="https://thrift.apache.org/download">Download</a>から、<strong>thrift-0.10.0.tar.gz</strong>、<strong>Thrift compiler for Windows</strong>をダウンロードします。 2017/04/09時点で、0.10.0が最新です。 コンパイラーといっても、<strong>gRPC tool</strong>のように、定義ファイルからコードを生成するだけのものです。 ソースは、任意の場所に展開します。 展開先の<strong>lib\cpp</strong>に<strong>thrift.sln</strong>があるので、Visual Studioで起動します。</p>
<h3 id="libthrift"><a href="#libthrift" class="headerlink" title="libthrift"></a>libthrift</h3><p>libthriftのプロパティを開きます。 <code>C/C++ -&gt; 全般</code>を開き、<strong>追加のインクルード ディレクトリ</strong>に下記を追加します。 [code] {boost_install_dir}\boost_X_YZ_0 {boost_install_dir}\boost_X_YZ_0\boost {openssl_install_dir}\include [/code] <code>ライブラリアン -&gt; 全般</code>を開き、<strong>追加のライブラリ ディレクトリ</strong>に下記を追加します。&gt;を開き、<strong>追加のライブラリ ディレクトリ</strong>に下記を追加します。 [code] {openss_install_dir}\lib [/code] 最後に、libthrift\concurrency\BoostThreadFactory.cppを<strong>プロジェクトから除外</strong>します。</p>
<h3 id="libthriftnb"><a href="#libthriftnb" class="headerlink" title="libthriftnb"></a>libthriftnb</h3><p>libthriftのプロパティを開きます。 <code>C/C++ -&gt; 全般</code>を開き、<strong>追加のインクルード ディレクトリ</strong>に下記を追加します。 [code] {boost_install_dir} {libevent_install_dir} {libevent_install_dir}\include {libevent_install_dir}\WIN32-Code\nmake [/code] 以上の設定を終えたら、ビルドが可能になります。 ソリューションでDebug/Release/Debug-mt/Release-mt、ターゲットプラットフォーム(x64/Win32)を選択してビルドします。</p>
<ul>
<li>libthriftnb.lib</li>
<li>libthrift.lib</li>
</ul>
<p>が生成されているはずです。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>今回は導入のみ。 次回は、C#-C++で通信してみます。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-04-09</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Microsoft/NET-Framework/" title=".NET Framework">.NET Framework </a><a class="tag" href="/categories/net-framework/" title="net-framework">net-framework </a><a class="tag" href="/categories/net-framework/NETで○○○を試してみる/" title=".NETで○○○を試してみる">.NETで○○○を試してみる </a><a class="tag" href="/categories/netで○○○を試してみる/" title="netで○○○を試してみる">netで○○○を試してみる </a><a class="tag" href="/categories/remote-procedure-call/" title="remote-procedure-call">remote-procedure-call </a><a class="tag" href="/categories/netで○○○を試してみる/NETでRPCを試してみる/" title=".NETでRPCを試してみる">.NETでRPCを試してみる </a><a class="tag" href="/categories/remote-procedure-call/Apache-Thrift/" title="Apache Thrift">Apache Thrift </a><a class="tag" href="/categories/Remote-Procedure-Call/" title="Remote Procedure Call">Remote Procedure Call </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2017/04/09/1991/,A certain engineer &quot;COMPLEX&quot;,.NETでRPCを試してみる Apache Thrift編 第0回,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/04/09/2004/" title=".NETでRPCを試してみる Apache Thrift編 第1回">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/04/06/1981/" title="開発メモ その41 OpenCVで非ユニコード文字列ファイル名を扱う">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>