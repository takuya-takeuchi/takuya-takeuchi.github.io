<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><link rel="icon" href="/images/favicon.ico" type="image/x-icon"><title>開発メモ その315 FFMPEG で libopenh264 を Windows で使う · A certain engineer "COMPLEX"</title><meta name="description" content="Introduction掲題の通り、FFMPEG で libopenh264 を Windows でビルドして使う方法。
H264 や H265 の特許にまみれたエンコーダのせいで、おちおち商用で使えないため、ここいらで本腰入れて作り方を習得した。ネットで転がっている記事はそれなりにあるが、手順はし"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>開発メモ その315 FFMPEG で libopenh264 を Windows で使う</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>掲題の通り、FFMPEG で <a target="_blank" rel="noopener" href="https://github.com/cisco/openh264">libopenh264</a> を Windows でビルドして使う方法。</p>
<p>H264 や H265 の特許にまみれたエンコーダのせいで、おちおち商用で使えないため、ここいらで本腰入れて作り方を習得した。<br>ネットで転がっている記事はそれなりにあるが、手順はしょってるし、libopenh264 が ffmpeg に埋め込まれていて、libopenh264 を使うことによるメリット <strong>ライセンス料支払いの免責</strong> が意味をなしてなかったりしてる。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/lembryo/ffmpeg">これ</a> とか。<br>libopenh264.dll を外しても普通に OpenH264 でエンコードを始めてしまう。<br>(マシン上に libopenh264.dll がどこにも存在しないことを確認した上で試したので間違いない)</p>
<h1 id="How-to-build"><a href="#How-to-build" class="headerlink" title="How to build?"></a>How to build?</h1><p>必要なものは下記</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.msys2.org/">MSYS2</a></li>
</ul>
<p>以前も MSYS2 は使ったことがあるが、正直あまり好きではない。<br>Ubuntu でのクロスコンパイルも試してみたが、どうしても libopenh264 のクロスコンパイルができなかったので、泣く泣く MSYS2 で対応。</p>
<h2 id="1-MSYS2-のセットアップ"><a href="#1-MSYS2-のセットアップ" class="headerlink" title="1. MSYS2 のセットアップ"></a>1. MSYS2 のセットアップ</h2><p>下記からダウンロード。</p>
<p><a href="../../../../public/2022/12/27/4474/msys2.png"><img src="../../../../public/2022/12/27/4474/msys2.png" alt="MSYS2" title="MSYS2"></a></p>
<p>手順に従ってインストールするだけ。<br>インストール先は変更しないほうが無難。</p>
<p><a href="../../../../public/2022/12/27/4474/install1.png"><img src="../../../../public/2022/12/27/4474/install1.png" alt="MSYS2" title="MSYS2"></a></p>
<p><a href="../../../../public/2022/12/27/4474/install2.png"><img src="../../../../public/2022/12/27/4474/install2.png" alt="MSYS2" title="MSYS2"></a></p>
<p><a href="../../../../public/2022/12/27/4474/install3.png"><img src="../../../../public/2022/12/27/4474/install3.png" alt="MSYS2" title="MSYS2"></a></p>
<p><a href="../../../../public/2022/12/27/4474/install4.png"><img src="../../../../public/2022/12/27/4474/install4.png" alt="MSYS2" title="MSYS2"></a></p>
<p><a href="../../../../public/2022/12/27/4474/install5.png"><img src="../../../../public/2022/12/27/4474/install5.png" alt="MSYS2" title="MSYS2"></a></p>
<h2 id="2-パッケージの更新"><a href="#2-パッケージの更新" class="headerlink" title="2. パッケージの更新"></a>2. パッケージの更新</h2><p><strong>MSYS2 MINGW64</strong> を起動。</p>
<p><a href="../../../../public/2022/12/27/4474/install6.png"><img src="../../../../public/2022/12/27/4474/install6.png" alt="MSYS2" title="MSYS2"></a></p>
<p>少し時間がかかるが、起動するとコンソールが表示される。</p>
<p>まず、パッケージマネージャの更新を実施。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pacman --needed -Sy bash pacman pacman-mirrors msys2-runtime</span></span><br><span class="line">:: Synchronizing package databases...</span><br><span class="line"> mingw32                        1757.2 KiB   815 KiB/s 00:02 [###############################] 100%</span><br><span class="line"> mingw64                        1772.4 KiB   680 KiB/s 00:03 [###############################] 100%</span><br><span class="line"> ucrt64                         1817.9 KiB   685 KiB/s 00:03 [###############################] 100%</span><br><span class="line"> clang32                        1738.5 KiB   818 KiB/s 00:02 [###############################] 100%</span><br><span class="line"> clang64                        1761.5 KiB   755 KiB/s 00:02 [###############################] 100%</span><br><span class="line"> msys                            414.6 KiB   355 KiB/s 00:01 [###############################] 100%</span><br><span class="line">warning: bash-5.2.009-1 is up to date -- skipping</span><br><span class="line">warning: pacman-mirrors-20221016-1 is up to date -- skipping</span><br><span class="line">resolving dependencies...</span><br><span class="line">looking for conflicting packages...</span><br><span class="line"></span><br><span class="line">Packages (2) msys2-runtime-3.4.3-4  pacman-6.0.1-26</span><br><span class="line"></span><br><span class="line">Total Download Size:    7.95 MiB</span><br><span class="line">Total Installed Size:  39.60 MiB</span><br><span class="line">Net Upgrade Size:      -4.68 MiB</span><br><span class="line"></span><br><span class="line">:: Proceed with installation? [Y/n] Y</span><br><span class="line">:: Retrieving packages...</span><br><span class="line"> msys2-runtime-3.4.3-4-x86_64      2.4 MiB  1701 KiB/s 00:01 [###############################] 100%</span><br><span class="line"> pacman-6.0.1-26-x86_64            5.5 MiB  2.35 MiB/s 00:02 [###############################] 100%</span><br><span class="line"> Total (2/2)                       7.9 MiB  3.10 MiB/s 00:03 [###############################] 100%</span><br><span class="line">(2/2) checking keys in keyring                               [###############################] 100%</span><br><span class="line">(2/2) checking package integrity                             [###############################] 100%</span><br><span class="line">(2/2) loading package files                                  [###############################] 100%</span><br><span class="line">(2/2) checking for file conflicts                            [###############################] 100%</span><br><span class="line">(2/2) checking available disk space                          [###############################] 100%</span><br><span class="line">:: Processing package changes...</span><br><span class="line">(1/2) upgrading pacman                                       [###############################] 100%</span><br><span class="line">(2/2) upgrading msys2-runtime                                [###############################] 100%</span><br></pre></td></tr></table></figure>

<p>完了後、MINGW64 を再起動。</p>
<p>次に、既にインストールされているパッケージを更新する。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pacman -Syuu</span></span><br><span class="line">:: Synchronizing package databases...</span><br><span class="line"> mingw32 is up to date</span><br><span class="line"> mingw64 is up to date</span><br><span class="line"> ucrt64 is up to date</span><br><span class="line"> clang32 is up to date</span><br><span class="line"> clang64 is up to date</span><br><span class="line"> msys is up to date</span><br><span class="line">:: Starting core system upgrade...</span><br><span class="line"> there is nothing to do</span><br><span class="line">:: Starting full system upgrade...</span><br><span class="line">resolving dependencies...</span><br><span class="line">looking for conflicting packages...</span><br><span class="line"></span><br><span class="line">Packages (13) brotli-1.0.9-5  bsdtar-3.6.2-3  curl-7.87.0-2  gawk-5.2.1-2  heimdal-libs-7.8.0-3</span><br><span class="line">              libcurl-7.87.0-2  liblzma-5.4.0-1  libopenssl-3.0.7-2  libpcre2_8-10.42-1</span><br><span class="line">              libssh2-1.10.0-3  nano-7.1-1  openssl-3.0.7-2  xz-5.4.0-1</span><br><span class="line"></span><br><span class="line">Total Download Size:    7.34 MiB</span><br><span class="line">Total Installed Size:  21.44 MiB</span><br><span class="line">Net Upgrade Size:       1.69 MiB</span><br><span class="line"></span><br><span class="line">:: Proceed with installation? [Y/n] Y</span><br><span class="line">:: Retrieving packages...</span><br><span class="line"> openssl-3.0.7-2-x86_64          661.0 KiB  1091 KiB/s 00:01 [###############################] 100%</span><br><span class="line"> gawk-5.2.1-2-x86_64            1224.1 KiB  1731 KiB/s 00:01 [###############################] 100%</span><br><span class="line"> heimdal-libs-7.8.0-3-x86_64     832.6 KiB   975 KiB/s 00:01 [###############################] 100%</span><br><span class="line"> curl-7.87.0-2-x86_64            916.2 KiB  1063 KiB/s 00:01 [###############################] 100%</span><br><span class="line"> libopenssl-3.0.7-2-x86_64      1603.9 KiB  1728 KiB/s 00:01 [###############################] 100%</span><br><span class="line"> brotli-1.0.9-5-x86_64           339.4 KiB   870 KiB/s 00:00 [###############################] 100%</span><br><span class="line"> nano-7.1-1-x86_64               640.8 KiB  1140 KiB/s 00:01 [###############################] 100%</span><br><span class="line"> xz-5.4.0-1-x86_64               319.0 KiB   795 KiB/s 00:00 [###############################] 100%</span><br><span class="line"> libcurl-7.87.0-2-x86_64         253.2 KiB   621 KiB/s 00:00 [###############################] 100%</span><br><span class="line"> bsdtar-3.6.2-3-x86_64           323.6 KiB   550 KiB/s 00:01 [###############################] 100%</span><br><span class="line"> libssh2-1.10.0-3-x86_64         192.5 KiB   486 KiB/s 00:00 [###############################] 100%</span><br><span class="line"> libpcre2_8-10.42-1-x86_64       125.0 KiB   342 KiB/s 00:00 [###############################] 100%</span><br><span class="line"> liblzma-5.4.0-1-x86_64           85.3 KiB   257 KiB/s 00:00 [###############################] 100%</span><br><span class="line"> Total (13/13)                     7.3 MiB  4.11 MiB/s 00:02 [###############################] 100%</span><br><span class="line">(13/13) checking keys in keyring                             [###############################] 100%</span><br><span class="line">(13/13) checking package integrity                           [###############################] 100%</span><br><span class="line">(13/13) loading package files                                [###############################] 100%</span><br><span class="line">(13/13) checking for file conflicts                          [###############################] 100%</span><br><span class="line">(13/13) checking available disk space                        [###############################] 100%</span><br><span class="line">:: Processing package changes...</span><br><span class="line">( 1/13) upgrading brotli                                     [###############################] 100%</span><br><span class="line">( 2/13) upgrading liblzma                                    [###############################] 100%</span><br><span class="line">( 3/13) upgrading libopenssl                                 [###############################] 100%</span><br><span class="line">( 4/13) upgrading bsdtar                                     [###############################] 100%</span><br><span class="line">( 5/13) upgrading heimdal-libs                               [###############################] 100%</span><br><span class="line">( 6/13) upgrading openssl                                    [###############################] 100%</span><br><span class="line">( 7/13) upgrading libpcre2_8                                 [###############################] 100%</span><br><span class="line">( 8/13) upgrading libssh2                                    [###############################] 100%</span><br><span class="line">( 9/13) upgrading libcurl                                    [###############################] 100%</span><br><span class="line">(10/13) upgrading curl                                       [###############################] 100%</span><br><span class="line">(11/13) upgrading gawk                                       [###############################] 100%</span><br><span class="line">(12/13) upgrading nano                                       [###############################] 100%</span><br><span class="line">(13/13) upgrading xz                                         [###############################] 100%</span><br><span class="line">:: Running post-transaction hooks...</span><br><span class="line">(1/1) Updating the info directory file...</span><br></pre></td></tr></table></figure>

<h2 id="3-パッケージの準備"><a href="#3-パッケージの準備" class="headerlink" title="3. パッケージの準備"></a>3. パッケージの準備</h2><p>ここからビルドに必要なものをインストール。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pacman -S mingw-w64-x86_64-gcc mingw-w64-x86_64-yasm mingw-w64-x86_64-pkg-config git make diffutils</span></span><br><span class="line">resolving dependencies...</span><br><span class="line">looking for conflicting packages...</span><br><span class="line">warning: dependency cycle detected:</span><br><span class="line">warning: mingw-w64-x86_64-gcc-libs will be installed before its mingw-w64-x86_64-mpc dependency</span><br><span class="line">warning: dependency cycle detected:</span><br><span class="line">warning: mingw-w64-x86_64-gcc-libs will be installed before its mingw-w64-x86_64-mpfr dependency</span><br><span class="line"></span><br><span class="line">Packages (54) heimdal-7.8.0-3  libcbor-0.9.0-1  libfido2-1.12.0-2  mingw-w64-x86_64-binutils-2.39-2</span><br><span class="line">              mingw-w64-x86_64-crt-git-10.0.0.r186.gfc55e181b-1  mingw-w64-x86_64-expat-2.5.0-1</span><br><span class="line">              mingw-w64-x86_64-gcc-libs-12.2.0-6  mingw-w64-x86_64-gettext-0.21-3</span><br><span class="line">              mingw-w64-x86_64-gmp-6.2.1-4  mingw-w64-x86_64-headers-git-10.0.0.r186.gfc55e181b-1</span><br><span class="line">              mingw-w64-x86_64-isl-0.25-1  mingw-w64-x86_64-libiconv-1.17-1</span><br><span class="line">              mingw-w64-x86_64-libwinpthread-git-10.0.0.r186.gfc55e181b-1</span><br><span class="line">              mingw-w64-x86_64-mpc-1.3.1-1  mingw-w64-x86_64-mpfr-4.1.1.p1-2</span><br><span class="line">              mingw-w64-x86_64-windows-default-manifest-6.4-4</span><br><span class="line">              mingw-w64-x86_64-winpthreads-git-10.0.0.r186.gfc55e181b-1</span><br><span class="line">              mingw-w64-x86_64-zlib-1.2.13-2  mingw-w64-x86_64-zstd-1.5.2-2  openssh-9.1p1-2</span><br><span class="line">              perl-Authen-SASL-2.16-2  perl-Clone-0.45-3  perl-Convert-BinHex-1.125-1</span><br><span class="line">              perl-Encode-Locale-1.05-1  perl-Error-0.17029-1  perl-File-Listing-6.15-1</span><br><span class="line">              perl-HTML-Parser-3.80-1  perl-HTML-Tagset-3.20-2  perl-HTTP-Cookies-6.10-1</span><br><span class="line">              perl-HTTP-Daemon-6.14-1  perl-HTTP-Date-6.05-1  perl-HTTP-Message-6.44-1</span><br><span class="line">              perl-HTTP-Negotiate-6.01-2  perl-IO-HTML-1.004-1  perl-IO-Socket-SSL-2.077-1</span><br><span class="line">              perl-IO-Stringy-2.113-1  perl-LWP-MediaTypes-6.04-1  perl-MIME-tools-5.510-1</span><br><span class="line">              perl-MailTools-2.21-1  perl-Net-HTTP-6.22-1  perl-Net-SMTP-SSL-1.04-1</span><br><span class="line">              perl-Net-SSLeay-1.92-3  perl-TermReadKey-2.38-4  perl-TimeDate-2.33-1</span><br><span class="line">              perl-Try-Tiny-0.31-1  perl-URI-5.16-1  perl-WWW-RobotRules-6.02-2  perl-libwww-6.67-1</span><br><span class="line">              diffutils-3.8-4  git-2.39.0-2  make-4.4-1  mingw-w64-x86_64-gcc-12.2.0-6</span><br><span class="line">              mingw-w64-x86_64-pkg-config-0.29.2-3  mingw-w64-x86_64-yasm-1.3.0-4</span><br><span class="line"></span><br><span class="line">Total Download Size:    61.80 MiB</span><br><span class="line">Total Installed Size:  472.23 MiB</span><br><span class="line"></span><br><span class="line">:: Proceed with installation? [Y/n] Y</span><br><span class="line">:: Retrieving packages...</span><br><span class="line"> mingw-w64-x86_64-binutils-2.39-2-any                       5.9 MiB  2.73 MiB/s 00:02 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-gettext-0.21-3-any                        3.1 MiB  2.09 MiB/s 00:01 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-isl-0.25-1-any                         1396.6 KiB  1042 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-crt-git-10.0.0.r186.gfc55e181b-1-any      3.3 MiB   618 KiB/s 00:05 [#################################################] 100%</span><br><span class="line"> openssh-9.1p1-2-x86_64                                   945.1 KiB   942 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-gcc-libs-12.2.0-6-any                   876.7 KiB   602 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-libiconv-1.17-1-any                     720.2 KiB   808 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-gmp-6.2.1-4-any                         571.9 KiB   697 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> heimdal-7.8.0-3-x86_64                                   544.5 KiB   641 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> git-2.39.0-2-x86_64                                        6.2 MiB   740 KiB/s 00:09 [#################################################] 100%</span><br><span class="line"> make-4.4-1-x86_64                                        501.7 KiB   660 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-yasm-1.3.0-4-any                        511.1 KiB   510 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-zstd-1.5.2-2-any                        494.9 KiB   600 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> diffutils-3.8-4-x86_64                                   363.9 KiB   596 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-mpfr-4.1.1.p1-2-any                     415.6 KiB   530 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-headers-git-10.0.0.r186.gfc55e181b...     5.6 MiB   592 KiB/s 00:10 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-pkg-config-0.29.2-3-any                 262.8 KiB   515 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> perl-Net-SSLeay-1.92-3-x86_64                            209.9 KiB   397 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> perl-IO-Socket-SSL-2.077-1-any                           156.7 KiB   363 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-MIME-tools-5.510-1-any                              183.6 KiB   333 KiB/s 00:01 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-expat-2.5.0-1-any                       155.8 KiB   361 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-libwww-6.67-1-any                                   129.8 KiB   301 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-mpc-1.3.1-1-any                         104.4 KiB   267 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-zlib-1.2.13-2-any                       103.7 KiB   241 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-MailTools-2.21-1-any                                 81.0 KiB   214 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-HTML-Parser-3.80-1-x86_64                            80.5 KiB   215 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-URI-5.16-1-any                                       80.3 KiB   214 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-HTTP-Message-6.44-1-any                              77.1 KiB   178 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> libfido2-1.12.0-2-x86_64                                  76.8 KiB   199 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-IO-Stringy-2.113-1-any                               66.4 KiB   173 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-TimeDate-2.33-1-any                                  55.2 KiB   145 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-Convert-BinHex-1.125-1-any                           42.8 KiB   115 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-Authen-SASL-2.16-2-any                               42.4 KiB   126 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-LWP-MediaTypes-6.04-1-any                            40.7 KiB   125 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-winpthreads-git-10.0.0.r186.gfc55e...    40.1 KiB   113 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-Error-0.17029-1-any                                  39.4 KiB   107 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-libwinpthread-git-10.0.0.r186.gfc5...    29.0 KiB  77.0 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-HTTP-Date-6.05-1-any                                 28.9 KiB  84.3 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-Encode-Locale-1.05-1-any                             24.3 KiB  73.1 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-HTTP-Cookies-6.10-1-any                              23.4 KiB  70.3 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-Net-HTTP-6.22-1-any                                  23.1 KiB  68.0 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-TermReadKey-2.38-4-x86_64                            21.1 KiB  62.9 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-Try-Tiny-0.31-1-any                                  19.8 KiB  59.8 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-HTTP-Daemon-6.14-1-any                               18.6 KiB  57.3 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-Net-SMTP-SSL-1.04-1-any                              18.4 KiB  57.1 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> libcbor-0.9.0-1-x86_64                                    18.0 KiB  53.9 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-IO-HTML-1.004-1-any                                  16.1 KiB  47.5 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-WWW-RobotRules-6.02-2-any                            12.2 KiB  37.5 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-HTTP-Negotiate-6.01-2-any                            11.4 KiB  35.1 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-File-Listing-6.15-1-any                              10.9 KiB  32.4 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-Clone-0.45-3-x86_64                                  10.8 KiB  32.7 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> perl-HTML-Tagset-3.20-2-any                               10.3 KiB  29.5 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-windows-default-manifest-6.4-4-any        3.1 KiB  8.97 KiB/s 00:00 [#################################################] 100%</span><br><span class="line"> mingw-w64-x86_64-gcc-12.2.0-6-any                         28.3 MiB  1420 KiB/s 00:20 [#################################################] 100%</span><br><span class="line"> Total (54/54)                                             61.8 MiB  3.03 MiB/s 00:20 [#################################################] 100%</span><br><span class="line">(54/54) checking keys in keyring                                                      [#################################################] 100%</span><br><span class="line">(54/54) checking package integrity                                                    [#################################################] 100%</span><br><span class="line">(54/54) loading package files                                                         [#################################################] 100%</span><br><span class="line">(54/54) checking for file conflicts                                                   [#################################################] 100%</span><br><span class="line">(54/54) checking available disk space                                                 [#################################################] 100%</span><br><span class="line">:: Processing package changes...</span><br><span class="line">( 1/54) installing mingw-w64-x86_64-libiconv                                          [#################################################] 100%</span><br><span class="line">( 2/54) installing mingw-w64-x86_64-zlib                                              [#################################################] 100%</span><br><span class="line">( 3/54) installing mingw-w64-x86_64-binutils                                          [#################################################] 100%</span><br><span class="line">( 4/54) installing mingw-w64-x86_64-headers-git                                       [#################################################] 100%</span><br><span class="line">( 5/54) installing mingw-w64-x86_64-crt-git                                           [#################################################] 100%</span><br><span class="line">( 6/54) installing mingw-w64-x86_64-gmp                                               [#################################################] 100%</span><br><span class="line">( 7/54) installing mingw-w64-x86_64-isl                                               [#################################################] 100%</span><br><span class="line">( 8/54) installing mingw-w64-x86_64-libwinpthread-git                                 [#################################################] 100%</span><br><span class="line">( 9/54) installing mingw-w64-x86_64-gcc-libs                                          [#################################################] 100%</span><br><span class="line">(10/54) installing mingw-w64-x86_64-mpfr                                              [#################################################] 100%</span><br><span class="line">(11/54) installing mingw-w64-x86_64-mpc                                               [#################################################] 100%</span><br><span class="line">(12/54) installing mingw-w64-x86_64-windows-default-manifest                          [#################################################] 100%</span><br><span class="line">(13/54) installing mingw-w64-x86_64-winpthreads-git                                   [#################################################] 100%</span><br><span class="line">(14/54) installing mingw-w64-x86_64-zstd                                              [#################################################] 100%</span><br><span class="line">(15/54) installing mingw-w64-x86_64-gcc                                               [#################################################] 100%</span><br><span class="line">(16/54) installing mingw-w64-x86_64-expat                                             [#################################################] 100%</span><br><span class="line">(17/54) installing mingw-w64-x86_64-gettext                                           [#################################################] 100%</span><br><span class="line">(18/54) installing mingw-w64-x86_64-yasm                                              [#################################################] 100%</span><br><span class="line">(19/54) installing mingw-w64-x86_64-pkg-config                                        [#################################################] 100%</span><br><span class="line">(20/54) installing heimdal                                                            [#################################################] 100%</span><br><span class="line">(21/54) installing libcbor                                                            [#################################################] 100%</span><br><span class="line">(22/54) installing libfido2                                                           [#################################################] 100%</span><br><span class="line">(23/54) installing openssh                                                            [#################################################] 100%</span><br><span class="line">(24/54) installing perl-Error                                                         [#################################################] 100%</span><br><span class="line">(25/54) installing perl-Authen-SASL                                                   [#################################################] 100%</span><br><span class="line">(26/54) installing perl-Encode-Locale                                                 [#################################################] 100%</span><br><span class="line">(27/54) installing perl-HTTP-Date                                                     [#################################################] 100%</span><br><span class="line">(28/54) installing perl-File-Listing                                                  [#################################################] 100%</span><br><span class="line">(29/54) installing perl-HTML-Tagset                                                   [#################################################] 100%</span><br><span class="line">(30/54) installing perl-Clone                                                         [#################################################] 100%</span><br><span class="line">(31/54) installing perl-IO-HTML                                                       [#################################################] 100%</span><br><span class="line">(32/54) installing perl-LWP-MediaTypes                                                [#################################################] 100%</span><br><span class="line">(33/54) installing perl-URI                                                           [#################################################] 100%</span><br><span class="line">(34/54) installing perl-HTTP-Message                                                  [#################################################] 100%</span><br><span class="line">(35/54) installing perl-HTML-Parser                                                   [#################################################] 100%</span><br><span class="line">(36/54) installing perl-HTTP-Cookies                                                  [#################################################] 100%</span><br><span class="line">(37/54) installing perl-HTTP-Daemon                                                   [#################################################] 100%</span><br><span class="line">(38/54) installing perl-HTTP-Negotiate                                                [#################################################] 100%</span><br><span class="line">(39/54) installing perl-Net-HTTP                                                      [#################################################] 100%</span><br><span class="line">(40/54) installing perl-WWW-RobotRules                                                [#################################################] 100%</span><br><span class="line">(41/54) installing perl-Try-Tiny                                                      [#################################################] 100%</span><br><span class="line">(42/54) installing perl-libwww                                                        [#################################################] 100%</span><br><span class="line">Optional dependencies for perl-libwww</span><br><span class="line">    perl-LWP-Protocol-https: for https:// url schemes</span><br><span class="line">(43/54) installing perl-TimeDate                                                      [#################################################] 100%</span><br><span class="line">(44/54) installing perl-MailTools                                                     [#################################################] 100%</span><br><span class="line">(45/54) installing perl-IO-Stringy                                                    [#################################################] 100%</span><br><span class="line">(46/54) installing perl-Convert-BinHex                                                [#################################################] 100%</span><br><span class="line">module test... pass.</span><br><span class="line">(47/54) installing perl-MIME-tools                                                    [#################################################] 100%</span><br><span class="line">(48/54) installing perl-Net-SSLeay                                                    [#################################################] 100%</span><br><span class="line">(49/54) installing perl-IO-Socket-SSL                                                 [#################################################] 100%</span><br><span class="line">(50/54) installing perl-Net-SMTP-SSL                                                  [#################################################] 100%</span><br><span class="line">(51/54) installing perl-TermReadKey                                                   [#################################################] 100%</span><br><span class="line">(52/54) installing git                                                                [#################################################] 100%</span><br><span class="line">Optional dependencies for git</span><br><span class="line">    python: various helper scripts</span><br><span class="line">    subversion: git svn</span><br><span class="line">(53/54) installing make                                                               [#################################################] 100%</span><br><span class="line">(54/54) installing diffutils                                                          [#################################################] 100%</span><br><span class="line">:: Running post-transaction hooks...</span><br><span class="line">(1/1) Updating the info directory file...</span><br></pre></td></tr></table></figure>

<h2 id="4-libopenh264-のインストール"><a href="#4-libopenh264-のインストール" class="headerlink" title="4. libopenh264 のインストール"></a>4. libopenh264 のインストール</h2><p>パッケージマネージャからインストール。<br>最新版は現時点で 2.3.1。<br>このバージョンが重要で、後述の <strong>libopenh264.dll</strong> を使う際は、同じバージョンを使う必要がある。</p>
<p>ソースからのビルドでも可能だが、これが確実。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pacman -S mingw-w64-x86_64-openh264</span></span><br><span class="line">resolving dependencies...</span><br><span class="line">looking for conflicting packages...</span><br><span class="line"></span><br><span class="line">Packages (1) mingw-w64-x86_64-openh264-2.3.1-1</span><br><span class="line"></span><br><span class="line">Total Download Size:   0.61 MiB</span><br><span class="line">Total Installed Size:  5.11 MiB</span><br><span class="line"></span><br><span class="line">:: Proceed with installation? [Y/n] Y</span><br><span class="line">:: Retrieving packages...</span><br><span class="line"> mingw-w64-x86_64-openh264-2.3.1-1-any                    623.7 KiB   358 KiB/s 00:02 [#################################################] 100%</span><br><span class="line">(1/1) checking keys in keyring                                                        [#################################################] 100%</span><br><span class="line">(1/1) checking package integrity                                                      [#################################################] 100%</span><br><span class="line">(1/1) loading package files                                                           [#################################################] 100%</span><br><span class="line">(1/1) checking for file conflicts                                                     [#################################################] 100%</span><br><span class="line">(1/1) checking available disk space                                                   [#################################################] 100%</span><br><span class="line">:: Processing package changes...</span><br><span class="line">(1/1) installing mingw-w64-x86_64-openh264                                            [#################################################] 100%</span><br></pre></td></tr></table></figure>

<p>インストール後、<code>/mingw64/lib/pkgconfig/openh264.pc</code> に pkg-config ができる。</p>
<h2 id="5-FFMPEG-のビルド"><a href="#5-FFMPEG-のビルド" class="headerlink" title="5. FFMPEG のビルド"></a>5. FFMPEG のビルド</h2><p>ソースからビルドする。<br>最新版の 5 系は抵抗があるので、ここでは 4.3.5 を使用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git config --global core.autoCRLF <span class="literal">false</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> -b n4.3.5 https://github.com/FFmpeg/FFmpeg ffmpeg</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ffmpeg</span></span><br></pre></td></tr></table></figure>

<p>次に、ビルドしたバイナリのインストール先フォルダを作る。<br>インストールと言っても単純にファイルが展開されるだけなので、システムディレクトリである必要はない。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir /home/ffmpeg-build</span></span><br></pre></td></tr></table></figure>

<p>FFMPEG をビルドする。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./configure \</span></span><br><span class="line">    --prefix=/home/ffmpeg-build \</span><br><span class="line">    --disable-bzlib \</span><br><span class="line">    --disable-cuda \</span><br><span class="line">    --disable-cuvid \</span><br><span class="line">    --disable-debug \</span><br><span class="line">    --disable-doc \</span><br><span class="line">    --disable-gpl \</span><br><span class="line">    --disable-htmlpages \</span><br><span class="line">    --disable-iconv \</span><br><span class="line">    --disable-logging \</span><br><span class="line">    --disable-manpages \</span><br><span class="line">    --disable-podpages \</span><br><span class="line">    --disable-postproc \</span><br><span class="line">    --disable-txtpages \</span><br><span class="line">    --enable-avdevice \</span><br><span class="line">    --enable-d3d11va \</span><br><span class="line">    --enable-dxva2 \</span><br><span class="line">    --enable-hwaccel=h264_dxva2 \</span><br><span class="line">    --enable-libopenh264 \</span><br><span class="line">    --enable-optimizations \</span><br><span class="line">    --enable-shared \</span><br><span class="line">    --enable-static \</span><br><span class="line">    --enable-version3 \</span><br><span class="line">    --enable-optimizations \</span><br><span class="line">    --extra-ldflags=&#x27;-static-libgcc -static-libstdc++&#x27;</span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make install</span></span><br></pre></td></tr></table></figure>

<p>重要なのは下記</p>
<ul>
<li><code>--disable-gpl</code><ul>
<li>GPL のコンポーネントを無効化</li>
</ul>
</li>
<li><code>--enable-libopenh264</code><ul>
<li>libopenh264 を有効化。事前にライブラリやヘッダを用意する必要があり、<code>openh264.pc</code> がシステムにインストールされているか <code>PKG_CONFIG_PATH</code> でパスが通っている必要がある</li>
</ul>
</li>
</ul>
<p>以上を実行すると、時間がかかるがバイナリが <code>/home/ffmpeg-build</code> に展開される。</p>
<p><a href="../../../../public/2022/12/27/4474/build.png"><img src="../../../../public/2022/12/27/4474/build.png" alt="MSYS2" title="MSYS2"></a></p>
<h2 id="6-実行準備"><a href="#6-実行準備" class="headerlink" title="6. 実行準備"></a>6. 実行準備</h2><p>これだけでは動かない。<br>正確には、FFMPEG をビルドした、MINGW64 が入っていないマシン上では、である。<br>MINGW64 の世界で参照した dll が欠落しているためである。</p>
<p>必要なのは下記。</p>
<ul>
<li>libopenh264.dll<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/cisco/openh264/releases">openh264</a> から適切なバージョン、プラットフォームのものをダウンロードして展開 (bz2 形式なので)し、名前を変更</li>
<li>github からダウンロードされたのものは Cisco のデジタル署名がなされているので要確認</li>
</ul>
</li>
<li>C:\msys64\mingw64\bin\libwinpthread-1.dll</li>
<li>C:\msys64\mingw64\bin\zlib1.dll</li>
<li>C:\msys64\mingw64\bin\liblzma-5.dll<ul>
<li>これが必要になる環境があったが原因は不明</li>
</ul>
</li>
</ul>
<p>ffmpeg.exe をたたいて動くまで必要な dll を回収する。<br>エラーを出さずに落ちるので、 Dependencies などで不足している dll を見つけ出す必要がある。</p>
<p>無事に動くと</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ ffmpeg.exe</span><br><span class="line">ffmpeg version n4.<span class="number">3</span>.<span class="number">5</span> Copyright (c) <span class="number">2000</span>-<span class="number">2022</span> the FFmpeg developers</span><br><span class="line">  built with gcc <span class="number">12</span>.<span class="number">2</span>.<span class="number">0</span> (Rev6, Built by MSYS2 project)</span><br><span class="line"><span class="function">  configuration: --<span class="title">prefix</span>=/<span class="title">home</span>/<span class="title">ffmpeg</span>-<span class="title">build</span> --<span class="title">disable</span>-<span class="title">logging</span> --<span class="title">disable</span>-<span class="title">gpl</span> --<span class="title">enable</span>-<span class="title">version3</span> --<span class="title">enable</span>-<span class="title">static</span> --<span class="title">enable</span>-<span class="title">shared</span> --<span class="title">disable</span>-<span class="title">doc</span> --<span class="title">disable</span>-<span class="title">htmlpages</span> --<span class="title">disable</span>-<span class="title">manpages</span> --<span class="title">disable</span>-<span class="title">podpages</span> --<span class="title">disable</span>-<span class="title">txtpages</span> --<span class="title">enable</span>-<span class="title">avdevice</span> --<span class="title">disable</span>-<span class="title">postproc</span> --<span class="title">disable</span>-<span class="title">bzlib</span> --<span class="title">disable</span>-<span class="title">iconv</span> --<span class="title">enable</span>-<span class="title">libopenh264</span> --<span class="title">disable</span>-<span class="title">cuda</span> --<span class="title">disable</span>-<span class="title">cuvid</span> --<span class="title">enable</span>-<span class="title">d3d11va</span> --<span class="title">enable</span>-<span class="title">dxva2</span> --<span class="title">enable</span>-<span class="title">hwaccel</span>=<span class="title">h264_dxva2</span> --<span class="title">disable</span>-<span class="title">debug</span> --<span class="title">enable</span>-<span class="title">optimizations</span> --<span class="title">extra</span>-<span class="title">ldflags</span>=&#x27;-<span class="title">static</span>-<span class="title">libgcc</span> -<span class="title">static</span>-<span class="title">libstdc</span>++&#x27;</span></span><br><span class="line"><span class="function">  <span class="title">libavutil</span>      56. 51.100 / 56. 51.100</span></span><br><span class="line"><span class="function">  <span class="title">libavcodec</span>     58. 91.100 / 58. 91.100</span></span><br><span class="line"><span class="function">  <span class="title">libavformat</span>    58. 45.100 / 58. 45.100</span></span><br><span class="line"><span class="function">  <span class="title">libavdevice</span>    58. 10.100 / 58. 10.100</span></span><br><span class="line"><span class="function">  <span class="title">libavfilter</span>     7. 85.100 /  7. 85.100</span></span><br><span class="line"><span class="function">  <span class="title">libswscale</span>      5.  7.100 /  5.  7.100</span></span><br><span class="line"><span class="function">  <span class="title">libswresample</span>   3.  7.100 /  3.  7.100</span></span><br><span class="line"><span class="function"><span class="title">Hyper</span> <span class="title">fast</span> <span class="title">Audio</span> <span class="title">and</span> <span class="title">Video</span> <span class="title">encoder</span></span></span><br><span class="line"><span class="function"><span class="title">usage</span>: <span class="title">ffmpeg</span> [<span class="title">options</span>] [[<span class="title">infile</span> <span class="title">options</span>] -<span class="title">i</span> <span class="title">infile</span>]... &#123;[<span class="title">outfile</span> <span class="title">options</span>] <span class="title">outfile</span>&#125;...</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Use</span> -<span class="title">h</span> <span class="title">to</span> <span class="title">get</span> <span class="title">full</span> <span class="title">help</span> <span class="title">or</span>, <span class="title">even</span> <span class="title">better</span>, <span class="title">run</span> &#x27;<span class="title">man</span> <span class="title">ffmpeg</span>&#x27;</span></span><br></pre></td></tr></table></figure>

<p>のように、ビルドした際のオプションなどが表示される。</p>
<h2 id="7-libopenh264-dll-が正しくリンクされているか確認"><a href="#7-libopenh264-dll-が正しくリンクされているか確認" class="headerlink" title="7. libopenh264.dll が正しくリンクされているか確認"></a>7. libopenh264.dll が正しくリンクされているか確認</h2><p>既に前の説明で気付くかもしれないが、libopenh264.dll が欠落していると</p>
<p><a href="../../../../public/2022/12/27/4474/error.png"><img src="../../../../public/2022/12/27/4474/error.png" alt="MSYS2" title="MSYS2"></a></p>
<p>が出る。<br>または、libopenh264.dll 「だけ」が欠落していると、 ffmpeg が何も言わずに終了するので、それで判断することもできる。</p>
<h2 id="8-H264-の動画を作る"><a href="#8-H264-の動画を作る" class="headerlink" title="8. H264 の動画を作る"></a>8. H264 の動画を作る</h2><p>手っ取り早く作るなら、連続した画像から作る方法がある。</p>
<p>ここではフリー素材を拝借してテスト。<br><a target="_blank" rel="noopener" href="https://edit-anything.com/edius/download_01_png.html">フリー素材 (連番PNG)</a> から <strong>小さい雪と大きな雪 [各 5秒]</strong> を利用。</p>
<p><strong>Snow(L)_00000.png</strong> のような末尾に 5 桁の数字が付与された連番の png であるため、下記のように指定。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ ffmpeg.exe -y ^</span><br><span class="line">             -framerate <span class="number">29</span>.<span class="number">4</span> ^</span><br><span class="line">             -i &quot;Snow(L)\Snow(L)_%<span class="number">05</span>d.png&quot; ^</span><br><span class="line">             -vcodec libopenh264 ^</span><br><span class="line">             -pix_fmt yuv420p ^</span><br><span class="line">             test.mp4</span><br><span class="line"></span><br><span class="line">ffmpeg version n4.<span class="number">3</span>.<span class="number">5</span> Copyright (c) <span class="number">2000</span>-<span class="number">2022</span> the FFmpeg developers</span><br><span class="line">  built with gcc <span class="number">12</span>.<span class="number">2</span>.<span class="number">0</span> (Rev6, Built by MSYS2 project)</span><br><span class="line"><span class="function">  configuration: --<span class="title">prefix</span>=/<span class="title">home</span>/<span class="title">ffmpeg</span>-<span class="title">build</span> --<span class="title">disable</span>-<span class="title">logging</span> --<span class="title">disable</span>-<span class="title">gpl</span> --<span class="title">enable</span>-<span class="title">version3</span> --<span class="title">enable</span>-<span class="title">static</span> --<span class="title">enable</span>-<span class="title">shared</span> --<span class="title">disable</span>-<span class="title">doc</span> --<span class="title">disable</span>-<span class="title">htmlpages</span> --<span class="title">disable</span>-<span class="title">manpages</span> --<span class="title">disable</span>-<span class="title">podpages</span> --<span class="title">disable</span>-<span class="title">txtpages</span> --<span class="title">enable</span>-<span class="title">avdevice</span> --<span class="title">disable</span>-<span class="title">postproc</span> --<span class="title">disable</span>-<span class="title">bzlib</span> --<span class="title">disable</span>-<span class="title">iconv</span> --<span class="title">enable</span>-<span class="title">libopenh264</span> --<span class="title">disable</span>-<span class="title">cuda</span> --<span class="title">disable</span>-<span class="title">cuvid</span> --<span class="title">enable</span>-<span class="title">d3d11va</span> --<span class="title">enable</span>-<span class="title">dxva2</span> --<span class="title">enable</span>-<span class="title">hwaccel</span>=<span class="title">h264_dxva2</span> --<span class="title">disable</span>-<span class="title">debug</span> --<span class="title">enable</span>-<span class="title">optimizations</span> --<span class="title">extra</span>-<span class="title">ldflags</span>=&#x27;-<span class="title">static</span>-<span class="title">libgcc</span> -<span class="title">static</span>-<span class="title">libstdc</span>++&#x27;</span></span><br><span class="line"><span class="function">  <span class="title">libavutil</span>      56. 51.100 / 56. 51.100</span></span><br><span class="line"><span class="function">  <span class="title">libavcodec</span>     58. 91.100 / 58. 91.100</span></span><br><span class="line"><span class="function">  <span class="title">libavformat</span>    58. 45.100 / 58. 45.100</span></span><br><span class="line"><span class="function">  <span class="title">libavdevice</span>    58. 10.100 / 58. 10.100</span></span><br><span class="line"><span class="function">  <span class="title">libavfilter</span>     7. 85.100 /  7. 85.100</span></span><br><span class="line"><span class="function">  <span class="title">libswscale</span>      5.  7.100 /  5.  7.100</span></span><br><span class="line"><span class="function">  <span class="title">libswresample</span>   3.  7.100 /  3.  7.100</span></span><br><span class="line"><span class="function"><span class="title">Input</span> #0, <span class="title">image2</span>, <span class="title">from</span> &#x27;<span class="title">Snow</span>(<span class="title">L</span>)\<span class="title">Snow</span>(<span class="title">L</span>)<span class="title">_</span>%05<span class="title">d.png</span>&#x27;:</span></span><br><span class="line"><span class="function">  <span class="title">Duration</span>: 00:00:05.10, <span class="title">start</span>: 0.000000, <span class="title">bitrate</span>: <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function">    <span class="title">Stream</span> #0:0: <span class="title">Video</span>: <span class="title">png</span>, <span class="title">rgba</span>(<span class="title">pc</span>), 1920<span class="title">x1080</span> [<span class="title">SAR</span> 1:1 <span class="title">DAR</span> 16:9], 29.42 <span class="title">fps</span>, 29.40 <span class="title">tbr</span>, 29.40 <span class="title">tbn</span>, 29.40 <span class="title">tbc</span></span></span><br><span class="line"><span class="function"><span class="title">Stream</span> <span class="title">mapping</span>:</span></span><br><span class="line"><span class="function">  <span class="title">Stream</span> #0:0 -&gt; #0:0 (<span class="title">png</span> (<span class="title">native</span>) -&gt; <span class="title">h264</span> (<span class="title">libopenh264</span>))</span></span><br><span class="line"><span class="function"><span class="title">Press</span> [<span class="title">q</span>] <span class="title">to</span> <span class="title">stop</span>, [?] <span class="title">for</span> <span class="title">help</span></span></span><br><span class="line"><span class="function">[<span class="title">libopenh264</span> @ 0000025<span class="title">ddbc69e40</span>] <span class="title">Slice</span> <span class="title">count</span> <span class="title">will</span> <span class="title">be</span> <span class="title">set</span> <span class="title">automatically</span></span></span><br><span class="line"><span class="function">[<span class="title">libopenh264</span> @ 0000025<span class="title">ddbc69e40</span>] [<span class="title">OpenH264</span>] <span class="title">this</span> = 0<span class="title">x0000025DD9CE5530</span>, <span class="title">Warning:bEnableFrameSkip</span> = 0,<span class="title">bitrate</span> <span class="title">can</span>&#x27;<span class="title">t</span> <span class="title">be</span> <span class="title">controlled</span> <span class="title">for</span> <span class="title">RC_QUALITY_MODE</span>,<span class="title">RC_BITRATE_MODE</span> <span class="title">and</span> <span class="title">RC_TIMESTAMP_MODE</span> <span class="title">without</span> <span class="title">enabling</span> <span class="title">skip</span> <span class="title">frame</span>.</span></span><br><span class="line"><span class="function"><span class="title">Output</span> #0, <span class="title">mp4</span>, <span class="title">to</span> &#x27;<span class="title">test.mp4</span>&#x27;:</span></span><br><span class="line"><span class="function">  <span class="title">Metadata</span>:</span></span><br><span class="line"><span class="function">    <span class="title">encoder</span>         : <span class="title">Lavf58</span>.45.100</span></span><br><span class="line"><span class="function">    <span class="title">Stream</span> #0:0: <span class="title">Video</span>: <span class="title">h264</span> (<span class="title">libopenh264</span>) (<span class="title">avc1</span> / 0<span class="title">x31637661</span>), <span class="title">yuv420p</span>, 1920<span class="title">x1080</span> [<span class="title">SAR</span> 1:1 <span class="title">DAR</span> 16:9], <span class="title">q</span>=-1--1, 29.40 <span class="title">fps</span>, 18816 <span class="title">tbn</span>, 29.40 <span class="title">tbc</span></span></span><br><span class="line"><span class="function">    <span class="title">Metadata</span>:</span></span><br><span class="line"><span class="function">      <span class="title">encoder</span>         : <span class="title">Lavc58</span>.91.100 <span class="title">libopenh264</span></span></span><br><span class="line"><span class="function">    <span class="title">Side</span> <span class="title">data</span>:</span></span><br><span class="line"><span class="function">      <span class="title">cpb</span>: <span class="title">bitrate</span> <span class="title">max</span>/<span class="title">min</span>/<span class="title">avg</span>: 0/0/2000000 <span class="title">buffer</span> <span class="title">size</span>: 0 <span class="title">vbv_delay</span>: <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">frame</span>=  150 <span class="title">fps</span>= 70 <span class="title">q</span>=-0.0 <span class="title">Lsize</span>=    2000<span class="title">kB</span> <span class="title">time</span>=00:00:05.06 <span class="title">bitrate</span>=3232.2<span class="title">kbits</span>/<span class="title">s</span> <span class="title">speed</span>=2.37<span class="title">x</span></span></span><br><span class="line"><span class="function"><span class="title">video</span>:1998<span class="title">kB</span> <span class="title">audio</span>:0<span class="title">kB</span> <span class="title">subtitle</span>:0<span class="title">kB</span> <span class="title">other</span> <span class="title">streams</span>:0<span class="title">kB</span> <span class="title">global</span> <span class="title">headers</span>:0<span class="title">kB</span> <span class="title">muxing</span> <span class="title">overhead</span>: 0.069837%</span></span><br></pre></td></tr></table></figure>

<p>バッチファイルから実行する場合は、下記のように <code>%</code> をエスケープする必要があるので注意。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ffmpeg.exe -y ^</span><br><span class="line">             -framerate <span class="number">29</span>.<span class="number">4</span> ^</span><br><span class="line">             -i &quot;Snow(L)\Snow(L)_<span class="variable">%%0</span>5d.png&quot; ^</span><br><span class="line">             -vcodec libopenh264 ^</span><br><span class="line">             -pix_fmt yuv420p ^</span><br><span class="line">             test.mp4</span><br></pre></td></tr></table></figure>

<p>ちなみに、<code>-vcodec libopenh264</code> をつけなくても動画を作ることはできるが、コーデックに下記のような違いが出る。</p>
<p><a href="../../../../public/2022/12/27/4474/no-h264.png"><img src="../../../../public/2022/12/27/4474/no-h264.png" alt="NotH264" title="NotH264"></a></p>
<p><a href="../../../../public/2022/12/27/4474/h264.png"><img src="../../../../public/2022/12/27/4474/h264.png" alt="H264" title="H264"></a></p>
<p>以上。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-12-27</span><i class="fa fa-tag"></i><a class="tag" href="/categories/その他/" title="その他">その他 </a><a class="tag" href="/categories/その他/MSYS/" title="MSYS">MSYS </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2022/12/27/4474/,A certain engineer &quot;COMPLEX&quot;,開発メモ その315 FFMPEG で libopenh264 を Windows で使う,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2022/12/04/4473/" title="開発メモ その314 dicker on WSL2 で GPU を使う">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>