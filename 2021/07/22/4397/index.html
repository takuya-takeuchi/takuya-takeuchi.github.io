<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><link rel="icon" href="/images/favicon.ico" type="image/x-icon"><title>開発メモ その238 .NET Core 3.1 は Ubuntu 16 で動かない? · A certain engineer "COMPLEX"</title><meta name="description" content="Introduction結果としては、多分、この記事は間違っている可能性が高いが、忘れないようにメモ。
事の経緯は、.NET Core 3.1 でビルドしたアプリが Ubuntu 16 上で動かなかったことから。実行時に、依存関係が足りないと言われるも、ldd で問題のライブラリの依存関係に問題は無"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/apps">Apps</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>開発メモ その238 .NET Core 3.1 は Ubuntu 16 で動かない?</a></h3></div><div class="post-content"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>結果としては、多分、この記事は間違っている可能性が高いが、忘れないようにメモ。</p>
<p>事の経緯は、.NET Core 3.1 でビルドしたアプリが Ubuntu 16 上で動かなかったことから。<br>実行時に、依存関係が足りないと言われるも、<code>ldd</code> で問題のライブラリの依存関係に問題は無かった。</p>
<p>そこでピンと来たのが、以前、<a target="_blank" rel="noopener" href="https://taktak.jp/2020/01/03/4223/">開発メモ その190 .NET CoreでP/Invokeでの動的リンクに失敗したためLD_DEBUGで原因を調べてみる</a> で書いたように、ライブラリが足りないのではなく、シンボルが読めないのでは？と思い下記で調べてみた。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> LD_DEBUG=libs dotnet <span class="built_in">test</span> -c Release 2&gt; error.log</span></span><br></pre></td></tr></table></figure>

<p>するとたくさん出るエラー。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">      1367:	/lib/x86_64-linux-gnu/libssl.so.1.0.0: error: symbol lookup error: undefined symbol: BIO_up_ref (fatal)</span><br><span class="line">      1367:	/lib/x86_64-linux-gnu/libssl.so.1.0.0: error: symbol lookup error: undefined symbol: DSA_get0_key (fatal)</span><br><span class="line">      1367:	/lib/x86_64-linux-gnu/libssl.so.1.0.0: error: symbol lookup error: undefined symbol: DSA_get0_pqg (fatal)</span><br><span class="line">      1367:	/lib/x86_64-linux-gnu/libssl.so.1.0.0: error: symbol lookup error: undefined symbol: DSA_get_method (fatal)</span><br><span class="line">      1367:	/lib/x86_64-linux-gnu/libssl.so.1.0.0: error: symbol lookup error: undefined symbol: DSA_set0_key (fatal)</span><br><span class="line">      1367:	/lib/x86_64-linux-gnu/libssl.so.1.0.0: error: symbol lookup error: undefined symbol: DSA_set0_pqg (fatal)</span><br><span class="line">      1367:	/lib/x86_64-linux-gnu/libssl.so.1.0.0: error: symbol lookup error: undefined symbol: EVP_CIPHER_CTX_reset (fatal)</span><br><span class="line">      1367:	/lib/x86_64-linux-gnu/libssl.so.1.0.0: error: symbol lookup error: undefined symbol: EVP_PKEY_up_ref (fatal)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>確かに、<code>nm -D /lib/x86_64-linux-gnu/libssl.so.1.0.0 | grep BIO_up_ref</code> ってしても、問題のシンボルが見つからない。</p>
<p>でも、<a target="_blank" rel="noopener" href="https://docs.microsoft.com/ja-jp/dotnet/core/install/linux-ubuntu#supported-distributions">サポートされているディストリビューション</a> のページでは Ubuntu 16.04 において、3.1 はサポート対象であると明記されている。</p>
<h1 id="Why？"><a href="#Why？" class="headerlink" title="Why？"></a>Why？</h1><p>答えは下記にあった。</p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://docs.microsoft.com/ja-jp/dotnet/core/compatibility/cryptography#net-core-30-prefers-openssl-11x-to-openssl-10x" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=docs.microsoft.com"></img><div class="hbc-site-name">docs.microsoft.com</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img src="https://learn.microsoft.com/dotnet/media/dotnet-logo.png"></img></div><div class="hbc-text"><div class="hbc-title">暗号での破壊的変更 - .NET</div><div class="hbc-url">https://docs.microsoft.com/ja-jp/dotnet/core/compatibility/cryptography#net-core-30-prefers-openssl-11x-to-openssl-10x</div><div class="hbc-description">.NET Core 2.1 から 3.0 での暗号に関する破壊的変更の一覧を示します。</div></div></div></div></a></div></div>

<blockquote>
<p>.NET Core 3.0 では、OpenSSL 1.0.x よりも OpenSSL 1.1.x が優先されます<br>Linux 用 .NET Core では、複数の Linux ディストリビューションで動作するため、OpenSSL 1.0.x と OpenSSL 1.1.x の両方がサポートされます。 .NET Core 2.1 および .NET Core 2.2 では、最初に 1.0.x が検索されてから、1.1.x にフォールバックされます。 .NET Core 3.0 では、最初に 1.1.x が検索されます。 この変更は、新しい暗号化標準のサポートを追加するために行われました。</p>
</blockquote>
<p>うん、つまり<br><code>libssl 1.0.X</code> がデフォルトの Ubuntu 16 では、どうにもならないってことです。<br>手動で <code>Libssl 1.1.X</code> を自分でビルドしてインストールすればいいんだろうけど。</p>
<p>でも、暗号系のAPI何か読んでいないのに、どうしてこんなエラーになったのかは疑問に残る。<br>予想だが、ビルドしたアプリが依存していたC++のライブラリ (ここではprotobuf) が OpenSSL を動的リンクしていて、そいつが .NET Core の依存する libssl の一致しなかったのでは、と考える。</p>
<h1 id="However…"><a href="#However…" class="headerlink" title="However…"></a>However…</h1><p>と思ったら、このエラーは関係ない可能性が高い。<br>というのも、 Ubuntu 20 における、 .NET Core 5.0 ではあるが、空のコンソールアプリケーションを作っても、似たようなシンボルが見つからないエラーが表示される。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dotnet new console</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dotnet run -c Relese -r linux-x64 2&gt; error.log</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">      4603:	find library=liblttng-ust-tracepoint.so.0 [0]; searching</span><br><span class="line">      4603:	 search cache=/etc/ld.so.cache</span><br><span class="line">      4603:	 search path=/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu:/lib:/usr/lib		(system search path)</span><br><span class="line">      4603:	  trying file=/lib/x86_64-linux-gnu/liblttng-ust-tracepoint.so.0</span><br><span class="line">      4603:	  trying file=/usr/lib/x86_64-linux-gnu/liblttng-ust-tracepoint.so.0</span><br><span class="line">      4603:	  trying file=/lib/liblttng-ust-tracepoint.so.0</span><br><span class="line">      4603:	  trying file=/usr/lib/liblttng-ust-tracepoint.so.0</span><br><span class="line">      4603:	</span><br><span class="line">      4603:	dotnet: error: symbol lookup error: undefined symbol: DllMain (fatal)</span><br><span class="line">      4603:	/usr/share/dotnet/shared/Microsoft.NETCore.App/5.0.8/libcoreclr.so: error: symbol lookup error: undefined symbol: PAL_RegisterModule (fatal)</span><br><span class="line">      4603:	</span><br><span class="line">      4603:	calling init: /usr/share/dotnet/shared/Microsoft.NET</span><br></pre></td></tr></table></figure>

<p>libssl や libicuuc でも同様のエラーが出ている事を見ると、エラーが出てもフォールバックで何事もなかったかのように処理をしている模様。</p>
<p>で、調査中だが、問題はC#からP/Invokeで呼出しているC++ライブラリがマズい可能性が高い。<br>自作のC++ライブラリを念のため別のC++から呼出す実行プログラムからリンクさせると、これがリンクの段階で動かない。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ld: XXXXX: hidden symbol `__cpu_indicator_init&#x27; in /usr/lib/gcc/x86_64-linux-gnu/5/libgcc.a(cpuinfo.o) is referenced by DSO</span><br><span class="line">/usr/bin/ld: final link failed: Bad value</span><br><span class="line">collect2: error: ld returned 1 exit status</span><br><span class="line">CMakeFiles/XXXXX.dir/build.make:95: recipe for target &#x27;XXXXX&#x27; failed</span><br></pre></td></tr></table></figure>

<p>このC++ライブラリの少し古いバージョンは問題なくリンクできて実行できた。<br>なので、差分を見ていって、問題を解決する。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-07-22</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Apple/" title="Apple">Apple </a><a class="tag" href="/categories/Apple/iOS/" title="iOS">iOS </a><a class="tag" href="/categories/Apple/iOS/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Apple/iOS/Microsoft/Xamarin/" title="Xamarin">Xamarin </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2021/07/22/4397/,A certain engineer &quot;COMPLEX&quot;,開発メモ その238 .NET Core 3.1 は Ubuntu 16 で動かない?,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2021/07/23/4398/" title="開発メモ その239 パッケージを公開できない">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2021/07/17/4397/" title="開発メモ その237 iOS Simulator における、Xamarin.iOS と Xcode と Metal の対応バージョン">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>