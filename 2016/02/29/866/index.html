<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>ディープラーニング CNTK その3 説明 · A certain engineer "COMPLEX"</title><meta name="description" content="前回はCNTK付属のサンプルを使って、テストをしてみました。今回は、CNTKを自分で使うための説明です。基本公式ページの訳ですが、日本語に直したほうがわかりやすいので。

概要前書きこのページは CNTK usage overview を訳しただけのページです。ですので、訳がおかしかったり間違いがあ"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>ディープラーニング CNTK その3 説明</a></h3></div><div class="post-content"><p><a target="_blank" rel="noopener" href="https://taktak.jp/2016/02/27/861">前回</a>はCNTK付属のサンプルを使って、テストをしてみました。今回は、CNTKを自分で使うための説明です。基本公式ページの訳ですが、日本語に直したほうがわかりやすいので。</p>
<a id="more"></a>
<h1 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h1><h2 id="前書き"><a href="#前書き" class="headerlink" title="前書き"></a>前書き</h2><p>このページは <a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/wiki/CNTK-usage-overview">CNTK usage overview</a> を訳しただけのページです。<br>ですので、訳がおかしかったり間違いがあるかもしれません。<br>それによって生じた損害は私は負えません。あしからず。</p>
<h2 id="CNTK-usage-overview-CNTK-使い方-概要"><a href="#CNTK-usage-overview-CNTK-使い方-概要" class="headerlink" title="CNTK usage overview (CNTK 使い方 概要)"></a>CNTK usage overview (CNTK 使い方 概要)</h2><blockquote>
<p>To use CNTK you need to either download the executable binaries or download the source code and compile it on your machine (details). There are three main tasks (or actions) that are supported by CNTK:</p>
<ul>
<li><strong>Train</strong> - Define a network and train it to produce a trained model using training data</li>
<li><strong>Evaluate</strong> - Test a trained model to assess its performance using test data</li>
<li><strong>Deploy</strong> - Use a trained model, e.g. in your own solution, to classify new instances</li>
</ul>
<p>A brief overview for each of these tasks is given below and pointers to a more detailed description are provided. In addition there are other tasks that CNTK supports such as <strong>edit</strong> existing models and <strong>write</strong> node outputs to a file. A description of these is provided in the Advanced Topics section on the Top-level commands page.</p>
</blockquote>
<h4 id="訳："><a href="#訳：" class="headerlink" title="訳："></a>訳：</h4><p>CNTKを使うためには、実行可能バイナリのダウンロードまたはソースコードのダウンロードとマシン上でのコンパイルが必要である。CNTKは3つの主要なタスク (またはアクション) をサポートしている。</p>
<ul>
<li><strong>学習</strong> - ネットワークの定義、そして教師データを用いて学習済みモデルを生成するための学習</li>
<li><strong>評価</strong> - テストデータ用いて性能を査定するために学習済みモデルをテストすること</li>
<li><strong>デプロイ</strong> - 学習済みモデルを使用すること。例えば、自身のソリューションにおいて、新しいインスタンスを分類すること</li>
</ul>
<p>各タスクの詳しい概要については下記に示してあり、より詳細な説明がポインタ (訳注：おそらくリンク) で提供している。それに加えて、CNTKは既存のモデルの<strong>編集</strong>とノードをファイルへ出力する<strong>書き出し</strong>をサポートしている。これらの詳細はトップレベルコマンドページの高度なトピックスで提供している。</p>
<h2 id="Training-a-model-using-CNTK-CNTKでモデルの学習"><a href="#Training-a-model-using-CNTK-CNTKでモデルの学習" class="headerlink" title="Training a model using CNTK (CNTKでモデルの学習)"></a>Training a model using CNTK (CNTKでモデルの学習)</h2><blockquote>
<p>In the following we use the CNTK configuration and results from the MNIST example, in particular the configuration ‘01_OneHidden.cntk’ (see Image/MNIST and 01_OneHidden.cntk for full details). To train a model using CNTK you need to provide a configuration file as the first argument when calling the CNTK executable, cntk configFile=01_OneHidden.cntk in our example (see also Config file overview for more details on config files). The following snippet provides an overview of the config file contents that are relevant for training.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ModelDir &#x3D; &quot;$OutputDir$&#x2F;Models&quot; deviceId &#x3D; 0 command &#x3D; MNISTtrain  </span><br><span class="line">&gt; modelPath &#x3D; &quot;$ModelDir$&#x2F;01\_OneHidden&quot;  </span><br><span class="line">&gt; MNISTtrain &#x3D; \[ action &#x3D; &quot;train&quot;  </span><br><span class="line">&gt; NDLNetworkBuilder &#x3D; \[ networkDescription &#x3D; &quot;$ConfigDir$&#x2F;01\_OneHidden.ndl&quot; \]  </span><br><span class="line">&gt; SGD &#x3D; \[ ... \]  </span><br><span class="line">&gt; reader &#x3D; \[ readerType &#x3D; &quot;UCIFastReader&quot; file &#x3D; &quot;$DataDir$&#x2F;Train-28x28.txt&quot; ... \] \]</span><br></pre></td></tr></table></figure>

<p>The above code snippet defines a command called MNISTtrain with action = “train”. Other supported actions are for example test or write. The deviceId parameter specifies whether to use CPU or GPU. When set to auto CNTK picks the best available device. Set it to -1 to use the CPU or to a value &gt;=0 to use a specific GPU. The modelPath defines where to store the intermediate and final trained models. In this example it uses the ModelDir variable defined at the beginning of the configuration file. The three main configuration blocks for training define the network itself and the parameters for the training algorithm and the data reader.</p>
<blockquote>
<ul>
<li>Network builder - here you define the topology and the details of the network such as the size and number of layers and the type of nodes. You can use the Simple Network Builder or the NDL Network Builder. Please refer to the corresponding Wiki pages for details.</li>
<li>SGD - this block lets you parameterize the training algorithm (stochastic gradient descent). Options include using momentum, adaptive learning rate, adaptive minibatch size or parallel training. See SGD block for more details.</li>
<li>reader - the reader block defines which reader to use and where the corresponding input files are. CNTK provides several data readers for different formats and tasks (see Reader block).</li>
</ul>
<p>Finally, the line command = “MNISTtrain” specifies which of the defined tasks to execute. To execute several tasks consecutively, e.g. training and evaluation, simply add more tasks to the command separated by a colon: command = “MNISTtrain:MNISTtest”</p>
</blockquote>
<h4 id="訳：-1"><a href="#訳：-1" class="headerlink" title="訳："></a>訳：</h4><p>下記に、CNTKで使用する設定とMNIST (訳注：Mixed National Institute of Standards and Technology、つまりアメリカ国立標準技術研究所がミックスしたもの) のサンプルの結果、特に 01_OneHidden.cntk (詳細は<a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/blob/master/Examples/Image/MNIST/README.md">Image/MNIST</a> と <a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/blob/master/Examples/Image/MNIST/Config/01_OneHidden.cntk">01_OneHidden.cntk</a> を) を示す。<br>CNTKでモデルを学習するために、CNTK実行ファイルを呼び出すとき;cntk configFile=01_OneHidden.cntk に渡した第一引数である設定ファイルを渡す必要がある。下記のスニペットで、トレーニングための正しい設定ファイルの内容の概要を示す。<br>(訳注：ここのコードは原文にあるので省略) 上のコードスニペットは action = “train” を備えた MNISTTrain と呼ばれるコマンドを定義している。ほかのコマンド、例えば test または write もサポートしています。<br>deviceId パラメータはCPUまたはGPUを使うかどうかを指定します。auto をセットした時は CNTK が利用可能な最適なデバイスを採用します。-1 をセットすると、CPU を使用し、0 以上の値を設定することで GPU を使います。modelPath は中間、最終学習済みモデルの保存先を定義します。サンプルでは、設定ファイルの先頭で定義されている ModelDir 変数を使っています。<br>学習のための主な3つの設定ブロックは、ネットワークの定義、学習アルゴリズムのためのパラメータとデータリーダーを定義します。</p>
<ul>
<li>ネットワークビルダー - ここは、トポロジーと、サイズやレイヤーの枚数のようなネットワークの詳細と、ノードの種別を定義します。<a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/wiki/Simple-Network-Builder">Simple Network Builder</a> または <a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/wiki/NDL-Network-Builder">NDL Network Builder</a> を使うことができます。詳細は対応する Wiki ページを。</li>
<li>SGD - このブロックは学習アルゴリズム (stochastic gradient descent : 確率的勾配降下法) をパラメータ化させます。オプションはモメンタム、適応的学習率、適応的ミニバッチサイズ、または並列学習です。詳細は <a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/wiki/SGD-block">SGD bock</a> を。</li>
<li>リーダー - リーダーブロックは、どのリーダーを使用するか、対応する入力ファイルがどこにあるかを定義します。CNTKは、異なるフォーマットとタスクのために、いくつかのデータリーダーを提供しています。(詳細は <a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/wiki/Reader-block">Reader block</a>).</li>
</ul>
<p>最後に、command = “MNISTtrain” 行は、実行する定義済みのタスクを指定します。連続していくつかのテスクを実行するためには、例えば、学習と評価の場合、単純に以降のタスクを “;” で区切って、コマンドに追加します。command = “MNISTtrain:MNISTtest”。</p>
<h2 id="Evaluating-a-trained-model-学習済みモデルの評価"><a href="#Evaluating-a-trained-model-学習済みモデルの評価" class="headerlink" title="Evaluating a trained model (学習済みモデルの評価)"></a>Evaluating a trained model (学習済みモデルの評価)</h2><blockquote>
<p>To evaluate a trained model you can use the eval or test command (see also Train, Test, Eval for full details). The corresponding configuration in the MNIST 01_OneHidden.cntk example looks as follows.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MNISTtest &#x3D; \[ action &#x3D; &quot;test&quot; minibatchSize &#x3D; 16  </span><br><span class="line">&gt; reader &#x3D; \[ readerType &#x3D; &quot;UCIFastReader&quot; file &#x3D; &quot;$DataDir$&#x2F;Test-28x28.txt&quot; ... \] \]</span><br></pre></td></tr></table></figure>

<p>The MNISTtest block uses action = “test”. For the test action you need to define a model that should be used for testing using the modelPath parameter. In this example the modelPath is not defined inside the MNISTtest block but on the top level (see training part above) and is used by both the train and test actions. Inside the reader block you specify the data file that should be used for testing, Test-28x28.txt in the example. Finally, you have to set command = MNISTtest and run cntk configFile=01_OneHidden.cntk to execute the testing. The result on the command line is:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Final Results: Minibatch\[1-625\]: Samples Seen = 10000 err: ErrorPrediction/Sample = 0.0239 ce: CrossEntropyWithSoftmax/Sample = 0.076812531 Perplexity = 1.0798396 COMPLETED </span><br></pre></td></tr></table></figure>

<h4 id="訳：-2"><a href="#訳：-2" class="headerlink" title="訳："></a>訳：</h4><p>学習済みモデルを評価するために、evalまたはtestコマンドを使うことができます。(詳細は <a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/wiki/Train%2C-Test%2C-Eval">Train, Test, Eval</a>)。下記のMNIST <a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/blob/master/Examples/Image/MNIST/Config/01_OneHidden.cntk">01_OneHidden.cntk</a> サンプル内の対応する設定を見ます。<br>(訳注：ここのコードは原文にあるので省略) MNISTtest ブロックでは、action = “test” を使います。test アクションでは、modelPath パラメータを使ってテストのために使用するモデルを定義する必要があります。このサンプルで、modelPath はMNISTTest ブロック内ではなくトップレベルで定義され (Training a model using CNTK を見てください)、trainとtestコマンドの両方が使用されています。readerブロック内では、テストに使用されるデータファイル;サンプルではTest-28x28.txt、を指定します。最後に、command = MNISTtestの設定と、テストを実行するために cntk configFile=01_OneHidden.cntk を走らせなくてはなりません。コマンドラインの結果は (訳注：ここのコードは原文にあるので省略)</p>
<h2 id="Using-a-trained-model-in-your-own-solution-学習済みモデルの評価"><a href="#Using-a-trained-model-in-your-own-solution-学習済みモデルの評価" class="headerlink" title="Using a trained model in your own solution (学習済みモデルの評価)"></a>Using a trained model in your own solution (学習済みモデルの評価)</h2><blockquote>
<p>To use a trained CNTK model in your own solution you can either use the EvalDll from C++ or wrap the EvalDll to call it from other languages. An example for a .NET wrapper and a C# client is provided in Source/Extensibility/CSEvalClient. The example shows how to use the trained MNIST 01_OneHidden model to classify an image. The following code snippet is taken from Program.cs in Source/Extensibility/CSEvalClient.</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">... Dictionary&lt;<span class="keyword">string</span>, List&lt;<span class="keyword">float</span>&gt;&gt; outputs;  </span><br><span class="line">&gt; <span class="keyword">using</span> (<span class="keyword">var</span> model = <span class="keyword">new</span> IEvaluateModelManagedF()) &#123; <span class="comment">// Initialize model evaluator string config = GetConfig(); model.Init(config);  </span></span><br><span class="line">&gt; <span class="comment">// Load model string modelFilePath = Path.Combine(Environment.CurrentDirectory, @&quot;..\\Output\\Models\\01\_OneHidden&quot;); model.LoadModel(modelFilePath);  </span></span><br><span class="line">&gt; <span class="comment">// Generate random input values in the appropriate structure and size var inputs = GetDictionary(&quot;features&quot;, 28\*28, 255);  </span></span><br><span class="line">&gt; <span class="comment">// We can call the evaluate method and get back the results (single layer)... // List&lt;float&gt; outputList = model.Evaluate(inputs, &quot;ol.z&quot;, 10);  </span></span><br><span class="line">&gt; <span class="comment">// ... or we can preallocate the structure and pass it in (multiple output layers) outputs = GetDictionary(&quot;ol.z&quot;, 10, 1); model.Evaluate(inputs, outputs); &#125; ...</span></span><br></pre></td></tr></table></figure>

<p>See Program.cs for full details. If you get an exception Cannot move externally owned matrices to the preferred device. please specify deviceId=-1 in the config file.</p>
<h4 id="訳：-3"><a href="#訳：-3" class="headerlink" title="訳："></a>訳：</h4><p>学習済みのCNTKモデルをソリューションで使用するために、C++から <a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/tree/master/Source/EvalDll">EvalDll</a>、または 他の言語から呼び出すためにEvalDll をラップしたものを使うことができます。サンプルのために、.NETラッパーとC#クライアントが <a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/tree/master/Source/Extensibility/CSEvalClient">Source/Extensibility/CSEvalClient</a> で提供されています。サンプルでは、学習済みのMNIST 01_OneHidden モデルを画像の分類のためにどのように使うかを示してします。下記のコードスニペットは <a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/tree/master/Source/Extensibility/CSEvalClient">Source/Extensibility/CSEvalClient</a> 内の、Program.cs です。<br>(訳注：ここのコードは原文にあるので省略) 詳細は、<a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/blob/master/Source/Extensibility/CSEvalClient/Program.cs">Program.cs</a> を。もし、Cannot move externally owned matrices to the preferred device (訳注 : 訳は「優先デバイスに所有権のある行列を外部に移動することはできません」ですが、CNTKの内部例外は日本語にならないので、このままにしました) という例外を受け取った場合は、deviceID=-1 を設定ファイルで指定してください。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>訳のレベルが低すぎるのはご愛嬌。<br>.NETのラッパーがサンプルで提供されていることが発覚しました。<br>これは面白くなってきました。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-02-29</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/ソフトウェア紹介/" title="ソフトウェア紹介">ソフトウェア紹介 </a><a class="tag" href="/categories/e3-83-87-e3-82-a3-e3-83-bc-e3-83-97-e3-83-a9-e3-83-bc-e3-83-8b-e3-83-b3-e3-82-b0/" title="%e3%83%87%e3%82%a3%e3%83%bc%e3%83%97%e3%83%a9%e3%83%bc%e3%83%8b%e3%83%b3%e3%82%b0">%e3%83%87%e3%82%a3%e3%83%bc%e3%83%97%e3%83%a9%e3%83%bc%e3%83%8b%e3%83%b3%e3%82%b0 </a><a class="tag" href="/categories/e3-83-87-e3-82-a3-e3-83-bc-e3-83-97-e3-83-a9-e3-83-bc-e3-83-8b-e3-83-b3-e3-82-b0/CNTK/" title="CNTK">CNTK </a><a class="tag" href="/categories/オープンソース/" title="オープンソース">オープンソース </a><a class="tag" href="/categories/gpupu/" title="gpupu">gpupu </a><a class="tag" href="/categories/ディープラーニング/" title="ディープラーニング">ディープラーニング </a><a class="tag" href="/categories/gpupu/CUDA/" title="CUDA">CUDA </a><a class="tag" href="/categories/GPUPU/" title="GPUPU">GPUPU </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2016/02/29/866/,A certain engineer &quot;COMPLEX&quot;,ディープラーニング CNTK その3 説明,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2016/03/03/882/" title="ディープラーニング CNTK その4 自分で学習">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2016/02/27/861/" title="ディープラーニング CNTK その2 テスト">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>