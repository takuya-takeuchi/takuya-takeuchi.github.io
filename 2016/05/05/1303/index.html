<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>Xamarinメモ その17 TabbedPageとNavigationPageの組み合わせ · A certain engineer "COMPLEX"</title><meta name="description" content="前回はAndroidのUnzipped Failedを解決しました。

Problem以前、TabbedPageについて記事を書きましたが、もう一つ重要なNavigationPageを組み合わせて見ます。 ただ、NavigationPageとTabbedPageを組み合わす際、NavigationP"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Xamarinメモ その17 TabbedPageとNavigationPageの組み合わせ</a></h3></div><div class="post-content"><p><a target="_blank" rel="noopener" href="http://wp.me/p7138e-jP">前回</a>はAndroidのUnzipped Failedを解決しました。</p>
<a id="more"></a>
<h1 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h1><p>以前、TabbedPageについて記事を書きましたが、もう一つ重要なNavigationPageを組み合わせて見ます。 ただ、NavigationPageとTabbedPageを組み合わす際、NavigationPageの子要素として、TabbedPageを加えるのはよくないとのこと。 三日月 ふゆの氏の記事。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="http://mikazuki.hatenablog.jp/entry/2015/11/10/012403" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=mikazuki.hatenablog.jp"></img><div class="hbc-site-name">みかづきメモ</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img src="https://ogimage.blog.st-hatena.com/8454420450093774953/6653458415127539795/1447147507"></img></div><div class="hbc-text"><div class="hbc-title">Xamarin.Forms で TabbedPage の子に NavigationPage を追加してみる - みかづきメモ</div><div class="hbc-url">http://mikazuki.hatenablog.jp/entry/2015/11/10/012403</div><div class="hbc-description">Xamarin.Forms(XAML) を使って、 NavigationPage + TabbedPage を作ってみます。 Twitter for iPhone や TweetBot みたいな感じの UI ですね。 ただ、 NavigationPage |- TabbedPag…</div></div></div></div></a></div></div> 元ネタ。 



<p>これを踏まえ、TabbedPageの下に、NavigationPage、NavigationPageの下に2つのContentPageというシンプルな実装を試しました。 ContentPageの最初でNextボタンがあり、それを押下すると、次のページにNavigationされる、というものです。 また、それぞれのPageにViewModelが紐付きます。つまり、4つのViewと4つのViewModelです。 そこまで大それたものではないはずです。 その実現のために、Webの各所を見ていきました。 下記は主に参考にさせていただいた記事です。 かずき氏の記事。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="http://blog.okazuki.jp/entry/2016/04/24/094141" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=blog.okazuki.jp"></img><div class="hbc-site-name">かずきのBlog@hatena</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/o/okazuki/20160423/20160423193303.png"></img></div><div class="hbc-text"><div class="hbc-title">Xamarin.Forms + Prism.Formsで画面遷移DeepDive - かずきのBlog@hatena</div><div class="hbc-url">http://blog.okazuki.jp/entry/2016/04/24/094141</div><div class="hbc-description">Prism.Formsは、地味にネストした画面遷移みたいなのをサポートしています。 画面遷移のINavigationService#Navigateメソッドに渡すURLに&quot;/HogePage/FugaPage/BarPage?id=10&quot;みたいに/で区切ってページ指定が出来ます。…</div></div></div></div></a></div></div> Prismの開発者の一人Brian Lagunas氏の記事。 

<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="http://brianlagunas.com/prism-for-xamarin-forms-6-2-0-preview/" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=brianlagunas.com"></img><div class="hbc-site-name">Brian Lagunas</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img src="https://brianlagunas.com/wp-content/uploads/2015/12/Prism-Logo-Graphic.jpg"></img></div><div class="hbc-text"><div class="hbc-title">Prism for Xamarin.Forms 6.2.0 Preview - Brian Lagunas</div><div class="hbc-url">http://brianlagunas.com/prism-for-xamarin-forms-6-2-0-preview/</div><div class="hbc-description">Learn what&#39;s new in Prism for Xamarin.Forms 6.2.0 Preview. Check out the all new navigation service features such as URI support and deep li…</div></div></div></div></a></div></div>

<p>で、いろいろ試行錯誤しましたが、実現できませんでした。 ページが遷移しない、クラッシュする、タブが出ないetcです。</p>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>逃げ口上ではないですが、注意事項です。</p>
<p><strong>Prism.Forms 6.1.0-pre4</strong></p>
<p><strong>Prism.Unity.Forms 6.2.0-pre4</strong></p>
<p><strong>Xamarin.Forms 2.2.0.31</strong></p>
<p>の環境の話です。 特に、Prism.Forms、Prism.Unity.Formsはプリリリース版なので、正式版では私が遭遇した問題は治っている可能性があります。 多分私の手法は間違っているだろうし、MVVMの観点からもよくないような気がします。 正しいやり方があると思いますが、動く方法が見つかったので、私は良しとしました。 動かないプロダクトよりも動くプロダクトのが何百倍も価値があります。</p>
<h3 id="UnityApplicationは使わない"><a href="#UnityApplicationは使わない" class="headerlink" title="UnityApplicationは使わない"></a>UnityApplicationは使わない</h3><p>まず、<strong>Prism.Unity.UnityApplication</strong>を継承して、Appを実装しますが、この方法は使いません。 なぜかというと、<strong>OnInitialized</strong>をオーバーライドし、NavigationSerice.Navigateメソッドで一番最初に表示するページを指示するのですが、TabbedPageを指示するとクラッシュします。ContentPageである、NavigationPageの子要素ならOKですが、そうすると、TabbedPageとNavigationPageが見えなくなります。 ですので、Obsoleteではありますが、<strong>Prism.Unity.UnityBootstrapper</strong>を継承したクラスを作成し、そのクラスのRunメソッドにAppクラスのインスタンスを渡す方法をとります。 これならば、<strong>CreateMainPage</strong>をオーバーライドする際に、TabbedPageを指定することができます。</p>
<h3 id="NavigationServiceは使わない"><a href="#NavigationServiceは使わない" class="headerlink" title="NavigationServiceは使わない"></a>NavigationServiceは使わない</h3><p>NavigationServiceのインスタンスには、明示的に指定しない限り、<strong>Prism.Unity.Navigation.UnityPageNavigationService</strong>が使われますが、無視します。 このクラスを使えば、本来はNavigationする際の、履歴を管理して、Backしたりできるはずなのですが、私にはどうやってもそれができませんでした。 ソースを見ると、UnityPageNavigationServiceのコンストラクタに、UnityContainerを渡しているのですが、途中でページの履歴の基準がMainPageになってしまっており、これによりNavigationがうまくいかなくなっているように見えます。ページは遷移するのですが、左上に本来は表示されるであろう直前のページへの遷移ボタンが表示されません。 以上を踏まえ今回のソースです。 </p>
<div class="blog-card"><div class="hbc-link-wrap"><a class="hbc-link" href="https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable8" target="_blank" rel="nofollow"><div class="hbc-card"><div class="hbc-info"><img class="hbc-favicon" src="http://www.google.com/s2/favicons?domain=github.com"></img><div class="hbc-site-name">GitHub</div></div><div class="hbc-contents"><div class="hbc-thumbnail"><img src="https://avatars0.githubusercontent.com/u/6241854?s=400&v=4"></img></div><div class="hbc-text"><div class="hbc-title">takuya-takeuchi/Demo</div><div class="hbc-url">https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable8</div><div class="hbc-description">Sample source code for Demonstration, Experiment and Test - takuya-takeuchi/Demo</div></div></div></div></a></div></div>

<h1 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a>Resolution</h1><h3 id="ViewModel"><a href="#ViewModel" class="headerlink" title="ViewModel"></a>ViewModel</h3><p>まず、ViewModelはすべて引数をとりません。またViewModelとViewの紐付けは<strong>ViewModelLocator.AutowireViewModel</strong>で実現しています。 TabbedPageとNavigationViewに対応するViewModelは空なので無視します。 <strong>FirstPageViewModel.cs</strong> [code lang=”csharp”] using Prism.Commands; using Prism.Common; using Prism.Mvvm; using Xamarin.Forms.Portable8.Views;<br>namespace Xamarin.Forms.Portable8.ViewModels { public sealed class FirstPageViewModel : BindableBase, IPageAware {<br>public Page Page { get; set; }<br>private DelegateCommand _NextCommand; public DelegateCommand NextCommand { get { if (this._NextCommand == null) { this._NextCommand = new DelegateCommand(() =&gt; { this.Page.Navigation.PushAsync(new NextPage()); }); }<br>return this._NextCommand; } } } } [/code] <strong>NextPageViewModel.cs</strong> [code lang=”csharp”] using Prism.Commands; using Prism.Common; using Prism.Mvvm;<br>namespace Xamarin.Forms.Portable8.ViewModels { public sealed class NextPageViewModel : BindableBase, IPageAware { public Page Page { get; set; }<br>private DelegateCommand _BackCommand; public DelegateCommand BackCommand { get { if (this._BackCommand == null) { this._BackCommand = new DelegateCommand(() =&gt; { this.Page.Navigation.PopAsync(); }); }<br>return this._BackCommand; } }<br>} } [/code] ポイントは<strong>Prism.Common.IPageAware</strong>の実装です。単純にPageプロパティを持つだけですが。 これによって、PageのNavigationプロパティにViewModelからアクセスできるようになり、PopAsyncとPushAsyncを呼び出せるようになります。 これでページの遷移が可能になります。</p>
<h3 id="Views"><a href="#Views" class="headerlink" title="Views"></a>Views</h3><p>正直、BindingContextを見て、挙動を変える方法はあまり好きではないですし、コードビハインドをいじるのも嫌なんですが… <strong>FirstPage.xaml.cs</strong> [code lang=”csharp”] using Prism.Common;<br>namespace Xamarin.Forms.Portable8.Views { public partial class FirstPage : ContentPage { public FirstPage() { // BindingContext is updated before InitializeComponent this.BindingContextChanged += (sender, args) =&gt; { var pageAware = this.BindingContext as IPageAware; if (pageAware != null) { pageAware.Page = this; } };<br>InitializeComponent(); } } } [/code] NextPage.xaml.csも同じような感じです。 BindingContextChangeをサブスクライブして、BindingContextがIPageAwareを実装していたら、Pageプロパティに自分自身を設定します。 コメントにもありますが、なぜかInitializeComponentより前で、BindingContextが設定されていたので、苦肉の策でInitializeComponentの前でサブスクライブしてます。 Xamlですが、Main、つまりアプリ全体を表現する要のXamlだけ記載しておきます。他は単純なので… <strong>MainPage.xaml</strong> [code lang=”xaml”] <?xml version="1.0" encoding="utf-8" ?> <TabbedPage x:Class="Xamarin.Forms.Portable8.Views.MainPage" xmlns="http://xamarin.com/schemas/2014/forms" xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml" xmlns:mvvm="clr-namespace:Prism.Mvvm;assembly=Prism.Forms" xmlns:views="clr-namespace:Xamarin.Forms.Portable8.Views;assembly=Xamarin.Forms.Portable8" mvvm:ViewModelLocator.AutowireViewModel="True"><br>&lt;TabbedPage.Padding&gt; <OnPlatform x:TypeArguments="Thickness" Android="0" WinPhone="0" iOS="0, 20, 0, 0" /> &lt;/TabbedPage.Padding&gt;<br>&lt;TabbedPage.Children&gt; &lt;views:NavigationPage Title=”Tab1”&gt; &lt;x:Arguments&gt; &lt;views:FirstPage /&gt; </x:Arguments> </views:NavigationPage> &lt;views:NavigationPage Title=”Tab2”&gt; &lt;x:Arguments&gt; &lt;views:FirstPage /&gt; </x:Arguments> </views:NavigationPage> &lt;views:NavigationPage Title=”Tab3”&gt; &lt;x:Arguments&gt; &lt;views:FirstPage /&gt; </x:Arguments> </views:NavigationPage> &lt;/TabbedPage.Children&gt; </TabbedPage> [/code]</p>
<h3 id="Startup"><a href="#Startup" class="headerlink" title="Startup"></a>Startup</h3><p>最後に、スタートアップ周りのコードです。 冒頭のObsolete等はここです。 <strong>App.cs</strong> [code lang=”csharp”] namespace Xamarin.Forms.Portable8 { public class App : Application { public App() { var bootstrapper = new Bootstrapper(); bootstrapper.Run(this); }<br>protected override void OnStart() { // Handle when your app starts }<br>protected override void OnSleep() { // Handle when your app sleeps }<br>protected override void OnResume() { // Handle when your app resumes } } } [/code] <strong>Bootstrapper.cs</strong> [code lang=”csharp”] using System; using Microsoft.Practices.Unity; using Prism.Unity; using Xamarin.Forms.Portable8.ViewModels; using Xamarin.Forms.Portable8.Views;<br>namespace Xamarin.Forms.Portable8 { public sealed class Bootstrapper : UnityBootstrapper { [Obsolete] protected override Xamarin.Forms.Page CreateMainPage() { return this.Container.Resolve(); }<br>protected override void RegisterTypes() { // ViewModels this.Container.RegisterType(); this.Container.RegisterType(); this.Container.RegisterType(); this.Container.RegisterType();<br>// Views // Maybe, the following codes are meaningless because NavigationSerivce is not used. //this.Container.RegisterType(); //this.Container.RegisterType(); //this.Container.RegisterType(); //this.Container.RegisterType();<br>//this.Container.RegisterTypeForNavigation(); //this.Container.RegisterTypeForNavigation(); //this.Container.RegisterTypeForNavigation(); }<br>protected override void OnInitialized() { // I guess it is meaningless. //this.NavigationService.Navigate(“/NavigationPage/MainPage”); } } } [/code] コメントアウトした箇所は実行に影響がないので削除しました。</p>
<h1 id="テスト"><a href="#テスト" class="headerlink" title="テスト"></a>テスト</h1><p>動かしてみました。</p>
<h4 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h4><p>[wc_row][wc_column size=”one-third” position=”first”] <a href="../../../../public/2016/05/i1-3.png"><img src="../../../../public/2016/05/i1-3-197x300.png" alt="Tab1のFirst page"></a></p>
<p>Tab1のFirst page</p>
<p>[/wc_column][wc_column size=”one-third”]<br><a href="../../../../public/2016/05/i2-2.png"><img src="../../../../public/2016/05/i2-2-197x300.png"></a></p>
<p>Tab1のNext page</p>
<p>[/wc_column][wc_column size=”one-third” position=”last”]<br><a href="../../../../public/2016/05/i3-1.png"><img src="../../../../public/2016/05/i3-1-197x300.png"></a></p>
<p>Tab2のFirst page</p>
<p>[/wc_column][/wc_row]</p>
<h4 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h4><p>[wc_row][wc_column size=”one-third” position=”first”] <a href="../../../../public/2016/05/3127e02ff1511185286456bc80f806f4.png"><img src="../../../../public/2016/05/3127e02ff1511185286456bc80f806f4-168x300.png" alt="Tab1のFirst page"></a></p>
<p>Tab1のFirst page</p>
<p>[/wc_column][wc_column size=”one-third”] <a href="../../../../public/2016/05/35a40365117b2d31c2681e1878827c73.png"><img src="../../../../public/2016/05/35a40365117b2d31c2681e1878827c73-168x300.png" alt="Tab1のNext page"></a></p>
<p>Tab1のNext page</p>
<p>[/wc_column][wc_column size=”one-third” position=”last”] <a href="../../../../public/2016/05/2e052e332b7c66d373ed4a52f1bee2b7.png"><img src="../../../../public/2016/05/2e052e332b7c66d373ed4a52f1bee2b7-168x300.png" alt="Tab2のFirst page"></a></p>
<p>Tab2のFirst page</p>
<p>[/wc_column][/wc_row]</p>
<h4 id="UWP"><a href="#UWP" class="headerlink" title="UWP"></a>UWP</h4><p>[wc_row][wc_column size=”one-third” position=”first”]<br><a href="../../../../public/2016/05/w1-2.png"><img src="../../../../public/2016/05/w1-2-157x300.png"></a></p>
<p>Tab1のFirst page</p>
<p>[/wc_column][wc_column size=”one-third”] <a href="../../../../public/2016/05/w2-2.png"><img src="../../../../public/2016/05/w2-2-157x300.png" alt="Tab1のNext page"></a></p>
<p>Tab1のNext page</p>
<p>[/wc_column][wc_column size=”one-third” position=”last”] <a href="../../../../public/2016/05/w3-1.png"><img src="../../../../public/2016/05/w3-1-157x300.png" alt="Tab2のFirst page"></a></p>
<p>Tab2のFirst page</p>
<p>[/wc_column][/wc_row] きちんとタブごとに遷移している状態を覚えています。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>かなり苦労しましたが、やりきった感じでいっぱいです。 間違っているようなやり方ですが、動けばいい、という方はいると思うので、だれかの役に立つでしょう。</p>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable8">https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable8</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-05-05</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Microsoft/NET-Framework/" title=".NET Framework">.NET Framework </a><a class="tag" href="/categories/Xamarin/" title="Xamarin">Xamarin </a><a class="tag" href="/categories/Microsoft/NET-Framework/C/" title="C#">C# </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2016/05/05/1303/,A certain engineer &quot;COMPLEX&quot;,Xamarinメモ その17 TabbedPageとNavigationPageの組み合わせ,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2016/05/06/1338/" title="Xamarinメモ その18 Xamarin.Forms.ThemesをPrism.Unity.Formsと併用する場合の注意">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2016/05/05/1229/" title="Xamarinメモ その16 Unzipping failed">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>