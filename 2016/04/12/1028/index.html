<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>UWPメモ その5 UWP/WPFで画像オブジェクトに対する解放処理は不要なのか · A certain engineer "COMPLEX"</title><meta name="description" content="会社で使う学習資料の更新が終わりました。毎回PowerPointのスライド20枚とサンプルプログラム1,2個つけたのが、今日の時点で13個。頑張ったものです。

ProblemWinFormsだと、画像オブジェクト、例えばSystem.Drawing.Bitmapは不要になったら、nullで参照を削"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>UWPメモ その5 UWP/WPFで画像オブジェクトに対する解放処理は不要なのか</a></h3></div><div class="post-content"><p>会社で使う学習資料の更新が終わりました。毎回PowerPointのスライド20枚とサンプルプログラム1,2個つけたのが、今日の時点で13個。頑張ったものです。</p>
<a id="more"></a>
<h1 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h1><p>WinFormsだと、画像オブジェクト、例えば<strong>System.Drawing.Bitmap</strong>は不要になったら、nullで参照を削除する前に、Disposeメソッドを呼び出す必要があります。<br>これは内部で保持している、GDIによるアンマネージドデータを破棄するために他なりません。<br>対して、GDIを使っていないWPF/UWPはどうなのでしょう？ 無限ループで<strong>System.Windows.Media.Imaging.WriteableBitmap</strong>を生成するプログラムを組んでチェックしましたが、private working setが増えていたことから、アンマネージドでどこかにデータを確保しているのは間違いありませんでした。<br>でも、IDiposableインターフェイスは実装していません。<br>本当に参照が全部消えれば破棄されるの？ 不安はぬぐい去れません。<br>五年前、入社二年目の私はインド人が手を入れた.NETをプログラムの修正を任されました。当時.NETを扱える人間が私しかいなかったためです。<br>で、そのソース、画像データを大量に扱う代物で、一切解放処理が書いてありませんでした。<br>当然しばらくするとメモリ不足で落ちました。4000x4000とか巨大なビットマップを扱うものですから… トルコまで行って対応したのはいい思い出です(白目)</p>
<h1 id="Inspection"><a href="#Inspection" class="headerlink" title="Inspection"></a>Inspection</h1><p>簡単なサンプルプログラムをWPF/UWPそれぞれ用意しました。<br><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/UWP4">https://github.com/takuya-takeuchi/Demo/tree/master/UWP4</a> UWP側のViewModelだけ記載します。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System; <span class="keyword">using</span> System.Collections.Generic; <span class="keyword">using</span> Windows.UI.Xaml.Media.Imaging; <span class="keyword">using</span> Prism.Commands; <span class="keyword">using</span> Prism.Windows.Mvvm; <span class="keyword">using</span> Shared.Services; <span class="keyword">using</span> Shared.ViewModels;  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">UWP4.ViewModels</span> &#123; <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">MainPageViewModel</span> : <span class="title">ViewModelBase</span>, <span class="title">IMainPageViewModel</span> &#123;  </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">readonly</span> <span class="title">List</span>&lt;<span class="title">WriteableBitmap</span>&gt; \_WriteableBitmaps</span> = <span class="keyword">new</span> List&lt;WriteableBitmap&gt;();  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> IDispatcherService \_DispatcherService;  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MainPageViewModel</span>(<span class="params">IDispatcherService dispatcherService</span>)</span> &#123; <span class="keyword">this</span>.\_DispatcherService = dispatcherService; <span class="keyword">this</span>.Width = <span class="number">2000</span>; <span class="keyword">this</span>.Height = <span class="number">2000</span>; <span class="keyword">this</span>.Count = <span class="number">10</span>; &#125;  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> \_Count; <span class="keyword">public</span> <span class="keyword">int</span> Count &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.\_Count; &#125; <span class="keyword">set</span> &#123; <span class="keyword">this</span>.SetProperty(<span class="keyword">ref</span> <span class="keyword">this</span>.\_Count, <span class="keyword">value</span>); &#125; &#125;  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> \_Width; <span class="keyword">public</span> <span class="keyword">int</span> Width &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.\_Width; &#125; <span class="keyword">set</span> &#123; <span class="keyword">this</span>.SetProperty(<span class="keyword">ref</span> <span class="keyword">this</span>.\_Width, <span class="keyword">value</span>); &#125; &#125;  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> \_Height; <span class="keyword">public</span> <span class="keyword">int</span> Height &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.\_Height; &#125; <span class="keyword">set</span> &#123; <span class="keyword">this</span>.SetProperty(<span class="keyword">ref</span> <span class="keyword">this</span>.\_Height, <span class="keyword">value</span>); &#125; &#125;  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">bool</span> \_Freeze; <span class="keyword">public</span> <span class="keyword">bool</span> Freeze &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.\_Freeze; &#125; <span class="keyword">set</span> &#123; <span class="keyword">this</span>.SetProperty(<span class="keyword">ref</span> <span class="keyword">this</span>.\_Freeze, <span class="keyword">value</span>); &#125; &#125;  </span><br><span class="line"><span class="keyword">private</span> DelegateCommand \_StartCommand; <span class="keyword">public</span> DelegateCommand StartCommand &#123; <span class="keyword">get</span> &#123; <span class="keyword">if</span> (<span class="keyword">this</span>.\_StartCommand == <span class="literal">null</span>) &#123; <span class="keyword">this</span>.\_StartCommand = <span class="keyword">new</span> DelegateCommand( () =&gt; &#123; <span class="keyword">var</span> width = <span class="keyword">this</span>.Width; <span class="keyword">var</span> height = <span class="keyword">this</span>.Height; <span class="keyword">var</span> count = <span class="keyword">this</span>.Count; <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++) <span class="keyword">this</span>.\_WriteableBitmaps.Add(<span class="keyword">new</span> WriteableBitmap(width, height)); &#125;); &#125;  </span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.\_StartCommand; &#125; &#125;  </span><br><span class="line"><span class="keyword">private</span> DelegateCommand \_ClearCommand; <span class="keyword">public</span> DelegateCommand ClearCommand &#123; <span class="keyword">get</span> &#123; <span class="keyword">if</span> (<span class="keyword">this</span>.\_ClearCommand == <span class="literal">null</span>) &#123; <span class="keyword">this</span>.\_ClearCommand = <span class="keyword">new</span> DelegateCommand( () =&gt; &#123; <span class="keyword">this</span>.\_WriteableBitmaps.Clear(); &#125;); &#125;  </span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.\_ClearCommand; &#125; &#125;  </span><br><span class="line"><span class="keyword">private</span> DelegateCommand \_GCCommand; <span class="keyword">public</span> DelegateCommand GCCommand &#123; <span class="keyword">get</span> &#123; <span class="keyword">if</span> (<span class="keyword">this</span>.\_GCCommand == <span class="literal">null</span>) &#123; <span class="keyword">this</span>.\_GCCommand = <span class="keyword">new</span> DelegateCommand(GC.Collect); &#125;  </span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.\_GCCommand; &#125; &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Startボタンを押下すると、TextBoxで指定した、Width、HeightとCountで指定しただけのWriteableBitmapを生成して、System.Collections.Generic.Listに格納していきます。<br>Clearボタンを押下すると、List.Clearを呼びリストを空にします。<br>この時点で参照が全て消えるので、GCが動けばメモリが解放されるはずです。<br>一応明示的にGCを呼ぶためのGCボタンを用意しました。<br>また、WPFのWriteableBitmapはSystem.Windows.Freezableクラスの派生形であるため、Freezeメソッドをコールした場合、そうでない場合、挙動がどう変化するのかを確認します。</p>
<h3 id="Try"><a href="#Try" class="headerlink" title="Try"></a>Try</h3><p>計測は、<strong>dotMemory</strong>を使います。<br>まずUWPです。<br>起動直後、Start直後、Clear直後、GC直後の4段階でSnapshotを採取します。</p>
<p><a href="../../../../public/2016/04/1-4.png"><img src="../../../../public/2016/04/1-4-1024x620.png"></a></p>
<p>次に、Start直後とClear直後で比較をとります。<br>Listに含まれるWriteableBitmapのインスタンスが削除されていることがわかりますが、この時点ではメモリ量は変化しません。<br>最後の、GC直後の段階でメモリ使用量が大幅に減っているのがわかります。</p>
<p><a href="../../../../public/2016/04/2-3.png"><img src="../../../../public/2016/04/2-3-1024x620.png"></a></p>
<p>同じようにWPFでもテストします。最初はFreezeしない状態で4つのSnapshotを採取します。</p>
<p><a href="../../../../public/2016/04/3-3.png"><img src="../../../../public/2016/04/3-3-1024x620.png"></a></p>
<p>最後に、起動直後にFreezeのフラグを有効にして、WriteableBitmap生成直後にFreezeする処理を追加したパターンで4つのSnapshotを採取します。</p>
<p><a href="../../../../public/2016/04/4-3.png"><img src="../../../../public/2016/04/4-3-1024x620.png"></a></p>
<p>Freezeの有無でメモリ使用量に変化があります。Freezeすると確保するメモリ量が60%位になりました。<br>Freeze状態にすると変更できなくなるため、データ内容を変更するために用意したバッファなどがなくなるのでしょうか？ どちらにしても変更が不要なら、不要になった時点で即座にFreezeした方が良さそうです。<br>UWPも219.67MB-66.69MB=152.98MB WPFも230.71MB-77.42MB=153.29MB となり、 2000_2000_4(ARGB?)*10/1024/1024=152MB というデータ量に近似します。<br>メモリリークは発生していないと言えそうです。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>WinFormsと異なり、画像データのメモリリークは起きないことが証明されました。<br>ただ、WinFormsとは違って、GCが発生しないとメモリが解放されないのはどうも… 明示的にGCを呼ぶのはWinFormsの時の経験から言って避けたいところです。明示的に呼んでフリーズしてそのまま何もできなくなってしまったことがあったので。<br>なにはともあれ、不安は消えました。</p>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/UWP4">https://github.com/takuya-takeuchi/Demo/tree/master/UWP4</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-04-12</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Microsoft/NET-Framework/" title=".NET Framework">.NET Framework </a><a class="tag" href="/categories/Microsoft/NET-Framework/Universal-Windows-Platform/" title="Universal Windows Platform">Universal Windows Platform </a><a class="tag" href="/categories/Microsoft/NET-Framework/Universal-Windows-Platform/Windows-Presentation-Foundation/" title="Windows Presentation Foundation">Windows Presentation Foundation </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2016/04/12/1028/,A certain engineer &quot;COMPLEX&quot;,UWPメモ その5 UWP/WPFで画像オブジェクトに対する解放処理は不要なのか,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2016/04/17/1066/" title="Xamarinメモ その3 またデバッグできない">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2016/04/10/1055/" title="Xamarinメモ その2 No valid iOS code signing keys found in keychainを解決">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>