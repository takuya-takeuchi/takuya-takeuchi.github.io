<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>Xamarinメモ その7 Timerを使ってみる · A certain engineer "COMPLEX"</title><meta name="description" content="前回はMVVMを使ってみました。

ProblemXamlを使ってみたので、色々簡単にできると思います。 なので、Timerを使ってストップウォッチを作ってみました。 ソースは https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.F"><meta name="keywords" content="极限博客,极限Blog,博客,极限"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>心之所愿，无事不成。<br> Nothing is impossible to a willing heart.</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/mrcore"><i class="fa fa-github"></i></a></li><li><a href="mailto:x@jixian.io"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY="><i class="fa fa-qq"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/people/"><i class="fa fa-mortar-board"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2017 - 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li><li><a href="/guestbook">メッセージ</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Xamarinメモ その7 Timerを使ってみる</a></h3></div><div class="post-content"><p><a target="_blank" rel="noopener" href="http://wp.me/p7138e-hP">前回</a>はMVVMを使ってみました。</p>
<a id="more"></a>
<h1 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h1><p>Xamlを使ってみたので、色々簡単にできると思います。 なので、Timerを使ってストップウォッチを作ってみました。 ソースは <a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable2">https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable2</a>です。 この手の話題は<strong>エクセルソフトの田淵様</strong>の<a target="_blank" rel="noopener" href="http://ytabuchi.hatenablog.com/entry/2015/12/20/012007">JXUGC #9 Xamarin.Forms Mvvm 実装方法 Teachathon を開催しました</a>で実施済みですが、あえて自分でやってみます。 課題はTimerをどうするか、ですが普通にXamarinのページに<a target="_blank" rel="noopener" href="https://developer.xamarin.com/api/member/Xamarin.Forms.Device.StartTimer/p/System.TimeSpan/System.Func%7BSystem.Boolean%7D/">Xamarin.Forms.Device.StartTimer</a>がありました。 けど、WinFormsやWPFでお世話になったSystem.Timers.Timerとかと違います。 インスタンスを作ってそこで管理するのではなく、Staticメソッドにコールバックを渡して、指定した間隔で処理をするようです。 タイマーを停止する方法は</p>
<blockquote>
<p>While the callback returns true, the timer will keep recurring.</p>
</blockquote>
<p>訳:コールバックがtrueを返す間は、タイマーは繰り返し発生し続けます。</p>
<p>とあるので、第二引数のコールバックで不要になったらfalseを返せば良いだけのようです。</p>
<h1 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a>Resolution</h1><p>Timerさえわかれば、あとはちょいちょい、って感じかと思ったそうでもありませんでした。 Xamlで作れるし、WPF、UWPとクラスが似ているので直感的に作れますが、細かいところが違います。 まず、WidthやHeightがReadOnlyなので、要素をおおまかなおおきさにして配置するのが面倒です。 あと、Xamlのインテリセンスが少し残念です。プロパティ要素構文でインテリセンスの推測が効かないので、最初は焦りました。 最もきついのは、Xaml構文でエラーになってもビルドが通ることです。 最初、間違えてResoueceプロパティの子要素に、下記のようにリソース要素を追加していました。 [code lang=”xaml”] &lt;ContentPage.Resources&gt; &lt;converters:BooleanInvertConverter x:Key=”BooleanInvertConverter” /&gt; &lt;/ContentPage.Resources&gt; [/code] でも、これでビルドが通って、長い時間かけて起動したiPhone Simulatorで実行時エラー、となると悲しいです。 正しくは当然下記のよう。 [code lang=”xaml”] &lt;ContentPage.Resources&gt; <ResourceDictionary> &lt;converters:BooleanInvertConverter x:Key=”BooleanInvertConverter” /&gt; </ResourceDictionary> &lt;/ContentPage.Resources&gt; [/code] これは改善して欲しいです。 辛いのはこれくらいですが、あとは普通です。WPFやUWPがきちんと使えればどうとでもなります。 VisiblityプロパティがIsVisibleでbool型なのはWinFormsを思い出して、(<em>´ω｀</em>)ﾎｯｺﾘしました。 最終的に、 <strong>MainPage.xaml</strong> [code lang=”xaml”] <?xml version="1.0" encoding="utf-8" ?> <ContentPage x:Class="Xamarin.Forms.Portable2.Views.MainPage" xmlns="http://xamarin.com/schemas/2014/forms" xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml" xmlns:converters="clr-namespace:Xamarin.Forms.Portable2.Converters;assembly=Xamarin.Forms.Portable2" xmlns:viewModels="clr-namespace:Xamarin.Forms.Portable2.ViewModels;assembly=Xamarin.Forms.Portable2"> &lt;ContentPage.BindingContext&gt; &lt;viewModels:MainPageViewModel /&gt; &lt;/ContentPage.BindingContext&gt;<br>&lt;ContentPage.Resources&gt; <ResourceDictionary> &lt;converters:BooleanInvertConverter x:Key=”BooleanInvertConverter” /&gt; <Style x:Key="LabelStyle" TargetType="Label"> <Setter Property="FontSize" Value="48" /> <Setter Property="HorizontalOptions" Value="Center" /> <Setter Property="VerticalOptions" Value="Center" /> </Style> </ResourceDictionary> &lt;/ContentPage.Resources&gt;<br><Grid VerticalOptions="Center"> &lt;Grid.ColumnDefinitions&gt; <ColumnDefinition Width="\*"/> <ColumnDefinition Width="2\*"/> <ColumnDefinition Width="10"/> <ColumnDefinition Width="2\*"/> <ColumnDefinition Width="10"/> <ColumnDefinition Width="2\*"/> <ColumnDefinition Width="\*"/> &lt;/Grid.ColumnDefinitions&gt; &lt;Grid.RowDefinitions&gt; <RowDefinition /> <RowDefinition /> &lt;/Grid.RowDefinitions&gt; <Label Grid.Row="0" Grid.Column="1" Style="{StaticResource LabelStyle}" Text="{Binding Minute}" /> <Label Grid.Row="0" Grid.Column="2" Style="{StaticResource LabelStyle}" Text=":" /> <Label Grid.Row="0" Grid.Column="3" Style="{StaticResource LabelStyle}" Text="{Binding Second}" /> <Label Grid.Row="0" Grid.Column="4" Style="{StaticResource LabelStyle}" Text="." /> <Label Grid.Row="0" Grid.Column="5" Style="{StaticResource LabelStyle}" Text="{Binding Millisecond}" /> <Button Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="5" Command="{Binding StartCommand}" HorizontalOptions="Center" IsVisible="{Binding IsRunning, Converter={StaticResource BooleanInvertConverter}}" Text="Start" VerticalOptions="Center" /> <Button Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="5" Command="{Binding StopCommand}" HorizontalOptions="Center" IsVisible="{Binding IsRunning}" Text="Stop" VerticalOptions="Center" /> </Grid> </ContentPage> [/code] <strong>MainPageViewModel.cs</strong> [code lang=”csharp”] using System; using System.Windows.Input; using Microsoft.Practices.Prism.Mvvm;<br>namespace Xamarin.Forms.Portable2.ViewModels { public sealed class MainPageViewModel : BindableBase {<br>public MainPageViewModel() { this.IsRunning = false; this.TimeSpan = new TimeSpan(0, 0, 0, 0, 0); }<br>private TimeSpan _TimeSpan;<br>public TimeSpan TimeSpan { get { return this._TimeSpan; } private set {<br>this.Minute = this.TimeSpan.Minutes.ToString(“00”); this.Second = this.TimeSpan.Seconds.ToString(“00”);<br>var ms = this.TimeSpan.Milliseconds / 10; this.Millisecond = ms.ToString(“00”); this.SetProperty(ref this._TimeSpan, value); } }<br>private string _Minute;<br>public string Minute { get { return this._Minute; } private set { this.SetProperty(ref this._Minute, value); } }<br>private string _Second;<br>public string Second { get { return this._Second; } private set { this.SetProperty(ref this._Second, value); } }<br>private string _Millisecond;<br>public string Millisecond { get { return this._Millisecond; } private set { this.SetProperty(ref this._Millisecond, value); } }<br>private bool _IsRunning = false;<br>public bool IsRunning { get { return this._IsRunning; } private set { this.SetProperty(ref this._IsRunning, value); } }<br>private ICommand _StartCommand;<br>public ICommand StartCommand { get { if (this._StartCommand == null) { this._StartCommand = new Command(() =&gt; { this.IsRunning = true;<br>Device.StartTimer(new TimeSpan(0, 0, 0, 0, 10), () =&gt; { this.TimeSpan = this.TimeSpan.Add(new TimeSpan(0, 0, 0, 0, 10)); return this.IsRunning; }); }); }<br>return this._StartCommand; } }<br>private ICommand _StopCommand;<br>public ICommand StopCommand { get { if (this._StopCommand == null) { this._StopCommand = new Command(() =&gt; { this.IsRunning = false; }); }<br>return this._StopCommand; } }<br>}<br>} [/code] になりました、 BooleanInvertConverterとかは省略します。簡単すぎますので。 出来上がった結果がこれ。 <a href="../../../../public/2016/04/1-10.png"><img src="../../../../public/2016/04/1-10-1024x819.png" alt="どこかでみたようなストップウォッチ"></a></p>
<p>シンプルなストップウォッチ…</p>
<p>Startを押せば、Stopボタンに変わり、経過時間が変化します。 が、このストップウォッチ問題があって、非常に精度が悪いです。10ms間隔がまずいのか非常に遅い。 ひょっとしたらTimerは別のAPIがあるのかもしれません。 ネイティブのAPIを直接呼ぶ方がよいか？</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>実用度と精度はともかくアプリと呼べるアプリを作ってみました。 XAMLでの開発経験があるならこれほど取っつきやすいものはないと思います。</p>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable2">https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable2</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-04-24</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Microsoft/NET-Framework/" title=".NET Framework">.NET Framework </a><a class="tag" href="/categories/Xamarin/" title="Xamarin">Xamarin </a><a class="tag" href="/categories/Microsoft/NET-Framework/C/" title="C#">C# </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2016/04/24/1115/,A certain engineer &quot;COMPLEX&quot;,Xamarinメモ その7 Timerを使ってみる,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2016/04/26/1118/" title="Xamarinメモ その8 TabbedPageを使ってみる">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2016/04/23/1105/" title="Xamarinメモ その6 ViewをMVVMで分離してみる">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script></body></html>