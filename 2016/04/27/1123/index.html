<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>Xamarinメモ その9 DataTemplateSelector+ViewModelで動的に可変タブを表現 · A certain engineer "COMPLEX"</title><meta name="description" content="前回はTabbedPageを使ってみました。

ProblemListView等でデータを表現しようとすると、データの種別に応じて、微妙に表現を変えたりしたいときがあります。自分としてよくあるのが、パラメータを入力するUIを作る際、設定ファイルなどから読み込んで動的に生成したViewModelに応じ"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Xamarinメモ その9 DataTemplateSelector+ViewModelで動的に可変タブを表現</a></h3></div><div class="post-content"><p><a target="_blank" rel="noopener" href="https://taktak.jp/2016/04/26/1118">前回</a>はTabbedPageを使ってみました。</p>
<a id="more"></a>
<h1 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h1><p>ListView等でデータを表現しようとすると、データの種別に応じて、微妙に表現を変えたりしたいときがあります。<br>自分としてよくあるのが、パラメータを入力するUIを作る際、設定ファイルなどから読み込んで動的に生成したViewModelに応じて、入力UIを変更する、ということです。<br>この手の表現はWPFの<strong>System.Windows.Controls.DataTemplateSelector</strong>やUWPの<strong>Windows.UI.Xaml.Controls.DataTemplateSelector</strong>を使います。<br>では、Xamarin.Formsにあるの？というとどうも2.1で追加されたよう。<br>詳しくはXamarinの中の人Nish Anil氏の<a target="_blank" rel="noopener" href="https://blog.xamarin.com/customizing-list-view-cells-xamarin-forms-datatemplateselector/">Customizing ListView Cells with Xamarin.Forms’ DataTemplateSelector</a>を参考。<br>が、私の環境で表示されない。<br><a target="_blank" rel="noopener" href="https://developer.xamarin.com/api/type/Xamarin.Forms.DataTemplateSelector/">Xamarin.Forms.DataTemplateSelector</a>というクラスが存在するのは間違いないのに… と、NuGet管理画面を見たら… <a href="../../../../public/2016/04/1-12.png"><img src="../../../../public/2016/04/1-12-1024x384.png" alt="NuGetパッケージマネージャー"></a></p>
<p>古い….</p>
<p>今回のサンプルソースは <a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable4">https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable4</a>です。</p>
<h1 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a>Resolution</h1><p>まず、NuGetパッケージマネージャーからXamarin.Formsを最新版に更新します。2016/04/26時点で最新版は2.1.0.6526です。<br>PCLとiOSプロジェクト(必要ならAndroid等も)で更新する必要があります。片方だけだと実行時にエラーが起きてクラッシュします。<br>これでDataTemplateSelectorが有効になりました。<br>今回は、TabbedPageの各子要素のPageインスタンスにバインディングされたViewModelをDataTemplateSelectorを使って変化させます。<br>これによって、TabbedPageのタブをViewModelの状態によって可変にしつつ、ViewModelに応じてタブの内容も変化させることが可能になります。<br>が、注意しなくてはならないのは、DataTemplateSelectorにDataTypeプロパティが存在しないため、Xamlで生成する際、インテリセンスが効かないため、実行時にバインディングされていないのことに気づかない可能性があります。<br>また、注意事項として、先のNish Anil氏曰く</p>
<blockquote>
<p>When using DataTemplateSelectors, it’s important to keep in mind the following limitations: No more than 20 templates per ListView on Android. The DataTemplateSelector subclass MUST return the same template for the same data if queried multiple times. The DataTemplateSelector must not return another DataTemplateSelector. The DataTemplateSelector must not return new instances of a DataTemplate on each call, instead the same instance must be returned. Failure to do so will effectively disable virtualization and lead to a memory leak.</p>
</blockquote>
<p>訳：DataTemplateSelectorsを使うとき、</p>
<ol>
<li>Androidでは、1つのListViewにテンプレートは20個まで</li>
<li>DataTemplateSelectorのサブクラスは、もし複数回要求されるなら、同一のデータに対して同一のテンプレートを<strong>必ず</strong>返す。</li>
<li>DataTemplateSelectorは別のDataTemplateSelectorを<strong>返してはならない</strong></li>
<li>DataTemplateSelectorは呼び出しのたびにDataTemplateの新しいインスタンスを<strong>返してはならない</strong>、代わりに同一のインスタンスを<strong>必ず</strong>返すこと。そうしないと、効果的な仮想化は無効化されメモリリークを引き起こす</li>
</ol>
<p>と指摘しています。<br>まぁ、20個もテンプレートを使うことはないと思いますが、DataTemplateSelectorから別のDataTemplateSelectorを返すな、というのはネストするな、ということでしょうか？ これはたまにやることがあるので注意しなければ。<br>というわけで実装サンプル。<br>まずはDataTemplateSelector。<br><strong>TabbedPageDataTemplateSelector.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System; <span class="keyword">using</span> System.Collections.Generic; <span class="keyword">using</span> System.Linq; <span class="keyword">using</span> System.Text; <span class="keyword">using</span> System.Threading.Tasks; <span class="keyword">using</span> Xamarin.Forms.Portable4.ViewModels;  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Xamarin.Forms.Portable4.Controls</span> &#123; <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">TabbedPageDataTemplateSelector</span> : <span class="title">DataTemplateSelector</span> &#123;  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TabbedPageDataTemplateSelector</span>(<span class="params"></span>)</span> &#123;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">public</span> DataTemplate TabbedPage1 &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;  </span><br><span class="line"><span class="keyword">public</span> DataTemplate TabbedPage2 &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;  </span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> DataTemplate <span class="title">OnSelectTemplate</span>(<span class="params"><span class="keyword">object</span> item, BindableObject container</span>)</span> &#123; <span class="keyword">var</span> viewModel = item <span class="keyword">as</span> TabbedPageViewModel; <span class="keyword">if</span> (viewModel == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line"><span class="keyword">return</span> viewModel <span class="keyword">is</span> TabbedPage1ViewModel ? <span class="keyword">this</span>.TabbedPage1 : viewModel <span class="keyword">is</span> TabbedPage2ViewModel ? <span class="keyword">this</span>.TabbedPage2 : <span class="literal">null</span>; &#125; &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>次は、エントリポイントとなるメインのビューであるMainPageView。<br>ここで全てのViewを、DataTemplateを使って定義しています。<br>ItemsSourceとItemTemplateはおなじみ、という感じですね。<br><strong>MainPageView.xaml</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot; ?&gt; &lt;TabbedPage x:Class&#x3D;&quot;Xamarin.Forms.Portable4.Views.MainPageView&quot; xmlns&#x3D;&quot;http:&#x2F;&#x2F;xamarin.com&#x2F;schemas&#x2F;2014&#x2F;forms&quot; xmlns:x&#x3D;&quot;http:&#x2F;&#x2F;schemas.microsoft.com&#x2F;winfx&#x2F;2009&#x2F;xaml&quot; xmlns:controls&#x3D;&quot;clr-namespace:Xamarin.Forms.Portable4.Controls;assembly&#x3D;Xamarin.Forms.Portable4&quot; xmlns:viewModels&#x3D;&quot;clr-namespace:Xamarin.Forms.Portable4.ViewModels;assembly&#x3D;Xamarin.Forms.Portable4&quot; ItemsSource&#x3D;&quot;&#123;Binding TabbedPages&#125;&quot;&gt;  </span><br><span class="line">&lt;TabbedPage.BindingContext&gt; &lt;viewModels:MainPageViewModel &#x2F;&gt; &lt;&#x2F;TabbedPage.BindingContext&gt;  </span><br><span class="line">&lt;TabbedPage.ItemTemplate&gt; &lt;controls:TabbedPageDataTemplateSelector&gt; &lt;controls:TabbedPageDataTemplateSelector.TabbedPage1&gt; &lt;DataTemplate&gt; &lt;ContentPage Title&#x3D;&quot;1&quot;&gt; &lt;Label Text&#x3D;&quot;&#123;Binding Title&#125;&quot; TextColor&#x3D;&quot;Red&quot; VerticalOptions&#x3D;&quot;Center&quot; HorizontalOptions&#x3D;&quot;Center&quot;&#x2F;&gt; &lt;&#x2F;ContentPage&gt; &lt;&#x2F;DataTemplate&gt; &lt;&#x2F;controls:TabbedPageDataTemplateSelector.TabbedPage1&gt; &lt;controls:TabbedPageDataTemplateSelector.TabbedPage2&gt; &lt;DataTemplate&gt; &lt;ContentPage Title&#x3D;&quot;2&quot;&gt; &lt;Label Text&#x3D;&quot;&#123;Binding Title&#125;&quot; TextColor&#x3D;&quot;Blue&quot; VerticalOptions&#x3D;&quot;Center&quot; HorizontalOptions&#x3D;&quot;Center&quot;&#x2F;&gt; &lt;&#x2F;ContentPage&gt; &lt;&#x2F;DataTemplate&gt; &lt;&#x2F;controls:TabbedPageDataTemplateSelector.TabbedPage2&gt; &lt;&#x2F;controls:TabbedPageDataTemplateSelector&gt; &lt;&#x2F;TabbedPage.ItemTemplate&gt;  </span><br><span class="line">&lt;&#x2F;TabbedPage&gt;</span><br></pre></td></tr></table></figure>

<p>MainViewのViewModelです。<br>この中でタブに対応するViewModelのコレクションを定義しています。<br>これによりタブの個数を可変にしています。<br><strong>MainPageView.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.ObjectModel; <span class="keyword">using</span> Microsoft.Practices.Prism.Mvvm;  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Xamarin.Forms.Portable4.ViewModels</span> &#123; <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">MainPageViewModel</span> : <span class="title">BindableBase</span> &#123; <span class="function"><span class="keyword">public</span> <span class="title">MainPageViewModel</span>(<span class="params"></span>)</span> &#123; <span class="keyword">var</span> tabbedPageViewModels = <span class="keyword">new</span> TabbedPageViewModel\[\] &#123; <span class="keyword">new</span> TabbedPage1ViewModel(), <span class="keyword">new</span> TabbedPage2ViewModel(), &#125;;  </span><br><span class="line"><span class="keyword">this</span>.TabbedPages = <span class="keyword">new</span> ObservableCollection(tabbedPageViewModels); &#125;  </span><br><span class="line"><span class="keyword">private</span> ObservableCollection \_TabbedPages;  </span><br><span class="line"><span class="keyword">public</span> ObservableCollection TabbedPages &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.\_TabbedPages; &#125; <span class="keyword">protected</span> <span class="keyword">set</span> &#123; <span class="keyword">this</span>.SetProperty(<span class="keyword">ref</span> <span class="keyword">this</span>.\_TabbedPages, <span class="keyword">value</span>); &#125; &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最後にタブのViewModelです。<br>TabbedPageViewModelを派生して、派生クラス毎にTitleプロパティを変更しています。<br>タブが複数ある場合は、往々にして、個々のタブは似た構成になることが多いので、抽象クラスで共通な振る舞いを定義するのはよくあると思います。<br><strong>TabbedPageViewModel.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Practices.Prism.Mvvm;  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Xamarin.Forms.Portable4.ViewModels</span> &#123; <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">TabbedPageViewModel</span> : <span class="title">BindableBase</span> &#123;  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">string</span> \_Title;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">string</span> Title &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.\_Title; &#125; <span class="keyword">protected</span> <span class="keyword">set</span> &#123; <span class="keyword">this</span>.SetProperty(<span class="keyword">ref</span> <span class="keyword">this</span>.\_Title, <span class="keyword">value</span>); &#125; &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">TabbedPage1ViewModel</span> : <span class="title">TabbedPageViewModel</span> &#123;  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TabbedPage1ViewModel</span>(<span class="params"></span>)</span> &#123; <span class="keyword">this</span>.Title = <span class="string">&quot;TabbedPage1&quot;</span>; &#125;  </span><br><span class="line">&#125; <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">TabbedPage2ViewModel</span> : <span class="title">TabbedPageViewModel</span> &#123; <span class="function"><span class="keyword">public</span> <span class="title">TabbedPage2ViewModel</span>(<span class="params"></span>)</span> &#123; <span class="keyword">this</span>.Title = <span class="string">&quot;TabbedPage2&quot;</span>; &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>実行すると下記のようになります。<br><a href="../../../../public/2016/04/2-10.png"><img src="../../../../public/2016/04/2-10-1024x819.png" alt="タブ1"></a> </p>
<p>タブ1</p>
<p><a href="../../../../public/2016/04/3-8.png"><img src="../../../../public/2016/04/3-8-1024x819.png" alt="タブ2"></a></p>
<p>タブ2</p>
<p>DataTemplateがあるかないかでは、表現の幅に大きな違いが出るので、非常にうれしい実装です。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>DataTypeがなかったり、少し制限がありますが、DataTemplateSelectorが遜色ない機能を持っていることがわかりました。</p>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable4">https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable4</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-04-27</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Microsoft/NET-Framework/" title=".NET Framework">.NET Framework </a><a class="tag" href="/categories/Xamarin/" title="Xamarin">Xamarin </a><a class="tag" href="/categories/Microsoft/NET-Framework/C/" title="C#">C# </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2016/04/27/1123/,A certain engineer &quot;COMPLEX&quot;,Xamarinメモ その9 DataTemplateSelector+ViewModelで動的に可変タブを表現,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2016/04/30/1151/" title="Xamarinメモ その10 PCLのビルドが通らない">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2016/04/26/1118/" title="Xamarinメモ その8 TabbedPageを使ってみる">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>