<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>Xamarinメモ その9 DataTemplateSelector+ViewModelで動的に可変タブを表現 · A certain engineer "COMPLEX"</title><meta name="description" content="前回はTabbedPageを使ってみました。

ProblemListView等でデータを表現しようとすると、データの種別に応じて、微妙に表現を変えたりしたいときがあります。 自分としてよくあるのが、パラメータを入力するUIを作る際、設定ファイルなどから読み込んで動的に生成したViewModelに応"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li><li><a href="/guestbook">メッセージ</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Xamarinメモ その9 DataTemplateSelector+ViewModelで動的に可変タブを表現</a></h3></div><div class="post-content"><p><a target="_blank" rel="noopener" href="http://wp.me/p7138e-i2">前回</a>はTabbedPageを使ってみました。</p>
<a id="more"></a>
<h1 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h1><p>ListView等でデータを表現しようとすると、データの種別に応じて、微妙に表現を変えたりしたいときがあります。 自分としてよくあるのが、パラメータを入力するUIを作る際、設定ファイルなどから読み込んで動的に生成したViewModelに応じて、入力UIを変更する、ということです。 この手の表現はWPFの<strong>System.Windows.Controls.DataTemplateSelector</strong>やUWPの<strong>Windows.UI.Xaml.Controls.DataTemplateSelector</strong>を使います。 では、Xamarin.Formsにあるの？というとどうも2.1で追加されたよう。 詳しくはXamarinの中の人Nish Anil氏の<a target="_blank" rel="noopener" href="https://blog.xamarin.com/customizing-list-view-cells-xamarin-forms-datatemplateselector/">Customizing ListView Cells with Xamarin.Forms’ DataTemplateSelector</a>を参考。 が、私の環境で表示されない。 <a target="_blank" rel="noopener" href="https://developer.xamarin.com/api/type/Xamarin.Forms.DataTemplateSelector/">Xamarin.Forms.DataTemplateSelector</a>というクラスが存在するのは間違いないのに… と、NuGet管理画面を見たら… <a href="../../../../public/2016/04/1-12.png"><img src="../../../../public/2016/04/1-12-1024x384.png" alt="NuGetパッケージマネージャー"></a></p>
<p>古い….</p>
<p>今回のサンプルソースは <a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable4">https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable4</a>です。</p>
<h1 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a>Resolution</h1><p>まず、NuGetパッケージマネージャーからXamarin.Formsを最新版に更新します。2016/04/26時点で最新版は2.1.0.6526です。 PCLとiOSプロジェクト(必要ならAndroid等も)で更新する必要があります。片方だけだと実行時にエラーが起きてクラッシュします。 これでDataTemplateSelectorが有効になりました。 今回は、TabbedPageの各子要素のPageインスタンスにバインディングされたViewModelをDataTemplateSelectorを使って変化させます。 これによって、TabbedPageのタブをViewModelの状態によって可変にしつつ、ViewModelに応じてタブの内容も変化させることが可能になります。 が、注意しなくてはならないのは、DataTemplateSelectorにDataTypeプロパティが存在しないため、Xamlで生成する際、インテリセンスが効かないため、実行時にバインディングされていないのことに気づかない可能性があります。 また、注意事項として、先のNish Anil氏曰く</p>
<blockquote>
<p>When using DataTemplateSelectors, it’s important to keep in mind the following limitations: No more than 20 templates per ListView on Android. The DataTemplateSelector subclass MUST return the same template for the same data if queried multiple times. The DataTemplateSelector must not return another DataTemplateSelector. The DataTemplateSelector must not return new instances of a DataTemplate on each call, instead the same instance must be returned. Failure to do so will effectively disable virtualization and lead to a memory leak.</p>
</blockquote>
<p>訳：DataTemplateSelectorsを使うとき、</p>
<ol>
<li>Androidでは、1つのListViewにテンプレートは20個まで</li>
<li>DataTemplateSelectorのサブクラスは、もし複数回要求されるなら、同一のデータに対して同一のテンプレートを<strong>必ず</strong>返す。</li>
<li>DataTemplateSelectorは別のDataTemplateSelectorを<strong>返してはならない</strong></li>
<li>DataTemplateSelectorは呼び出しのたびにDataTemplateの新しいインスタンスを<strong>返してはならない</strong>、代わりに同一のインスタンスを<strong>必ず</strong>返すこと。そうしないと、効果的な仮想化は無効化されメモリリークを引き起こす</li>
</ol>
<p>と指摘しています。 まぁ、20個もテンプレートを使うことはないと思いますが、DataTemplateSelectorから別のDataTemplateSelectorを返すな、というのはネストするな、ということでしょうか？ これはたまにやることがあるので注意しなければ。 というわけで実装サンプル。 まずはDataTemplateSelector。 <strong>TabbedPageDataTemplateSelector.cs</strong> [code lang=”csharp”] using System; using System.Collections.Generic; using System.Linq; using System.Text; using System.Threading.Tasks; using Xamarin.Forms.Portable4.ViewModels;<br>namespace Xamarin.Forms.Portable4.Controls { public sealed class TabbedPageDataTemplateSelector : DataTemplateSelector {<br>public TabbedPageDataTemplateSelector() {<br>}<br>public DataTemplate TabbedPage1 { get; set; }<br>public DataTemplate TabbedPage2 { get; set; }<br>protected override DataTemplate OnSelectTemplate(object item, BindableObject container) { var viewModel = item as TabbedPageViewModel; if (viewModel == null) return null;<br>return viewModel is TabbedPage1ViewModel ? this.TabbedPage1 : viewModel is TabbedPage2ViewModel ? this.TabbedPage2 : null; } } } [/code] 次は、エントリポイントとなるメインのビューであるMainPageView。 ここで全てのViewを、DataTemplateを使って定義しています。 ItemsSourceとItemTemplateはおなじみ、という感じですね。 <strong>MainPageView.xaml</strong> [code lang=”xaml”] <?xml version="1.0" encoding="utf-8" ?> <TabbedPage x:Class="Xamarin.Forms.Portable4.Views.MainPageView" xmlns="http://xamarin.com/schemas/2014/forms" xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml" xmlns:controls="clr-namespace:Xamarin.Forms.Portable4.Controls;assembly=Xamarin.Forms.Portable4" xmlns:viewModels="clr-namespace:Xamarin.Forms.Portable4.ViewModels;assembly=Xamarin.Forms.Portable4" ItemsSource="{Binding TabbedPages}"><br>&lt;TabbedPage.BindingContext&gt; &lt;viewModels:MainPageViewModel /&gt; &lt;/TabbedPage.BindingContext&gt;<br>&lt;TabbedPage.ItemTemplate&gt; <a href="controls:TabbedPageDataTemplateSelector">controls:TabbedPageDataTemplateSelector</a> <a href="controls:TabbedPageDataTemplateSelector.TabbedPage1">controls:TabbedPageDataTemplateSelector.TabbedPage1</a> <DataTemplate> <ContentPage Title="1"> <Label Text="{Binding Title}" TextColor="Red" VerticalOptions="Center" HorizontalOptions="Center"/> </ContentPage> </DataTemplate> &lt;/controls:TabbedPageDataTemplateSelector.TabbedPage1&gt; <a href="controls:TabbedPageDataTemplateSelector.TabbedPage2">controls:TabbedPageDataTemplateSelector.TabbedPage2</a> <DataTemplate> <ContentPage Title="2"> <Label Text="{Binding Title}" TextColor="Blue" VerticalOptions="Center" HorizontalOptions="Center"/> </ContentPage> </DataTemplate> &lt;/controls:TabbedPageDataTemplateSelector.TabbedPage2&gt; </controls:TabbedPageDataTemplateSelector> &lt;/TabbedPage.ItemTemplate&gt;<br></TabbedPage> [/code] MainViewのViewModelです。 この中でタブに対応するViewModelのコレクションを定義しています。 これによりタブの個数を可変にしています。 <strong>MainPageView.cs</strong> [code lang=”csharp”] using System.Collections.ObjectModel; using Microsoft.Practices.Prism.Mvvm;<br>namespace Xamarin.Forms.Portable4.ViewModels { public sealed class MainPageViewModel : BindableBase { public MainPageViewModel() { var tabbedPageViewModels = new TabbedPageViewModel[] { new TabbedPage1ViewModel(), new TabbedPage2ViewModel(), };<br>this.TabbedPages = new ObservableCollection(tabbedPageViewModels); }<br>private ObservableCollection _TabbedPages;<br>public ObservableCollection TabbedPages { get { return this._TabbedPages; } protected set { this.SetProperty(ref this._TabbedPages, value); } }<br>}<br>} [/code] 最後にタブのViewModelです。 TabbedPageViewModelを派生して、派生クラス毎にTitleプロパティを変更しています。 タブが複数ある場合は、往々にして、個々のタブは似た構成になることが多いので、抽象クラスで共通な振る舞いを定義するのはよくあると思います。 <strong>TabbedPageViewModel.cs</strong> [code lang=”csharp”] using Microsoft.Practices.Prism.Mvvm;<br>namespace Xamarin.Forms.Portable4.ViewModels { public abstract class TabbedPageViewModel : BindableBase {<br>private string _Title;<br>public string Title { get { return this._Title; } protected set { this.SetProperty(ref this._Title, value); } }<br>}<br>public sealed class TabbedPage1ViewModel : TabbedPageViewModel {<br>public TabbedPage1ViewModel() { this.Title = “TabbedPage1”; }<br>} public sealed class TabbedPage2ViewModel : TabbedPageViewModel { public TabbedPage2ViewModel() { this.Title = “TabbedPage2”; }<br>}<br>} [/code] 実行すると下記のようになります。 <a href="../../../../public/2016/04/2-10.png"><img src="../../../../public/2016/04/2-10-1024x819.png" alt="タブ1"></a> </p>
<p>タブ1</p>
<p><a href="../../../../public/2016/04/3-8.png"><img src="../../../../public/2016/04/3-8-1024x819.png" alt="タブ2"></a></p>
<p>タブ2</p>
<p>DataTemplateがあるかないかでは、表現の幅に大きな違いが出るので、非常にうれしい実装です。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>DataTypeがなかったり、少し制限がありますが、DataTemplateSelectorが遜色ない機能を持っていることがわかりました。</p>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable4">https://github.com/takuya-takeuchi/Demo/tree/master/Xamarin.Forms.Portable4</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-04-27</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Microsoft/NET-Framework/" title=".NET Framework">.NET Framework </a><a class="tag" href="/categories/Xamarin/" title="Xamarin">Xamarin </a><a class="tag" href="/categories/Microsoft/NET-Framework/C/" title="C#">C# </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2016/04/27/1123/,A certain engineer &quot;COMPLEX&quot;,Xamarinメモ その9 DataTemplateSelector+ViewModelで動的に可変タブを表現,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2016/04/30/1151/" title="Xamarinメモ その10 PCLのビルドが通らない">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2016/04/26/1118/" title="Xamarinメモ その8 TabbedPageを使ってみる">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script></body></html>