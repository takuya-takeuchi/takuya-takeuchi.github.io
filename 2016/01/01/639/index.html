<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>.NETでNoSQLを試してみる MongoDB編 第2回 · A certain engineer "COMPLEX"</title><meta name="description" content="前回はインストールしました。今回は実際にデータを追加します。

IntroductionMongoDB は親切にも接続のためのドライバを用意してくれてます。しかも.NET用かつNuget経由で。素晴らしい。 恐ろしいことに、C、C++、C#、Java、Node.js、Perl、PHP、Python、"><meta name="keywords" content="极限博客,极限Blog,博客,极限"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>心之所愿，无事不成。<br> Nothing is impossible to a willing heart.</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/mrcore"><i class="fa fa-github"></i></a></li><li><a href="mailto:x@jixian.io"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://sighttp.qq.com/authd?IDKEY="><i class="fa fa-qq"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/people/"><i class="fa fa-mortar-board"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2017 - 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li><li><a href="/guestbook">メッセージ</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>.NETでNoSQLを試してみる MongoDB編 第2回</a></h3></div><div class="post-content"><p><a target="_blank" rel="noopener" href="http://wp.me/p7138e-ad">前回</a>はインストールしました。今回は実際にデータを追加します。</p>
<a id="more"></a>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>MongoDB は親切にも<a target="_blank" rel="noopener" href="https://docs.mongodb.org/ecosystem/drivers/">接続のためのドライバ</a>を用意してくれてます。しかも.NET用かつNuget経由で。素晴らしい。 恐ろしいことに、C、C++、C#、Java、Node.js、Perl、PHP、Python、Motor、Ruby、Scala用のドライバがオープンソースで用意してあります。 MongodDBおそろしい子！ 今回もきちんと公式ページを見てやります。ちゃんと英文訳します。参考にしてください。 …ちゃんと英語ドキュメント見ないと勉強になりませんから(白目)</p>
<h1 id="Explanation"><a href="#Explanation" class="headerlink" title="Explanation"></a>Explanation</h1><h2 id="開発環境構築"><a href="#開発環境構築" class="headerlink" title="開発環境構築"></a>開発環境構築</h2><p>何はともあれ、Nugetです。 Nugetでインストールは、GUIでもできますが、GUIだとMongoDBが2つ出てきます。片方は古いMongoDBのドライバです。 <a href="../../../../public/2015/12/nuget.png"><img src="../../../../public/2015/12/nuget.png" alt="nuget"></a></p>
<p>コンソールで [code] Install-Package MongoDB.Driver [/code] とやると確実です。 ちなみに、前回は最新版のMongoDB (執筆時点で3.2.0)をインストールし、今回はドライバのバージョンが2.2ですが、ちゃんと繋がるの？という方、<a target="_blank" rel="noopener" href="https://docs.mongodb.org/ecosystem/drivers/csharp/">C# and .NET MongoDB Driver</a> にて互換性について説明があります。 2.2は <strong>MongoDB 2.4</strong>、<strong>MongoDB 2.6</strong>、<strong>MongoDB 3.0</strong>、<strong>MongoDB 3.2</strong> に繋がります。うん安心。 ただし、.NETの互換性が非常にタイトです。 2.0(ドキュメントには2.2とは書いてない)は.NET 4.5とMono 3.xでしか動きません。 逆に1.10は.NET 3.5以降をサポートしています。しかも <strong>Mono 2.10</strong>、<strong>Mono 3.x</strong> も。 また、MongoDBは、Visual Studio は2010、2012でビルドして、テストしたようです。2015でも、いけるよね？</p>
<h2 id="接続実験"><a href="#接続実験" class="headerlink" title="接続実験"></a>接続実験</h2><p>公式ページ<a target="_blank" rel="noopener" href="https://docs.mongodb.org/ecosystem/tutorial/authenticate-with-csharp-driver/">Authenticate to MongoDB with the C# Driver</a>に説明があります。ちなみに、1.8以降のみの説明です。 のっけから意味のわからないことが書いてあります。<strong>Internal Authentication</strong>と<strong>External Authentication</strong>とあります。 <strong>Internal Authentication</strong></p>
<blockquote>
<p>Internal authentication refers to accounts stored inside MongoDB. Currently, the only way to authenticate against internal accounts is to use the MongoDB Challenge Response mechanism, or MONGODB-CR. This is the default mechanism.</p>
</blockquote>
<p>[code] 訳:Internal authenticationは、内部のMongoDBに保存されているアカウントを参照します。現在、内部アカウントに対する認証する唯一の方法は、MogoDB Challenge Response メカニズム、または MONGODB-CR を使うことです。これは既定のメカニズムです。 [/code] <strong>External Authentication</strong></p>
<blockquote>
<p>External authentication refers to credentials validated outside of MongoDB. The external authentication provider currently used is Kerberos. To authenticate to a MongoDB cluster using Kerberos, you must specify the GSSAPI mechanism and a user name. On Windows, it is also possible to provide the password. Fundamentally, the process for connecting with Kerberos is the same for Windows and Linux systems; however, Linux systems require the use of kinit to acquire the security credentials whereas Windows systems perform this action transparently using SSPI based on the account running the current process when a password is not used.</p>
</blockquote>
<p>[code] 訳:External authenticationは、外部のMongoDB検証された資格情報を参照します。外部認証プロバイダーは現在Kerberosが使用されます。Kerberosを使用したMongoDBクラスターへ認証するために、GSSAPIメカニズムとユーザ名を必ず使用します。Windowsでは、パスワードを提供することも可能です。 基本的には、Kerberosによる接続プロセスは、WindowsとLinuxでのそれと同一です。しかし、Linuxではセキュリティ認証を得るためにkinitの使用を、一方でWindowsでは、パスワードを利用しないとき、現在のプロセスを実行しているアカウントに基づくSSPIを利用した透過的なアクションを実行します。 [/code] とあります。External authenticationのWindowsに対する最後の説明は意味不明ですが、要するに、サービスとして動いているローカルのMongoDBへのアクセスは、Internal、といことでしょう。きっと。Kerberosなんて言われても困ります。 で、Internalにのみ目を向けると、サンプルコードがあります。</p>
<blockquote>
<p>var credential = MongoCredential.CreateMongoCRCredential(“test”, “user1”, “password1”); var settings = new MongoClientSettings { Credentials = new[] { credential } }; var mongoClient = new MongoClient(settings);</p>
</blockquote>
<p>または、</p>
<blockquote>
<p>var connectionString = “mongodb://user1:password1@localhost/test”; var mongoClient = new MongoClient(connectionString);</p>
</blockquote>
<p>はぁ？パスワード？と思ったあなた。ご安心を、パスワードはなくても接続できます。 前回は設定していませんしね(白目) [code lang=”csharp”] var mongoClient= new MongoClient(“mongodb://localhost”); [/code] これでOKです。 まずは前回設定したサービスを起動します。 で、起動後、下記のプログラムを実行します。 [code lang=”csharp”] using System; using MongoDB.Driver;<br>namespace MongoDB2 { class Program { static void Main(string[] args) { var mongoClient = new MongoClient(“mongodb://localhost”); foreach (var document in mongoClient.ListDatabases().ToList()) { Console.WriteLine(“Document:{0}”, document); foreach (var name in document.Names) { Console.WriteLine(“Name:{0}”, name); } }<br>Console.ReadKey(); } } } [/code] 実行後、コマンドプロンプトに [code lang=”json”] Document:{ “name” : “local”, “sizeOnDisk” : 65536.0, “empty” : false } Name:name Name:sizeOnDisk Name:empty [/code] と表示されるはずです。 データベースとかを既に追加していたら違う結果になると思いますが。 サービスが起動していないと、 <a href="../../../../public/2015/12/exception.png"><img src="../../../../public/2015/12/exception.png" alt="タイムアウト"></a></p>
<p>って出ます。内容を見る限りタイムアウトは30秒のようです。 とりあえず接続試験はOKです。</p>
<h2 id="データベースって何？"><a href="#データベースって何？" class="headerlink" title="データベースって何？"></a>データベースって何？</h2><p>先のコードで、 [code lang=”csharp”] foreach (var document in mongoClient.ListDatabases().ToList()) [/code] って書きました。 <strong>ListDatabases</strong> ってあるのに変数名がdocumentとか、センスないの？馬鹿なの？って思った人いるかもしれませんが、これは <strong>ListDatabases</strong> メソッドの戻りが、<strong>MongoDB.Driver.IAsyncCursor&lt;MongoDB.Bson.BsonDocument&gt;</strong> だからです。 Bsonって何？というと、Wiki先生は<a target="_blank" rel="noopener" href="https://ja.wikipedia.org/wiki/BSON">こう仰っています</a>。</p>
<blockquote>
<p>BSONは主にMongoDBのデータストレージ及びネットワーク転送フォーマットとして利用されている、データ交換フォーマットである。 単純なデータ構造や連想配列（MongoDBではオブジェクトまたはドキュメントと表す）を示すバイナリ構造であり、 名称はJSON由来であり”バイナリ型JSON”の略語である。</p>
</blockquote>
<p>よーするにMongoDB用のデータ構造でJsonのバイナリ版だと。 で、BsonDocumentって何？って調べても、<strong>Represents a BSON document.</strong> としか書いてない。 これがデータベース？と思いきや、<strong>MongoClient.GetDatabase</strong> メソッドというのがあって、これの戻り値は <strong>MongoDB.Driver.IMongoDatabase</strong> となっていて、データベースは存在するよう。 じゃぁ、さっきのListDatabases メソッドはっていうと、<strong>Lists the databases on the server.</strong> って言っている。 これはAPIとしてどうなの？という感じがしないでもない。 MongoClient クラスには、DropDatabaseはあるから、作成はあっても良さそうな気がする。</p>
<h2 id="データベースを作る"><a href="#データベースを作る" class="headerlink" title="データベースを作る"></a>データベースを作る</h2><p>先の ListDatabases メソッドで戻ってきた BsonDocument はきっと初期状態で入っている、管理用のデータベースの中身、と仮定します。 なので、データベースを作れば結果が変わる、と信じてデータベースを作ってみます。 が、そんなAPIがない、というのは前章のとおり。 というわけでGoogle先生に聞いてみた。 公式にもない、というか見つからなかったが、<a target="_blank" rel="noopener" href="http://putridparrot.com/blog/creating-a-simple-database-in-mongodb-with-c/">Creating a simple database in MongoDB with C#</a> によると、</p>
<blockquote>
<p>The line server.GetDatabase(“MyDatabase”) will get the database (if it exists) but also create a database if it doesn’t exist. Note: if you are creating a database using GetDatabase it will not exist until you actually store data in it.</p>
</blockquote>
<p>[code] 訳: server.GetDatabase(“MyDatabase”) の行はデータベース (存在すれば) を取得しますが、存在しなければデータベースを作ったりもします。<br>ノート:GetDatabaseでデータベースを作ったとしても、データを突っ込むまでは、データベースは存在しません。 [/code] って言ってます。 必要になるまでテーブルは要らない、ってことですか。</p>
<h2 id="データを追加する"><a href="#データを追加する" class="headerlink" title="データを追加する"></a>データを追加する</h2><p>データベース「だけ」を作る方法はないので、データを設定してみます。 さっきのページに、親切にも同じようなことが書いてあります。</p>
<blockquote>
<p>Like the creating of the database, if no employees currently exist we still get a collection object which we can then save data to.</p>
</blockquote>
<p>[code] 訳: データベースの作成のように、もしemployeesがそのときに存在しなければ、データを保存することのできるコレクションオブジェクトを取得します。 [/code] とある。サンプルを見ると、</p>
<blockquote>
<p>public class Person { public ObjectId Id { get; set; } public string FirstName { get; set; } public string LastName { get; set; } public int Age { get; set; } } MongoClient client = new MongoClient(); MongoServer server = client.GetServer(); MongoDatabase db = server.GetDatabase(“MyDatabase”); MongoCollection collection = db.GetCollection(“employees”); Person p = new Person { Id = ObjectId.GenerateNewId(), FirstName = “Bob”, LastName = “Baker”, Age = 36 } collection.Save(p);</p>
</blockquote>
<p>とあるので、コレクションも必要になるまで反映されない、ってことですか。 というか、データベースの配下にコレクションなのね。そーいう構造ですか。 で、作ったサンプルは<a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/MongoDB2">こちら</a>。 [code lang=”default”] class Program { static void Main(string[] args) { var mongoClient = new MongoClient(“mongodb://localhost”); //TestConnect(mongoClient);<br>InsertData(mongoClient); TestConnect(mongoClient);<br>Console.WriteLine(“Please enter any key…”); Console.ReadKey(); }<br>private static void InsertData(MongoClient mongoClient) { Console.WriteLine(“InsertData”);<br>var database = mongoClient.GetDatabase(“Database1”);<br>var c1 = new Company { Id = ObjectId.GenerateNewId(), Name = “Microsoft”, Established = new DateTime(1975, 4, 4) };<br>var c2 = new Company { Id = ObjectId.GenerateNewId(), Name = “Apple”, Established = new DateTime(1976, 4, 1) };<br>var collection = database.GetCollection<Company>(“Companies”); collection.InsertOne(c1); collection.InsertOne(c2);<br>var findFluent = collection.Find(FilterDefinition<Company>.Empty); var count = findFluent.Count(); Console.WriteLine(“Count:{0}”, count); }<br>public sealed class Company {<br>public ObjectId Id { get; set; }<br>public string Name { set; get; }<br>public DateTime Established { get; set; }<br>}<br>private static void TestConnect(MongoClient mongoClient) { Console.WriteLine(“TestConnect”);<br>foreach (var document in mongoClient.ListDatabases().ToList()) { Console.WriteLine(“\tDocument:{0}”, document);<br>foreach (var name in document.Names) { Console.WriteLine(“\t\tName:{0}”, name); } } }<br>} [/code] データの検索は、<strong>Find</strong> メソッドが使えることがわかりました。 で、先のBlogのページで使っていた <strong>Save</strong> メソッドはレガシーのAPI用だったようで、今は <strong>InserOne</strong> メソッドのでした。 <strong>ObjectId</strong> とかわかりませんし、シリアライズできないオブジェクトはどうなるの？とか色々ありますがまずはこれだけ。 実行結果はこんな感じ。 [code lang=”json”] InsertData Count:2 TestConnect Document:{ “name” : “Database1”, “sizeOnDisk” : 8192.0, “empty” : false } Name:name Name:sizeOnDisk Name:empty Document:{ “name” : “local”, “sizeOnDisk” : 65536.0, “empty” : false } Name:name Name:sizeOnDisk Name:empty Please enter any key… [/code] ドキュメントが増えただけ？</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>まだまだ、わからないことだらけです。手軽な感じはしますが、ちょっともやもやします。 人によっては、もっとシンプルな <strong>KVS (Key-Valueストア)</strong> な <strong>Redis</strong> とかのいいのでしょうか？Redisよく知らないけど。</p>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/MongoDB2">https://github.com/takuya-takeuchi/Demo/tree/master/MongoDB2</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-01-01</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Microsoft/NET-Framework/" title=".NET Framework">.NET Framework </a><a class="tag" href="/categories/net-framework/" title="net-framework">net-framework </a><a class="tag" href="/categories/Microsoft/NET-Framework/C/" title="C#">C# </a><a class="tag" href="/categories/ソフトウェア紹介/" title="ソフトウェア紹介">ソフトウェア紹介 </a><a class="tag" href="/categories/net-framework/NETで○○○を試してみる/" title=".NETで○○○を試してみる">.NETで○○○を試してみる </a><a class="tag" href="/categories/netで○○○を試してみる/" title="netで○○○を試してみる">netで○○○を試してみる </a><a class="tag" href="/categories/netで○○○を試してみる/NETでNoSQLを試してみる-MongoDB編/" title=".NETでNoSQLを試してみる MongoDB編">.NETでNoSQLを試してみる MongoDB編 </a><a class="tag" href="/categories/nosql/" title="nosql">nosql </a><a class="tag" href="/categories/データベース/" title="データベース">データベース </a><a class="tag" href="/categories/nosql/MongoDB/" title="MongoDB">MongoDB </a><a class="tag" href="/categories/データベース/NoSQL/" title="NoSQL">NoSQL </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2016/01/01/639/,A certain engineer &quot;COMPLEX&quot;,.NETでNoSQLを試してみる MongoDB編 第2回,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2016/01/01/755/" title=".NETで画像処理を試してみる OpenCVSharp編 第3回">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2015/12/30/633/" title=".NETでNoSQLを試してみる MongoDB編 第1回">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script></body></html>