<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>.NETでディープラーニングを試してみる CNTK編 第1回 · A certain engineer "COMPLEX"</title><meta name="description" content="前回は評価データをExcelで可視化しました。今回は.NETから使ってみます。

注意CNTKのソースコード自体、現在進行形で進化しています。入手できるバイナリも現時点 (2016/03/18) でも動作しません。 実行は最新ソースを取得してビルドする必要があります。 また、設定ファイルやソースコー"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>.NETでディープラーニングを試してみる CNTK編 第1回</a></h3></div><div class="post-content"><p><a target="_blank" rel="noopener" href="http://wp.me/p7138e-el">前回</a>は評価データをExcelで可視化しました。今回は.NETから使ってみます。</p>
<a id="more"></a>
<h1 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h1><p>CNTKのソースコード自体、現在進行形で進化しています。入手できるバイナリも現時点 (2016/03/18) でも動作しません。 実行は最新ソースを取得してビルドする必要があります。 また、設定ファイルやソースコードもトライアンドエラーで試した結果です。</p>
<h1 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h1><p>対象データは、MNISTとします。 ネットワークモデルは、<strong>Examples\Image\MNIST</strong> にあります。 ただし、データそのものは、含まれていません。 <a target="_blank" rel="noopener" href="http://yann.lecun.com/exdb/mnist/">THE MNIST DATABASE</a> から入手できるのですが、ここから入手しても、CNTKが読み込める形式にはなっていません。 <strong>Examples\Image\MNIST\AdditionalFiles</strong> に、データの入手、変換を行うPython のスクリプトが入っているのですが、Python環境がないと使えません。 ですので、後述のサンプルプログラムにデータを含めておきました。 data\mnist.zip になります。これを解凍してできる、<strong>Train-28x28.txt</strong>、<strong>Test-28x28.txt</strong> を <strong>Examples\Image\MNIST\Data</strong> にコピーします。 次に設定ファイルを変更します。 <strong>Examples\Image\MNIST\Config\01_OneHidden.cntk</strong> を開いて、 [code] deviceId = 0 imageLayout = “cudnn” [/code] を [code] deviceId = -1 imageLayout = “legacy” [/code] に変更します。 [code] # stderr = “$OutputDir$/01_OneHidden_out” [/code] を [code] stderr = “$OutputDir$/01_OneHidden_out” [/code] に変更して学習途中のログを生成することもおすすめしておきます。 以上で準備が完了です。</p>
<h2 id="ビルド"><a href="#ビルド" class="headerlink" title="ビルド"></a>ビルド</h2><p>最新ソースを取得してビルドします。 個人的には、GPUを使わない方が良いと思います。 ただし、3/18の時点では、<a target="_blank" rel="noopener" href="http://wp.me/p7138e-ew">ディープラーニング CNTK 雑談1 動かない api-ms-win-core-path-l1-1-0.dll がない</a> で報告したバグが直っていないので、Windows7で動かすなら、記事を参考にソースを修正してからビルドしてください。</p>
<h2 id="学習"><a href="#学習" class="headerlink" title="学習"></a>学習</h2><p>ビルド完了後、出来上がるパスをメモします。CNTK.slnがあるディレクトリから見て、<strong>x64\Release_CpuOnly</strong> または <strong>x64\Release_CpuOnly</strong> になると思います。 コマンドプロンプトを開いて、CNTK.slnがあるディレクトリにカレントディレクトリを移動します。 そして、次のコマンドを実行します。 [code lang=”dos”] set PATH=”%CD%\x64\Release_CpuOnly”;%PATH% set CURRENT=%CD% rmdir “Examples\Image\MNIST\Output” /s /q cd “Examples\Image\MNIST\Config” CNTK configFile=01_OneHidden.cntk deviceId=-1 cd %CURRENT% [/code] これでしばらくすると、<strong>Examples\Image\MNIST\Output\Models</strong> に学習済みのモデルファイルが出来上がっているはずです。 ログは、<strong>Examples\Image\MNIST\Output\01_OneHidden_out_MNISTtrain_MNISTtest.log</strong> になります。 さらっとながめてみますと、 [code] Allocating matrices for forward and/or backward propagation. UCIFastReader: Starting at epoch 0, counting lines to determine record count… 10000 records found. starting epoch 0 at record count 0, and file position 0 already there from last epoch RandomOrdering: 1989 retries for 10000 elements (19.9%) to ensure window condition RandomOrdering: recached sequence for seed 0: 2334, 3830, … Minibatch[1-500]: SamplesSeen = 8000 err: ErrorPrediction/Sample = 0.024125 ce: CrossEntropyWithSoftmax/Sample = 0.076922514 Minibatch[501-625]: SamplesSeen = 2000 err: ErrorPrediction/Sample = 0.0155 ce: CrossEntropyWithSoftmax/Sample = 0.060455356 Final Results: Minibatch[1-625]: SamplesSeen = 10000 err: ErrorPrediction/Sample = 0.0224 ce: CrossEntropyWithSoftmax/Sample = 0.073629082 Perplexity = 1.0764075<br>Action “test” complete.<br>COMPLETED [/code] とあり、エラー率2.24%と出ています。まずまずです。</p>
<h2 id="NETからテスト"><a href="#NETからテスト" class="headerlink" title=".NETからテスト"></a>.NETからテスト</h2><p>テスト自体は、既にログを見るとおりわかっているのですが、これを.NETから可視化します。 実は、.NETのラッパーライブラリ自体は既にサンプル付きでCNTKに含まれています。 <a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/tree/master/Source/Extensibility">https://github.com/Microsoft/CNTK/tree/master/Source/Extensibility</a> がそれです。 ソースである、<a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/blob/master/Source/Extensibility/CSEvalClient/Program.cs">Program.cs</a>を見ると非常に簡単であることがわかります。 [code lang=”csharp”] using (var model = new IEvaluateModelManagedF()) { // Initialize model evaluator string config = GetFileContents(Path.Combine(Environment.CurrentDirectory, @”..\Config\01_OneHidden.cntk”)); model.Init(config);<br>// Load model string modelFilePath = Path.Combine(Environment.CurrentDirectory, @”..\Output\Models\01_OneHidden”); model.CreateNetwork(string.Format(“deviceId=-1\nmodelPath=\“{0}\“”, modelFilePath));<br>// Generate random input values in the appropriate structure and size var inputs = GetDictionary(“features”, 28*28, 255);<br>// We can call the evaluate method and get back the results (single layer)… outputs = model.Evaluate(inputs, “ol.z”, 10); } [/code] です。 Init関数には、設定ファイルのパスを、CreateNetworkには、コマンドプロンプトで渡す記述を渡すだけです。 ただし、わかりにくいのが、<strong>inputs</strong> と <strong>outputs</strong> です。 inputsは、<strong>System.Collections.Generic.Dictionary&lt;string, System.Collections.Generic.List<float>&gt;</strong> ですが、GetDictionaryで得られる戻り値は、*<em>“features”** というキー、長さ28_28の**System.Collections.Generic.List<float>**の値のペアが一つです。 値の中身は0-255の値がランダムに入っています。 MNISTは28_28なのでそういう条件なのです。 \</em>.cntkにも784という数字が書いてありましたが、まさしくこれです。 <strong>outputs</strong> は、<strong>System.Collections.Generic.List<float></strong> です。 今回は長さ10で、添え字0-9が、MNISTで認識する0-9の数値にそのまま対応しています。 また、各要素の値は、入力データが、添え字に対応する数字のどれに対応するか、という確率を返します。 では、**”features”** と <strong>“ol.z”</strong> は何を意味するのでしょうか？ これは、入力データと出力データを識別するキーになります。 ディープラーニングでは、各レイヤー毎に複数の入出力を持つことが可能です。その入出力を識別するためのキーになります。 <a target="_blank" rel="noopener" href="http://caffe.berkeleyvision.org/">Caffe</a> でいう、Bottom (入力)、Top (出力)になります。 では、この定義はどこにあるのか、というと <strong>Examples\Image\MNIST\Config\01_OneHidden.ndl</strong> を見るとわかります。 [code] FeatureNodes = (features) LabelNodes = (labels) CriterionNodes = (ce) EvalNodes = (err) OutputNodes = (ol) [/code] という記述がまさにそれです。 ただし、<strong>ol</strong> だけは、**”.z”** を付与しないと、実行時にエラーを投げてしまいますので、そうしています。 さて、実行するとわかりますが、戻ってくる値には、負数が含まれており、全部の数値を合計しても確率を表すと思われる、1または100になりません。 これは、後述のサンプルソースで含まれるSoftmaxメソッドで確率に変換すること目的を達成できます。 ディープラーニングでは、出力層で得られた結果をSoftmaxで確率に変換することで識別を行います。 説明は<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Softmax_function">Softmax_function</a> でわかりますが、簡単にソースで示すと、 [code lang=”csharp”] private IList<double> Softmax(IList<float> outputs) { var results = new double[outputs.Count];<br>var total = 0d; for (int index = 0, length = results.Length; index &lt; length; index++) { results[index] = Math.Exp(outputs[index]); total += results[index]; }<br>for (int index = 0, length = results.Length; index &lt; length; index++) { results[index] /= total; }<br>return results; } [/code] になります。簡単ですね。</p>
<h1 id="テストする"><a href="#テストする" class="headerlink" title="テストする"></a>テストする</h1><p>が、先のサンプルは、入力データがランダムな値で全くもって意味がありません。 ですので、MNISTの画像を使って実際にテストしてみたいと思います。 入力画像は28*28の8bit画像です。 これをGUIで実行するのが、 <a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/CNTK6">https://github.com/takuya-takeuchi/Demo/tree/master/CNTK6</a> になります。 ビルドする際は、<strong>CNTK6\assemblies\CNTK</strong> というフォルダを作って、そこに EvalWrapper.dll をコピーしてください。 また、実行する際は、CNTKで出力される全てのバイナリを実行フォルダにコピーしてください。 実行すると、こんな感じです。 <a href="../../../../public/2016/03/8902e16d1b34c914ec3b34aca8ce52d0.png"><img src="../../../../public/2016/03/8902e16d1b34c914ec3b34aca8ce52d0.png" alt="サンプルアプリ"></a></p>
<p>下のリストビューに確率がでており、この画像だと6である可能性が一番高いことを示唆しています。 入力画像は8、24、32bitに対応しており、それぞれバイナリに変換します。 ですので、MNIST以外にも使えます。<strong>CIFAR-100</strong> でも利用できます。 (CIFAR-100で最初はテストしていましたが、結果がいまいちなので、MNISTにしまいた。)</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>ついに.NET から利用できるようになりました。 これで利用までの敷居がぐっと下がったような気がします。 アプリへの組み込みも他のディープラーニングのフレームワークに比べて楽になります。</p>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/CNTK6/source/CNTK6">https://github.com/takuya-takeuchi/Demo/tree/master/CNTK6/source/CNTK6</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-03-19</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/ソフトウェア紹介/" title="ソフトウェア紹介">ソフトウェア紹介 </a><a class="tag" href="/categories/e3-83-87-e3-82-a3-e3-83-bc-e3-83-97-e3-83-a9-e3-83-bc-e3-83-8b-e3-83-b3-e3-82-b0/" title="%e3%83%87%e3%82%a3%e3%83%bc%e3%83%97%e3%83%a9%e3%83%bc%e3%83%8b%e3%83%b3%e3%82%b0">%e3%83%87%e3%82%a3%e3%83%bc%e3%83%97%e3%83%a9%e3%83%bc%e3%83%8b%e3%83%b3%e3%82%b0 </a><a class="tag" href="/categories/e3-83-87-e3-82-a3-e3-83-bc-e3-83-97-e3-83-a9-e3-83-bc-e3-83-8b-e3-83-b3-e3-82-b0/CNTK/" title="CNTK">CNTK </a><a class="tag" href="/categories/netで○○○を試してみる/" title="netで○○○を試してみる">netで○○○を試してみる </a><a class="tag" href="/categories/オープンソース/" title="オープンソース">オープンソース </a><a class="tag" href="/categories/gpupu/" title="gpupu">gpupu </a><a class="tag" href="/categories/ディープラーニング/" title="ディープラーニング">ディープラーニング </a><a class="tag" href="/categories/netで○○○を試してみる/NETでディープラーニングを試してみる/" title=".NETでディープラーニングを試してみる">.NETでディープラーニングを試してみる </a><a class="tag" href="/categories/gpupu/CUDA/" title="CUDA">CUDA </a><a class="tag" href="/categories/GPUPU/" title="GPUPU">GPUPU </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2016/03/19/897/,A certain engineer &quot;COMPLEX&quot;,.NETでディープラーニングを試してみる CNTK編 第1回,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2016/03/21/597/" title=".NETでOneDriveを試してみる 第1回">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2016/03/13/900/" title="ディープラーニング CNTK 雑談1 動かない api-ms-win-core-path-l1-1-0.dll がない">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>