<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><link rel="icon" href="/images/favicon.ico" type="image/x-icon"><title>.NETでディープラーニングを試してみる CNTK編 第1回 · A certain engineer "COMPLEX"</title><meta name="description" content="前回は評価データをExcelで可視化しました。今回は.NETから使ってみます。

注意CNTKのソースコード自体、現在進行形で進化しています。入手できるバイナリも現時点 (2016/03/18) でも動作しません。実行は最新ソースを取得してビルドする必要があります。また、設定ファイルやソースコードも"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>.NETでディープラーニングを試してみる CNTK編 第1回</a></h3></div><div class="post-content"><p><a target="_blank" rel="noopener" href="https://taktak.jp/2016/03/06/889">前回</a>は評価データをExcelで可視化しました。今回は.NETから使ってみます。</p>
<a id="more"></a>
<h1 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h1><p>CNTKのソースコード自体、現在進行形で進化しています。入手できるバイナリも現時点 (2016/03/18) でも動作しません。<br>実行は最新ソースを取得してビルドする必要があります。<br>また、設定ファイルやソースコードもトライアンドエラーで試した結果です。</p>
<h1 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h1><p>対象データは、MNISTとします。<br>ネットワークモデルは、<strong>Examples\Image\MNIST</strong> にあります。<br>ただし、データそのものは、含まれていません。</p>
<p><a target="_blank" rel="noopener" href="http://yann.lecun.com/exdb/mnist/">THE MNIST DATABASE</a> から入手できるのですが、ここから入手しても、CNTKが読み込める形式にはなっていません。<br><strong>Examples\Image\MNIST\AdditionalFiles</strong> に、データの入手、変換を行うPython のスクリプトが入っているのですが、Python環境がないと使えません。<br>ですので、後述のサンプルプログラムにデータを含めておきました。<br>data\mnist.zip になります。これを解凍してできる、<strong>Train-28x28.txt</strong>、<strong>Test-28x28.txt</strong> を <strong>Examples\Image\MNIST\Data</strong> にコピーします。</p>
<p>次に設定ファイルを変更します。<br><strong>Examples\Image\MNIST\Config\01_OneHidden.cntk</strong> を開いて、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">deviceId &#x3D; 0</span><br><span class="line">imageLayout &#x3D; &quot;cudnn&quot;</span><br></pre></td></tr></table></figure>

<p>を</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">deviceId &#x3D; -1</span><br><span class="line">imageLayout &#x3D; &quot;legacy&quot;</span><br></pre></td></tr></table></figure>

<p>に変更します。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># stderr &#x3D; &quot;$OutputDir$&#x2F;01_OneHidden_out&quot;</span><br></pre></td></tr></table></figure>

<p>を</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stderr &#x3D; &quot;$OutputDir$&#x2F;01_OneHidden_out&quot;</span><br></pre></td></tr></table></figure>

<p>に変更して学習途中のログを生成することもおすすめしておきます。<br>以上で準備が完了です。</p>
<h2 id="ビルド"><a href="#ビルド" class="headerlink" title="ビルド"></a>ビルド</h2><p>最新ソースを取得してビルドします。<br>個人的には、GPUを使わない方が良いと思います。</p>
<p>ただし、3/18の時点では、<a target="_blank" rel="noopener" href="https://taktak.jp/2016/03/13/900">ディープラーニング CNTK 雑談1 動かない api-ms-win-core-path-l1-1-0.dll がない</a> で報告したバグが直っていないので、Windows7で動かすなら、記事を参考にソースを修正してからビルドしてください。</p>
<h2 id="学習"><a href="#学習" class="headerlink" title="学習"></a>学習</h2><p>ビルド完了後、出来上がるパスをメモします。CNTK.slnがあるディレクトリから見て、<strong>x64\Release_CpuOnly</strong> または <strong>x64\Release_CpuOnly</strong> になると思います。<br>コマンドプロンプトを開いて、CNTK.slnがあるディレクトリにカレントディレクトリを移動します。<br>そして、次のコマンドを実行します。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> <span class="built_in">PATH</span>=&quot;<span class="variable">%CD%</span>\x64\Release_CpuOnly&quot;;<span class="variable">%PATH%</span></span><br><span class="line"><span class="built_in">set</span> CURRENT=<span class="variable">%CD%</span></span><br><span class="line"><span class="built_in">rmdir</span> &quot;Examples\Image\MNIST\Output&quot; /s /q</span><br><span class="line"><span class="built_in">cd</span> &quot;Examples\Image\MNIST\Config&quot;</span><br><span class="line">CNTK configFile=<span class="number">01</span>_OneHidden.cntk deviceId=-<span class="number">1</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">%CURRENT%</span></span><br></pre></td></tr></table></figure>

<p>これでしばらくすると、<strong>Examples\Image\MNIST\Output\Models</strong> に学習済みのモデルファイルが出来上がっているはずです。<br>ログは、<strong>Examples\Image\MNIST\Output\01_OneHidden_out_MNISTtrain_MNISTtest.log</strong> になります。</p>
<p>さらっとながめてみますと、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Allocating matrices for forward and&#x2F;or backward propagation.</span><br><span class="line">UCIFastReader: Starting at epoch 0, counting lines to determine record count...</span><br><span class="line"> 10000 records found.</span><br><span class="line">starting epoch 0 at record count 0, and file position 0</span><br><span class="line">already there from last epoch</span><br><span class="line">RandomOrdering: 1989 retries for 10000 elements (19.9%) to ensure window condition</span><br><span class="line">RandomOrdering: recached sequence for seed 0: 2334, 3830, ...</span><br><span class="line">Minibatch[1-500]: SamplesSeen &#x3D; 8000    err: ErrorPrediction&#x2F;Sample &#x3D; 0.024125    ce: CrossEntropyWithSoftmax&#x2F;Sample &#x3D; 0.076922514</span><br><span class="line">Minibatch[501-625]: SamplesSeen &#x3D; 2000    err: ErrorPrediction&#x2F;Sample &#x3D; 0.0155    ce: CrossEntropyWithSoftmax&#x2F;Sample &#x3D; 0.060455356</span><br><span class="line">Final Results: Minibatch[1-625]: SamplesSeen &#x3D; 10000    err: ErrorPrediction&#x2F;Sample &#x3D; 0.0224    ce: CrossEntropyWithSoftmax&#x2F;Sample &#x3D; 0.073629082    Perplexity &#x3D; 1.0764075</span><br><span class="line"></span><br><span class="line">Action &quot;test&quot; complete.</span><br><span class="line"></span><br><span class="line">COMPLETED</span><br></pre></td></tr></table></figure>

<p>とあり、エラー率2.24%と出ています。まずまずです。</p>
<h2 id="NETからテスト"><a href="#NETからテスト" class="headerlink" title=".NETからテスト"></a>.NETからテスト</h2><p>テスト自体は、既にログを見るとおりわかっているのですが、これを.NETから可視化します。<br>実は、.NETのラッパーライブラリ自体は既にサンプル付きでCNTKに含まれています。<br><a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/tree/master/Source/Extensibility">https://github.com/Microsoft/CNTK/tree/master/Source/Extensibility</a> がそれです。<br>ソースである、<a target="_blank" rel="noopener" href="https://github.com/Microsoft/CNTK/blob/master/Source/Extensibility/CSEvalClient/Program.cs">Program.cs</a>を見ると非常に簡単であることがわかります。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> model = <span class="keyword">new</span> IEvaluateModelManagedF())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Initialize model evaluator</span></span><br><span class="line">    <span class="keyword">string</span> config = GetFileContents(Path.Combine(Environment.CurrentDirectory, <span class="string">@&quot;..\Config\01_OneHidden.cntk&quot;</span>));</span><br><span class="line">    model.Init(config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load model</span></span><br><span class="line">    <span class="keyword">string</span> modelFilePath = Path.Combine(Environment.CurrentDirectory, <span class="string">@&quot;..\Output\Models\01_OneHidden&quot;</span>);</span><br><span class="line">    model.CreateNetwork(<span class="keyword">string</span>.Format(<span class="string">&quot;deviceId=-1\nmodelPath=\&quot;&#123;0&#125;\&quot;&quot;</span>, modelFilePath));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate random input values in the appropriate structure and size</span></span><br><span class="line">    <span class="keyword">var</span> inputs = GetDictionary(<span class="string">&quot;features&quot;</span>, <span class="number">28</span>*<span class="number">28</span>, <span class="number">255</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We can call the evaluate method and get back the results (single layer)...</span></span><br><span class="line">    outputs = model.Evaluate(inputs, <span class="string">&quot;ol.z&quot;</span>, <span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>です。<br>Init関数には、設定ファイルのパスを、CreateNetworkには、コマンドプロンプトで渡す記述を渡すだけです。</p>
<p>ただし、わかりにくいのが、<strong>inputs</strong> と <strong>outputs</strong> です。</p>
<p>inputsは、<strong>System.Collections.Generic.Dictionary&lt;string, System.Collections.Generic.List<float>&gt;</strong> ですが、GetDictionaryで得られる戻り値は、**”features”** というキー、長さ28_28の <strong>System.Collections.Generic.List<float></strong> の値のペアが一つです。<br>値の中身は0-255の値がランダムに入っています。<br>MNISTは28_28なのでそういう条件なのです。<br>*.cntkにも784という数字が書いてありましたが、まさしくこれです。</p>
<p><strong>outputs</strong> は、<strong>System.Collections.Generic.List<float></strong> です。<br>今回は長さ10で、添え字0-9が、MNISTで認識する0-9の数値にそのまま対応しています。<br>また、各要素の値は、入力データが、添え字に対応する数字のどれに対応するか、という確率を返します。</p>
<p>では、**”features”** と <strong>“ol.z”</strong> は何を意味するのでしょうか？ これは、入力データと出力データを識別するキーになります。<br>ディープラーニングでは、各レイヤー毎に複数の入出力を持つことが可能です。その入出力を識別するためのキーになります。<br><a target="_blank" rel="noopener" href="http://caffe.berkeleyvision.org/">Caffe</a> でいう、Bottom (入力)、Top (出力)になります。</p>
<p>では、この定義はどこにあるのか、というと <strong>Examples\Image\MNIST\Config\01_OneHidden.ndl</strong> を見るとわかります。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FeatureNodes &#x3D; (features)</span><br><span class="line">LabelNodes &#x3D; (labels)</span><br><span class="line">CriterionNodes &#x3D; (ce)</span><br><span class="line">EvalNodes &#x3D; (err)</span><br><span class="line">OutputNodes &#x3D; (ol)</span><br></pre></td></tr></table></figure>

<p>という記述がまさにそれです。<br>ただし、<strong>ol</strong> だけは、**”.z”** を付与しないと、実行時にエラーを投げてしまいますので、そうしています。</p>
<p>さて、実行するとわかりますが、戻ってくる値には、負数が含まれており、全部の数値を合計しても確率を表すと思われる、1または100になりません。<br>これは、後述のサンプルソースで含まれるSoftmaxメソッドで確率に変換すること目的を達成できます。</p>
<p>ディープラーニングでは、出力層で得られた結果をSoftmaxで確率に変換することで識別を行います。<br>説明は<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Softmax_function">Softmax_function</a> でわかりますが、簡単にソースで示すと、</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> IList&lt;<span class="keyword">double</span>&gt; <span class="title">Softmax</span>(<span class="params">IList&lt;<span class="keyword">float</span>&gt; outputs</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> results = <span class="keyword">new</span> <span class="keyword">double</span>[outputs.Count];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> total = <span class="number">0</span>d;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>, length = results.Length; index &lt; length; index++)</span><br><span class="line">    &#123;</span><br><span class="line">        results[index] = Math.Exp(outputs[index]);</span><br><span class="line">        total += results[index];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>, length = results.Length; index &lt; length; index++)</span><br><span class="line">    &#123;</span><br><span class="line">        results[index] /= total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>になります。簡単ですね。</p>
<h1 id="テストする"><a href="#テストする" class="headerlink" title="テストする"></a>テストする</h1><p>が、先のサンプルは、入力データがランダムな値で全くもって意味がありません。<br>ですので、MNISTの画像を使って実際にテストしてみたいと思います。<br>入力画像は28*28の8bit画像です。</p>
<p>これをGUIで実行するのが、</p>
<p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/MachineLearning/CNTK/CNTK6">https://github.com/takuya-takeuchi/Demo/tree/master/MachineLearning/CNTK/CNTK6</a></p>
<p>になります。<br>ビルドする際は、<strong>CNTK6\assemblies\CNTK</strong> というフォルダを作って、そこに EvalWrapper.dll をコピーしてください。<br>また、実行する際は、CNTKで出力される全てのバイナリを実行フォルダにコピーしてください。</p>
<p>実行すると、こんな感じです。</p>
<p><a href="../../../../public/2016/03/8902e16d1b34c914ec3b34aca8ce52d0.png"><img src="../../../../public/2016/03/8902e16d1b34c914ec3b34aca8ce52d0.png" alt="サンプルアプリ"></a></p>
<p>下のリストビューに確率がでており、この画像だと6である可能性が一番高いことを示唆しています。</p>
<p>入力画像は8、24、32bitに対応しており、それぞれバイナリに変換します。<br>ですので、MNIST以外にも使えます。<strong>CIFAR-100</strong> でも利用できます。<br>(CIFAR-100で最初はテストしていましたが、結果がいまいちなので、MNISTにしまいた。)</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>ついに.NET から利用できるようになりました。<br>これで利用までの敷居がぐっと下がったような気がします。<br>アプリへの組み込みも他のディープラーニングのフレームワークに比べて楽になります。</p>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/MachineLearning/CNTK/CNTK6/source/CNTK6">https://github.com/takuya-takeuchi/Demo/tree/master/MachineLearning/CNTK/CNTK6/source/CNTK6</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-03-19</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/ソフトウェア紹介/" title="ソフトウェア紹介">ソフトウェア紹介 </a><a class="tag" href="/categories/ディープラーニング/" title="ディープラーニング">ディープラーニング </a><a class="tag" href="/categories/netで○○○を試してみる/" title="netで○○○を試してみる">netで○○○を試してみる </a><a class="tag" href="/categories/オープンソース/" title="オープンソース">オープンソース </a><a class="tag" href="/categories/gpupu/" title="gpupu">gpupu </a><a class="tag" href="/categories/ディープラーニング/CNTK/" title="CNTK">CNTK </a><a class="tag" href="/categories/netで○○○を試してみる/NETでディープラーニングを試してみる/" title=".NETでディープラーニングを試してみる">.NETでディープラーニングを試してみる </a><a class="tag" href="/categories/gpupu/CUDA/" title="CUDA">CUDA </a><a class="tag" href="/categories/GPUPU/" title="GPUPU">GPUPU </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2016/03/19/897/,A certain engineer &quot;COMPLEX&quot;,.NETでディープラーニングを試してみる CNTK編 第1回,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2016/03/21/597/" title=".NETでOneDriveを試してみる 第1回">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2016/03/13/900/" title="ディープラーニング CNTK 雑談1 動かない api-ms-win-core-path-l1-1-0.dll がない">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>