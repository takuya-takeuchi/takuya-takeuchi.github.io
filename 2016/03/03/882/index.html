<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>ディープラーニング CNTK その4 自分で学習 · A certain engineer "COMPLEX"</title><meta name="description" content="前回は軽くCNTKの設定の仕方について説明しました。今回は自分で学習させてみます。

データの準備CIFAR-100CIFAR-100というデータを用意します。 データはここから入手できます。 ページ下の CIFAR-100 binary version (suitable for C progra"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>ディープラーニング CNTK その4 自分で学習</a></h3></div><div class="post-content"><p><a target="_blank" rel="noopener" href="http://wp.me/p7138e-dY">前回</a>は軽くCNTKの設定の仕方について説明しました。今回は自分で学習させてみます。</p>
<a id="more"></a>
<h1 id="データの準備"><a href="#データの準備" class="headerlink" title="データの準備"></a>データの準備</h1><h2 id="CIFAR-100"><a href="#CIFAR-100" class="headerlink" title="CIFAR-100"></a>CIFAR-100</h2><p>CIFAR-100というデータを用意します。 データは<a target="_blank" rel="noopener" href="https://www.cs.toronto.edu/~kriz/cifar.html">ここ</a>から入手できます。 ページ下の <strong>CIFAR-100 binary version (suitable for C programs)</strong> からダウンロードできます。 このデータを用意したのはCaffeを説明した際に少しだけ名前が出てきた <strong>ALXENET</strong> の考案者である <strong>Alex Krizhevsky氏</strong> です。感謝です。 CIFAR-10やMNISTをテストしているブログは多いですが、CIFAR-100をテストしている人は少ないので、これを選びました。 また、CNTKにもCIFAR-10しかないので、これを選んだのが理由です。 まずは、ダウンロードしたデータから教師データを作成します。</p>
<h2 id="教師データ作成-画像編"><a href="#教師データ作成-画像編" class="headerlink" title="教師データ作成 画像編"></a>教師データ作成 画像編</h2><p>結論から言いますと、ダウンロードしたデータはそのままでは使うことができません。 CIFAR-100のデータも画像そのもの、というわけではありません。 まず教師データである画像データは test.binとtrain.binにバイナリで含まれています。 binデータは [code] &lt;1 x coarse label&gt;&lt;1 x fine label&gt;&lt;3072 x pixel&gt; … &lt;1 x coarse label&gt;&lt;1 x fine label&gt;&lt;3072 x pixel&gt; [/code] という順でバイナリに含まれています。 つまり1ファイル3074バイトです。 coarse labelは、雑なラベル付けで、「魚」、「昆虫」とかいう大雑把なラベルです。 fine labelは、もっと詳細なラベル付けで、「鮫」、「蝶」とかいう具体的なラベルです。 0から始まる整数値でそれぞれ、coarse_label_names.txt、fine_label_names.txtの先頭の行番号-1と対応します。 ここで注意するのが、画像領域の3072バイトが、先頭1024バイトに赤、次の1024バイトに緑、残りに青の画素が含まれています。 これをBGRの順で1ピクセルずつ格納しなおす必要があります。 つまり [code lang=”csharp”] // dst は出力先のビットマップ領域 // src は入力元の3072バイト領域 for (var index = 0; index &lt; 1024; index++) { dst[index * 3 + 2] = src[1024 * 0 + index]; dst[index * 3 + 1] = src[1024 * 1 + index]; dst[index * 3 + 0] = src[1024 * 2 + index]; } [/code] こういう感じです。 これに直してビットマップで出力すると、Windowsで表示できます。 例えば、test.binの最初のデータは [code] 10 49 199 196… [/code] となっています。これを画像にすると、large_natural_outdoor_scenes(10+1=11行目)のmountain(49+1=50行目)なので、 <a href="../../../../public/2016/02/moutain.png"><img src="../../../../public/2016/02/moutain.png" alt="山"></a></p>
<p>になります (実際は32x32ですが、8倍に拡大してあります)。 では、画像には変換できましたが、これをCNTKが理解できる形式にする必要があります。 前回の章で説明した<strong>Reader Block</strong>で指定できる形式ですので、<strong>UCIFastReader</strong>で読み込める形式です。 これは、CSVと同じで、タブでバイトを1つずつ区切ります。一つの画像が終わったら改行します。 注意するのは改行コードですが、CR+LFにします。 左から順に、coarse label、fine label、1画素目の青、1画素目の緑、1画素目の赤、2画素目の青とつなげていきます。 ですので、下記のようになります [code] 10\t49\t249\t215… [/code] 以上の変換を自動で実行するプログラムを作りました。 <a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/CNTK4">https://github.com/takuya-takeuchi/Demo/tree/master/CNTK4</a> coarse_label_names.txt、fine_label_names.txt、test.bin、train.binと同一のフォルダで <strong>CNTK4.exe</strong> を、実行すると、下記のファイルとフォルダを出力します。</p>
<ul>
<li>test.txt : テスト用のデータ</li>
<li>train.txt : 学習用のデータ</li>
<li>test : テスト用の画像データをラベルごとにフォルダわけしてBmpにしたもの</li>
<li>train : 学習用の画像データをラベルごとにフォルダわけしてBmpにしたもの</li>
<li>train_Label.txt : 学習用データのラベルのリスト</li>
<li>test_Label.txt : テスト用データのラベルのリスト</li>
</ul>
<h2 id="教師データ作成-ラベル編"><a href="#教師データ作成-ラベル編" class="headerlink" title="教師データ作成 ラベル編"></a>教師データ作成 ラベル編</h2><p>次はラベルです。 CNTKはラベルを文字として受けるとことができません。 ですので、fine_label_names.txt等をそのままラベルとして使うことができません。 今回はfine_label_names.txtをラベルとして使いますので、このファイルを上書きするか別のファイルに0から99の値を1行ごとに改行したテキストファイルを作成します。 改行コードですが、CR+LFにします。 [code] 0 1 2 3 4 5 6 7 8 .. [/code] こんな感じです。</p>
<h2 id="設定ファイルデータ作成"><a href="#設定ファイルデータ作成" class="headerlink" title="設定ファイルデータ作成"></a>設定ファイルデータ作成</h2><p>流石に設定ファイルは1から作るのは厳しいので、<strong>\CNTK\Examples\Image\Miscellaneous\CIFAR-10</strong> を改造します。CIFAR-10フォルダから下記のファイルをコピーして、どこか別のフォルダに移動します。 <strong>01_Conv.cntk 01_Convolution.ndl Macros.ndl</strong> ここでは、<strong>\CNTK\Examples\Image\Miscellaneous\CIFAR-100</strong>にコピーしました。 まず、01_Conv.cntkを修正します。</p>
<ol>
<li>Train.reader.features.start、Test.reader.features.startを <strong>2</strong> に修正</li>
<li>Train.reader.labels.start、Test.reader.labels.startを <strong>1</strong> に修正</li>
<li>Train.reader.labels.labelDim、Test.reader.labels.labelDimを <strong>100</strong> に修正</li>
<li>Train.reader.labels.labelMappingFile、Test.reader.labels.labelMappingFileを <strong>$DataDir$/fine_label_names.txt</strong> に修正</li>
</ol>
<p>Train.reader.labels.start値は、それぞれ、test.txt、train.txtの各行の左から何列目かを表しています。0基準で、今回はfine_labelを使うので、1になったというわけです。 Train.reader.features.start値も同様です。 labelDimはラベルの個数です。fine_labelは100個のラベルですので、100と入力します。 labelMappingFileは先ほど、0-99を入力したファイルを指定します。中止するのは、フルパスで入力してもよいですが、今回は、すべてのファイルが同一ディレクトリにある前提ですので、上のように直します。 次は、01_Convolution.ndlです。</p>
<ol>
<li>ndlMnistMacros.LabelDimを <strong>100</strong> に修正</li>
</ol>
<p>これだけです。 以上で終了です。 Macros.ndlは修正しませんが、ないと動かないと思います。</p>
<h1 id="学習！"><a href="#学習！" class="headerlink" title="学習！"></a>学習！</h1><p><strong>CNTK\Examples\Image\Miscellaneous\CIFAR-100</strong>フォルダに、教師データ作成の段で出力されたファイルと修正したラベルファイルをコピーします。 現時点で、 <strong>01_Conv.cntk 01_Convolution.ndl fine_label_names.txt Macros.ndl test.txt train.txt</strong> が存在します。 いよいよ実行します。 コマンドプロンプトで、CNTK.slnのあるディレクトリから [code lang=”dos”] set PATH=”%CD%\Release”;%PATH% cd Examples\Image\Miscellaneous\CIFAR-100 CNTK configFile=01_Conv.cntk deviceId=0 1&gt; out.txt 2&gt;&amp;1 [/code] のようにたたきます。 しばらく待つと <strong>CNTK\Examples\Image\Miscellaneous\CIFAR-100\Output\01_Conv_Train_Test.log</strong> に結果が出力されます。 エラーがなければ末尾に <strong>COMPLETED</strong> と表示されます。 GPUを指定しましたが、私の環境で9分強かかりました。 また、学習済みモデルが <strong>CNTK\Examples\Image\Miscellaneous\CIFAR-100\Output\Models</strong> に結果が出力されます。</p>
<h1 id="ところがどっこい"><a href="#ところがどっこい" class="headerlink" title="ところがどっこい"></a>ところがどっこい</h1><h2 id="エラー-0"><a href="#エラー-0" class="headerlink" title="エラー 0"></a>エラー 0</h2><p>出力のログを見ると、末尾にエラー率等の情報が出ます。 ですが、なぜか0。 [code lang=”dos”] Minibatch[1-500]: Samples Seen = 8000 err: ErrorPrediction/Sample = 0 ce: CrossEntropyWithSoftmax/Sample = 0 Minibatch[501-625]: Samples Seen = 2000 err: ErrorPrediction/Sample = 0 ce: CrossEntropyWithSoftmax/Sample = 0 Final Results: Minibatch[1-625]: Samples Seen = 10000 err: ErrorPrediction/Sample = 0 ce: CrossEntropyWithSoftmax/Sample = 0 Perplexity = 1 COMPLETED [/code] どう考えてもありえません。 100%の認識率などあり得ません。 なので、ネットワーク設定がおかしいのか？と思いいろいろ見直しました。 それでもわからない。 結論から言えば、GitHubでコンパイル済みのバイナリを使ったらうまくいきました。 下記はその結果です。 [code lang=”dos”] Allocating matrices for forward and/or backward propagation. UCIFastReader: Starting at epoch 0, counting lines to determine record count… 10000 records found. starting epoch 0 at record count 0, and file position 0 already there from last epoch RandomOrdering: 1989 retries for 10000 elements (19.9%) to ensure window condition RandomOrdering: recached sequence for seed 0: 2334, 3830, … Minibatch[1-500]: Samples Seen = 8000 Err: ErrorPrediction/Sample = 0.58 CE: CrossEntropyWithSoftmax/Sample = 2.2598516 Minibatch[501-625]: Samples Seen = 2000 Err: ErrorPrediction/Sample = 0.5805 CE: CrossEntropyWithSoftmax/Sample = 2.2639628 Final Results: Minibatch[1-625]: Samples Seen = 10000 Err: ErrorPrediction/Sample = 0.5801 CE: CrossEntropyWithSoftmax/Sample = 2.2606739 Perplexity = 9.5895492 COMPLETED [/code] エラー率58%。よくないですが、まぁこんなものでしょう。 なぜこうなったし。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>ついに自分で学習できました。 が、ビルドしたものがおかしいという悲劇。CUDA 7.5をつかったのがダメだったのか？ 次回はお待ちかねの評価を実施します。</p>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/CNTK4">https://github.com/takuya-takeuchi/Demo/tree/master/CNTK4</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-03-03</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/ソフトウェア紹介/" title="ソフトウェア紹介">ソフトウェア紹介 </a><a class="tag" href="/categories/e3-83-87-e3-82-a3-e3-83-bc-e3-83-97-e3-83-a9-e3-83-bc-e3-83-8b-e3-83-b3-e3-82-b0/" title="%e3%83%87%e3%82%a3%e3%83%bc%e3%83%97%e3%83%a9%e3%83%bc%e3%83%8b%e3%83%b3%e3%82%b0">%e3%83%87%e3%82%a3%e3%83%bc%e3%83%97%e3%83%a9%e3%83%bc%e3%83%8b%e3%83%b3%e3%82%b0 </a><a class="tag" href="/categories/e3-83-87-e3-82-a3-e3-83-bc-e3-83-97-e3-83-a9-e3-83-bc-e3-83-8b-e3-83-b3-e3-82-b0/CNTK/" title="CNTK">CNTK </a><a class="tag" href="/categories/オープンソース/" title="オープンソース">オープンソース </a><a class="tag" href="/categories/gpupu/" title="gpupu">gpupu </a><a class="tag" href="/categories/ディープラーニング/" title="ディープラーニング">ディープラーニング </a><a class="tag" href="/categories/gpupu/CUDA/" title="CUDA">CUDA </a><a class="tag" href="/categories/GPUPU/" title="GPUPU">GPUPU </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2016/03/03/882/,A certain engineer &quot;COMPLEX&quot;,ディープラーニング CNTK その4 自分で学習,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2016/03/06/889/" title="ディープラーニング CNTK その5 評価の可視化">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2016/02/29/866/" title="ディープラーニング CNTK その3 説明">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>