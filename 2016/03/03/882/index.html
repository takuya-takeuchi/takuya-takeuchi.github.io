<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>ディープラーニング CNTK その4 自分で学習 · A certain engineer "COMPLEX"</title><meta name="description" content="前回は軽くCNTKの設定の仕方について説明しました。今回は自分で学習させてみます。

データの準備CIFAR-100CIFAR-100というデータを用意します。データはここから入手できます。ページ下の CIFAR-100 binary version (suitable for C programs"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>ディープラーニング CNTK その4 自分で学習</a></h3></div><div class="post-content"><p><a target="_blank" rel="noopener" href="https://taktak.jp/2016/02/29/866">前回</a>は軽くCNTKの設定の仕方について説明しました。今回は自分で学習させてみます。</p>
<a id="more"></a>
<h1 id="データの準備"><a href="#データの準備" class="headerlink" title="データの準備"></a>データの準備</h1><h2 id="CIFAR-100"><a href="#CIFAR-100" class="headerlink" title="CIFAR-100"></a>CIFAR-100</h2><p>CIFAR-100というデータを用意します。<br>データは<a target="_blank" rel="noopener" href="https://www.cs.toronto.edu/~kriz/cifar.html">ここ</a>から入手できます。<br>ページ下の <strong>CIFAR-100 binary version (suitable for C programs)</strong> からダウンロードできます。<br>このデータを用意したのはCaffeを説明した際に少しだけ名前が出てきた <strong>ALXENET</strong> の考案者である <strong>Alex Krizhevsky氏</strong> です。感謝です。</p>
<p>CIFAR-10やMNISTをテストしているブログは多いですが、CIFAR-100をテストしている人は少ないので、これを選びました。<br>また、CNTKにもCIFAR-10しかないので、これを選んだのが理由です。</p>
<p>まずは、ダウンロードしたデータから教師データを作成します。</p>
<h2 id="教師データ作成-画像編"><a href="#教師データ作成-画像編" class="headerlink" title="教師データ作成 画像編"></a>教師データ作成 画像編</h2><p>結論から言いますと、ダウンロードしたデータはそのままでは使うことができません。<br>CIFAR-100のデータも画像そのもの、というわけではありません。</p>
<p>まず教師データである画像データは test.binとtrain.binにバイナリで含まれています。<br>binデータは</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;1 x coarse label&gt;&lt;1 x fine label&gt;&lt;3072 x pixel&gt;</span><br><span class="line">...</span><br><span class="line">&lt;1 x coarse label&gt;&lt;1 x fine label&gt;&lt;3072 x pixel&gt;</span><br></pre></td></tr></table></figure>

<p>という順でバイナリに含まれています。<br>つまり1ファイル3074バイトです。<br>coarse labelは、雑なラベル付けで、「魚」、「昆虫」とかいう大雑把なラベルです。<br>fine labelは、もっと詳細なラベル付けで、「鮫」、「蝶」とかいう具体的なラベルです。<br>0から始まる整数値でそれぞれ、coarse_label_names.txt、fine_label_names.txtの先頭の行番号-1と対応します。<br>ここで注意するのが、画像領域の3072バイトが、先頭1024バイトに赤、次の1024バイトに緑、残りに青の画素が含まれています。<br>これをBGRの順で1ピクセルずつ格納しなおす必要があります。<br>つまり</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dst は出力先のビットマップ領域</span></span><br><span class="line"><span class="comment">// src は入力元の3072バイト領域</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; <span class="number">1024</span>; index++)</span><br><span class="line">&#123;</span><br><span class="line">    dst[index * <span class="number">3</span> + <span class="number">2</span>] = src[<span class="number">1024</span> * <span class="number">0</span> + index];</span><br><span class="line">    dst[index * <span class="number">3</span> + <span class="number">1</span>] = src[<span class="number">1024</span> * <span class="number">1</span> + index];</span><br><span class="line">    dst[index * <span class="number">3</span> + <span class="number">0</span>] = src[<span class="number">1024</span> * <span class="number">2</span> + index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>こういう感じです。<br>これに直してビットマップで出力すると、Windowsで表示できます。<br>例えば、test.binの最初のデータは</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10 49 199 196...</span><br></pre></td></tr></table></figure>

<p>となっています。これを画像にすると、large_natural_outdoor_scenes(10+1=11行目)のmountain(49+1=50行目)なので、</p>
<p><a href="../../../../public/2016/02/moutain.png"><img src="../../../../public/2016/02/moutain.png" alt="山"></a></p>
<p>になります (実際は32x32ですが、8倍に拡大してあります)。<br>では、画像には変換できましたが、これをCNTKが理解できる形式にする必要があります。</p>
<p>前回の章で説明した<strong>Reader Block</strong>で指定できる形式ですので、<strong>UCIFastReader</strong>で読み込める形式です。<br>これは、CSVと同じで、タブでバイトを1つずつ区切ります。一つの画像が終わったら改行します。<br>注意するのは改行コードですが、CR+LFにします。<br>左から順に、coarse label、fine label、1画素目の青、1画素目の緑、1画素目の赤、2画素目の青とつなげていきます。</p>
<p>ですので、下記のようになります</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10\t49\t249\t215...</span><br></pre></td></tr></table></figure>

<p>以上の変換を自動で実行するプログラムを作りました。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/CNTK4">https://github.com/takuya-takeuchi/Demo/tree/master/CNTK4</a></p>
<p>coarse_label_names.txt、fine_label_names.txt、test.bin、train.binと同一のフォルダで <strong>CNTK4.exe</strong> を、実行すると、下記のファイルとフォルダを出力します。</p>
<ul>
<li>test.txt : テスト用のデータ</li>
<li>train.txt : 学習用のデータ</li>
<li>test : テスト用の画像データをラベルごとにフォルダわけしてBmpにしたもの</li>
<li>train : 学習用の画像データをラベルごとにフォルダわけしてBmpにしたもの</li>
<li>train_Label.txt : 学習用データのラベルのリスト</li>
<li>test_Label.txt : テスト用データのラベルのリスト</li>
</ul>
<h2 id="教師データ作成-ラベル編"><a href="#教師データ作成-ラベル編" class="headerlink" title="教師データ作成 ラベル編"></a>教師データ作成 ラベル編</h2><p>次はラベルです。<br>CNTKはラベルを文字として受けるとことができません。<br>ですので、fine_label_names.txt等をそのままラベルとして使うことができません。<br>今回はfine_label_names.txtをラベルとして使いますので、このファイルを上書きするか別のファイルに0から99の値を1行ごとに改行したテキストファイルを作成します。<br>改行コードですが、CR+LFにします。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">..</span><br></pre></td></tr></table></figure>

<p>こんな感じです。</p>
<h2 id="設定ファイルデータ作成"><a href="#設定ファイルデータ作成" class="headerlink" title="設定ファイルデータ作成"></a>設定ファイルデータ作成</h2><p>流石に設定ファイルは1から作るのは厳しいので、<strong>\CNTK\Examples\Image\Miscellaneous\CIFAR-10</strong> を改造します。CIFAR-10フォルダから下記のファイルをコピーして、どこか別のフォルダに移動します。<br><strong>01_Conv.cntk 01_Convolution.ndl Macros.ndl</strong> ここでは、<strong>\CNTK\Examples\Image\Miscellaneous\CIFAR-100</strong>にコピーしました。<br>まず、01_Conv.cntkを修正します。</p>
<ol>
<li>Train.reader.features.start、Test.reader.features.startを <strong>2</strong> に修正</li>
<li>Train.reader.labels.start、Test.reader.labels.startを <strong>1</strong> に修正</li>
<li>Train.reader.labels.labelDim、Test.reader.labels.labelDimを <strong>100</strong> に修正</li>
<li>Train.reader.labels.labelMappingFile、Test.reader.labels.labelMappingFileを  <strong>$DataDir$/fine_label_names.txt</strong> に修正</li>
</ol>
<p>Train.reader.labels.start値は、それぞれ、test.txt、train.txtの各行の左から何列目かを表しています。0基準で、今回はfine_labelを使うので、1になったというわけです。<br>Train.reader.features.start値も同様です。<br>labelDimはラベルの個数です。fine_labelは100個のラベルですので、100と入力します。<br>labelMappingFileは先ほど、0-99を入力したファイルを指定します。中止するのは、フルパスで入力してもよいですが、今回は、すべてのファイルが同一ディレクトリにある前提ですので、上のように直します。</p>
<p>次は、01_Convolution.ndlです。</p>
<ol>
<li>ndlMnistMacros.LabelDimを <strong>100</strong> に修正</li>
</ol>
<p>これだけです。<br>以上で終了です。<br>Macros.ndlは修正しませんが、ないと動かないと思います。</p>
<h1 id="学習！"><a href="#学習！" class="headerlink" title="学習！"></a>学習！</h1><p><strong>CNTK\Examples\Image\Miscellaneous\CIFAR-100</strong>フォルダに、教師データ作成の段で出力されたファイルと修正したラベルファイルをコピーします。<br>現時点で、</p>
<ul>
<li>01_Conv.cntk</li>
<li>01_Convolution.ndl</li>
<li>fine_label_names.txt</li>
<li>Macros.ndl</li>
<li>test.txt</li>
<li>train.txt</li>
</ul>
<p>が存在します。<br>いよいよ実行します。<br>コマンドプロンプトで、CNTK.slnのあるディレクトリから</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> <span class="built_in">PATH</span>=&quot;<span class="variable">%CD%</span>\Release&quot;;<span class="variable">%PATH%</span></span><br><span class="line"><span class="built_in">cd</span> Examples\Image\Miscellaneous\CIFAR-<span class="number">100</span></span><br><span class="line">CNTK configFile=<span class="number">01</span>_Conv.cntk deviceId=<span class="number">0</span> <span class="number">1</span>&gt; out.txt <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>のようにたたきます。<br>しばらく待つと <strong>CNTK\Examples\Image\Miscellaneous\CIFAR-100\Output\01_Conv_Train_Test.log</strong> に結果が出力されます。<br>エラーがなければ末尾に <strong>COMPLETED</strong> と表示されます。<br>GPUを指定しましたが、私の環境で9分強かかりました。<br>また、学習済みモデルが <strong>CNTK\Examples\Image\Miscellaneous\CIFAR-100\Output\Models</strong> に結果が出力されます。</p>
<h1 id="ところがどっこい"><a href="#ところがどっこい" class="headerlink" title="ところがどっこい"></a>ところがどっこい</h1><h2 id="エラー-0"><a href="#エラー-0" class="headerlink" title="エラー 0"></a>エラー 0</h2><p>出力のログを見ると、末尾にエラー率等の情報が出ます。<br>ですが、なぜか0。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Minibatch[<span class="number">1</span>-<span class="number">500</span>]: Samples Seen = <span class="number">8000</span>    err: ErrorPrediction/Sample = <span class="number">0</span>    ce: CrossEntropyWithSoftmax/Sample = <span class="number">0</span></span><br><span class="line">Minibatch[<span class="number">501</span>-<span class="number">625</span>]: Samples Seen = <span class="number">2000</span>    err: ErrorPrediction/Sample = <span class="number">0</span>    ce: CrossEntropyWithSoftmax/Sample = <span class="number">0</span></span><br><span class="line">Final Results: Minibatch[<span class="number">1</span>-<span class="number">625</span>]: Samples Seen = <span class="number">10000</span>    err: ErrorPrediction/Sample = <span class="number">0</span>    ce: CrossEntropyWithSoftmax/Sample = <span class="number">0</span>    Perplexity = <span class="number">1</span></span><br><span class="line">COMPLETED</span><br></pre></td></tr></table></figure>

<p>どう考えてもありえません。<br>100%の認識率などあり得ません。</p>
<p>なので、ネットワーク設定がおかしいのか？と思いいろいろ見直しました。<br>それでもわからない。</p>
<p>結論から言えば、GitHubでコンパイル済みのバイナリを使ったらうまくいきました。<br>下記はその結果です。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Allocating matrices <span class="keyword">for</span> forward and/or backward propagation.</span><br><span class="line"><span class="function">UCIFastReader: <span class="title">Starting</span> <span class="title">at</span> <span class="title">epoch</span> 0, <span class="title">counting</span> <span class="title">lines</span> <span class="title">to</span> <span class="title">determine</span> <span class="title">record</span> <span class="title">count</span>...</span></span><br><span class="line"><span class="function"> 10000 <span class="title">records</span> <span class="title">found</span>.</span></span><br><span class="line"><span class="function"><span class="title">starting</span> <span class="title">epoch</span> 0 <span class="title">at</span> <span class="title">record</span> <span class="title">count</span> 0, <span class="title">and</span> <span class="title">file</span> <span class="title">position</span> 0</span></span><br><span class="line"><span class="function"><span class="title">already</span> <span class="title">there</span> <span class="title">from</span> <span class="title">last</span> <span class="title">epoch</span></span></span><br><span class="line"><span class="function"><span class="title">RandomOrdering</span>: 1989 <span class="title">retries</span> <span class="title">for</span> 10000 <span class="title">elements</span> (19.9%) <span class="title">to</span> <span class="title">ensure</span> <span class="title">window</span> <span class="title">condition</span></span></span><br><span class="line"><span class="function"><span class="title">RandomOrdering</span>: <span class="title">recached</span> <span class="title">sequence</span> <span class="title">for</span> <span class="title">seed</span> 0: 2334, 3830, ...</span></span><br><span class="line"><span class="function"><span class="title">Minibatch</span>[1-500]: <span class="title">Samples</span> <span class="title">Seen</span> = 8000    <span class="title">Err</span>: <span class="title">ErrorPrediction</span>/<span class="title">Sample</span> = 0.58    <span class="title">CE</span>: <span class="title">CrossEntropyWithSoftmax</span>/<span class="title">Sample</span> = 2.2598516</span></span><br><span class="line"><span class="function"><span class="title">Minibatch</span>[501-625]: <span class="title">Samples</span> <span class="title">Seen</span> = 2000    <span class="title">Err</span>: <span class="title">ErrorPrediction</span>/<span class="title">Sample</span> = 0.5805    <span class="title">CE</span>: <span class="title">CrossEntropyWithSoftmax</span>/<span class="title">Sample</span> = 2.2639628</span></span><br><span class="line"><span class="function"><span class="title">Final</span> <span class="title">Results</span>: <span class="title">Minibatch</span>[1-625]: <span class="title">Samples</span> <span class="title">Seen</span> = 10000    <span class="title">Err</span>: <span class="title">ErrorPrediction</span>/<span class="title">Sample</span> = 0.5801    <span class="title">CE</span>: <span class="title">CrossEntropyWithSoftmax</span>/<span class="title">Sample</span> = 2.2606739    <span class="title">Perplexity</span> = 9.5895492</span></span><br><span class="line"><span class="function"><span class="title">COMPLETED</span></span></span><br></pre></td></tr></table></figure>

<p>エラー率58%。よくないですが、まぁこんなものでしょう。</p>
<p>なぜこうなったし。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>ついに自分で学習できました。<br>が、ビルドしたものがおかしいという悲劇。CUDA 7.5をつかったのがダメだったのか？ 次回はお待ちかねの評価を実施します。</p>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/CNTK4">https://github.com/takuya-takeuchi/Demo/tree/master/CNTK4</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-03-03</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/ソフトウェア紹介/" title="ソフトウェア紹介">ソフトウェア紹介 </a><a class="tag" href="/categories/e3-83-87-e3-82-a3-e3-83-bc-e3-83-97-e3-83-a9-e3-83-bc-e3-83-8b-e3-83-b3-e3-82-b0/" title="%e3%83%87%e3%82%a3%e3%83%bc%e3%83%97%e3%83%a9%e3%83%bc%e3%83%8b%e3%83%b3%e3%82%b0">%e3%83%87%e3%82%a3%e3%83%bc%e3%83%97%e3%83%a9%e3%83%bc%e3%83%8b%e3%83%b3%e3%82%b0 </a><a class="tag" href="/categories/e3-83-87-e3-82-a3-e3-83-bc-e3-83-97-e3-83-a9-e3-83-bc-e3-83-8b-e3-83-b3-e3-82-b0/CNTK/" title="CNTK">CNTK </a><a class="tag" href="/categories/オープンソース/" title="オープンソース">オープンソース </a><a class="tag" href="/categories/gpupu/" title="gpupu">gpupu </a><a class="tag" href="/categories/ディープラーニング/" title="ディープラーニング">ディープラーニング </a><a class="tag" href="/categories/gpupu/CUDA/" title="CUDA">CUDA </a><a class="tag" href="/categories/GPUPU/" title="GPUPU">GPUPU </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2016/03/03/882/,A certain engineer &quot;COMPLEX&quot;,ディープラーニング CNTK その4 自分で学習,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2016/03/06/889/" title="ディープラーニング CNTK その5 評価の可視化">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2016/02/29/866/" title="ディープラーニング CNTK その3 説明">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>