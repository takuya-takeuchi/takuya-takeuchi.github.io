<!DOCTYPE html><html lang="ja-JP"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>.NETでGPUPUを試してみる CUDA編 第3回 · A certain engineer "COMPLEX"</title><meta name="description" content="前回はCUDAの性能を改善しましたが、今一歩及ばずというところです。

Introductionところで、これまで.NETが一度も出てきていないのにこのタイトルは詐欺なんじゃないですかねぇ(震え声)
ExplanationTread!thread!!Thread!!!前回はスレッドを使って大幅に性能"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/blogcard.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.1.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">A certain engineer &quot;COMPLEX&quot;</a></h3><div class="description"><p>とある技術者の劣等感</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/takuya_takeuchi"><i class="fa fa-twitter-square"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.facebook.com/takuya.takeuchi.sns"><i class="fa fa-facebook-square"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core  </a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="search"><div class="text"><input placeholder="検索ワードを入力してください" id="search-text" onkeypress="javascript:search(event)"></div><div class="btn"><a><i class="fa fa-search"></i></a></div></div><div class="nav"><li><a href="/">ホーム</a></li><li><a href="/archives">アーカイブ</a></li><li><a href="/tags">タグ</a></li><li><a href="/about">自己紹介</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>.NETでGPUPUを試してみる CUDA編 第3回</a></h3></div><div class="post-content"><p><a target="_blank" rel="noopener" href="https://taktak.jp/2016/02/16/735">前回</a>はCUDAの性能を改善しましたが、今一歩及ばずというところです。</p>
<a id="more"></a>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>ところで、これまで.NETが一度も出てきていないのにこのタイトルは詐欺なんじゃないですかねぇ(震え声)</p>
<h1 id="Explanation"><a href="#Explanation" class="headerlink" title="Explanation"></a>Explanation</h1><h2 id="Tread-thread-Thread"><a href="#Tread-thread-Thread" class="headerlink" title="Tread!thread!!Thread!!!"></a>Tread!thread!!Thread!!!</h2><p>前回はスレッドを使って大幅に性能を改善しました。<br>が、それでもCPUが純粋にシーケンシャルで処理する方が速かったです。</p>
<p>CUDAに対する理解が全く足りていないのでもう少し調べてみます。<br>前回登場した、<strong>CUDA_C_Programming_Guide.pdf</strong> で、スレッドに関する記述を見てみます。</p>
<blockquote>
<p>2.2. Thread Hierarchy For convenience, threadIdx is a 3-component vector, so that threads can be identified using a one-dimensional, two-dimensional, or three-dimensional thread index, forming a one-dimensional, two-dimensional, or three-dimensional block of threads, called a thread block. This provides a natural way to invoke computation across the elements in a domain such as a vector, matrix, or volume.</p>
</blockquote>
<p><code>訳: 2.2. スレッドの階層 便利なことに、threadIdxは3成分のベクトルであり、つまりスレッドは1次元、2次元、3次元のスレッドインデックス、で識別することができ、スレッドブロックと呼ばれる1次元、2次元、3次元のスレッドのブロックを形作る。これは、ベクトル、行列、ボリューム (訳注：ここでいうベクトルは、力学のベクトルではなく、配列のような1次元データで、行列は2次元、ボリュームは3次元という意味) のようなドメイン内の要素を横断する計算を実行するための自然な方法を提供する。</code></p>
<p>といっています。<br>ブロックという単語が出てきました、これは前回でも出てきましたが、流しました。<br>要するに、スレッドはブロックという単位になっていることです。</p>
<blockquote>
<p>The index of a thread and its thread ID relate to each other in a straightforward way: For a one-dimensional block, they are the same; for a two-dimensional block of size $$(D_x, D_y)$$ ,the thread ID of a thread of index $$(x, y)$$ is $$(x + y, D_x)$$; for a three-dimensional block of size $$(D_x, D_y, D_x)$$, the thread ID of a thread of index $$(x, y, x)$$ is $$(x + y D_x + z D_x D_y)$$.</p>
</blockquote>
<p><code>訳: スレッドのインデックスとそのスレッドIDは素直なやり方で互いに関連している。1次元のブロックではそれらは同一であり、2次元のブロックのサイズ (Dx, Dy)、スレッドのインデックス (x, y) のスレッドIDは (x + y, Dx); 3次元のブロックのサイズ (Dx, Dy, Dx)、スレッドのインデックス (x, y, z) のスレッドIDは (x + y Dx + z Dx Dy)である。</code></p>
<p>つまるところ、各ブロックにスレッドが存在するっていってます。</p>
<blockquote>
<p>There is a limit to the number of threads per block, since all threads of a block are expected to reside on the same processor core and must share the limited memory resources of that core. On current GPUs, a thread block may contain up to 1024 threads. However, a kernel can be executed by multiple equally-shaped thread blocks, so that the total number of threads is equal to the number of threads per block times the number of blocks. Blocks are organized into a one-dimensional, two-dimensional, or three-dimensional grid of thread blocks as illustrated by Figure 6. The number of thread blocks in a grid is usually dictated by the size of the data being processed or the number of processors in the system, which it can greatly exceed.<br><a href="../../../../public/2015/12/Figure6.png"><img src="../../../../public/2015/12/Figure6-300x254.png" alt="Figure6"></a></p>
</blockquote>
<p><code>訳: 1ブロック毎のスレッド数には制限があり、一つのブロックの全スレッドは、プロセッサーコアから予測でき、コアの制限されたメモリリソースを共有しなくてはならない。現在のGPUにて、スレッドブロックは1024スレッドまで内包するかもしれない。しかし、カーネルは複数の同一形状のスレッドブロックで実行され、ゆえにスレッドの合計数はブロックの個数と1ブロックあたりのスレッドの個数の積になる。 ブロックは、Figure 6で図示された、スレッドブロックの1次元、2次元、3次元のグリッドを形作る。1つのグリッド内におけるスレッドブロックの数は通常、処理されるデータのサイズまたはシステムのプロセッサー数から規定される。(訳注：最後のwhichはどこにかかっているのかわかりませんでしたので、最後のwhich以降は無視します)</code></p>
<br>

<p><strong>スレッドの合計数はブロックの個数と1ブロックあたりのスレッドの個数の積</strong></p>
<br>

<p>なんか凄いこと書いてあります。<br>ってか、前回書いた記事で1ブロックあたり最大512スレッド、って書きましたけど、あれは間違い？ 当時のCUDA搭載GPUの最大値なのか？</p>
<p>とりあえず、自分のGPU性能を詳しく知りたい。<br><a target="_blank" rel="noopener" href="http://www.gdep.jp/page/view/250">第3回　CUDA4.0のインストール</a>によれば、<strong>deviceQuery.exe</strong> というプログラムが性能を詳しく教えてくれるとのこと。<br>これはCUDA Toolkitインストール時にコピーされており、デフォルトは。<strong>C:\ProgramData\NVIDIA Corporation\CUDA Samples\v7.5\1_Utilities\deviceQuery</strong> に入っていると。<br>とりあえず、自分でビルドして実行</p>
<p><a href="../../../../public/2015/12/deviceQuery.png"><img src="../../../../public/2015/12/deviceQuery-204x300.png" alt="deviceQuery"></a></p>
<p>結果として、1プロセッサーあたり1536スレッド、1ブロックあたり最大1024スレッド起動できることがわかりました。最大1536スレッドでしょぼくない？と思ったら、上に <strong>(4) Multiprocessors</strong> ってあるので、全部で1536*4=6144スレッドってこと？</p>
<p>とりあえず可能な限りスレッドを活用するべくコードを修正。<br>また、スレッド数を活用できるようなカーネルに内容を変更します。<br>サンプルコードはページの末尾を参照。<br>変更点は</p>
<ul>
<li>ベクトルの和の計算を行列乗算の計算に変更。1000x1000の行列なので1000^3 の計算</li>
<li>スレッド数指定</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> SIZE = <span class="number">32</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MATRIX_SIZE = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">cudaError_t <span class="title">addWithCuda</span><span class="params">(<span class="keyword">float</span> *c, <span class="keyword">const</span> <span class="keyword">float</span> *a, <span class="keyword">const</span> <span class="keyword">float</span> *b)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="keyword">void</span> <span class="title">addKernel</span><span class="params">(<span class="keyword">float</span> *c, <span class="keyword">const</span> <span class="keyword">float</span> *a, <span class="keyword">const</span> <span class="keyword">float</span> *b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> row = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line">    <span class="keyword">int</span> col = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (row &lt; MATRIX_SIZE &amp;&amp; col &lt; MATRIX_SIZE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> v = <span class="number">0.f</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> x = <span class="number">0</span>; x &lt; MATRIX_SIZE; x++)</span><br><span class="line">        &#123;</span><br><span class="line">            v += a[row * MATRIX_SIZE + x] * b[x * MATRIX_SIZE + col];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        c[row * MATRIX_SIZE + col] = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>こんな感じ。<br>ホスト側は省略。<br>結果は</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">threadsPerBlock.X =32, threadsPerBlock.y = 32</span><br><span class="line">numBlocks.X =32, numBlocks.y = 32</span><br><span class="line">CUDA is</span><br><span class="line">        time = &#123;117&#125;</span><br><span class="line">No CUDA is</span><br><span class="line">        time = &#123;7076&#125;</span><br></pre></td></tr></table></figure>

<p>やりました。60倍のパフォーマンスをたたき出しています。</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>そもそもの原因として、CUDAの得意領域に持ち込んでいなかったのが問題でした。<br>如何にスレッドを有効活用するか、というところに主眼をおいて実装を進める必要があります。</p>
<h1 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h1><p><a target="_blank" rel="noopener" href="https://github.com/takuya-takeuchi/Demo/tree/master/CUDA3">https://github.com/takuya-takeuchi/Demo/tree/master/CUDA3</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-03-12</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Microsoft/" title="Microsoft">Microsoft </a><a class="tag" href="/categories/Microsoft/NET-Framework/" title=".NET Framework">.NET Framework </a><a class="tag" href="/categories/net-framework/" title="net-framework">net-framework </a><a class="tag" href="/categories/ソフトウェア紹介/" title="ソフトウェア紹介">ソフトウェア紹介 </a><a class="tag" href="/categories/net-framework/NETで○○○を試してみる/" title=".NETで○○○を試してみる">.NETで○○○を試してみる </a><a class="tag" href="/categories/gpupu/" title="gpupu">gpupu </a><a class="tag" href="/categories/gpupu/CUDA/" title="CUDA">CUDA </a><a class="tag" href="/categories/GPUPU/" title="GPUPU">GPUPU </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://takuya-takeuchi.github.io/2016/03/12/740/,A certain engineer &quot;COMPLEX&quot;,.NETでGPUPUを試してみる CUDA編 第3回,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2016/03/13/900/" title="ディープラーニング CNTK 雑談1 動かない api-ms-win-core-path-l1-1-0.dll がない">前へ</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2016/03/06/889/" title="ディープラーニング CNTK その5 評価の可視化">次へ</a></li></ul></div></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/search.js"></script></body></html>