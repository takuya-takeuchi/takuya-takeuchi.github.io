!function(){"use strict";for(var j,TCproto,ocanvas,abs=Math.abs,sin=Math.sin,cos=Math.cos,max=Math.max,min=Math.min,ceil=Math.ceil,sqrt=Math.sqrt,pow=Math.pow,hexlookup3={},hexlookup2={},hexlookup1={0:"0,",1:"17,",2:"34,",3:"51,",4:"68,",5:"85,",6:"102,",7:"119,",8:"136,",9:"153,",a:"170,",A:"170,",b:"187,",B:"187,",c:"204,",C:"204,",d:"221,",D:"221,",e:"238,",E:"238,",f:"255,",F:"255,"},doc=document,handlers={},i=0;i<256;++i)j=i.toString(16),i<16&&(j="0"+j),hexlookup2[j]=hexlookup2[j.toUpperCase()]=i.toString()+",";function IsObject(o){return"object"==typeof o&&null!=o}function Clamp(v,mn,mx){return isNaN(v)?mx:min(mx,max(mn,v))}function Nop(){return!1}function TimeNow(){return(new Date).valueOf()}function Shuffle(a){for(var t,p,i=a.length-1;i;)p=~~(Math.random()*i),t=a[i],a[i]=a[p],a[p]=t,--i}function Vector(x,y,z){this.x=x,this.y=y,this.z=z}function Matrix(a){this[1]={1:a[0],2:a[1],3:a[2]},this[2]={1:a[3],2:a[4],3:a[5]},this[3]={1:a[6],2:a[7],3:a[8]}}function PointsOnSphere(n,xr,yr,zr,magic){for(var y,r,phi,pts=[],off=2/n,inc=Math.PI*(3-sqrt(5)+(parseFloat(magic)?parseFloat(magic):0)),i=0;i<n;++i)r=sqrt(1-(y=i*off-1+off/2)*y),phi=i*inc,pts.push([cos(phi)*r*xr,y*yr,sin(phi)*r*zr]);return pts}function Cylinder(n,o,xr,yr,zr,magic){for(var j,k,l,pts=[],off=2/n,inc=Math.PI*(3-sqrt(5)+(parseFloat(magic)?parseFloat(magic):0)),i=0;i<n;++i)j=i*off-1+off/2,k=cos(l=i*inc),l=sin(l),pts.push(o?[j*xr,k*yr,l*zr]:[k*xr,j*yr,l*zr]);return pts}function Ring(o,n,xr,yr,zr,j){for(var k,l,pts=[],inc=2*Math.PI/n,i=0;i<n;++i)k=cos(l=i*inc),l=sin(l),pts.push(o?[j*xr,k*yr,l*zr]:[k*xr,j*yr,l*zr]);return pts}function PointsOnCylinderV(n,xr,yr,zr,m){return Cylinder(n,0,xr,yr,zr,m)}function PointsOnCylinderH(n,xr,yr,zr,m){return Cylinder(n,1,xr,yr,zr,m)}function PointsOnRingV(n,xr,yr,zr,offset){return Ring(0,n,xr,yr,zr,offset=isNaN(offset)?0:+offset)}function PointsOnRingH(n,xr,yr,zr,offset){return Ring(1,n,xr,yr,zr,offset=isNaN(offset)?0:+offset)}function NewCanvas(w,h){if(window.G_vmlCanvasManager)return null;var c=doc.createElement("canvas");return c.width=w,c.height=h,c}function FindGradientColour(cv,p,d){var c,i,l=1024,h=1,gl=cv.weightGradient;if(cv.gCanvas)c=cv.gCanvas.getContext("2d"),h=cv.gCanvas.height;else{if(IsObject(gl[0])?h=gl.length:gl=[gl],cv.gCanvas=cv=NewCanvas(l,h),!cv)return null;for(c=cv.getContext("2d"),i=0;i<h;++i)!function(c,l,o,g){var i,gd=c.createLinearGradient(0,0,l,0);for(i in g)gd.addColorStop(1-i,g[i]);c.fillStyle=gd,c.fillRect(0,o,l,1)}(c,l,i,gl[i])}return d=max(min(d||0,h-1),0),"rgba("+(d=c.getImageData(~~((l-1)*p),d,1,1).data)[0]+","+d[1]+","+d[2]+","+d[3]/255+")"}function TextSet(ctxt,font,colour,strings,padx,pady,shadowColour,shadowBlur,shadowOffsets,maxWidth,widths,align){var i,xc,xo=padx+(shadowBlur||0)+(shadowOffsets.length&&shadowOffsets[0]<0?abs(shadowOffsets[0]):0),yo=pady+(shadowBlur||0)+(shadowOffsets.length&&shadowOffsets[1]<0?abs(shadowOffsets[1]):0);for(ctxt.font=font,ctxt.textBaseline="top",ctxt.fillStyle=colour,shadowColour&&(ctxt.shadowColor=shadowColour),shadowBlur&&(ctxt.shadowBlur=shadowBlur),shadowOffsets.length&&(ctxt.shadowOffsetX=shadowOffsets[0],ctxt.shadowOffsetY=shadowOffsets[1]),i=0;i<strings.length;++i)xc=0,widths&&("right"==align?xc=maxWidth-widths[i]:"centre"==align&&(xc=(maxWidth-widths[i])/2)),ctxt.fillText(strings[i],xo+xc,yo),yo+=parseInt(font)}function RRect(c,x,y,w,h,r,s){r?(c.beginPath(),c.moveTo(x,y+h-r),c.arcTo(x,y,x+r,y,r),c.arcTo(x+w,y,x+w,y+r,r),c.arcTo(x+w,y+h,x+w-r,y+h,r),c.arcTo(x,y+h,x,y+h-r,r),c.closePath(),c[s?"stroke":"fill"]()):c[s?"strokeRect":"fillRect"](x,y,w,h)}function TextCanvas(strings,font,w,h,maxWidth,stringWidths,align,valign,scale){this.strings=strings,this.font=font,this.width=w,this.height=h,this.maxWidth=maxWidth,this.stringWidths=stringWidths,this.align=align,this.valign=valign,this.scale=scale}function ExpandImage(i,w,h){var cv=NewCanvas(w,h);return cv?(cv.getContext("2d").drawImage(i,(w-i.width)/2,(h-i.height)/2),cv):null}function ScaleImage(i,w,h){var cv=NewCanvas(w,h);return cv?(cv.getContext("2d").drawImage(i,0,0,w,h),cv):null}function AddBackgroundToImage(i,w,h,scale,colour,othickness,ocolour,padding,ocanvas,cc){var c,x1,y1,x2,y2,cw=w+(2*padding+othickness)*scale,ch=h+(2*padding+othickness)*scale,cv=NewCanvas(cw,ch);return cv?(ocanvas*=scale,x2=cw-(othickness*=scale),y2=ch-othickness,padding=padding*scale+(x1=y1=othickness/2),c=cv.getContext("2d"),ocanvas=min(ocanvas,x2/2,y2/2),colour&&(c.fillStyle=colour,RRect(c,x1,y1,x2,y2,ocanvas)),othickness&&(c.strokeStyle=ocolour,c.lineWidth=othickness,RRect(c,x1,y1,x2,y2,ocanvas,!0)),cc?((cc=(ocanvas=NewCanvas(cw,ch)).getContext("2d")).drawImage(i,padding,padding,w,h),cc.globalCompositeOperation="source-in",cc.fillStyle=ocolour,cc.fillRect(0,0,cw,ch),cc.globalCompositeOperation="destination-over",cc.drawImage(cv,0,0),cc.globalCompositeOperation="source-over",c.drawImage(ocanvas,0,0)):c.drawImage(i,padding,padding,i.width,i.height),{image:cv,width:cw/scale,height:ch/scale}):null}function FindTextBoundingBox(s,f,ht){var c,idata,w1,h1,x,y,i,ex,w=parseInt(s.toString().length*ht),h=parseInt(2*ht*s.length),cv=NewCanvas(w,h);if(!cv)return null;for((c=cv.getContext("2d")).fillStyle="#000",c.fillRect(0,0,w,h),TextSet(c,ht+"px "+f,"#fff",s,0,0,0,0,[],"centre"),ex={min:{x:w1=(idata=c.getImageData(0,0,w,h)).width,y:h1=idata.height},max:{x:-1,y:-1}},y=0;y<h1;++y)for(x=0;x<w1;++x)i=4*(y*w1+x),0<idata.data[1+i]&&(x<ex.min.x&&(ex.min.x=x),x>ex.max.x&&(ex.max.x=x),y<ex.min.y&&(ex.min.y=y),y>ex.max.y&&(ex.max.y=y));return w1!=w&&(ex.min.x*=w/w1,ex.max.x*=w/w1),h1!=h&&(ex.min.y*=w/h1,ex.max.y*=w/h1),cv=null,ex}function FixFont(f){return"'"+f.replace(/(\'|\")/g,"").replace(/\s*,\s*/g,"', '")+"'"}function AddHandler(h,f,e){(e=e||doc).addEventListener?e.addEventListener(h,f,!1):e.attachEvent("on"+h,f)}function AddImage(i,o,t,tc){var mscale,ic,bc,iw,ih,oc=tc.imageScale;return o.complete?i.complete?(o.width=o.width,o.height=o.height,oc&&(i.width=o.width*oc,i.height=o.height*oc),t.iw=i.width,t.ih=i.height,tc.txtOpt&&(ic=i,mscale=tc.zoomMax*tc.txtScale,iw=t.iw*mscale,ih=t.ih*mscale,iw<o.naturalWidth||ih<o.naturalHeight?(ic=ScaleImage(i,iw,ih))&&(t.fimage=ic):(iw=t.iw,ih=t.ih,mscale=1),parseFloat(tc.imageRadius)&&(t.image=t.fimage=i=function(i,r,iw,ih,c){var r1=parseFloat(r),l=max(iw,ih),cv=NewCanvas(iw,ih);return cv?(0<r.indexOf("%")?r1=l*r1/100:r1*=c,(c=cv.getContext("2d")).globalCompositeOperation="source-over",c.fillStyle="#fff",l/2<=r1?(r1=min(iw,ih)/2,c.beginPath(),c.moveTo(iw/2,ih/2),c.arc(iw/2,ih/2,r1,0,2*Math.PI,!1),c.fill(),c.closePath()):(RRect(c,0,0,iw,ih,r1=min(iw/2,ih/2,r1),!0),c.fill()),c.globalCompositeOperation="source-in",c.drawImage(i,0,0,iw,ih),cv):null}(t.image,tc.imageRadius,iw,ih,mscale)),t.HasText()||(tc.shadow&&(ic=function(i,w,h,scale,sc,sb,so){var cv=abs(so[0]),c=abs(so[1]),cw=w+(sb<cv?cv+sb:2*sb)*scale,ch=h+(sb<c?c+sb:2*sb)*scale,xo=scale*((sb||0)+(so[0]<0?cv:0)),yo=scale*((sb||0)+(so[1]<0?c:0));return(cv=NewCanvas(cw,ch))?(c=cv.getContext("2d"),sc&&(c.shadowColor=sc),sb&&(c.shadowBlur=sb*scale),so&&(c.shadowOffsetX=so[0]*scale,c.shadowOffsetY=so[1]*scale),c.drawImage(i,xo,yo,w,h),{image:cv,width:cw/scale,height:ch/scale}):null}(t.image,iw,ih,mscale,tc.shadow,tc.shadowBlur,tc.shadowOffset))&&(t.fimage=ic.image,t.w=ic.width,t.h=ic.height),(tc.bgColour||tc.bgOutlineThickness)&&(bc="tag"==tc.bgColour?GetProperty(t.a,"background-color"):tc.bgColour,oc="tag"==tc.bgOutline?GetProperty(t.a,"color"):tc.bgOutline||tc.textColour,iw=t.fimage.width,ih=t.fimage.height,"colour"==tc.outlineMethod&&(ic=AddBackgroundToImage(t.fimage,iw,ih,mscale,bc,tc.bgOutlineThickness,t.outline.colour,tc.padding,tc.bgRadius,1))&&(t.oimage=ic.image),(ic=AddBackgroundToImage(t.fimage,iw,ih,mscale,bc,tc.bgOutlineThickness,oc,tc.padding,tc.bgRadius))&&(t.fimage=ic.image,t.w=ic.width,t.h=ic.height)),"size"==tc.outlineMethod&&(0<tc.outlineIncrease?(t.iw+=2*tc.outlineIncrease,t.ih+=2*tc.outlineIncrease,iw=mscale*t.iw,ih=mscale*t.ih,ic=ScaleImage(t.fimage,iw,ih),t.oimage=ic,t.fimage=ExpandImage(t.fimage,t.oimage.width,t.oimage.height)):(iw=mscale*(t.iw+2*tc.outlineIncrease),ih=mscale*(t.ih+2*tc.outlineIncrease),ic=ScaleImage(t.fimage,iw,ih),t.oimage=ExpandImage(ic,t.fimage.width,t.fimage.height))))),void t.Init()):(AddHandler("load",function(){AddImage(i,o,t,tc)},i),0):(AddHandler("load",function(){AddImage(i,o,t,tc)},o),0)}function GetProperty(e,p){var dv=doc.defaultView,pc=p.replace(/\-([a-z])/g,function(a){return a.charAt(1).toUpperCase()});return dv&&dv.getComputedStyle&&dv.getComputedStyle(e,null).getPropertyValue(p)||e.currentStyle&&e.currentStyle[pc]}function EventToCanvasId(e){return(e.target&&void 0!==e.target.id?e.target:e.srcElement.parentNode).id}function EventXY(e,p){var xy,xmul=parseInt(GetProperty(p,"width"))/p.width,ymul=parseInt(GetProperty(p,"height"))/p.height;return void 0!==e.offsetX?xy={x:e.offsetX,y:e.offsetY}:(p=AbsPos(p.id),void 0!==e.changedTouches&&(e=e.changedTouches[0]),e.pageX&&(xy={x:e.pageX-p.x,y:e.pageY-p.y})),xy&&xmul&&ymul&&(xy.x/=xmul,xy.y/=ymul),xy}function MouseOut(tc){tc=tc.target||tc.fromElement.parentNode,tc=TagCanvas.tc[tc.id];tc&&(tc.mx=tc.my=-1,tc.UnFreeze(),tc.EndDrag())}function MouseMove(e){var i,tc,t=TagCanvas,p=EventToCanvasId(e);for(i in t.tc)(tc=t.tc[i]).tttimer&&(clearTimeout(tc.tttimer),tc.tttimer=null);p&&t.tc[p]&&((p=EventXY(e,(tc=t.tc[p]).canvas))&&(tc.mx=p.x,tc.my=p.y,tc.Drag(e,p)),tc.drawn=0)}function MouseDown(e){var cb=doc.addEventListener?0:1,tg=EventToCanvasId(e);tg&&e.button==cb&&TagCanvas.tc[tg]&&TagCanvas.tc[tg].BeginDrag(e)}function MouseUp(e){var cb=doc.addEventListener?0:1,tc=EventToCanvasId(e);tc&&e.button==cb&&TagCanvas.tc[tc]&&(tc=TagCanvas.tc[tc],MouseMove(e),tc.EndDrag()||tc.touchState||tc.Clicked(e))}function TouchDown(e){var p=EventToCanvasId(e),tc=p&&TagCanvas.tc[p];tc&&e.changedTouches&&(1==e.touches.length&&0==tc.touchState?(tc.touchState=1,tc.BeginDrag(e),(p=EventXY(e,tc.canvas))&&(tc.mx=p.x,tc.my=p.y,tc.drawn=0)):2==e.targetTouches.length&&tc.pinchZoom?(tc.touchState=3,tc.EndDrag(),tc.BeginPinch(e)):(tc.EndDrag(),tc.EndPinch(),tc.touchState=0))}function TouchUp(e){var tg=EventToCanvasId(e),tc=tg&&TagCanvas.tc[tg];if(tc&&e.changedTouches){switch(tc.touchState){case 1:tc.Draw(),tc.Clicked();break;case 2:tc.EndDrag();break;case 3:tc.EndPinch()}tc.touchState=0}}function TouchMove(e){var i,tc,p,t=TagCanvas,tg=EventToCanvasId(e);for(i in t.tc)(tc=t.tc[i]).tttimer&&(clearTimeout(tc.tttimer),tc.tttimer=null);if((tc=tg&&t.tc[tg])&&e.changedTouches&&tc.touchState){switch(tc.touchState){case 1:case 2:(p=EventXY(e,tc.canvas))&&(tc.mx=p.x,tc.my=p.y,tc.Drag(e,p)&&(tc.touchState=2));break;case 3:tc.Pinch(e)}tc.drawn=0}}function MouseWheel(e){var t=TagCanvas,tg=EventToCanvasId(e);tg&&t.tc[tg]&&(e.cancelBubble=!0,e.returnValue=!1,e.preventDefault&&e.preventDefault(),t.tc[tg].Wheel(0<(e.wheelDelta||e.detail)))}function Scroll(e){var i,t=TagCanvas;for(i in clearTimeout(t.scrollTimer),t.tc)t.tc[i].Pause();t.scrollTimer=setTimeout(function(){var i,t=TagCanvas;for(i in t.tc)t.tc[i].Resume()},t.scrollPause)}function DrawCanvas(){DrawCanvasRAF(TimeNow())}function DrawCanvasRAF(t){var i,tc=TagCanvas.tc;for(i in TagCanvas.NextFrame(TagCanvas.interval),t=t||TimeNow(),tc)tc[i].Draw(t)}function AbsPos(ys){var r=doc.getElementById(ys).getBoundingClientRect(),dd=doc.documentElement,yo=doc.body,xo=window,xs=xo.pageXOffset||dd.scrollLeft,ys=xo.pageYOffset||dd.scrollTop,xo=dd.clientLeft||yo.clientLeft,yo=dd.clientTop||yo.clientTop;return{x:r.left+xs-xo,y:r.top+ys-yo}}function TextSplitter(e){this.e=e,this.br=0,this.line=[],this.text=[],this.original=e.innerText||e.textContent}function Outline(tc,t){this.ts=null,this.tc=tc,this.tag=t,this.x=this.y=this.w=this.h=this.sc=1,this.z=0,this.pulse=1,this.pulsate=tc.pulsateTo<1,this.colour=tc.outlineColour,this.adash=~~tc.outlineDash,this.agap=~~tc.outlineDashSpace||this.adash,this.aspeed=+tc.outlineDashSpeed,"tag"==this.colour?this.colour=GetProperty(t.a,"color"):"tagbg"==this.colour&&(this.colour=GetProperty(t.a,"background-color")),this.Draw=this.pulsate?this.DrawPulsate:this.DrawSimple,this.radius=0|tc.outlineRadius,this.SetMethod(tc.outlineMethod)}function Tag(tc,text,a,v,w,h,col,bcol,bradius,boutline,bothickness,font,padding,original){this.tc=tc,this.image=null,this.text=text,this.text_original=original,this.line_widths=[],this.title=a.title||null,this.a=a,this.position=new Vector(v[0],v[1],v[2]),this.x=this.y=this.z=0,this.w=w,this.h=h,this.colour=col||tc.textColour,this.bgColour=bcol||tc.bgColour,this.bgRadius=0|bradius,this.bgOutline=boutline||this.colour,this.bgOutlineThickness=0|bothickness,this.textFont=font||tc.textFont,this.padding=0|padding,this.sc=this.alpha=1,this.weighted=!tc.weight,this.outline=new Outline(tc,this)}function TagCanvas(cid,raf,opt){var i,p,t,c=doc.getElementById(cid),cp=["id","class","innerHTML"];if(!c)throw 0;if(void 0!==window.G_vmlCanvasManager&&(c=window.G_vmlCanvasManager.initElement(c),this.ie=parseFloat(navigator.appVersion.split("MSIE")[1])),c&&(!c.getContext||!c.getContext("2d").fillText)){for(p=doc.createElement("DIV"),i=0;i<cp.length;++i)p[cp[i]]=c[cp[i]];throw c.parentNode.insertBefore(p,c),c.parentNode.removeChild(c),0}for(i in TagCanvas.options)this[i]=(opt&&void 0!==opt[i]?opt:void 0!==TagCanvas[i]?TagCanvas:TagCanvas.options)[i];if(this.canvas=c,this.ctxt=c.getContext("2d"),this.z1=250/max(this.depth,.001),this.z2=this.z1/this.zoom,this.radius=.0075*min(c.height,c.width),this.max_radius=100,this.max_weight=[],this.min_weight=[],this.textFont=this.textFont&&FixFont(this.textFont),this.textHeight*=1,this.imageRadius=this.imageRadius.toString(),this.pulsateTo=Clamp(this.pulsateTo,0,1),this.minBrightness=Clamp(this.minBrightness,0,1),this.maxBrightness=Clamp(this.maxBrightness,this.minBrightness,1),this.ctxt.textBaseline="top",this.lx=(this.lock+"").indexOf("x")+1,this.ly=(this.lock+"").indexOf("y")+1,this.frozen=this.dx=this.dy=this.fixedAnim=this.touchState=0,this.fixedAlpha=1,this.source=raf||cid,this.repeatTags=min(64,~~this.repeatTags),this.minTags=min(200,~~this.minTags),0<~~this.scrollPause?TagCanvas.scrollPause=~~this.scrollPause:this.scrollPause=0,0<this.minTags&&this.repeatTags<1&&(i=this.GetTags().length)&&(this.repeatTags=ceil(this.minTags/i)-1),this.transform=Matrix.Identity(),this.startTime=this.time=TimeNow(),this.mx=this.my=-1,this.centreImage&&function(t){var i=new Image;i.onload=function(){var dx=i.width/2,dy=i.height/2;t.centreFunc=function(c,w,h,cx,cy){c.setTransform(1,0,0,1,0,0),c.globalAlpha=1,c.drawImage(i,cx-dx,cy-dy)}},i.src=t.centreImage}(this),this.Animate=this.dragControl?this.AnimateDrag:this.AnimatePosition,this.animTiming="function"==typeof TagCanvas[this.animTiming]?TagCanvas[this.animTiming]:TagCanvas.Smooth,this.shadowBlur||this.shadowOffset[0]||this.shadowOffset[1]?(this.ctxt.shadowColor=this.shadow,this.shadow=this.ctxt.shadowColor,this.shadowAlpha=function(){var c,cv=NewCanvas(3,3);return!!cv&&((c=cv.getContext("2d")).strokeStyle="#000",c.shadowColor="#fff",c.shadowBlur=3,c.globalAlpha=0,c.strokeRect(2,2,2,2),c.globalAlpha=1,cv=null,0<c.getImageData(2,2,1,1).data[0])}()):delete this.shadow,this.Load(),raf&&this.hideTags&&(t=this,TagCanvas.loaded?t.HideTags():AddHandler("load",function(){t.HideTags()},window)),this.yaw=this.initial?this.initial[0]*this.maxSpeed:0,this.pitch=this.initial?this.initial[1]*this.maxSpeed:0,this.tooltip?(this.ctitle=c.title,c.title="","native"==this.tooltip?this.Tooltip=this.TooltipNative:(this.Tooltip=this.TooltipDiv,this.ttdiv||(this.ttdiv=doc.createElement("div"),this.ttdiv.className=this.tooltipClass,this.ttdiv.style.position="absolute",this.ttdiv.style.zIndex=c.style.zIndex+1,AddHandler("mouseover",function(e){e.target.style.display="none"},this.ttdiv),doc.body.appendChild(this.ttdiv)))):this.Tooltip=this.TooltipNone,!this.noMouse&&!handlers[cid])for(handlers[cid]=[["mousemove",MouseMove],["mouseout",MouseOut],["mouseup",MouseUp],["touchstart",TouchDown],["touchend",TouchUp],["touchcancel",TouchUp],["touchmove",TouchMove]],this.dragControl&&(handlers[cid].push(["mousedown",MouseDown]),handlers[cid].push(["selectstart",Nop])),this.wheelZoom&&(handlers[cid].push(["mousewheel",MouseWheel]),handlers[cid].push(["DOMMouseScroll",MouseWheel])),this.scrollPause&&handlers[cid].push(["scroll",Scroll,window]),i=0;i<handlers[cid].length;++i)AddHandler((p=handlers[cid][i])[0],p[1],p[2]||c);TagCanvas.started||(raf=window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,TagCanvas.NextFrame=raf?TagCanvas.NextFrameRAF:TagCanvas.NextFrameTimeout,TagCanvas.interval=this.interval,TagCanvas.NextFrame(this.interval),TagCanvas.started=1)}function PinchDistance(t2){var t1=t2.targetTouches[0],t2=t2.targetTouches[1];return sqrt(pow(t2.pageX-t1.pageX,2)+pow(t2.pageY-t1.pageY,2))}function tccall(f,id){TagCanvas.tc[id]&&TagCanvas.tc[id][f]()}for(i in(TCproto=Vector.prototype).length=function(){return sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},TCproto.dot=function(v){return this.x*v.x+this.y*v.y+this.z*v.z},TCproto.cross=function(v){return new Vector(this.y*v.z-this.z*v.y,this.z*v.x-this.x*v.z,this.x*v.y-this.y*v.x)},TCproto.angle=function(ac){var dot=this.dot(ac);return 0==dot?Math.PI/2:1<=(ac=dot/(this.length()*ac.length()))?0:ac<=-1?Math.PI:Math.acos(ac)},TCproto.unit=function(){var l=this.length();return new Vector(this.x/l,this.y/l,this.z/l)},TCproto=Matrix.prototype,Matrix.Identity=function(){return new Matrix([1,0,0,0,1,0,0,0,1])},Matrix.Rotation=function(mcos,u){var sina=sin(mcos),cosa=cos(mcos),mcos=1-cosa;return new Matrix([cosa+pow(u.x,2)*mcos,u.x*u.y*mcos-u.z*sina,u.x*u.z*mcos+u.y*sina,u.y*u.x*mcos+u.z*sina,cosa+pow(u.y,2)*mcos,u.y*u.z*mcos-u.x*sina,u.z*u.x*mcos-u.y*sina,u.z*u.y*mcos+u.x*sina,cosa+pow(u.z,2)*mcos])},TCproto.mul=function(m){for(var j,a=[],mmatrix=m.xform?1:0,i=1;i<=3;++i)for(j=1;j<=3;++j)mmatrix?a.push(this[i][1]*m[1][j]+this[i][2]*m[2][j]+this[i][3]*m[3][j]):a.push(this[i][j]*m);return new Matrix(a)},TCproto.xform=function(z){var a={},x=z.x,y=z.y,z=z.z;return a.x=x*this[1][1]+y*this[2][1]+z*this[3][1],a.y=x*this[1][2]+y*this[2][2]+z*this[3][2],a.z=x*this[1][3]+y*this[2][3]+z*this[3][3],a},(TCproto=TextCanvas.prototype).SetImage=function(image,w,h,position,padding,align,valign,scale){this.image=image,this.iwidth=w*this.scale,this.iheight=h*this.scale,this.ipos=position,this.ipad=padding*this.scale,this.iscale=scale,this.ialign=align,this.ivalign=valign},TCproto.Align=function(size,space,a){var pos=0;return"right"==a||"bottom"==a?pos=space-size:"left"!=a&&"top"!=a&&(pos=(space-size)/2),pos},TCproto.Create=function(colour,bgColour,bgOutline,bgOutlineThickness,shadowColour,shadowBlur,shadowOffsets,rr,c){var cv,cw,ch,x1,x2,y1,y2,offx,offy,ix,iy,iw,ih,shadowcv,shadowc,sox=abs(shadowOffsets[0]),soy=abs(shadowOffsets[1]);return y1=x1=2*((rr=max(rr,sox+shadowBlur,soy+shadowBlur))+bgOutlineThickness),cw=this.width+x1,ch=this.height+y1,offx=offy=rr+bgOutlineThickness,this.image&&(ix=iy=rr+bgOutlineThickness,iw=this.iwidth,ih=this.iheight,"top"==this.ipos||"bottom"==this.ipos?(iw<this.width?ix+=this.Align(iw,this.width,this.ialign):offx+=this.Align(this.width,iw,this.align),"top"==this.ipos?offy+=ih+this.ipad:iy+=this.height+this.ipad,cw=max(cw,iw+x1),ch+=ih+this.ipad):(ih<this.height?iy+=this.Align(ih,this.height,this.ivalign):offy+=this.Align(this.height,ih,this.valign),"right"==this.ipos?ix+=this.width+this.ipad:offx+=iw+this.ipad,cw+=iw+this.ipad,ch=max(ch,ih+y1))),(cv=NewCanvas(cw,ch))?(x1=y1=bgOutlineThickness/2,rr=min(c,(x2=cw-bgOutlineThickness)/2,(y2=ch-bgOutlineThickness)/2),c=cv.getContext("2d"),bgColour&&(c.fillStyle=bgColour,RRect(c,x1,y1,x2,y2,rr)),bgOutlineThickness&&(c.strokeStyle=bgOutline,c.lineWidth=bgOutlineThickness,RRect(c,x1,y1,x2,y2,rr,!0)),(shadowBlur||sox||soy)&&(shadowcv=NewCanvas(cw,ch))&&(shadowc=c,c=shadowcv.getContext("2d")),TextSet(c,this.font,colour,this.strings,offx,offy,0,0,[],this.maxWidth,this.stringWidths,this.align),this.image&&c.drawImage(this.image,ix,iy,iw,ih),shadowc&&(c=shadowc,shadowColour&&(c.shadowColor=shadowColour),shadowBlur&&(c.shadowBlur=shadowBlur),c.shadowOffsetX=shadowOffsets[0],c.shadowOffsetY=shadowOffsets[1],c.drawImage(shadowcv,0,0)),cv):null},(TCproto=TextSplitter.prototype).Empty=function(){for(var i=0;i<this.text.length;++i)if(this.text[i].length)return!1;return!0},TCproto.Lines=function(e){for(var cn,r=e?1:0,cl=(cn=(e=e||this.e).childNodes).length,i=0;i<cl;++i)"BR"==cn[i].nodeName?(this.text.push(this.line.join(" ")),this.br=1):3==cn[i].nodeType?this.br?(this.line=[cn[i].nodeValue],this.br=0):this.line.push(cn[i].nodeValue):this.Lines(cn[i]);return r||this.br||this.text.push(this.line.join(" ")),this.text},TCproto.SplitWidth=function(w,c,f,h){var i,j,words,text=[];for(c.font=h+"px "+f,i=0;i<this.text.length;++i){for(words=this.text[i].split(/\s+/),this.line=[words[0]],j=1;j<words.length;++j)c.measureText(this.line.join(" ")+" "+words[j]).width>w?(text.push(this.line.join(" ")),this.line=[words[j]]):this.line.push(words[j]);text.push(this.line.join(" "))}return this.text=text},(TCproto=Outline.prototype).SetMethod=function(om){var funcs={block:["PreDraw","DrawBlock"],colour:["PreDraw","DrawColour"],outline:["PostDraw","DrawOutline"],classic:["LastDraw","DrawOutline"],size:["PreDraw","DrawSize"],none:["LastDraw"]},funcs=funcs[om]||funcs.outline;"none"==om?this.Draw=function(){return 1}:this.drawFunc=this[funcs[1]],this[funcs[0]]=this.Draw},TCproto.Update=function(x,y,w,h,sc,z,xo,yo){var o=this.tc.outlineOffset,o2=2*o;this.x=sc*x+xo-o,this.y=sc*y+yo-o,this.w=sc*w+o2,this.h=sc*h+o2,this.sc=sc,this.z=z},TCproto.Ants=function(c){var l,s,length,l1,l2,g1,g2,seq,ants;this.adash&&(length=(l=this.adash)+(ants=this.agap),l2=l,g1=ants,seq=g2=l1=0,(s=this.aspeed)&&(seq=abs(s)*(TimeNow()-this.ts)/50,s<0&&(seq=864e4-seq),s=~~seq%length),ants=s?(s<=l?(l1=l-s,l2=s):g2=ants-(g1=length-s),[l1,g1,l2,g2]):[l,ants],c.setLineDash(ants))},TCproto.DrawOutline=function(c,x,y,w,h,colour){var r=min(this.radius,h/2,w/2);c.strokeStyle=colour,this.Ants(c),RRect(c,x,y,w,h,r,!0)},TCproto.DrawSize=function(c,x,y,w,h,colour,tag,x1,y1){var i,m,tw=tag.w,th=tag.h;return this.pulsate?(m=tag.image?(tag.image.height+this.tc.outlineIncrease)/tag.image.height:tag.oscale,i=tag.fimage||tag.image,m=1+(m-1)*(1-this.pulse),tag.h*=m,tag.w*=m):i=tag.oimage,tag.alpha=1,tag.Draw(c,x1,y1,i),tag.h=th,tag.w=tw,1},TCproto.DrawColour=function(c,x,y,w,h,colour,tag,x1,y1){return tag.oimage?(this.pulse<1?(tag.alpha=1-pow(this.pulse,2),tag.Draw(c,x1,y1,tag.fimage),tag.alpha=this.pulse):tag.alpha=1,tag.Draw(c,x1,y1,tag.oimage),1):this[tag.image?"DrawColourImage":"DrawColourText"](c,x,y,w,h,colour,tag,x1,y1)},TCproto.DrawColourText=function(c,x,y,w,h,colour,tag,x1,y1){var normal=tag.colour;return tag.colour=colour,tag.alpha=1,tag.Draw(c,x1,y1),tag.colour=normal,1},TCproto.DrawColourImage=function(c,fx,fy,fw,fh,colour,tag,x1,y1){var ccanvas=c.canvas,fx=~~max(fx,0),fy=~~max(fy,0),fw=min(ccanvas.width-fx,fw)+.5|0,fh=min(ccanvas.height-fy,fh)+.5|0;return ocanvas?(ocanvas.width=fw,ocanvas.height=fh):ocanvas=NewCanvas(fw,fh),ocanvas?(ocanvas.getContext("2d").drawImage(ccanvas,fx,fy,fw,fh,0,0,fw,fh),c.clearRect(fx,fy,fw,fh),this.pulsate?tag.alpha=1-pow(this.pulse,2):tag.alpha=1,tag.Draw(c,x1,y1),c.setTransform(1,0,0,1,0,0),c.save(),c.beginPath(),c.rect(fx,fy,fw,fh),c.clip(),c.globalCompositeOperation="source-in",c.fillStyle=colour,c.fillRect(fx,fy,fw,fh),c.restore(),c.globalAlpha=1,c.globalCompositeOperation="destination-over",c.drawImage(ocanvas,0,0,fw,fh,fx,fy,fw,fh),c.globalCompositeOperation="source-over",1):this.SetMethod("outline")},TCproto.DrawBlock=function(c,x,y,w,h,colour){var r=min(this.radius,h/2,w/2);c.fillStyle=colour,RRect(c,x,y,w,h,r)},TCproto.DrawSimple=function(c,tag,x1,y1,ga,useGa){var t=this.tc;return c.setTransform(1,0,0,1,0,0),c.strokeStyle=this.colour,c.lineWidth=t.outlineThickness,c.shadowBlur=c.shadowOffsetX=c.shadowOffsetY=0,c.globalAlpha=useGa?ga:1,this.drawFunc(c,this.x,this.y,this.w,this.h,this.colour,tag,x1,y1)},TCproto.DrawPulsate=function(c,tag,x1,y1){var diff=TimeNow()-this.ts,ga=this.tc,ga=ga.pulsateTo+(1-ga.pulsateTo)*(.5+cos(2*Math.PI*diff/(1e3*ga.pulsateTime))/2);return this.pulse=ga=TagCanvas.Smooth(1,ga),this.DrawSimple(c,tag,x1,y1,ga,1)},TCproto.Active=function(c,x,a){a=x>=this.x&&a>=this.y&&x<=this.x+this.w&&a<=this.y+this.h;return this.ts=a?this.ts||TimeNow():null,a},TCproto.PreDraw=TCproto.PostDraw=TCproto.LastDraw=Nop,(TCproto=Tag.prototype).Init=function(e){var tc=this.tc;this.textHeight=tc.textHeight,this.HasText()?this.Measure(tc.ctxt,tc):(this.w=this.iw,this.h=this.ih),this.SetShadowColour=tc.shadowAlpha?this.SetShadowColourAlpha:this.SetShadowColourFixed,this.SetDraw(tc)},TCproto.Draw=Nop,TCproto.HasText=function(){return this.text&&0<this.text[0].length},TCproto.EqualTo=function(e){var i=e.getElementsByTagName("img");return this.a.href!=e.href?0:i.length?this.image.src==i[0].src:(e.innerText||e.textContent)==this.text_original},TCproto.SetImage=function(i){this.image=this.fimage=i},TCproto.SetDraw=function(t){this.Draw=this.fimage?7<t.ie?this.DrawImageIE:this.DrawImage:this.DrawText,t.noSelect&&(this.CheckActive=Nop)},TCproto.MeasureText=function(c){for(var wl,l=this.text.length,w=0,i=0;i<l;++i)this.line_widths[i]=wl=c.measureText(this.text[i]).width,w=max(w,wl);return w},TCproto.Measure=function(c,t){var s,th,f,soff,cw,twidth,img,tcv,extents=FindTextBoundingBox(this.text,this.textFont,this.textHeight),theight=extents?extents.max.y+extents.min.y:this.textHeight;c.font=this.font=this.textHeight+"px "+this.textFont,twidth=this.MeasureText(c),t.txtOpt&&(f=(s=t.txtScale)*this.textHeight+"px "+this.textFont,soff=[s*t.shadowOffset[0],s*t.shadowOffset[1]],c.font=f,cw=this.MeasureText(c),tcv=new TextCanvas(this.text,f,cw+s,s*theight+s,cw,this.line_widths,t.textAlign,t.textVAlign,s),this.image&&tcv.SetImage(this.image,this.iw,this.ih,t.imagePosition,t.imagePadding,t.imageAlign,t.imageVAlign,t.imageScale),img=tcv.Create(this.colour,this.bgColour,this.bgOutline,s*this.bgOutlineThickness,t.shadow,s*t.shadowBlur,soff,s*this.padding,s*this.bgRadius),"colour"==t.outlineMethod?this.oimage=tcv.Create(this.outline.colour,this.bgColour,this.outline.colour,s*this.bgOutlineThickness,t.shadow,s*t.shadowBlur,soff,s*this.padding,s*this.bgRadius):"size"==t.outlineMethod&&(th=(extents=FindTextBoundingBox(this.text,this.textFont,this.textHeight+t.outlineIncrease)).max.y+extents.min.y,f=s*(this.textHeight+t.outlineIncrease)+"px "+this.textFont,c.font=f,cw=this.MeasureText(c),tcv=new TextCanvas(this.text,f,cw+s,s*th+s,cw,this.line_widths,t.textAlign,t.textVAlign,s),this.image&&tcv.SetImage(this.image,this.iw+t.outlineIncrease,this.ih+t.outlineIncrease,t.imagePosition,t.imagePadding,t.imageAlign,t.imageVAlign,t.imageScale),this.oimage=tcv.Create(this.colour,this.bgColour,this.bgOutline,s*this.bgOutlineThickness,t.shadow,s*t.shadowBlur,soff,s*this.padding,s*this.bgRadius),this.oscale=this.oimage.width/img.width,0<t.outlineIncrease?img=ExpandImage(img,this.oimage.width,this.oimage.height):this.oimage=ExpandImage(this.oimage,img.width,img.height)),img&&(this.fimage=img,twidth=this.fimage.width/s,theight=this.fimage.height/s),this.SetDraw(t),t.txtOpt=!!this.fimage),this.h=theight,this.w=twidth},TCproto.SetFont=function(f,c,bc,boc){this.textFont=f,this.colour=c,this.bgColour=bc,this.bgOutline=boc,this.Measure(this.tc.ctxt,this.tc)},TCproto.SetWeight=function(w){var m,s,tc=this.tc,modes=tc.weightMode.split(/[, ]/),wl=w.length;if(this.HasText()){for(this.weighted=!0,s=0;s<wl;++s)"both"==(m=modes[s]||"size")?(this.Weight(w[s],tc.ctxt,tc,"size",tc.min_weight[s],tc.max_weight[s],s),this.Weight(w[s],tc.ctxt,tc,"colour",tc.min_weight[s],tc.max_weight[s],s)):this.Weight(w[s],tc.ctxt,tc,m,tc.min_weight[s],tc.max_weight[s],s);this.Measure(tc.ctxt,tc)}},TCproto.Weight=function(w,c,t,m,nweight,wmax,wnum){nweight=((w=isNaN(w)?1:w)-nweight)/(wmax-nweight);"colour"==m?this.colour=FindGradientColour(t,nweight,wnum):"bgcolour"==m?this.bgColour=FindGradientColour(t,nweight,wnum):"bgoutline"==m?this.bgOutline=FindGradientColour(t,nweight,wnum):"outline"==m?this.outline.colour=FindGradientColour(t,nweight,wnum):"size"==m&&(0<t.weightSizeMin&&t.weightSizeMax>t.weightSizeMin?this.textHeight=t.weightSize*(t.weightSizeMin+(t.weightSizeMax-t.weightSizeMin)*nweight):this.textHeight=max(1,w*t.weightSize))},TCproto.SetShadowColourFixed=function(c,s,a){c.shadowColor=s},TCproto.SetShadowColourAlpha=function(c,s,a){c.shadowColor=function(c,a){var p1,d=c,p2=(+a).toPrecision(3)+")";return"#"===c[0]?(hexlookup3[c]||(4===c.length?hexlookup3[c]="rgba("+hexlookup1[c[1]]+hexlookup1[c[2]]+hexlookup1[c[3]]:hexlookup3[c]="rgba("+hexlookup2[c.substr(1,2)]+hexlookup2[c.substr(3,2)]+hexlookup2[c.substr(5,2)]),d=hexlookup3[c]+p2):"rgb("===c.substr(0,4)||"hsl("===c.substr(0,4)?d=c.replace("(","a(").replace(")",","+p2):"rgba("!==c.substr(0,5)&&"hsla("!==c.substr(0,5)||(p1=c.lastIndexOf(",")+1,p2=c.indexOf(")"),a*=parseFloat(c.substring(p1,p2)),d=c.substr(0,p1)+a.toPrecision(3)+")"),d}(s,a)},TCproto.DrawText=function(c,xoff,yoff){var i,xl,t=this.tc,x=this.x,y=this.y,s=this.sc;for(c.globalAlpha=this.alpha,c.fillStyle=this.colour,t.shadow&&this.SetShadowColour(c,t.shadow,this.alpha),c.font=this.font,x+=xoff/s,y+=yoff/s-this.h/2,i=0;i<this.text.length;++i)xl=x,"right"==t.textAlign?xl+=this.w/2-this.line_widths[i]:"centre"==t.textAlign?xl-=this.line_widths[i]/2:xl-=this.w/2,c.setTransform(s,0,0,s,s*xl,s*y),c.fillText(this.text[i],0,0),y+=this.textHeight},TCproto.DrawImage=function(c,xoff,yoff,shadow){var x=this.x,y=this.y,s=this.sc,i=shadow||this.fimage,w=this.w,h=this.h,a=this.alpha,shadow=this.shadow;c.globalAlpha=a,shadow&&this.SetShadowColour(c,shadow,a),x+=xoff/s-w/2,y+=yoff/s-h/2,c.setTransform(s,0,0,s,s*x,s*y),c.drawImage(i,0,0,w,h)},TCproto.DrawImageIE=function(c,xoff,yoff){var i=this.fimage,s=this.sc,x=i.width=this.w*s,y=i.height=this.h*s,x=this.x*s+xoff-x/2,y=this.y*s+yoff-y/2;c.setTransform(1,0,0,1,0,0),c.globalAlpha=this.alpha,c.drawImage(i,x,y)},TCproto.Calc=function(pp,a){var t=this.tc,mnb=t.minBrightness,mxb=t.maxBrightness,r=t.max_radius,pp=pp.xform(this.position);return pp=function(tc,p1,sx,sy){var m=tc.radius*tc.z1/(tc.z1+tc.z2+p1.z);return{x:p1.x*m*sx,y:p1.y*m*sy,z:p1.z,w:(tc.z1-p1.z)/tc.z2}}(t,this.xformed=pp,t.stretchX,t.stretchY),this.x=pp.x,this.y=pp.y,this.z=pp.z,this.sc=pp.w,this.alpha=a*Clamp(mnb+(mxb-mnb)*(r-this.z)/(2*r),0,1),this.xformed},TCproto.UpdateActive=function(c,xoff,yoff){var o=this.outline,w=this.w,h=this.h,x=this.x-w/2,y=this.y-h/2;return o.Update(x,y,w,h,this.sc,this.z,xoff,yoff),o},TCproto.CheckActive=function(c,xoff,o){var t=this.tc,o=this.UpdateActive(c,xoff,o);return o.Active(c,t.mx,t.my)?o:null},TCproto.Clicked=function(e){var evt,a=this.a,t=a.target,h=a.href;if(""==t||"_self"==t){if(doc.createEvent){if((evt=doc.createEvent("MouseEvents")).initMouseEvent("click",1,1,window,0,0,0,0,0,0,0,0,0,0,null),!a.dispatchEvent(evt))return}else if(a.fireEvent&&!a.fireEvent("onclick"))return;doc.location=h}else if(self.frames[t])self.frames[t].document.location=h;else{try{if(top.frames[t])return void(top.frames[t].document.location=h)}catch(err){}window.open(h,t)}},(TCproto=TagCanvas.prototype).SourceElements=function(){return doc.querySelectorAll?doc.querySelectorAll("#"+this.source):[doc.getElementById(this.source)]},TCproto.HideTags=function(){for(var el=this.SourceElements(),i=0;i<el.length;++i)el[i].style.display="none"},TCproto.GetTags=function(){for(var etl,i,j,el=this.SourceElements(),tl=[],k=0;k<=this.repeatTags;++k)for(i=0;i<el.length;++i)for(etl=el[i].getElementsByTagName("a"),j=0;j<etl.length;++j)tl.push(etl[j]);return tl},TCproto.Message=function(text){for(var a,x,t,tl=[],tc=text.split(""),i=0;i<tc.length;++i)" "!=tc[i]&&(t=i-tc.length/2,(a=doc.createElement("A")).href="#",a.innerText=tc[i],x=100*sin(t/9),t=-100*cos(t/9),(t=new Tag(this,tc[i],a,[x,0,t],2,18,"#000","#fff",0,0,0,"monospace",2,tc[i])).Init(),tl.push(t));return tl},TCproto.CreateTag=function(e){var im,i,t,txt,ts,font,bc,boc,p=[0,0,0];return"text"!=this.imageMode&&((im=e.getElementsByTagName("img")).length&&((i=new Image).src=im[0].src,!this.imageMode))?((t=new Tag(this,"",e,p,0,0)).SetImage(i),AddImage(i,im[0],t,this),t):("image"!=this.imageMode&&(txt=(ts=new TextSplitter(e)).Lines(),ts.Empty()?ts=null:(font=this.textFont||FixFont(GetProperty(e,"font-family")),this.splitWidth&&(txt=ts.SplitWidth(this.splitWidth,this.ctxt,font,this.textHeight)),bc="tag"==this.bgColour?GetProperty(e,"background-color"):this.bgColour,boc="tag"==this.bgOutline?GetProperty(e,"color"):this.bgOutline)),ts||i?(t=new Tag(this,txt,e,p,2,this.textHeight+2,this.textColour||GetProperty(e,"color"),bc,this.bgRadius,boc,this.bgOutlineThickness,font,this.padding,ts&&ts.original),i?(t.SetImage(i),AddImage(i,im[0],t,this)):t.Init(),t):void 0)},TCproto.UpdateTag=function(t,a){var colour=this.textColour||GetProperty(a,"color"),font=this.textFont||FixFont(GetProperty(a,"font-family")),bc="tag"==this.bgColour?GetProperty(a,"background-color"):this.bgColour,boc="tag"==this.bgOutline?GetProperty(a,"color"):this.bgOutline;t.a=a,t.title=a.title,t.colour==colour&&t.textFont==font&&t.bgColour==bc&&t.bgOutline==boc||t.SetFont(font,colour,bc,boc)},TCproto.Weight=function(tl){for(var w,s,valid,ll=tl.length,weights=[],wfrom=this.weightFrom?this.weightFrom.split(/[, ]/):[null],wl=wfrom.length,i=0;i<ll;++i)for(weights[i]=[],s=0;s<wl;++s)w=function(p,wFrom,tHeight){var w=1;return wFrom?w=+(p.getAttribute(wFrom)||tHeight):(p=GetProperty(p,"font-size"))&&(w=-1<p.indexOf("px")&&+p.replace("px","")||-1<p.indexOf("pt")&&1.25*p.replace("pt","")||3.3*p),w}(tl[i].a,wfrom[s],this.textHeight),(!this.max_weight[s]||w>this.max_weight[s])&&(this.max_weight[s]=w),(!this.min_weight[s]||w<this.min_weight[s])&&(this.min_weight[s]=w),weights[i][s]=w;for(s=0;s<wl;++s)this.max_weight[s]>this.min_weight[s]&&(valid=1);if(valid)for(i=0;i<ll;++i)tl[i].SetWeight(weights[i])},TCproto.Load=function(){var shape,t,shapeArgs,rx,ry,rz,vl,i,tl=this.GetTags(),taglist=[],tagmap=[],pfuncs={sphere:PointsOnSphere,vcylinder:PointsOnCylinderV,hcylinder:PointsOnCylinderH,vring:PointsOnRingV,hring:PointsOnRingH};if(tl.length){for(tagmap.length=tl.length,i=0;i<tl.length;++i)tagmap[i]=i;for(this.shuffleTags&&Shuffle(tagmap),rx=100*this.radiusX,ry=100*this.radiusY,rz=100*this.radiusZ,this.max_radius=max(rx,max(ry,rz)),i=0;i<tl.length;++i)(t=this.CreateTag(tl[tagmap[i]]))&&taglist.push(t);for(this.weight&&this.Weight(taglist,!0),this.shapeArgs?this.shapeArgs[0]=taglist.length:(shape=(shapeArgs=this.shape.toString().split(/[(),]/)).shift(),"function"==typeof window[shape]?this.shape=window[shape]:this.shape=pfuncs[shape]||pfuncs.sphere,this.shapeArgs=[taglist.length,rx,ry,rz].concat(shapeArgs)),vl=this.shape.apply(this,this.shapeArgs),this.listLength=taglist.length,i=0;i<taglist.length;++i)taglist[i].position=new Vector(vl[i][0],vl[i][1],vl[i][2])}this.noTagsMessage&&!taglist.length&&(i=this.imageMode&&"both"!=this.imageMode?this.imageMode+" ":"",taglist=this.Message("No "+i+"tags")),this.taglist=taglist},TCproto.Update=function(){var found,vl,ol,nl,i,j,tl=this.GetTags(),newlist=[],taglist=this.taglist,added=[],removed=[];if(!this.shapeArgs)return this.Load();if(tl.length){for(nl=this.listLength=tl.length,ol=taglist.length,i=0;i<ol;++i)newlist.push(taglist[i]),removed.push(i);for(i=0;i<nl;++i){for(found=j=0;j<ol;++j)taglist[j].EqualTo(tl[i])&&(this.UpdateTag(newlist[j],tl[i]),found=removed[j]=-1);found||added.push(i)}for(j=i=0;i<ol;++i)-1==removed[j]?removed.splice(j,1):++j;if(removed.length){for(Shuffle(removed);removed.length&&added.length;)i=removed.shift(),j=added.shift(),newlist[i]=this.CreateTag(tl[j]);for(removed.sort(function(a,b){return a-b});removed.length;)newlist.splice(removed.pop(),1)}for(j=newlist.length/(added.length+1),i=0;added.length;)newlist.splice(ceil(++i*j),0,this.CreateTag(tl[added.shift()]));for(this.shapeArgs[0]=nl=newlist.length,vl=this.shape.apply(this,this.shapeArgs),i=0;i<nl;++i)newlist[i].position=new Vector(vl[i][0],vl[i][1],vl[i][2]);this.weight&&this.Weight(newlist)}this.taglist=newlist},TCproto.SetShadow=function(c){c.shadowBlur=this.shadowBlur,c.shadowOffsetX=this.shadowOffset[0],c.shadowOffsetY=this.shadowOffset[1]},TCproto.Draw=function(fixed){if(!this.paused){var active,a,i,cv=this.canvas,cw=cv.width,ch=cv.height,max_sc=0,tdelta=(fixed-this.time)*TagCanvas.interval/1e3,x=cw/2+this.offsetX,y=ch/2+this.offsetY,c=this.ctxt,aindex=-1,tl=this.taglist,l=tl.length,frontsel=this.frontSelect,centreDrawn=this.centreFunc==Nop;if(this.time=fixed,this.frozen&&this.drawn)return this.Animate(cw,ch,tdelta);for(fixed=this.AnimateFixed(),c.setTransform(1,0,0,1,0,0),i=0;i<l;++i)tl[i].Calc(this.transform,this.fixedAlpha);if(tl=function(l,f){for(var nl=[],tl=l.length,i=0;i<tl;++i)nl.push(l[i]);return nl.sort(f),nl}(tl,function(a,b){return b.z-a.z}),fixed&&this.fixedAnim.active)active=this.fixedAnim.tag.UpdateActive(c,x,y);else{for(this.active=null,i=0;i<l;++i)(a=0<=this.mx&&0<=this.my&&this.taglist[i].CheckActive(c,x,y))&&a.sc>max_sc&&(!frontsel||a.z<=0)&&(aindex=i,(active=a).tag=this.taglist[i],max_sc=a.sc);this.active=active}for(this.txtOpt||this.shadow&&this.SetShadow(c),c.clearRect(0,0,cw,ch),i=0;i<l;++i){if(!centreDrawn&&tl[i].z<=0){try{this.centreFunc(c,cw,ch,x,y)}catch(e){alert(e),this.centreFunc=Nop}centreDrawn=!0}active&&active.tag==tl[i]&&active.PreDraw(c,tl[i],x,y)||tl[i].Draw(c,x,y),active&&active.tag==tl[i]&&active.PostDraw(c)}this.freezeActive&&active?this.Freeze():(this.UnFreeze(),this.drawn=l==this.listLength),this.fixedCallback&&(this.fixedCallback(this,this.fixedCallbackTag),this.fixedCallback=null),fixed||this.Animate(cw,ch,tdelta),active&&active.LastDraw(c),cv.style.cursor=active?this.activeCursor:"",this.Tooltip(active,this.taglist[aindex])}},TCproto.TooltipNone=function(){},TCproto.TooltipNative=function(active,tag){this.canvas.title=active?tag&&tag.title?tag.title:"":this.ctitle},TCproto.SetTTDiv=function(title,tag){var tc=this,s=tc.ttdiv.style;title!=tc.ttdiv.innerHTML&&(s.display="none"),tc.ttdiv.innerHTML=title,tag&&(tag.title=tc.ttdiv.innerHTML),"none"!=s.display||tc.tttimer||(tc.tttimer=setTimeout(function(){var p=AbsPos(tc.canvas.id);s.display="block",s.left=p.x+tc.mx+"px",s.top=p.y+tc.my+24+"px",tc.tttimer=null},tc.tooltipDelay))},TCproto.TooltipDiv=function(active,tag){active&&tag&&tag.title?this.SetTTDiv(tag.title,tag):!active&&-1!=this.mx&&-1!=this.my&&this.ctitle.length?this.SetTTDiv(this.ctitle):this.ttdiv.style.display="none"},TCproto.Transform=function(tc,sy,ym){var sp,pm;(sy||ym)&&(sp=sin(sy),pm=cos(sy),sy=sin(ym),ym=new Matrix([ym=cos(ym),0,sy,0,1,0,-sy,0,ym]),pm=new Matrix([1,0,0,0,pm,-sp,0,sp,pm]),tc.transform=tc.transform.mul(ym.mul(pm)))},TCproto.AnimateFixed=function(){var t1,angle,m,d;return this.fadeIn&&((t1=TimeNow()-this.startTime)>=this.fadeIn?(this.fadeIn=0,this.fixedAlpha=1):this.fixedAlpha=t1/this.fadeIn),!!this.fixedAnim&&(this.fixedAnim.transform||(this.fixedAnim.transform=this.transform),m=this.fixedAnim,t1=TimeNow()-m.t0,angle=m.angle,d=this.animTiming(m.t,t1),this.transform=m.transform,t1>=m.t?(this.fixedCallbackTag=m.tag,this.fixedCallback=m.cb,this.fixedAnim=this.yaw=this.pitch=0):angle*=d,m=Matrix.Rotation(angle,m.axis),this.transform=this.transform.mul(m),0!=this.fixedAnim)},TCproto.AnimatePosition=function(w,h,t){var s,r,tc=this,x=tc.mx,y=tc.my;!tc.frozen&&0<=x&&0<=y&&x<w&&y<h?(s=tc.maxSpeed,r=tc.reverse?-1:1,tc.lx||(tc.yaw=(2*x*s/w-s)*r*t),tc.ly||(tc.pitch=(2*y*s/h-s)*-r*t),tc.initial=null):tc.initial||(tc.frozen&&!tc.freezeDecel?tc.yaw=tc.pitch=0:tc.Decel(tc)),this.Transform(tc,tc.pitch,tc.yaw)},TCproto.AnimateDrag=function(w,h,rs){var tc=this,rs=100*rs*tc.maxSpeed/tc.max_radius/tc.zoom;tc.dx||tc.dy?(tc.lx||(tc.yaw=tc.dx*rs/tc.stretchX),tc.ly||(tc.pitch=tc.dy*-rs/tc.stretchY),tc.dx=tc.dy=0,tc.initial=null):tc.initial||tc.Decel(tc),this.Transform(tc,tc.pitch,tc.yaw)},TCproto.Freeze=function(){this.frozen||(this.preFreeze=[this.yaw,this.pitch],this.frozen=1,this.drawn=0)},TCproto.UnFreeze=function(){this.frozen&&(this.yaw=this.preFreeze[0],this.pitch=this.preFreeze[1],this.frozen=0)},TCproto.Decel=function(tc){var s=tc.minSpeed,ay=abs(tc.yaw),ap=abs(tc.pitch);!tc.lx&&s<ay&&(tc.yaw=ay>tc.z0?tc.yaw*tc.decel:0),!tc.ly&&s<ap&&(tc.pitch=ap>tc.z0?tc.pitch*tc.decel:0)},TCproto.Zoom=function(r){this.z2=this.z1*(1/r),this.drawn=0},TCproto.Clicked=function(e){var a=this.active;try{a&&a.tag&&(!1===this.clickToFront||null===this.clickToFront?a.tag.Clicked(e):this.TagToFront(a.tag,this.clickToFront,function(){a.tag.Clicked(e)},!0))}catch(ex){}},TCproto.Wheel=function(z){z=this.zoom+this.zoomStep*(z?1:-1);this.zoom=min(this.zoomMax,max(this.zoomMin,z)),this.Zoom(this.zoom)},TCproto.BeginDrag=function(e){this.down=EventXY(e,this.canvas),e.cancelBubble=!0,e.returnValue=!1,e.preventDefault&&e.preventDefault()},TCproto.Drag=function(e,p){var t2,dx,dy;return this.dragControl&&this.down&&(t2=this.dragThreshold*this.dragThreshold,dx=p.x-this.down.x,dy=p.y-this.down.y,(this.dragging||t2<dx*dx+dy*dy)&&(this.dx=dx,this.dy=dy,this.dragging=1,this.down=p)),this.dragging},TCproto.EndDrag=function(){var res=this.dragging;return this.dragging=this.down=null,res},TCproto.BeginPinch=function(e){this.pinched=[PinchDistance(e),this.zoom],e.preventDefault&&e.preventDefault()},TCproto.Pinch=function(d){var z=this.pinched;z&&(d=PinchDistance(d),z=z[1]*d/z[0],this.zoom=min(this.zoomMax,max(this.zoomMin,z)),this.Zoom(this.zoom))},TCproto.EndPinch=function(e){this.pinched=null},TCproto.Pause=function(){this.paused=!0},TCproto.Resume=function(){this.paused=!1},TCproto.SetSpeed=function(i){this.initial=i,this.yaw=i[0]*this.maxSpeed,this.pitch=i[1]*this.maxSpeed},TCproto.FindTag=function(t){if(void 0===t)return null;if(void 0!==t.index&&(t=t.index),!IsObject(t))return this.taglist[t];var srch,tgt,i;for(void 0!==t.id?(srch="id",tgt=t.id):void 0!==t.text&&(srch="innerText",tgt=t.text),i=0;i<this.taglist.length;++i)if(this.taglist[i].a[srch]==tgt)return this.taglist[i]},TCproto.RotateTag=function(tag,angle,u,time,callback,active){var v1=tag.Calc(this.transform,1),v1=new Vector(v1.x,v1.y,v1.z),u=function(lg,lt){return lt=lt*Math.PI/180,lg=lg*Math.PI/180,new Vector(sin(lg)*cos(lt),-sin(lt),-cos(lg)*cos(lt))}(u,angle),angle=v1.angle(u),u=v1.cross(u).unit();0==angle?(this.fixedCallbackTag=tag,this.fixedCallback=callback):this.fixedAnim={angle:-angle,axis:u,t:time,t0:TimeNow(),cb:callback,tag:tag,active:active}},TCproto.TagToFront=function(tag,time,callback,active){this.RotateTag(tag,0,0,time,callback,active)},TagCanvas.Start=function(id,l,o){TagCanvas.Delete(id),TagCanvas.tc[id]=new TagCanvas(id,l,o)},TagCanvas.Linear=function(t,t0){return t0/t},TagCanvas.Smooth=function(t,t0){return.5-cos(t0*Math.PI/t)/2},TagCanvas.Pause=function(id){tccall("Pause",id)},TagCanvas.Resume=function(id){tccall("Resume",id)},TagCanvas.Reload=function(id){tccall("Load",id)},TagCanvas.Update=function(id){tccall("Update",id)},TagCanvas.SetSpeed=function(id,speed){return!(!IsObject(speed)||!TagCanvas.tc[id]||isNaN(speed[0])||isNaN(speed[1]))&&(TagCanvas.tc[id].SetSpeed(speed),!0)},TagCanvas.TagToFront=function(id,options){return!!IsObject(options)&&(options.lat=options.lng=0,TagCanvas.RotateTag(id,options))},TagCanvas.RotateTag=function(id,options){if(IsObject(options)&&TagCanvas.tc[id]){isNaN(options.time)&&(options.time=500);var tt=TagCanvas.tc[id].FindTag(options);if(tt)return TagCanvas.tc[id].RotateTag(tt,options.lat,options.lng,options.time,options.callback,options.active),!0}return!1},TagCanvas.Delete=function(id){var i,c,h,f,e;if(handlers[id]&&(c=doc.getElementById(id)))for(i=0;i<handlers[id].length;++i)h=handlers[id][i][0],f=handlers[id][i][1],(e=(e=c)||doc).removeEventListener?e.removeEventListener(h,f):e.detachEvent("on"+h,f);delete handlers[id],delete TagCanvas.tc[id]},TagCanvas.NextFrameRAF=function(){requestAnimationFrame(DrawCanvasRAF)},TagCanvas.NextFrameTimeout=function(iv){setTimeout(DrawCanvas,iv)},TagCanvas.tc={},TagCanvas.options={z1:2e4,z2:2e4,z0:2e-4,freezeActive:!0,freezeDecel:!1,activeCursor:"pointer",pulsateTo:1,pulsateTime:3,reverse:!1,depth:.5,maxSpeed:.05,minSpeed:0,decel:.95,interval:20,minBrightness:.1,maxBrightness:1,outlineColour:"",outlineThickness:2,outlineOffset:5,outlineMethod:"outline",outlineRadius:0,textColour:["#222","#000"],textHeight:15,textFont:"Helvetica, Arial, sans-serif",shadow:"#111",shadowBlur:1,shadowOffset:[.1,.1],initial:null,hideTags:!1,zoom:0,weight:!1,weightMode:"size",weightFrom:null,weightSize:1,weightSizeMin:null,weightSizeMax:null,weightGradient:{0:"#f00",.33:"#ff0",.66:"#0f0",1:"#00f"},txtOpt:!0,txtScale:2,frontSelect:!1,wheelZoom:!0,zoomMin:.8,zoomMax:.8,zoomStep:.05,shape:"sphere",lock:null,tooltip:null,tooltipDelay:300,tooltipClass:"tctooltip",radiusX:1,radiusY:1,radiusZ:1,stretchX:1,stretchY:1,offsetX:0,offsetY:0,shuffleTags:!1,noSelect:!1,noMouse:!1,imageScale:1,paused:!1,dragControl:!1,dragThreshold:4,centreFunc:Nop,splitWidth:0,animTiming:"Smooth",clickToFront:!1,fadeIn:0,padding:0,bgColour:null,bgRadius:0,bgOutline:null,bgOutlineThickness:0,outlineIncrease:4,textAlign:"centre",textVAlign:"middle",imageMode:null,imagePosition:null,imagePadding:2,imageAlign:"centre",imageVAlign:"middle",noTagsMessage:!0,centreImage:null,pinchZoom:!1,repeatTags:0,minTags:0,imageRadius:0,scrollPause:!1,outlineDash:0,outlineDashSpace:0,outlineDashSpeed:1},TagCanvas.options)TagCanvas[i]=TagCanvas.options[i];window.TagCanvas=TagCanvas,AddHandler("load",function(){TagCanvas.loaded=1},window)}();